{"version":3,"file":"static/js/index.6e662526.js","mappings":"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","sources":["webpack://wasm-boids/./src/components/Settings.vue","webpack://wasm-boids/./src/components/Settings.vue?b3ff","webpack://wasm-boids/./src/rendering/BoidInstancing.js","webpack://wasm-boids/./src/rendering/FogPipeline.js","webpack://wasm-boids/./src/rendering/LightRaysOverlay.js","webpack://wasm-boids/./src/rendering/ParticleField.js","webpack://wasm-boids/./src/simulation/WasmtimeBridge.js","webpack://wasm-boids/./src/state/FlockSettingsStore.js","webpack://wasm-boids/./src/App.vue","webpack://wasm-boids/./src/App.vue?7ccd","webpack://wasm-boids/./src/main.js","webpack://wasm-boids/webpack/bootstrap","webpack://wasm-boids/webpack/runtime/chunk loaded","webpack://wasm-boids/webpack/runtime/define property getters","webpack://wasm-boids/webpack/runtime/global","webpack://wasm-boids/webpack/runtime/hasOwnProperty shorthand","webpack://wasm-boids/webpack/runtime/jsonp chunk loading","webpack://wasm-boids/webpack/startup"],"sourcesContent":["<template>\r\n  <div class=\"settings\">\r\n    <details class=\"species-section\" :open=\"false\">\r\n      <summary class=\"species-header\">\r\n        <span class=\"species-title\">{{ settings.species }} ({{ settings.count }})</span>\r\n        <button\r\n          v-if=\"canRemove\"\r\n          class=\"species-remove\"\r\n          type=\"button\"\r\n          @click.stop=\"emitRemove\"\r\n        ></button>\r\n      </summary>\r\n\r\n      <div class=\"species-content\">\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.species\"><br />(Species):</label>\r\n          <span :title=\"settingHelp.species\">{{ settings.species }}</span>\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.count\">()<br />(Count):</label>\r\n          <input\r\n            type=\"range\"\r\n            v-model.number=\"countDraft\"\r\n            min=\"0\"\r\n            max=\"50000\"\r\n            step=\"1\"\r\n            @change=\"commitCountFromSlider\"\r\n            :title=\"settingHelp.count\"\r\n          />\r\n          <span\r\n            v-if=\"!editingCount\"\r\n            class=\"editable-value\"\r\n            @click=\"startEditCount\"\r\n            :title=\"settingHelp.count + ''\"\r\n          >{{ settings.count }}</span>\r\n          <input\r\n            v-else\r\n            ref=\"countInput\"\r\n            class=\"value-input\"\r\n            type=\"number\"\r\n            v-model.number=\"countDraft\"\r\n            min=\"0\"\r\n            max=\"20000\"\r\n            step=\"1\"\r\n            @blur=\"cancelCountEdit\"\r\n            @keyup.enter=\"commitCountFromInput\"\r\n            :title=\"settingHelp.count\"\r\n          />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.cohesion\"><br />(Cohesion):</label>\r\n          <input type=\"range\" v-model.number=\"settings.cohesion\" min=\"0\" max=\"40\" step=\"0.01\" :title=\"settingHelp.cohesion\" />\r\n          <span v-if=\"!editingCohesion\" class=\"editable-value\" @click=\"startEditCohesion\" :title=\"settingHelp.cohesion + ''\">{{ settings.cohesion }}</span>\r\n          <input v-else ref=\"cohesionInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.cohesion\" min=\"0\" max=\"40\" step=\"0.01\" @blur=\"stopEditCohesion\" @keyup.enter=\"stopEditCohesion\" :title=\"settingHelp.cohesion\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.cohesionRange\"><br />(Cohesion Range):</label>\r\n          <input type=\"range\" v-model.number=\"settings.cohesionRange\" min=\"1\" max=\"300\" step=\"1\" :title=\"settingHelp.cohesionRange\" />\r\n          <span v-if=\"!editingCohesionRange\" class=\"editable-value\" @click=\"startEditCohesionRange\" :title=\"settingHelp.cohesionRange + ''\">{{ settings.cohesionRange }}</span>\r\n          <input v-else ref=\"cohesionRangeInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.cohesionRange\" min=\"1\" max=\"300\" step=\"1\" @blur=\"stopEditCohesionRange\" @keyup.enter=\"stopEditCohesionRange\" :title=\"settingHelp.cohesionRange\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.separation\"><br />(Separation):</label>\r\n          <input type=\"range\" v-model.number=\"settings.separation\" min=\"0\" max=\"10\" step=\"0.01\" :title=\"settingHelp.separation\" />\r\n          <span v-if=\"!editingSeparation\" class=\"editable-value\" @click=\"startEditSeparation\" :title=\"settingHelp.separation + ''\">{{ settings.separation }}</span>\r\n          <input v-else ref=\"separationInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.separation\" min=\"0\" max=\"10\" step=\"0.01\" @blur=\"stopEditSeparation\" @keyup.enter=\"stopEditSeparation\" :title=\"settingHelp.separation\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.separationRange\"><br />(Separation Range):</label>\r\n          <input type=\"range\" v-model.number=\"settings.separationRange\" min=\"0.1\" max=\"10\" step=\"0.1\" :title=\"settingHelp.separationRange\" />\r\n          <span v-if=\"!editingSeparationRange\" class=\"editable-value\" @click=\"startEditSeparationRange\" :title=\"settingHelp.separationRange + ''\">{{ settings.separationRange }}</span>\r\n          <input v-else ref=\"separationRangeInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.separationRange\" min=\"0.1\" max=\"10\" step=\"0.1\" @blur=\"stopEditSeparationRange\" @keyup.enter=\"stopEditSeparationRange\" :title=\"settingHelp.separationRange\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.alignment\"><br />(Alignment):</label>\r\n          <input type=\"range\" v-model.number=\"settings.alignment\" min=\"0\" max=\"20\" step=\"0.01\" :title=\"settingHelp.alignment\" />\r\n          <span v-if=\"!editingAlignment\" class=\"editable-value\" @click=\"startEditAlignment\" :title=\"settingHelp.alignment + ''\">{{ settings.alignment }}</span>\r\n          <input v-else ref=\"alignmentInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.alignment\" min=\"0\" max=\"20\" step=\"0.01\" @blur=\"stopEditAlignment\" @keyup.enter=\"stopEditAlignment\" :title=\"settingHelp.alignment\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.alignmentRange\"><br />(Alignment Range):</label>\r\n          <input type=\"range\" v-model.number=\"settings.alignmentRange\" min=\"1\" max=\"100\" step=\"1\" :title=\"settingHelp.alignmentRange\" />\r\n          <span v-if=\"!editingAlignmentRange\" class=\"editable-value\" @click=\"startEditAlignmentRange\" :title=\"settingHelp.alignmentRange + ''\">{{ settings.alignmentRange }}</span>\r\n          <input v-else ref=\"alignmentRangeInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.alignmentRange\" min=\"1\" max=\"100\" step=\"1\" @blur=\"stopEditAlignmentRange\" @keyup.enter=\"stopEditAlignmentRange\" :title=\"settingHelp.alignmentRange\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.predatorAlertRadius\"><br />(Predator Alert):</label>\r\n          <input type=\"range\" v-model.number=\"settings.predatorAlertRadius\" min=\"0\" max=\"10\" step=\"0.05\" :title=\"settingHelp.predatorAlertRadius\" />\r\n          <span v-if=\"!editingPredatorAlertRadius\" class=\"editable-value\" @click=\"startEditPredatorAlertRadius\" :title=\"settingHelp.predatorAlertRadius + ''\">{{ settings.predatorAlertRadius }}</span>\r\n          <input v-else ref=\"predatorAlertRadiusInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.predatorAlertRadius\" min=\"0\" max=\"20\" step=\"0.05\" @blur=\"stopEditPredatorAlertRadius\" @keyup.enter=\"stopEditPredatorAlertRadius\" :title=\"settingHelp.predatorAlertRadius\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.densityReturnStrength\"><br />(Density Return):</label>\r\n          <input type=\"range\" v-model.number=\"settings.densityReturnStrength\" min=\"0\" max=\"80\" step=\"0.5\" :title=\"settingHelp.densityReturnStrength\" />\r\n          <span v-if=\"!editingDensityReturnStrength\" class=\"editable-value\" @click=\"startEditDensityReturnStrength\" :title=\"settingHelp.densityReturnStrength + ''\">{{ settings.densityReturnStrength }}</span>\r\n          <input v-else ref=\"densityReturnStrengthInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.densityReturnStrength\" min=\"0\" max=\"120\" step=\"0.5\" @blur=\"stopEditDensityReturnStrength\" @keyup.enter=\"stopEditDensityReturnStrength\" :title=\"settingHelp.densityReturnStrength\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.maxSpeed\"><br />(Max Speed):</label>\r\n          <input type=\"range\" v-model.number=\"settings.maxSpeed\" min=\"0.1\" max=\"2\" step=\"0.01\" :title=\"settingHelp.maxSpeed\" />\r\n          <span v-if=\"!editingMaxSpeed\" class=\"editable-value\" @click=\"startEditMaxSpeed\" :title=\"settingHelp.maxSpeed + ''\">{{ settings.maxSpeed }}</span>\r\n          <input v-else ref=\"maxSpeedInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.maxSpeed\" min=\"0.1\" max=\"2\" step=\"0.01\" @blur=\"stopEditMaxSpeed\" @keyup.enter=\"stopEditMaxSpeed\" :title=\"settingHelp.maxSpeed\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.maxTurnAngle\"><br />(Max Curvature):</label>\r\n          <input type=\"range\" v-model.number=\"settings.maxTurnAngle\" min=\"0\" max=\"30\" step=\"0.1\" :title=\"settingHelp.maxTurnAngle\" />\r\n          <span v-if=\"!editingMaxTurnAngle\" class=\"editable-value\" @click=\"startEditMaxTurnAngle\" :title=\"settingHelp.maxTurnAngle + ''\">{{ settings.maxTurnAngle }}</span>\r\n          <input v-else ref=\"maxTurnAngleInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.maxTurnAngle\" min=\"0\" max=\"60\" step=\"0.1\" @blur=\"stopEditMaxTurnAngle\" @keyup.enter=\"stopEditMaxTurnAngle\" :title=\"settingHelp.maxTurnAngle\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.maxNeighbors\"><br />(Max Neighbors):</label>\r\n          <input type=\"range\" v-model.number=\"settings.maxNeighbors\" min=\"0\" max=\"32\" step=\"1\" :title=\"settingHelp.maxNeighbors\" />\r\n          <span v-if=\"!editingMaxNeighbors\" class=\"editable-value\" @click=\"startEditMaxNeighbors\" :title=\"settingHelp.maxNeighbors + ''\">{{ settings.maxNeighbors }}</span>\r\n          <input v-else ref=\"maxNeighborsInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.maxNeighbors\" min=\"0\" max=\"32\" step=\"1\" @blur=\"stopEditMaxNeighbors\" @keyup.enter=\"stopEditMaxNeighbors\" :title=\"settingHelp.maxNeighbors\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.horizontalTorque\"><br />(Horizontal Torque):</label>\r\n          <input type=\"range\" v-model.number=\"settings.horizontalTorque\" min=\"0.0\" max=\"0.2\" step=\"0.001\" :title=\"settingHelp.horizontalTorque\" />\r\n          <span v-if=\"!editingHorizontalTorque\" class=\"editable-value\" @click=\"startEditHorizontalTorque\" :title=\"settingHelp.horizontalTorque + ''\">{{ settings.horizontalTorque }}</span>\r\n          <input v-else ref=\"horizontalTorqueInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.horizontalTorque\" min=\"0.0\" max=\"0.2\" step=\"0.001\" @blur=\"stopEditHorizontalTorque\" @keyup.enter=\"stopEditHorizontalTorque\" :title=\"settingHelp.horizontalTorque\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.torqueStrength\"><br />(Torque Strength):</label>\r\n          <input type=\"range\" v-model.number=\"settings.torqueStrength\" min=\"0.0\" max=\"20\" step=\"0.001\" :title=\"settingHelp.torqueStrength\" />\r\n          <span v-if=\"!editingTorqueStrength\" class=\"editable-value\" @click=\"startEditTorqueStrength\" :title=\"settingHelp.torqueStrength + ''\">{{ settings.torqueStrength }}</span>\r\n          <input v-else ref=\"torqueStrengthInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.torqueStrength\" min=\"0.0\" max=\"5\" step=\"0.001\" @blur=\"stopEditTorqueStrength\" @keyup.enter=\"stopEditTorqueStrength\" :title=\"settingHelp.torqueStrength\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.lambda\"><br />(Damping Coefficient):</label>\r\n          <input type=\"range\" v-model.number=\"settings.lambda\" min=\"0\" max=\"1\" step=\"0.001\" :title=\"settingHelp.lambda\" />\r\n          <span v-if=\"!editingLambda\" class=\"editable-value\" @click=\"startEditLambda\" :title=\"settingHelp.lambda + ''\">{{ settings.lambda }}</span>\r\n          <input v-else ref=\"lambdaInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.lambda\" min=\"0\" max=\"1\" step=\"0.001\" @blur=\"stopEditLambda\" @keyup.enter=\"stopEditLambda\" :title=\"settingHelp.lambda\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.tau\"><br />(Memory Time):</label>\r\n          <input type=\"range\" v-model.number=\"settings.tau\" min=\"0\" max=\"5\" step=\"0.01\" :title=\"settingHelp.tau\" />\r\n          <span v-if=\"!editingTau\" class=\"editable-value\" @click=\"startEditTau\" :title=\"settingHelp.tau + ''\">{{ settings.tau }}</span>\r\n          <input v-else ref=\"tauInput\" class=\"value-input\" type=\"number\" v-model.number=\"settings.tau\" min=\"0\" max=\"5\" step=\"0.01\" @blur=\"stopEditTau\" @keyup.enter=\"stopEditTau\" :title=\"settingHelp.tau\" />\r\n        </div>\r\n\r\n        <div class=\"setting-row\">\r\n          <label :title=\"settingHelp.isPredator\"><br />(Is Predator):</label>\r\n          <input type=\"checkbox\" v-model=\"settings.isPredator\" :title=\"settingHelp.isPredator\" />\r\n          <span :title=\"settingHelp.isPredator\">{{ settings.isPredator }}</span>\r\n        </div>\r\n      </div>\r\n    </details>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { nextTick, ref, watch } from 'vue';\r\n\r\n// (App.vue)\r\n//  v-model \r\nconst props = defineProps({\r\n  settings: {\r\n    type: Object,\r\n    required: true,\r\n  },\r\n  canRemove: {\r\n    type: Boolean,\r\n    default: true,\r\n  },\r\n});\r\n\r\nconst emit = defineEmits(['remove']);\r\n\r\nfunction emitRemove() {\r\n  emit('remove');\r\n}\r\n\r\n//  title \r\n// NOTE: /\r\nconst settingHelp = {\r\n  species: '',\r\n  count: '',\r\n  cohesion: '',\r\n  cohesionRange: '',\r\n  separation: '',\r\n  separationRange: '',\r\n  alignment: '',\r\n  alignmentRange: '',\r\n  predatorAlertRadius: '',\r\n  densityReturnStrength: '',\r\n  maxSpeed: '',\r\n  maxTurnAngle: '',\r\n  maxNeighbors: '',\r\n  horizontalTorque: '',\r\n  torqueStrength: '',\r\n  lambda: '',\r\n  tau: '',\r\n  isPredator: '',\r\n};\r\n\r\n// count  draft \r\nconst countDraft = ref(props.settings.count);\r\nconst editingCount = ref(false);\r\nconst countInput = ref(null);\r\n\r\nwatch(\r\n  () => props.settings.count,\r\n  (newCount) => {\r\n    // \r\n    if (!editingCount.value) {\r\n      countDraft.value = newCount;\r\n    }\r\n  }\r\n);\r\n\r\nfunction startEditCount() {\r\n  editingCount.value = true;\r\n  countDraft.value = props.settings.count;\r\n  nextTick(() => {\r\n    countInput.value?.focus?.();\r\n  });\r\n}\r\n\r\nfunction commitCountFromSlider() {\r\n  props.settings.count = countDraft.value;\r\n}\r\n\r\nfunction commitCountFromInput() {\r\n  props.settings.count = countDraft.value;\r\n  editingCount.value = false;\r\n}\r\n\r\nfunction cancelCountEdit() {\r\n  editingCount.value = false;\r\n  countDraft.value = props.settings.count;\r\n}\r\n\r\n// \r\nfunction startEditNumber(editingFlag, inputRef) {\r\n  editingFlag.value = true;\r\n  nextTick(() => {\r\n    inputRef.value?.focus?.();\r\n  });\r\n}\r\n\r\nfunction stopEditNumber(editingFlag) {\r\n  editingFlag.value = false;\r\n}\r\n\r\nconst editingCohesion = ref(false);\r\nconst cohesionInput = ref(null);\r\nfunction startEditCohesion() { startEditNumber(editingCohesion, cohesionInput); }\r\nfunction stopEditCohesion() { stopEditNumber(editingCohesion); }\r\n\r\nconst editingCohesionRange = ref(false);\r\nconst cohesionRangeInput = ref(null);\r\nfunction startEditCohesionRange() { startEditNumber(editingCohesionRange, cohesionRangeInput); }\r\nfunction stopEditCohesionRange() { stopEditNumber(editingCohesionRange); }\r\n\r\nconst editingSeparation = ref(false);\r\nconst separationInput = ref(null);\r\nfunction startEditSeparation() { startEditNumber(editingSeparation, separationInput); }\r\nfunction stopEditSeparation() { stopEditNumber(editingSeparation); }\r\n\r\nconst editingSeparationRange = ref(false);\r\nconst separationRangeInput = ref(null);\r\nfunction startEditSeparationRange() { startEditNumber(editingSeparationRange, separationRangeInput); }\r\nfunction stopEditSeparationRange() { stopEditNumber(editingSeparationRange); }\r\n\r\nconst editingAlignment = ref(false);\r\nconst alignmentInput = ref(null);\r\nfunction startEditAlignment() { startEditNumber(editingAlignment, alignmentInput); }\r\nfunction stopEditAlignment() { stopEditNumber(editingAlignment); }\r\n\r\nconst editingAlignmentRange = ref(false);\r\nconst alignmentRangeInput = ref(null);\r\nfunction startEditAlignmentRange() { startEditNumber(editingAlignmentRange, alignmentRangeInput); }\r\nfunction stopEditAlignmentRange() { stopEditNumber(editingAlignmentRange); }\r\n\r\nconst editingPredatorAlertRadius = ref(false);\r\nconst predatorAlertRadiusInput = ref(null);\r\nfunction startEditPredatorAlertRadius() { startEditNumber(editingPredatorAlertRadius, predatorAlertRadiusInput); }\r\nfunction stopEditPredatorAlertRadius() { stopEditNumber(editingPredatorAlertRadius); }\r\n\r\nconst editingDensityReturnStrength = ref(false);\r\nconst densityReturnStrengthInput = ref(null);\r\nfunction startEditDensityReturnStrength() { startEditNumber(editingDensityReturnStrength, densityReturnStrengthInput); }\r\nfunction stopEditDensityReturnStrength() { stopEditNumber(editingDensityReturnStrength); }\r\n\r\nconst editingMaxSpeed = ref(false);\r\nconst maxSpeedInput = ref(null);\r\nfunction startEditMaxSpeed() { startEditNumber(editingMaxSpeed, maxSpeedInput); }\r\nfunction stopEditMaxSpeed() { stopEditNumber(editingMaxSpeed); }\r\n\r\nconst editingMaxTurnAngle = ref(false);\r\nconst maxTurnAngleInput = ref(null);\r\nfunction startEditMaxTurnAngle() { startEditNumber(editingMaxTurnAngle, maxTurnAngleInput); }\r\nfunction stopEditMaxTurnAngle() { stopEditNumber(editingMaxTurnAngle); }\r\n\r\nconst editingMaxNeighbors = ref(false);\r\nconst maxNeighborsInput = ref(null);\r\nfunction startEditMaxNeighbors() { startEditNumber(editingMaxNeighbors, maxNeighborsInput); }\r\nfunction stopEditMaxNeighbors() { stopEditNumber(editingMaxNeighbors); }\r\n\r\nconst editingHorizontalTorque = ref(false);\r\nconst horizontalTorqueInput = ref(null);\r\nfunction startEditHorizontalTorque() { startEditNumber(editingHorizontalTorque, horizontalTorqueInput); }\r\nfunction stopEditHorizontalTorque() { stopEditNumber(editingHorizontalTorque); }\r\n\r\nconst editingTorqueStrength = ref(false);\r\nconst torqueStrengthInput = ref(null);\r\nfunction startEditTorqueStrength() { startEditNumber(editingTorqueStrength, torqueStrengthInput); }\r\nfunction stopEditTorqueStrength() { stopEditNumber(editingTorqueStrength); }\r\n\r\nconst editingLambda = ref(false);\r\nconst lambdaInput = ref(null);\r\nfunction startEditLambda() { startEditNumber(editingLambda, lambdaInput); }\r\nfunction stopEditLambda() { stopEditNumber(editingLambda); }\r\n\r\nconst editingTau = ref(false);\r\nconst tauInput = ref(null);\r\nfunction startEditTau() { startEditNumber(editingTau, tauInput); }\r\nfunction stopEditTau() { stopEditNumber(editingTau); }\r\n</script>\r\n\r\n<style scoped>\r\n.settings {\r\n  pointer-events: auto;\r\n}\r\n\r\n.species-section {\r\n  border: 1px solid rgba(255, 255, 255, 0.2);\r\n  border-radius: 5px;\r\n  margin-bottom: 10px;\r\n  background-color: rgba(255, 255, 255, 0.05);\r\n  pointer-events: auto;\r\n  position: relative;\r\n  overflow: visible;\r\n  max-width: 100%;\r\n  width: fit-content;\r\n  min-width: 260px;\r\n}\r\n\r\n.species-header {\r\n  padding: 10px;\r\n  font-weight: bold;\r\n  cursor: pointer;\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  border-radius: 5px 5px 0 0;\r\n  user-select: none;\r\n  pointer-events: auto;\r\n  max-width: 100%;\r\n  width: 100%;\r\n  box-sizing: border-box;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  gap: 8px;\r\n}\r\n\r\n.species-header:hover {\r\n  background-color: rgba(255, 255, 255, 0.15);\r\n}\r\n\r\n.species-title {\r\n  flex: 1;\r\n}\r\n\r\n.species-remove {\r\n  pointer-events: auto;\r\n  background: #d9534f;\r\n  color: #fff;\r\n  border: none;\r\n  border-radius: 4px;\r\n  padding: 4px 8px;\r\n  font-size: 0.8rem;\r\n  cursor: pointer;\r\n}\r\n\r\n.species-remove:hover {\r\n  background: #c9302c;\r\n}\r\n\r\n.species-content {\r\n  padding: 10px;\r\n  pointer-events: auto;\r\n  position: relative;\r\n  max-width: 100%;\r\n  width: 100%;\r\n  box-sizing: border-box;\r\n  /*\r\n     title \r\n    \r\n  */\r\n  overflow: visible;\r\n}\r\n\r\n.setting-row {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n  width: 100%;\r\n  /*  */\r\n  overflow: visible;\r\n}\r\n\r\n.setting-row label {\r\n  width: 150px;\r\n  text-align: left;\r\n  margin-right: 10px;\r\n  flex-shrink: 0;\r\n  line-height: 1.3;\r\n}\r\n\r\n.setting-row input[type=\"range\"] {\r\n  width: 140px;\r\n  min-width: 100px;\r\n  max-width: 220px;\r\n  margin: 0 10px;\r\n}\r\n\r\n.value-input {\r\n  width: 70px;\r\n  padding: 2px 4px;\r\n  border: 1px solid #ccc;\r\n  border-radius: 3px;\r\n  background: transparent;\r\n  color: inherit;\r\n  font-size: inherit;\r\n}\r\n\r\n.value-input:focus {\r\n  outline: none;\r\n  border-color: #007bff;\r\n  box-shadow: 0 0 3px rgba(0, 123, 255, 0.3);\r\n}\r\n\r\n.editable-value {\r\n  width: 70px;\r\n  padding: 2px 4px;\r\n  border: 1px dashed rgba(255, 255, 255, 0.35);\r\n  border-radius: 3px;\r\n  cursor: pointer;\r\n  text-align: right;\r\n  user-select: none;\r\n}\r\n</style>\r\n","import script from \"./Settings.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./Settings.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./Settings.vue?vue&type=style&index=0&id=27c2e252&scoped=true&lang=css\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['__scopeId',\"data-v-27c2e252\"]])\n\nexport default __exports__","import * as THREE from 'three';\r\n\r\n/**\r\n * Boid \r\n * / LOD  uniform \r\n */\r\nexport class BoidInstancing {\r\n  constructor({\r\n    tailAnimation,\r\n    tripleBufferSize = 3,        // \r\n    hiddenPosition = 1e6,        // \r\n    identityQuaternion = [0, 0, 0, 1], // \r\n    lodNearDistanceSq = 4,       // 2m\r\n    lodMidDistanceSq = 25,       // LOD 5m\r\n  } = {}) {\r\n    this.tailAnimation = tailAnimation;\r\n    this.tripleBufferSize = tripleBufferSize;\r\n    this.hiddenPosition = hiddenPosition;\r\n    this.identityQuaternion = identityQuaternion;\r\n    this.lodNearDistanceSq = lodNearDistanceSq;\r\n    this.lodMidDistanceSq = lodMidDistanceSq;\r\n    this.streamUsage = THREE.StreamDrawUsage ?? THREE.DynamicDrawUsage;\r\n\r\n    this.scene = null;\r\n    this.count = 0;\r\n\r\n    this.instancedMeshHigh = null;\r\n    this.instancedMeshLow = null;\r\n    this.instancingMaterials = new Set();\r\n\r\n    this.bufferSetHigh = null;\r\n    this.bufferSetLow = null;\r\n    this.tailPhaseSeeds = null;\r\n    this.bufferCursor = 0;\r\n\r\n    this.previousVelocities = null;\r\n    this.previousLodFlags = null;\r\n\r\n    this.predatorModel = null;\r\n    this.predatorMeshes = [];\r\n    this.predatorMeshCountCache = -1;\r\n\r\n    // instancePos  16bit normalized \r\n    // extent [m] [-extent, extent] 2*extent\r\n    this.positionQuantization = {\r\n      // NOTE:  update()  posRange \r\n      extent: 64,\r\n      originSnap: 1.0,\r\n    };\r\n    this.positionQuantUniforms = {\r\n      uInstanceOrigin: { value: new THREE.Vector3() },\r\n      uInstanceExtent: { value: this.positionQuantization.extent },\r\n    };\r\n  }\r\n\r\n  init(scene, {\r\n    count,\r\n    boidModel,\r\n    boidModelLod,\r\n    highMaterial,\r\n    lowMaterial,\r\n    predatorModel = null,\r\n  }) {\r\n    if (!scene || !boidModel || !boidModelLod || !highMaterial || !lowMaterial) {\r\n      console.error('BoidInstancing.init: missing required arguments.');\r\n      return false;\r\n    }\r\n    if (!boidModel.children?.length || !boidModel.children[0].geometry) {\r\n      console.error('BoidInstancing.init: invalid high model.');\r\n      return false;\r\n    }\r\n    if (!boidModelLod.children?.length || !boidModelLod.children[0].geometry) {\r\n      console.error('BoidInstancing.init: invalid LOD model.');\r\n      return false;\r\n    }\r\n\r\n    this.dispose(scene);\r\n\r\n    this.scene = scene;\r\n    this.count = count;\r\n    if (predatorModel) {\r\n      this.predatorModel = predatorModel;\r\n    }\r\n\r\n    const highMaterialClone = highMaterial.clone();\r\n    const lowMaterialClone = lowMaterial.clone();\r\n    this.patchMaterial(highMaterialClone);\r\n    this.patchMaterial(lowMaterialClone);\r\n\r\n    // \r\n    const highGeometry = boidModel.children[0].geometry.clone();\r\n    const lowGeometry = boidModelLod.children[0].geometry.clone();\r\n    this.ensureBodyCoordAttribute(highGeometry);\r\n    this.ensureBodyCoordAttribute(lowGeometry);\r\n\r\n    this.instancedMeshHigh = new THREE.InstancedMesh(highGeometry, highMaterialClone, count);\r\n    this.configureInstancedMesh(this.instancedMeshHigh, highMaterialClone);\r\n\r\n    this.instancedMeshLow = new THREE.InstancedMesh(lowGeometry, lowMaterialClone, count);\r\n    this.configureInstancedMesh(this.instancedMeshLow, lowMaterialClone);\r\n\r\n    scene.add(this.instancedMeshHigh);\r\n    scene.add(this.instancedMeshLow);\r\n\r\n    this.bufferSetHigh = this.createBufferSet(count);\r\n    this.bufferSetLow = this.createBufferSet(count);\r\n    this.resetBufferSetToHidden(this.bufferSetHigh);\r\n    this.resetBufferSetToHidden(this.bufferSetLow);\r\n\r\n    this.tailPhaseSeeds = this.createTailPhaseArray(count);\r\n    this.applyTailPhaseSeeds(this.bufferSetHigh, this.tailPhaseSeeds);\r\n    this.applyTailPhaseSeeds(this.bufferSetLow, this.tailPhaseSeeds);\r\n\r\n    this.bufferCursor = 0;\r\n    this.applyBufferSet(this.instancedMeshHigh, this.bufferSetHigh, this.bufferCursor);\r\n    this.applyBufferSet(this.instancedMeshLow, this.bufferSetLow, this.bufferCursor);\r\n\r\n    this.instancedMeshHigh.instanceMatrix.setUsage(THREE.StaticDrawUsage);\r\n    this.instancedMeshLow.instanceMatrix.setUsage(THREE.StaticDrawUsage);\r\n    // update \r\n    this.instancedMeshHigh.count = 0;\r\n    this.instancedMeshLow.count = 0;\r\n\r\n    this.previousVelocities = null;\r\n    this.previousLodFlags = null;\r\n\r\n    if (this.scene && this.predatorModel) {\r\n      this.ensurePredatorMeshes(0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n * LOD \r\n *\r\n * NOTE:\r\n *  -  High/Low  count  hiddenPosition \r\n *     GPU High+Low //\r\n *  -  LOD mesh.count  High/Low \r\n *    GPU \r\n *\r\n * App.vue instanceIndex  boidIndex\r\n */\r\nupdate({\r\n  count,\r\n  positions,\r\n  orientations,\r\n  velocities,\r\n  cameraPosition,\r\n  predatorCount = 0,\r\n  posRange,\r\n  originPosition,\r\n}) {\r\n  if (!this.instancedMeshHigh || !this.instancedMeshLow || !this.bufferSetHigh || !this.bufferSetLow) {\r\n    return { visibleCount: 0, lodFlags: null };\r\n  }\r\n  if (!positions || !orientations) {\r\n    return { visibleCount: 0, lodFlags: null };\r\n  }\r\n\r\n  const currentIndex = this.bufferCursor;\r\n  const nextIndex = (currentIndex + 1) % this.tripleBufferSize;\r\n\r\n  this.ensureTailRuntimeBuffers(count);\r\n  this.ensureTailSeedCapacity(count);\r\n  const lodFlags = this.ensureLodFlagBuffer(count);\r\n\r\n  const highPosAttr = this.bufferSetHigh.pos[currentIndex];\r\n  const highQuatAttr = this.bufferSetHigh.quat[currentIndex];\r\n  const highTailParamsAttr = this.bufferSetHigh.tailParams[currentIndex];\r\n  const highTailPhaseAttr = this.bufferSetHigh.tailPhase[currentIndex];\r\n  const lowPosAttr = this.bufferSetLow.pos[currentIndex];\r\n  const lowQuatAttr = this.bufferSetLow.quat[currentIndex];\r\n  const lowTailParamsAttr = this.bufferSetLow.tailParams[currentIndex];\r\n  const lowTailPhaseAttr = this.bufferSetLow.tailPhase[currentIndex];\r\n\r\n  const highPosArray = highPosAttr.array;\r\n  const highQuatArray = highQuatAttr.array;\r\n  const highTailParamsArray = highTailParamsAttr.array;\r\n  const highTailPhaseArray = highTailPhaseAttr.array;\r\n  const lowPosArray = lowPosAttr.array;\r\n  const lowQuatArray = lowQuatAttr.array;\r\n  const lowTailParamsArray = lowTailParamsAttr.array;\r\n  const lowTailPhaseArray = lowTailPhaseAttr.array;\r\n\r\n  let highTransformTouched = false;\r\n  let lowTransformTouched = false;\r\n  let highTailTouched = false;\r\n  let lowTailTouched = false;\r\n  let highTailPhaseTouched = false;\r\n  let lowTailPhaseTouched = false;\r\n\r\n  const camX = cameraPosition?.x ?? 0;\r\n  const camY = cameraPosition?.y ?? 0;\r\n  const camZ = cameraPosition?.z ?? 0;\r\n\r\n  // NOTE: camera \r\n  const originBaseX = originPosition?.x ?? camX;\r\n  const originBaseY = originPosition?.y ?? camY;\r\n  const originBaseZ = originPosition?.z ?? camZ;\r\n\r\n  //  instancePos GPU  origin/extent \r\n  // posRange \r\n  const extentFromPosRange = Number.isFinite(posRange) && posRange > 0\r\n    ? posRange * 16\r\n    : 0;\r\n  const extent = Math.max(this.positionQuantization.extent, extentFromPosRange);\r\n  const snap = this.positionQuantization.originSnap;\r\n  const originX = snap > 0 ? Math.floor(originBaseX / snap) * snap : originBaseX;\r\n  const originY = snap > 0 ? Math.floor(originBaseY / snap) * snap : originBaseY;\r\n  const originZ = snap > 0 ? Math.floor(originBaseZ / snap) * snap : originBaseZ;\r\n\r\n  // uniform \r\n  this.positionQuantUniforms.uInstanceOrigin.value.set(originX, originY, originZ);\r\n  this.positionQuantUniforms.uInstanceExtent.value = extent;\r\n\r\n  const invExtent = extent > 0 ? 1.0 / extent : 0.0;\r\n\r\n  // C++ \r\n  const predatorStartIndex = predatorCount > 0 ? Math.max(0, count - predatorCount) : count;\r\n  if (this.scene && this.predatorModel) {\r\n    if (this.ensurePredatorMeshes(predatorCount)) {\r\n      this.predatorMeshCountCache = predatorCount;\r\n    }\r\n    for (const mesh of this.predatorMeshes) {\r\n      mesh.visible = false;\r\n    }\r\n  }\r\n\r\n  const prevVel = this.previousVelocities;\r\n  const tailSeeds = this.tailPhaseSeeds;\r\n\r\n  // LOD  write index\r\n  let highWrite = 0;\r\n  let lowWrite = 0;\r\n\r\n  // instanceIndex  boidIndex \r\n  if (!this.highInstanceToBoid || this.highInstanceToBoid.length < count) {\r\n    this.highInstanceToBoid = new Uint32Array(count);\r\n    this.lowInstanceToBoid = new Uint32Array(count);\r\n  }\r\n\r\n  for (let i = 0; i < count; i++) {\r\n    const basePos = i * 3;\r\n    const baseQuat = i * 4;\r\n\r\n    const px = positions[basePos];\r\n    const py = positions[basePos + 1];\r\n    const pz = positions[basePos + 2];\r\n\r\n    const qx = orientations[baseQuat];\r\n    const qy = orientations[baseQuat + 1];\r\n    const qz = orientations[baseQuat + 2];\r\n    const qw = orientations[baseQuat + 3];\r\n\r\n    // \r\n    if (i >= predatorStartIndex) {\r\n      if (this.scene && this.predatorModel) {\r\n        const predatorLocalIndex = i - predatorStartIndex;\r\n        const predatorMesh = this.predatorMeshes[predatorLocalIndex];\r\n        if (predatorMesh) {\r\n          predatorMesh.visible = true;\r\n          predatorMesh.position.set(px, py, pz);\r\n          predatorMesh.quaternion.set(qx, qy, qz, qw);\r\n        }\r\n      }\r\n      if (lodFlags) {\r\n        lodFlags[i] = 0;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    const dx = px - camX;\r\n    const dy = py - camY;\r\n    const dz = pz - camZ;\r\n    //  LOD \r\n    const distSq = dx * dx + dy * dy + dz * dz;\r\n    const isNear = distSq < this.lodNearDistanceSq;\r\n    const isMid = !isNear && distSq < this.lodMidDistanceSq;\r\n    const animateTail = isNear || isMid;\r\n\r\n    // \r\n    const vx = velocities ? velocities[basePos] : 0;\r\n    const vy = velocities ? velocities[basePos + 1] : 0;\r\n    const vz = velocities ? velocities[basePos + 2] : 0;\r\n\r\n    const speed = Math.hypot(vx, vy, vz);\r\n    const prevVx = prevVel ? prevVel[basePos] : 0;\r\n    const prevVy = prevVel ? prevVel[basePos + 1] : 0;\r\n    const prevVz = prevVel ? prevVel[basePos + 2] : 0;\r\n    const prevLen = Math.hypot(prevVx, prevVy, prevVz);\r\n\r\n    let turnAmount = 0;\r\n    if (prevLen > 1e-5 && speed > 1e-5) {\r\n      //  Y \r\n      const crossY = prevVz * vx - prevVx * vz;\r\n      const dot = prevVx * vx + prevVy * vy + prevVz * vz;\r\n      turnAmount = Math.atan2(crossY, dot);\r\n    }\r\n\r\n    const tailSpeedValue = animateTail ? speed : 0;\r\n    const tailTurnValue = animateTail ? turnAmount : 0;\r\n    const driveValue = animateTail ? 1 : 0;\r\n\r\n    if (isNear) {\r\n      // High \r\n      const writeIndex = highWrite;\r\n      const outPos = writeIndex * 3;\r\n      const outQuat = writeIndex * 4;\r\n      const outTail = writeIndex * 3;\r\n\r\n      // 16bit normalized: 0..1  Uint16 \r\n      {\r\n        const lx = Math.max(-extent, Math.min(extent, px - originX));\r\n        const ly = Math.max(-extent, Math.min(extent, py - originY));\r\n        const lz = Math.max(-extent, Math.min(extent, pz - originZ));\r\n\r\n        const nx = Math.max(0, Math.min(1, lx * 0.5 * invExtent + 0.5));\r\n        const ny = Math.max(0, Math.min(1, ly * 0.5 * invExtent + 0.5));\r\n        const nz = Math.max(0, Math.min(1, lz * 0.5 * invExtent + 0.5));\r\n\r\n        highPosArray[outPos] = ((nx * 65535 + 0.5) | 0);\r\n        highPosArray[outPos + 1] = ((ny * 65535 + 0.5) | 0);\r\n        highPosArray[outPos + 2] = ((nz * 65535 + 0.5) | 0);\r\n      }\r\n      highQuatArray[outQuat] = qx;\r\n      highQuatArray[outQuat + 1] = qy;\r\n      highQuatArray[outQuat + 2] = qz;\r\n      highQuatArray[outQuat + 3] = qw;\r\n      highTailParamsArray[outTail] = tailSpeedValue;\r\n      highTailParamsArray[outTail + 1] = tailTurnValue;\r\n      highTailParamsArray[outTail + 2] = driveValue;\r\n      // Boid \r\n      // tailPhase  Boid LOD \r\n      const seedValue = tailSeeds && i < tailSeeds.length ? tailSeeds[i] : 0;\r\n      highTailPhaseArray[writeIndex] = seedValue;\r\n\r\n      this.highInstanceToBoid[writeIndex] = i;\r\n      highWrite++;\r\n\r\n      highTransformTouched = true;\r\n      highTailTouched = true;\r\n      highTailPhaseTouched = true;\r\n    } else {\r\n      // Low \r\n      const writeIndex = lowWrite;\r\n      const outPos = writeIndex * 3;\r\n      const outQuat = writeIndex * 4;\r\n      const outTail = writeIndex * 3;\r\n\r\n      // 16bit normalized: 0..1  Uint16 \r\n      {\r\n        const lx = Math.max(-extent, Math.min(extent, px - originX));\r\n        const ly = Math.max(-extent, Math.min(extent, py - originY));\r\n        const lz = Math.max(-extent, Math.min(extent, pz - originZ));\r\n\r\n        const nx = Math.max(0, Math.min(1, lx * 0.5 * invExtent + 0.5));\r\n        const ny = Math.max(0, Math.min(1, ly * 0.5 * invExtent + 0.5));\r\n        const nz = Math.max(0, Math.min(1, lz * 0.5 * invExtent + 0.5));\r\n\r\n        lowPosArray[outPos] = ((nx * 65535 + 0.5) | 0);\r\n        lowPosArray[outPos + 1] = ((ny * 65535 + 0.5) | 0);\r\n        lowPosArray[outPos + 2] = ((nz * 65535 + 0.5) | 0);\r\n      }\r\n      lowQuatArray[outQuat] = qx;\r\n      lowQuatArray[outQuat + 1] = qy;\r\n      lowQuatArray[outQuat + 2] = qz;\r\n      lowQuatArray[outQuat + 3] = qw;\r\n      lowTailParamsArray[outTail] = tailSpeedValue;\r\n      lowTailParamsArray[outTail + 1] = tailTurnValue;\r\n      lowTailParamsArray[outTail + 2] = driveValue;\r\n      const seedValue = tailSeeds && i < tailSeeds.length ? tailSeeds[i] : 0;\r\n      lowTailPhaseArray[writeIndex] = seedValue;\r\n\r\n      this.lowInstanceToBoid[writeIndex] = i;\r\n      lowWrite++;\r\n\r\n      lowTransformTouched = true;\r\n      lowTailTouched = true;\r\n      lowTailPhaseTouched = true;\r\n    }\r\n\r\n    if (lodFlags) {\r\n      lodFlags[i] = isNear ? 1 : 2;\r\n    }\r\n\r\n    if (prevVel) {\r\n      prevVel[basePos] = vx;\r\n      prevVel[basePos + 1] = vy;\r\n      prevVel[basePos + 2] = vz;\r\n    }\r\n  }\r\n\r\n  const visibleCount = predatorCount > 0 ? Math.max(0, count - predatorCount) : count;\r\n\r\n  // High/Low \r\n  this.instancedMeshHigh.count = highWrite;\r\n  this.instancedMeshLow.count = lowWrite;\r\n\r\n  this.applyBufferSet(this.instancedMeshHigh, this.bufferSetHigh, currentIndex);\r\n  this.applyBufferSet(this.instancedMeshLow, this.bufferSetLow, currentIndex);\r\n\r\n  highPosAttr.needsUpdate = highTransformTouched;\r\n  highQuatAttr.needsUpdate = highTransformTouched;\r\n  lowPosAttr.needsUpdate = lowTransformTouched;\r\n  lowQuatAttr.needsUpdate = lowTransformTouched;\r\n  highTailParamsAttr.needsUpdate = highTailTouched;\r\n  lowTailParamsAttr.needsUpdate = lowTailTouched;\r\n  highTailPhaseAttr.needsUpdate = highTailPhaseTouched;\r\n  lowTailPhaseAttr.needsUpdate = lowTailPhaseTouched;\r\n\r\n  this.bufferCursor = nextIndex;\r\n\r\n  return {\r\n    visibleCount,\r\n    lodFlags,\r\n    highCount: highWrite,\r\n    lowCount: lowWrite,\r\n    highInstanceToBoid: this.highInstanceToBoid,\r\n    lowInstanceToBoid: this.lowInstanceToBoid,\r\n  };\r\n}\r\n\r\n  forEachInstancingMaterial(callback) {\r\n    for (const material of this.instancingMaterials) {\r\n      callback(material);\r\n    }\r\n  }\r\n\r\n  getMeshes() {\r\n    return {\r\n      high: this.instancedMeshHigh,\r\n      low: this.instancedMeshLow,\r\n    };\r\n  }\r\n\r\n  getPredatorMeshes() {\r\n    return this.predatorMeshes;\r\n  }\r\n\r\n  setTailUniformTime(time) {\r\n    if (!this.tailAnimation?.uniforms) return;\r\n    if (this.tailAnimation.uniforms.uTailTime) {\r\n      this.tailAnimation.uniforms.uTailTime.value = time;\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  uniform \r\n   */\r\n  patchMaterial(material) {\r\n    if (!material || material.userData?.instancingPatched) return;\r\n    const uniforms = this.tailAnimation?.uniforms;\r\n    if (!uniforms) {\r\n      console.warn('BoidInstancing.patchMaterial: tailAnimation.uniforms ');\r\n    }\r\n\r\n    material.onBeforeCompile = (shader) => {\r\n      if (uniforms) {\r\n        //  uniform \r\n        Object.entries(uniforms).forEach(([key, uniform]) => {\r\n          shader.uniforms[key] = uniform;\r\n        });\r\n      }\r\n\r\n      // instancePos  uniform\r\n      shader.uniforms.uInstanceOrigin = this.positionQuantUniforms.uInstanceOrigin;\r\n      shader.uniforms.uInstanceExtent = this.positionQuantUniforms.uInstanceExtent;\r\n\r\n      shader.vertexShader = shader.vertexShader\r\n        .replace(\r\n          '#include <common>',\r\n          `#include <common>\\nattribute vec3 instancePos;\\nattribute vec4 instanceQuat;\\nattribute float aBodyCoord;\\nattribute float instanceTailPhase;\\nattribute vec3 instanceTailParams;\\nuniform vec3 uInstanceOrigin;\\nuniform float uInstanceExtent;\\nuniform float uTailTime;\\nuniform float uTailAmplitude;\\nuniform float uTailFrequency;\\nuniform float uTailPhaseStride;\\nuniform float uTailTurnStrength;\\nuniform float uTailSpeedScale;\\nuniform vec3 uTailRight;\\nuniform vec3 uTailForward;\\nuniform vec3 uTailUp;\\nuniform float uTailEnable;\\nuniform sampler2D uSinLut;\\nuniform float uLutSize;\\nvec3 quatTransform(vec3 v, vec4 q) {\\n  vec3 t = 2.0 * cross(q.xyz, v);\\n  return v + q.w * t + cross(q.xyz, t);\\n}\\nvec3 decodeInstancePos(vec3 packed01) {\\n  // Uint16 normalized (0..1)  [-extent, extent] \r\n  vec3 local = (packed01 * 2.0 - 1.0) * uInstanceExtent;\\n  return uInstanceOrigin + local;\\n}\\nvec2 sampleSinCos(float angle) {\\n  float u = fract(angle * 0.15915494309189535);\\n  u = u * (uLutSize - 1.0) + 0.5;\\n  vec4 lutSample = texture(uSinLut, vec2(u / uLutSize, 0.5));\\n  return lutSample.rg * 2.0 - 1.0;\\n}`\r\n        )\r\n        .replace(\r\n          '#include <instancing_vertex>',\r\n          `#ifdef USE_INSTANCING\r\n#endif\r\n#ifdef USE_INSTANCING_COLOR\r\n  vColor.xyz *= instanceColor.xyz;\r\n#endif`\r\n        )\r\n        .replace(\r\n          '#include <begin_vertex>',\r\n          `#include <begin_vertex>\\nvec3 tailParams = instanceTailParams;\\nif (uTailEnable > 0.5) {\\n  float driveRaw = tailParams.z;\\n  if (driveRaw > 0.01) {\\n    float drive = clamp(driveRaw, 0.0, 1.0);\\n    vec3 originalPos = transformed;\\n    vec3 right = normalize(uTailRight);\\n    vec3 forward = normalize(uTailForward);\\n    vec3 up = normalize(uTailUp);\\n\\n    float localX = dot(originalPos, right);\\n    float localY = dot(originalPos, forward);\\n    float localZ = dot(originalPos, up);\\n\\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\\n\\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\\n    vec2 waveSC = sampleSinCos(wavePhase);\\n    float wag = waveSC.x * uTailAmplitude * drive;\\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\\n\\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\\n\\n    float bendAngle = motion * bendStrength;\\n    vec2 bendSC = sampleSinCos(bendAngle);\\n    float s = bendSC.x;\\n    float c = bendSC.y;\\n    float rotX = localX * c - localY * s;\\n    float rotY = localX * s + localY * c;\\n\\n    float sway = motion * 0.4 * tipDamping;\\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\\n\\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\\n    transformed = rotated;\\n  }\\n}\\ntransformed = quatTransform(transformed, instanceQuat) + decodeInstancePos(instancePos);`\r\n        )\r\n        .replace(\r\n          '#include <beginnormal_vertex>',\r\n          '#include <beginnormal_vertex>\\nobjectNormal = quatTransform(objectNormal, instanceQuat);'\r\n        )\r\n        .replace(\r\n          '#include <project_vertex>',\r\n          `#include <project_vertex>\\n#ifdef DEPTH_PACKING\\nvec3 tailParams = instanceTailParams;\\nif (uTailEnable > 0.5) {\\n  float driveRaw = tailParams.z;\\n  if (driveRaw > 0.01) {\\n    float drive = clamp(driveRaw, 0.0, 1.0);\\n    vec3 viewPos = mvPosition.xyz;\\n    mat3 normalMatrix3 = mat3(normalMatrix);\\n    vec3 right = normalize(normalMatrix3 * uTailRight);\\n    vec3 forward = normalize(normalMatrix3 * uTailForward);\\n    vec3 up = normalize(normalMatrix3 * uTailUp);\\n\\n    float localX = dot(viewPos, right);\\n    float localY = dot(viewPos, forward);\\n    float localZ = dot(viewPos, up);\\n\\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\\n\\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\\n    vec2 waveSC = sampleSinCos(wavePhase);\\n    float wag = waveSC.x * uTailAmplitude * drive;\\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\\n\\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\\n\\n    float bendAngle = motion * bendStrength;\\n    vec2 bendSC = sampleSinCos(bendAngle);\\n    float s = bendSC.x;\\n    float c = bendSC.y;\\n    float rotX = localX * c - localY * s;\\n    float rotY = localX * s + localY * c;\\n\\n    float sway = motion * 0.4 * tipDamping;\\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\\n\\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\\n    mvPosition.xyz = rotated;\\n    gl_Position = projectionMatrix * mvPosition;\\n  }\\n}\\n#endif`\r\n        );\r\n\r\n      material.userData = {\r\n        ...(material.userData || {}),\r\n        instancingPatched: true,\r\n      };\r\n    };\r\n\r\n    material.needsUpdate = true;\r\n    this.instancingMaterials.add(material);\r\n  }\r\n\r\n  createDepthMaterial(sourceMaterial) {\r\n    const depthMaterial = new THREE.MeshDepthMaterial({\r\n      depthPacking: THREE.RGBADepthPacking,\r\n      alphaTest: sourceMaterial.alphaTest ?? 0,\r\n    });\r\n    depthMaterial.map = sourceMaterial.map ?? null;\r\n    depthMaterial.alphaMap = sourceMaterial.alphaMap ?? null;\r\n    depthMaterial.transparent = sourceMaterial.transparent ?? false;\r\n    this.patchMaterial(depthMaterial);\r\n    return depthMaterial;\r\n  }\r\n\r\n  createDistanceMaterial(sourceMaterial) {\r\n    const distanceMaterial = new THREE.MeshDistanceMaterial({\r\n      alphaTest: sourceMaterial.alphaTest ?? 0,\r\n    });\r\n    distanceMaterial.map = sourceMaterial.map ?? null;\r\n    distanceMaterial.alphaMap = sourceMaterial.alphaMap ?? null;\r\n    distanceMaterial.transparent = sourceMaterial.transparent ?? false;\r\n    this.patchMaterial(distanceMaterial);\r\n    return distanceMaterial;\r\n  }\r\n\r\n  configureInstancedMesh(mesh, material) {\r\n    mesh.castShadow = true;\r\n    mesh.receiveShadow = true;\r\n    mesh.frustumCulled = false;\r\n    mesh.customDepthMaterial = this.createDepthMaterial(material);\r\n    mesh.customDistanceMaterial = this.createDistanceMaterial(material);\r\n\r\n    const white = new THREE.Color(1, 1, 1);\r\n    for (let i = 0; i < mesh.count; i++) {\r\n      mesh.setColorAt(i, white);\r\n    }\r\n    if (mesh.instanceColor) {\r\n      mesh.instanceColor.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  createAttributeSet(count, itemSize, ArrayType = Float32Array) {\r\n    const length = count * itemSize;\r\n    const attributes = [];\r\n    for (let i = 0; i < this.tripleBufferSize; i++) {\r\n      const attr = new THREE.InstancedBufferAttribute(new ArrayType(length), itemSize);\r\n      attr.setUsage(this.streamUsage);\r\n      attributes.push(attr);\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  createNormalizedAttributeSet(count, itemSize, ArrayType) {\r\n    const length = count * itemSize;\r\n    const attributes = [];\r\n    for (let i = 0; i < this.tripleBufferSize; i++) {\r\n      const attr = new THREE.InstancedBufferAttribute(new ArrayType(length), itemSize, true);\r\n      attr.setUsage(this.streamUsage);\r\n      attributes.push(attr);\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  createBufferSet(count) {\r\n    return {\r\n      // instancePos  Uint16 normalized (0..1) \r\n      pos: this.createNormalizedAttributeSet(count, 3, Uint16Array),\r\n      quat: this.createAttributeSet(count, 4),\r\n      tailPhase: this.createAttributeSet(count, 1),\r\n      tailParams: this.createAttributeSet(count, 3),\r\n    };\r\n  }\r\n\r\n  resetBufferSetToHidden(bufferSet) {\r\n    // \r\n    for (const attr of bufferSet.pos) {\r\n      const array = attr.array;\r\n      // Uint16 normalized mesh.count=0\r\n      array.fill(0);\r\n    }\r\n    for (const attr of bufferSet.quat) {\r\n      const array = attr.array;\r\n      for (let i = 0; i < array.length; i += 4) {\r\n        array[i] = this.identityQuaternion[0];\r\n        array[i + 1] = this.identityQuaternion[1];\r\n        array[i + 2] = this.identityQuaternion[2];\r\n        array[i + 3] = this.identityQuaternion[3];\r\n      }\r\n    }\r\n    for (const attr of bufferSet.tailPhase) {\r\n      attr.array.fill(0);\r\n    }\r\n    for (const attr of bufferSet.tailParams) {\r\n      attr.array.fill(0);\r\n    }\r\n  }\r\n\r\n  applyBufferSet(mesh, bufferSet, index) {\r\n    mesh.geometry.setAttribute('instancePos', bufferSet.pos[index]);\r\n    mesh.geometry.setAttribute('instanceQuat', bufferSet.quat[index]);\r\n    mesh.geometry.setAttribute('instanceTailPhase', bufferSet.tailPhase[index]);\r\n    mesh.geometry.setAttribute('instanceTailParams', bufferSet.tailParams[index]);\r\n  }\r\n\r\n  createTailPhaseArray(count) {\r\n    const array = new Float32Array(count);\r\n    for (let i = 0; i < count; i++) {\r\n      array[i] = Math.random() * Math.PI * 2;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  applyTailPhaseSeeds(bufferSet, seeds) {\r\n    if (!bufferSet?.tailPhase) return;\r\n    for (const attr of bufferSet.tailPhase) {\r\n      attr.array.set(seeds);\r\n      attr.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  ensureTailRuntimeBuffers(count) {\r\n    const targetLength = count * 3;\r\n    if (!this.previousVelocities || this.previousVelocities.length !== targetLength) {\r\n      this.previousVelocities = new Float32Array(targetLength);\r\n    }\r\n  }\r\n\r\n  ensureLodFlagBuffer(count) {\r\n    if (count <= 0) {\r\n      this.previousLodFlags = null;\r\n      return null;\r\n    }\r\n    if (!this.previousLodFlags || this.previousLodFlags.length !== count) {\r\n      this.previousLodFlags = new Uint8Array(count);\r\n    }\r\n    return this.previousLodFlags;\r\n  }\r\n\r\n  ensureTailSeedCapacity(count) {\r\n    if (count <= 0) {\r\n      return;\r\n    }\r\n    const currentLength = this.tailPhaseSeeds ? this.tailPhaseSeeds.length : 0;\r\n    if (!this.tailPhaseSeeds || currentLength < count) {\r\n      const next = new Float32Array(count);\r\n      if (this.tailPhaseSeeds && currentLength > 0) {\r\n        next.set(this.tailPhaseSeeds.subarray(0, currentLength));\r\n      }\r\n      for (let i = currentLength; i < count; i++) {\r\n        next[i] = Math.random() * Math.PI * 2;\r\n      }\r\n      this.tailPhaseSeeds = next;\r\n    }\r\n  }\r\n\r\n  ensureBodyCoordAttribute(geometry) {\r\n    if (geometry.getAttribute('aBodyCoord')) return;\r\n    const position = geometry.getAttribute('position');\r\n    if (!position) return;\r\n\r\n    const count = position.count;\r\n    const array = position.array;\r\n    let minX = Infinity;\r\n    let minY = Infinity;\r\n    let minZ = Infinity;\r\n    let maxX = -Infinity;\r\n    let maxY = -Infinity;\r\n    let maxZ = -Infinity;\r\n\r\n    for (let i = 0; i < count; i++) {\r\n      const ix = i * 3;\r\n      const x = array[ix];\r\n      const y = array[ix + 1];\r\n      const z = array[ix + 2];\r\n      if (x < minX) minX = x;\r\n      if (x > maxX) maxX = x;\r\n      if (y < minY) minY = y;\r\n      if (y > maxY) maxY = y;\r\n      if (z < minZ) minZ = z;\r\n      if (z > maxZ) maxZ = z;\r\n    }\r\n\r\n    const rangeX = maxX - minX;\r\n    const rangeY = maxY - minY;\r\n    const rangeZ = maxZ - minZ;\r\n\r\n    let axis = 'z';\r\n    let min = minZ;\r\n    let range = rangeZ;\r\n    if (rangeX > rangeY && rangeX > rangeZ) {\r\n      axis = 'x';\r\n      min = minX;\r\n      range = rangeX;\r\n    } else if (rangeY > rangeZ) {\r\n      axis = 'y';\r\n      min = minY;\r\n      range = rangeY;\r\n    }\r\n\r\n    const bodyCoord = new Float32Array(count);\r\n    const denom = range > 0 ? range : 1;\r\n    for (let i = 0; i < count; i++) {\r\n      const ix = i * 3;\r\n      const value = axis === 'x' ? array[ix] : axis === 'y' ? array[ix + 1] : array[ix + 2];\r\n      bodyCoord[i] = (value - min) / denom;\r\n    }\r\n\r\n    //  0-1 \r\n    geometry.setAttribute('aBodyCoord', new THREE.BufferAttribute(bodyCoord, 1));\r\n  }\r\n\r\n  ensurePredatorMeshes(count) {\r\n    if (!this.scene || !this.predatorModel) return false;\r\n\r\n    const target = Math.max(0, count);\r\n    while (this.predatorMeshes.length > target) {\r\n      const mesh = this.predatorMeshes.pop();\r\n      if (mesh) {\r\n        this.scene.remove(mesh);\r\n      }\r\n    }\r\n\r\n    while (this.predatorMeshes.length < target) {\r\n      const clone = this.predatorModel.clone(true);\r\n      clone.traverse((child) => {\r\n        if (child.isMesh) {\r\n          child.castShadow = true;\r\n          child.receiveShadow = true;\r\n        }\r\n      });\r\n      clone.visible = false;\r\n      this.scene.add(clone);\r\n      this.predatorMeshes.push(clone);\r\n    }\r\n    return this.predatorMeshes.length === target;\r\n  }\r\n\r\n  dispose(scene = this.scene) {\r\n    if (this.instancedMeshHigh) {\r\n      scene?.remove(this.instancedMeshHigh);\r\n      this.instancedMeshHigh.geometry?.dispose?.();\r\n      this.instancedMeshHigh.material?.dispose?.();\r\n      this.instancedMeshHigh = null;\r\n    }\r\n    if (this.instancedMeshLow) {\r\n      scene?.remove(this.instancedMeshLow);\r\n      this.instancedMeshLow.geometry?.dispose?.();\r\n      this.instancedMeshLow.material?.dispose?.();\r\n      this.instancedMeshLow = null;\r\n    }\r\n    if (scene) {\r\n      for (const mesh of this.predatorMeshes) {\r\n        scene.remove(mesh);\r\n      }\r\n    }\r\n    this.instancingMaterials.clear();\r\n    this.bufferSetHigh = null;\r\n    this.bufferSetLow = null;\r\n    this.tailPhaseSeeds = null;\r\n    this.bufferCursor = 0;\r\n    this.previousVelocities = null;\r\n    this.previousLodFlags = null;\r\n    this.predatorMeshes = [];\r\n    this.predatorMeshCountCache = -1;\r\n    this.scene = scene ?? null;\r\n    this.count = 0;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';\r\nimport { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';\r\nimport { SSAOPass } from 'three/examples/jsm/postprocessing/SSAOPass.js';\r\nimport { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass.js';\r\nimport { ShaderPass } from 'three/examples/jsm/postprocessing/ShaderPass.js';\r\n\r\n/**\r\n * \r\n * Three.js  EffectComposer \r\n * \r\n */\r\nexport class FogPipeline {\r\n  constructor(fogConfig) {\r\n    this.config = fogConfig;\r\n    this.composer = null;\r\n    this.heightFogPass = null;\r\n    this.heightFogRenderTarget = null;\r\n    this.renderer = null;\r\n    this.scene = null;\r\n    this.camera = null;\r\n\r\n    //  GPU \r\n    // Fog/SSAO/Bloom\r\n    this.internalScale = 0.75;\r\n  }\r\n\r\n  /** HeightFog  ShaderPass  */\r\n  get heightFog() {\r\n    return this.heightFogPass;\r\n  }\r\n\r\n  /**\r\n   * \r\n   *  +  HeightFogShader \r\n   */\r\n  init(renderer, scene, camera, width, height) {\r\n    if (!renderer || !scene || !camera) {\r\n      console.warn('FogPipeline.init: renderer / scene / camera ');\r\n      return;\r\n    }\r\n\r\n    this.dispose();\r\n\r\n    this.renderer = renderer;\r\n    this.scene = scene;\r\n    this.camera = camera;\r\n\r\n    const scale = Math.max(0.25, Math.min(Number(this.internalScale) || 1.0, 1.0));\r\n    const scaledWidth = Math.max(1, Math.floor(width * scale));\r\n    const scaledHeight = Math.max(1, Math.floor(height * scale));\r\n\r\n    // fog \r\n    const rtOptions = { depthBuffer: true, stencilBuffer: false };\r\n    this.heightFogRenderTarget = new THREE.WebGLRenderTarget(scaledWidth, scaledHeight, rtOptions);\r\n    // Fog \r\n    // Float /\r\n    this.heightFogRenderTarget.depthTexture = new THREE.DepthTexture(scaledWidth, scaledHeight, THREE.UnsignedIntType);\r\n    this.heightFogRenderTarget.depthTexture.format = THREE.DepthFormat;\r\n    this.heightFogRenderTarget.depthTexture.type = THREE.UnsignedIntType;\r\n    this.heightFogRenderTarget.depthTexture.needsUpdate = true;\r\n\r\n    this.composer = new EffectComposer(renderer, this.heightFogRenderTarget);\r\n\r\n    // \r\n    const renderPass = new RenderPass(scene, camera);\r\n    this.composer.addPass(renderPass);\r\n\r\n    //  SSAO\r\n    const ssaoPass = new SSAOPass(scene, camera, scaledWidth, scaledHeight);\r\n    ssaoPass.kernelRadius = 5;     //  AO\r\n    ssaoPass.minDistance = 0.01;   // \r\n    ssaoPass.maxDistance = 0.3;    // \r\n    this.composer.addPass(ssaoPass);\r\n\r\n    // \r\n    const bloomStrength = 4.5;   // \r\n    const bloomRadius = 0.1;     // \r\n    const bloomThreshold = 0.83; // \r\n    const bloomPass = new UnrealBloomPass(new THREE.Vector2(scaledWidth, scaledHeight), bloomStrength, bloomRadius, bloomThreshold);\r\n    this.composer.addPass(bloomPass);\r\n\r\n    const shader = createHeightFogShader(this.config);\r\n    this.heightFogPass = new ShaderPass(shader);\r\n    // \r\n    const originalRender = this.heightFogPass.render.bind(this.heightFogPass);\r\n    this.heightFogPass.render = (passRenderer, writeBuffer, readBuffer, deltaTime, maskActive) => {\r\n      if (this.heightFogPass.uniforms.tDepth) {\r\n        const depthTexture = readBuffer?.depthTexture ?? this.heightFogRenderTarget?.depthTexture ?? null;\r\n        if (depthTexture) {\r\n          this.heightFogPass.uniforms.tDepth.value = depthTexture;\r\n        }\r\n      }\r\n      originalRender(passRenderer, writeBuffer, readBuffer, deltaTime, maskActive);\r\n    };\r\n    this.heightFogPass.needsSwap = false;\r\n    this.heightFogPass.uniforms.tDepth.value = this.heightFogRenderTarget.depthTexture;\r\n\r\n    applyFogConfigToUniforms(this.heightFogPass.uniforms, this.config);\r\n\r\n    const material = this.heightFogPass.material;\r\n    if (material) {\r\n      material.depthTest = false;\r\n      material.depthWrite = false;\r\n      material.transparent = false;\r\n      material.blending = THREE.NoBlending;\r\n      // RenderPass \r\n      material.toneMapped = false;\r\n      material.needsUpdate = true;\r\n    }\r\n\r\n    this.heightFogPass.renderToScreen = true;\r\n    this.composer.addPass(this.heightFogPass);\r\n  }\r\n\r\n  /**  */\r\n  resize(width, height) {\r\n    if (!this.composer) {\r\n      return;\r\n    }\r\n    const scale = Math.max(0.25, Math.min(Number(this.internalScale) || 1.0, 1.0));\r\n    const scaledWidth = Math.max(1, Math.floor(width * scale));\r\n    const scaledHeight = Math.max(1, Math.floor(height * scale));\r\n    this.composer.setSize(scaledWidth, scaledHeight);\r\n    this.heightFogRenderTarget?.setSize(scaledWidth, scaledHeight);\r\n  }\r\n\r\n  /** composer  */\r\n  render(delta) {\r\n    if (!this.composer) {\r\n      return;\r\n    }\r\n\r\n    // NOTE: toneMapping / exposure renderer \r\n    // HeightFogShader \r\n    this.composer.render(delta);\r\n  }\r\n\r\n  /** composer  */\r\n  isReady() {\r\n    return !!this.composer;\r\n  }\r\n\r\n  /**  */\r\n  updateCameraUniforms(camera) {\r\n    const pass = this.heightFogPass;\r\n    const targetCamera = camera || this.camera;\r\n    if (!pass || !targetCamera) {\r\n      return;\r\n    }\r\n    const { uniforms } = pass;\r\n\r\n    // renderer \r\n    if (uniforms.uExposure) {\r\n      const exposure = Number(this.renderer?.toneMappingExposure);\r\n      uniforms.uExposure.value = Number.isFinite(exposure) ? exposure : 1.0;\r\n    }\r\n\r\n    if (uniforms.cameraNear) {\r\n      uniforms.cameraNear.value = targetCamera.near;\r\n    }\r\n    if (uniforms.cameraFar) {\r\n      uniforms.cameraFar.value = targetCamera.far;\r\n    }\r\n    if (uniforms.projectionMatrixInverse?.value) {\r\n      uniforms.projectionMatrixInverse.value.copy(targetCamera.projectionMatrixInverse);\r\n    }\r\n    if (uniforms.cameraMatrixWorld?.value) {\r\n      uniforms.cameraMatrixWorld.value.copy(targetCamera.matrixWorld);\r\n    }\r\n  }\r\n\r\n  /**  */\r\n  updateConfig(nextConfig = {}) {\r\n    this.config = { ...this.config, ...nextConfig };\r\n    if (!this.heightFogPass) {\r\n      return;\r\n    }\r\n    applyFogConfigToUniforms(this.heightFogPass.uniforms, this.config);\r\n  }\r\n\r\n  /**  */\r\n  dispose() {\r\n    // HeightFog LUT\r\n    // composer/material \r\n    const lut = this.heightFogPass?.uniforms?.tDistanceCurveLut?.value ?? null;\r\n    if (lut && typeof lut.dispose === 'function') {\r\n      lut.dispose();\r\n    }\r\n    this.heightFogPass = null;\r\n    this.composer?.dispose?.();\r\n    this.composer = null;\r\n    this.heightFogRenderTarget?.dispose?.();\r\n    this.heightFogRenderTarget = null;\r\n    this.renderer = null;\r\n    this.scene = null;\r\n    this.camera = null;\r\n  }\r\n}\r\n\r\n/**\r\n * HeightFogShader \r\n */\r\nexport function createHeightFogShader(config = {}) {\r\n  const defaults = buildFogDefaults();\r\n  const finalConfig = { ...defaults, ...config };\r\n\r\n  // \r\n  // LUT1GPU\r\n  const distanceCurveLut = createOrUpdateDistanceCurveLutTexture(\r\n    null,\r\n    cloneVector2(finalConfig.distanceControlPoint1),\r\n    cloneVector2(finalConfig.distanceControlPoint2)\r\n  );\r\n\r\n  return {\r\n    uniforms: {\r\n      tDiffuse: { value: null },\r\n      tDepth: { value: null },\r\n      tDistanceCurveLut: { value: distanceCurveLut },\r\n      // renderer toneMappingExposure\r\n      // NOTE: \r\n      uExposure: { value: 1.0 },\r\n      cameraNear: { value: 0.1 },\r\n      cameraFar: { value: 1000 },\r\n      projectionMatrixInverse: { value: new THREE.Matrix4() },\r\n      cameraMatrixWorld: { value: new THREE.Matrix4() },\r\n      fogColor: { value: cloneColor(finalConfig.color) },                     // \r\n      distanceStart: { value: finalConfig.distanceStart },                   // \r\n      distanceEnd: { value: finalConfig.distanceEnd },                       // \r\n      distanceExponent: { value: finalConfig.distanceExponent },             // \r\n      // NOTE: JSLUT\r\n      surfaceLevel: { value: finalConfig.surfaceLevel },                     // y\r\n      heightFalloff: { value: finalConfig.heightFalloff },                   // \r\n      heightExponent: { value: finalConfig.heightExponent },                 // \r\n      maxOpacity: { value: finalConfig.maxOpacity },                         // \r\n    },\r\n    vertexShader: /* glsl */`\r\n    varying vec2 vUv;\r\n    void main() {\r\n      vUv = uv;\r\n      gl_Position = vec4(position.xy, 0.0, 1.0);\r\n    }\r\n  `,\r\n    fragmentShader: /* glsl */`\r\n    precision highp float;\r\n    varying vec2 vUv;\r\n\r\n    uniform sampler2D tDiffuse;\r\n    uniform sampler2D tDepth;\r\n    uniform sampler2D tDistanceCurveLut;\r\n    uniform float uExposure;\r\n    uniform float cameraNear;\r\n    uniform float cameraFar;\r\n    uniform vec3 fogColor;\r\n    uniform float distanceStart;\r\n    uniform float distanceEnd;\r\n    uniform float distanceExponent;\r\n    uniform float surfaceLevel;\r\n    uniform float heightFalloff;\r\n    uniform float heightExponent;\r\n    uniform float maxOpacity;\r\n    uniform mat4 projectionMatrixInverse;\r\n    uniform mat4 cameraMatrixWorld;\r\n\r\n    float sampleDistanceCurve(float x) {\r\n      // 256x1 LUTLinearFilter\r\n      float u = clamp(x, 0.0, 1.0);\r\n      return texture2D(tDistanceCurveLut, vec2(u, 0.5)).r;\r\n    }\r\n\r\n\r\n    void main() {\r\n      vec4 baseColor = texture2D(tDiffuse, vUv);\r\n      float depth = texture2D(tDepth, vUv).x;\r\n\r\n      if (depth >= 1.0) {\r\n        gl_FragColor = baseColor;\r\n        return;\r\n      }\r\n\r\n      vec2 ndc = vUv * 2.0 - 1.0;\r\n      float ndcZ = depth * 2.0 - 1.0;\r\n      vec4 clipPos = vec4(ndc, ndcZ, 1.0);\r\n      vec4 viewPos = projectionMatrixInverse * clipPos;\r\n      viewPos /= max(viewPos.w, 1e-5);\r\n      // height fog  world-space  Y=\r\n      // vec4 Y  ALU \r\n      float worldY =\r\n        cameraMatrixWorld[0][1] * viewPos.x +\r\n        cameraMatrixWorld[1][1] * viewPos.y +\r\n        cameraMatrixWorld[2][1] * viewPos.z +\r\n        cameraMatrixWorld[3][1] * viewPos.w;\r\n\r\n      // Fog \r\n      // sqrt(length) \r\n      float viewDistance = abs(viewPos.z);\r\n\r\n      // distanceStart \r\n      // NOTE: \r\n      // start\r\n      if (viewDistance <= distanceStart) {\r\n        gl_FragColor = baseColor;\r\n        #include <colorspace_fragment>\r\n        return;\r\n      }\r\n\r\n      float distanceFogNorm = clamp(\r\n        (viewDistance - distanceStart) / max(distanceEnd - distanceStart, 1e-5),\r\n        0.0,\r\n        1.0\r\n      );\r\n      float distanceFog = sampleDistanceCurve(distanceFogNorm);\r\n      distanceFog = pow(distanceFog, distanceExponent);\r\n\r\n      float depthBelowSurface = max(surfaceLevel - worldY, 0.0);\r\n      float heightFactor = 1.0 - exp(-depthBelowSurface * heightFalloff);\r\n      heightFactor = clamp(pow(heightFactor, heightExponent), 0.0, 1.0);\r\n\r\n      // ()\r\n      // \r\n      float heightDistanceFade = smoothstep(distanceStart, distanceStart + 10.0, viewDistance);\r\n      heightFactor *= heightDistanceFade;\r\n\r\n      float fogFactor = clamp(distanceFog * heightFactor, 0.0, 1.0);\r\n      fogFactor = mix(0.0, maxOpacity, fogFactor);\r\n\r\n      // /\r\n      // \r\n      float luma = dot(baseColor.rgb, vec3(0.2126, 0.7152, 0.0722));\r\n      float highlightMask = smoothstep(0.6, 1.2, luma);\r\n      fogFactor *= mix(1.0, 0.35, highlightMask);\r\n\r\n      // RenderPass\r\n      // fogColor \r\n      vec3 fogTarget = fogColor * uExposure;\r\n      vec3 fogged = mix(baseColor.rgb, fogTarget, fogFactor);\r\n      gl_FragColor = vec4(fogged, baseColor.a);\r\n      #include <colorspace_fragment>\r\n    }\r\n  `,\r\n  };\r\n}\r\n\r\nexport const HeightFogShader = createHeightFogShader();\r\n\r\nfunction buildFogDefaults() {\r\n  return {\r\n    color: new THREE.Color('#153a6c'),                // \r\n    distanceStart: 2,                                 // \r\n    distanceEnd: 5,                                  // \r\n    distanceExponent: 0.4,                            // \r\n    distanceControlPoint1: new THREE.Vector2(0.4, 0.75), // \r\n    distanceControlPoint2: new THREE.Vector2(0.75, 0.95), // \r\n    surfaceLevel: 100,                                //  World Y \r\n    heightFalloff: 0.01,                              // \r\n    heightExponent: 1,                                // \r\n    maxOpacity: 1,                                    // \r\n  };\r\n}\r\n\r\nfunction cloneColor(value) {\r\n  if (value instanceof THREE.Color) {\r\n    return value.clone();\r\n  }\r\n  if (typeof value === 'string' || typeof value === 'number') {\r\n    return new THREE.Color(value);\r\n  }\r\n  return new THREE.Color('#000000');\r\n}\r\n\r\nfunction cloneVector2(value) {\r\n  if (value instanceof THREE.Vector2) {\r\n    return value.clone();\r\n  }\r\n  if (value && typeof value.x === 'number' && typeof value.y === 'number') {\r\n    return new THREE.Vector2(value.x, value.y);\r\n  }\r\n  return new THREE.Vector2();\r\n}\r\n\r\nfunction applyFogConfigToUniforms(uniforms, config = {}) {\r\n  const defaults = buildFogDefaults();\r\n  const finalConfig = { ...defaults, ...config };\r\n\r\n  if (uniforms.fogColor?.value) {\r\n    uniforms.fogColor.value.copy(cloneColor(finalConfig.color));\r\n  }\r\n  if (uniforms.distanceStart) {\r\n    uniforms.distanceStart.value = finalConfig.distanceStart;\r\n  }\r\n  if (uniforms.distanceEnd) {\r\n    uniforms.distanceEnd.value = finalConfig.distanceEnd;\r\n  }\r\n  if (uniforms.distanceExponent) {\r\n    uniforms.distanceExponent.value = finalConfig.distanceExponent;\r\n  }\r\n  if (uniforms.tDistanceCurveLut) {\r\n    uniforms.tDistanceCurveLut.value = createOrUpdateDistanceCurveLutTexture(\r\n      uniforms.tDistanceCurveLut.value,\r\n      cloneVector2(finalConfig.distanceControlPoint1),\r\n      cloneVector2(finalConfig.distanceControlPoint2)\r\n    );\r\n  }\r\n  if (uniforms.surfaceLevel) {\r\n    uniforms.surfaceLevel.value = finalConfig.surfaceLevel;\r\n  }\r\n  if (uniforms.heightFalloff) {\r\n    uniforms.heightFalloff.value = finalConfig.heightFalloff;\r\n  }\r\n  if (uniforms.heightExponent) {\r\n    uniforms.heightExponent.value = finalConfig.heightExponent;\r\n  }\r\n  if (uniforms.maxOpacity) {\r\n    uniforms.maxOpacity.value = finalConfig.maxOpacity;\r\n  }\r\n}\r\n\r\n// ---- Distance curve LUT ----\r\n// xyNewton\r\n// JS256LUT\r\nfunction createOrUpdateDistanceCurveLutTexture(existingTexture, controlPoint1, controlPoint2) {\r\n  const size = 256;\r\n  const needsNew = !existingTexture ||\r\n    !(existingTexture instanceof THREE.DataTexture) ||\r\n    existingTexture.image?.width !== size ||\r\n    existingTexture.image?.height !== 1;\r\n\r\n  const c1 = controlPoint1 instanceof THREE.Vector2 ? controlPoint1 : new THREE.Vector2();\r\n  const c2 = controlPoint2 instanceof THREE.Vector2 ? controlPoint2 : new THREE.Vector2();\r\n\r\n  // GPU\r\n  const last = existingTexture?.userData?.distanceCurveLut ?? null;\r\n  const same = last &&\r\n    last.c1x === c1.x && last.c1y === c1.y &&\r\n    last.c2x === c2.x && last.c2y === c2.y;\r\n  if (!needsNew && same) {\r\n    return existingTexture;\r\n  }\r\n\r\n  const data = needsNew ? new Uint8Array(size * 4) : existingTexture.image.data;\r\n\r\n  // cubic-bezier(0,0) -> (c1) -> (c2) -> (1,1)\r\n  const bezier1D = (t, p0, p1, p2, p3) => {\r\n    const u = 1 - t;\r\n    const uu = u * u;\r\n    const tt = t * t;\r\n    return u * uu * p0 + 3 * uu * t * p1 + 3 * u * tt * p2 + tt * t * p3;\r\n  };\r\n  const bezierDerivative1D = (t, p0, p1, p2, p3) => {\r\n    const u = 1 - t;\r\n    return 3 * u * u * (p1 - p0) + 6 * u * t * (p2 - p1) + 3 * t * t * (p3 - p2);\r\n  };\r\n\r\n  // xtNewtony\r\n  for (let i = 0; i < size; i += 1) {\r\n    const x = i / (size - 1);\r\n    let t = x;\r\n    for (let iter = 0; iter < 5; iter += 1) {\r\n      const current = bezier1D(t, 0, c1.x, c2.x, 1) - x;\r\n      const slope = bezierDerivative1D(t, 0, c1.x, c2.x, 1);\r\n      if (Math.abs(slope) < 1e-5) {\r\n        break;\r\n      }\r\n      t = Math.min(1, Math.max(0, t - current / slope));\r\n    }\r\n    const y = bezier1D(t, 0, c1.y, c2.y, 1);\r\n    const v = Math.min(255, Math.max(0, Math.round(y * 255)));\r\n    const base = i * 4;\r\n    data[base + 0] = v;\r\n    data[base + 1] = v;\r\n    data[base + 2] = v;\r\n    data[base + 3] = 255;\r\n  }\r\n\r\n  const texture = needsNew\r\n    ? new THREE.DataTexture(data, size, 1, THREE.RGBAFormat, THREE.UnsignedByteType)\r\n    : existingTexture;\r\n\r\n  texture.wrapS = THREE.ClampToEdgeWrapping;\r\n  texture.wrapT = THREE.ClampToEdgeWrapping;\r\n  texture.minFilter = THREE.LinearFilter;\r\n  texture.magFilter = THREE.LinearFilter;\r\n  texture.generateMipmaps = false;\r\n  texture.needsUpdate = true;\r\n  texture.userData.distanceCurveLut = { c1x: c1.x, c1y: c1.y, c2x: c2.x, c2y: c2.y };\r\n\r\n  return texture;\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * \r\n * - \r\n * - SSAO/Bloom \r\n * - /\r\n */\r\nexport class LightRaysOverlay {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      color: options.color ?? new THREE.Color('#4fbaff'),\r\n      intensity: Number.isFinite(options.intensity) ? options.intensity : 0.14,\r\n      rayDensity: Number.isFinite(options.rayDensity) ? options.rayDensity : 7.0,\r\n      raySoftness: Number.isFinite(options.raySoftness) ? options.raySoftness : 0.30,\r\n      speed: Number.isFinite(options.speed) ? options.speed : 0.07,\r\n\r\n      // \r\n      planeCount: Number.isFinite(options.planeCount) ? Math.floor(options.planeCount) : 7,\r\n      planeWidth: Number.isFinite(options.planeWidth) ? options.planeWidth : 120.0,\r\n      planeHeight: Number.isFinite(options.planeHeight) ? options.planeHeight : 220.0,\r\n      // \r\n      placementRadius: Number.isFinite(options.placementRadius) ? options.placementRadius : 90.0,\r\n      // \r\n      topOffsetY: Number.isFinite(options.topOffsetY) ? options.topOffsetY : 70.0,\r\n    };\r\n\r\n    this.scene = null;\r\n    this.material = null;\r\n    this.meshes = [];\r\n\r\n    // GC\r\n    this.anchor = new THREE.Vector3(0, 0, 0);\r\n    this.anchorSmoothed = new THREE.Vector3(0, 0, 0);\r\n    this.tmp = new THREE.Vector3();\r\n\r\n    this.timeSeconds = 0.0;\r\n  }\r\n\r\n  /** renderer 1 */\r\n  init() {\r\n    this.dispose();\r\n\r\n    this.scene = new THREE.Scene();\r\n\r\n    const planeCount = Math.max(1, Math.min(this.options.planeCount, 16));\r\n    const geometry = new THREE.PlaneGeometry(this.options.planeWidth, this.options.planeHeight, 1, 1);\r\n    this.material = new THREE.ShaderMaterial({\r\n      uniforms: {\r\n        uTime: { value: 0.0 },\r\n        uIntensity: { value: this.options.intensity },\r\n        uColor: { value: this.options.color.clone() },\r\n        uRayDensity: { value: this.options.rayDensity },\r\n        uRaySoftness: { value: this.options.raySoftness },\r\n        // \r\n        uSeed: { value: 0.0 },\r\n      },\r\n      vertexShader: /* glsl */`\r\n        varying vec2 vUv;\r\n        varying float vSeed;\r\n        uniform float uSeed;\r\n        void main() {\r\n          vUv = uv;\r\n          vSeed = uSeed;\r\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n        }\r\n      `,\r\n      fragmentShader: /* glsl */`\r\n        precision highp float;\r\n        varying vec2 vUv;\r\n        varying float vSeed;\r\n\r\n        uniform float uTime;\r\n        uniform float uIntensity;\r\n        uniform vec3 uColor;\r\n        uniform float uRayDensity;\r\n        uniform float uRaySoftness;\r\n\r\n        float hash12(vec2 p) {\r\n          // \r\n          vec3 p3 = fract(vec3(p.xyx) * 0.1031);\r\n          p3 += dot(p3, p3.yzx + 33.33);\r\n          return fract((p3.x + p3.y) * p3.z);\r\n        }\r\n\r\n        void main() {\r\n          // \r\n          float fromTop = clamp((vUv.y - 0.05) / 0.95, 0.0, 1.0);\r\n          float verticalFade = pow(fromTop, 2.2);\r\n\r\n          // x\r\n          float x = vUv.x;\r\n          float t = uTime;\r\n\r\n          // \r\n          float n = hash12(vec2(floor(x * uRayDensity + vSeed * 17.0), floor(t * 2.5 + vSeed * 11.0)));\r\n          float phase = (x * uRayDensity + (n - 0.5) * 2.0 + vSeed * 3.0) + t * 0.55;\r\n\r\n          // softness \r\n          float stripe = abs(fract(phase) - 0.5);\r\n          float ray = 1.0 - smoothstep(uRaySoftness, 0.5, stripe);\r\n\r\n          // \r\n          ray *= verticalFade;\r\n\r\n          // \r\n          float edge = smoothstep(0.0, 0.12, vUv.x) * smoothstep(0.0, 0.12, 1.0 - vUv.x);\r\n          ray *= edge;\r\n\r\n          float a = clamp(ray * uIntensity, 0.0, 1.0);\r\n          vec3 outColor = uColor * a;\r\n\r\n          // \r\n          gl_FragColor = vec4(outColor, a);\r\n          #include <colorspace_fragment>\r\n        }\r\n      `,\r\n      transparent: true,\r\n      depthTest: false,\r\n      depthWrite: false,\r\n      blending: THREE.AdditiveBlending,\r\n    });\r\n\r\n    // composer  renderer \r\n    this.material.toneMapped = false;\r\n\r\n    this.meshes = [];\r\n    this.meshes.length = 0;\r\n    for (let i = 0; i < planeCount; i += 1) {\r\n      const mat = this.material.clone();\r\n      // uniform  clone \r\n      mat.uniforms = THREE.UniformsUtils.clone(this.material.uniforms);\r\n      mat.uniforms.uSeed.value = i + 0.37;\r\n      mat.toneMapped = false;\r\n\r\n      const mesh = new THREE.Mesh(geometry, mat);\r\n      mesh.frustumCulled = false;\r\n      mesh.matrixAutoUpdate = true;\r\n      this.scene.add(mesh);\r\n      this.meshes.push(mesh);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \r\n   * - anchorPosition:  controls.target \r\n   * - camera: \r\n   */\r\n  update(deltaSeconds, anchorPosition, camera) {\r\n    const dt = Number(deltaSeconds);\r\n    if (Number.isFinite(dt) && dt > 0.0) {\r\n      this.timeSeconds += dt;\r\n    }\r\n\r\n    if (anchorPosition && typeof anchorPosition.x === 'number') {\r\n      this.anchor.copy(anchorPosition);\r\n    }\r\n\r\n    // \r\n    // NOTE: dt \r\n    const smooth = 1.0 - Math.exp(-dt * 2.5);\r\n    this.anchorSmoothed.lerp(this.anchor, Number.isFinite(smooth) ? smooth : 0.0);\r\n\r\n    const t = this.timeSeconds * this.options.speed;\r\n    const meshes = this.meshes;\r\n    const count = meshes.length;\r\n    if (!count) {\r\n      return;\r\n    }\r\n\r\n    // \r\n    const hasCamera = !!camera;\r\n\r\n    for (let i = 0; i < count; i += 1) {\r\n      const mesh = meshes[i];\r\n      const mat = mesh.material;\r\n\r\n      // \r\n      if (mat?.uniforms?.uTime) {\r\n        mat.uniforms.uTime.value = t;\r\n      }\r\n\r\n      // \r\n      // NOTE: sin/cos 11\r\n      const phase = (i / count) * Math.PI * 2.0 + t * 0.2;\r\n      const radius = this.options.placementRadius;\r\n      const ox = Math.cos(phase) * radius;\r\n      const oz = Math.sin(phase) * radius;\r\n      mesh.position.set(\r\n        this.anchorSmoothed.x + ox,\r\n        this.anchorSmoothed.y + this.options.topOffsetY,\r\n        this.anchorSmoothed.z + oz\r\n      );\r\n\r\n      // \r\n      const scale = 0.85 + 0.3 * Math.sin(phase * 1.3 + 1.7);\r\n      mesh.scale.setScalar(scale);\r\n\r\n      if (hasCamera) {\r\n        // \r\n        mesh.lookAt(camera.position);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**  */\r\n  render(renderer, camera) {\r\n    if (!renderer || !this.scene || !camera) {\r\n      return;\r\n    }\r\n\r\n    // \r\n    const prevAutoClear = renderer.autoClear;\r\n    renderer.autoClear = false;\r\n    try {\r\n      renderer.render(this.scene, camera);\r\n    } finally {\r\n      renderer.autoClear = prevAutoClear;\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    if (this.meshes && this.meshes.length) {\r\n      for (const mesh of this.meshes) {\r\n        if (!mesh) {\r\n          continue;\r\n        }\r\n        this.scene?.remove?.(mesh);\r\n        mesh.geometry?.dispose?.();\r\n        mesh.material?.dispose?.();\r\n      }\r\n    }\r\n    this.meshes = [];\r\n    this.material = null;\r\n    this.scene = null;\r\n    this.timeSeconds = 0.0;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n// XYZ: \r\nconst PARTICLE_BASE_SPREAD_DESKTOP = new THREE.Vector3(24, 12, 26);\r\nconst PARTICLE_BASE_SPREAD_MOBILE = new THREE.Vector3(16, 9, 18);\r\n// : \r\nconst PARTICLE_BASE_MAX_DISTANCE_DESKTOP = PARTICLE_BASE_SPREAD_DESKTOP.z * 1.2;\r\nconst PARTICLE_BASE_MAX_DISTANCE_MOBILE = PARTICLE_BASE_SPREAD_MOBILE.z * 1.2;\r\n// \r\nconst FLOW_TILT_DEGREES = 30; // 30\r\nconst DEFAULT_FLOW_DIR = new THREE.Vector3(\r\n  Math.cos(THREE.MathUtils.degToRad(FLOW_TILT_DEGREES)),\r\n  -Math.sin(THREE.MathUtils.degToRad(FLOW_TILT_DEGREES)),\r\n  0\r\n);\r\nconst DEFAULT_LAT1 = new THREE.Vector3(0, 0, 1);\r\nconst DEFAULT_LAT2 = new THREE.Vector3(0, 1, 0);\r\n\r\n//  new \r\nconst TEMP_DIR = new THREE.Vector3();\r\nconst TEMP_AXIS = new THREE.Vector3();\r\nconst TEMP_LAT1 = new THREE.Vector3();\r\nconst TEMP_LAT2 = new THREE.Vector3();\r\n\r\n/**\r\n * \r\n * App.vue  init/update/dispose  Three.js  Points \r\n */\r\nexport class ParticleField {\r\n  constructor(isMobileDevice) {\r\n    this.isMobileDevice = Boolean(isMobileDevice);\r\n    this.scene = null;\r\n    this.renderer = null;\r\n    this.camera = null;\r\n    this.controls = null;\r\n\r\n    this.particlePoints = null;\r\n    this.particleMaterial = null;\r\n    this.elapsedTime = 0;\r\n\r\n    // \r\n    // \r\n    // \r\n    this.worldOrigin = new THREE.Vector3(0, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Three.js \r\n   */\r\n  init(scene, renderer, camera, controls) {\r\n    if (!scene || !renderer?.capabilities?.isWebGL2) {\r\n      console.warn('Skipping particle system: WebGL2 required.');\r\n      return false;\r\n    }\r\n\r\n    this.dispose(scene);\r\n\r\n    this.scene = scene;\r\n    this.renderer = renderer;\r\n    this.camera = camera;\r\n    this.controls = controls;\r\n    this.elapsedTime = 0;\r\n\r\n    const count = this.isMobileDevice ? 800 : 2000; // \r\n    const geometry = new THREE.BufferGeometry();\r\n    geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(count * 3), 3));\r\n    geometry.setDrawRange(0, count);\r\n\r\n    const baseSpread = (this.isMobileDevice ? PARTICLE_BASE_SPREAD_MOBILE : PARTICLE_BASE_SPREAD_DESKTOP).clone();\r\n    const baseMaxDistance = this.isMobileDevice ? PARTICLE_BASE_MAX_DISTANCE_MOBILE : PARTICLE_BASE_MAX_DISTANCE_DESKTOP;\r\n\r\n    const material = new THREE.ShaderMaterial({\r\n      glslVersion: THREE.GLSL3,\r\n      transparent: true,\r\n      depthWrite: false,\r\n      depthTest: true,\r\n      blending: THREE.AdditiveBlending,\r\n      uniforms: {\r\n        uTime: { value: 0 }, // CPU\r\n        uOrigin: { value: new THREE.Vector3() }, // \r\n        uFlowDir: { value: DEFAULT_FLOW_DIR.clone() }, // \r\n        uLat1: { value: DEFAULT_LAT1.clone() }, // 1\r\n        uLat2: { value: DEFAULT_LAT2.clone() }, // 2\r\n        uSpread: { value: baseSpread.clone() }, // XYZ \r\n        uMaxDistance: { value: baseMaxDistance }, // \r\n        uBaseSpeed: { value: 0.6 }, // \r\n        uJitterAmp: { value: 0.22 }, // \r\n        uSizePx: { value: this.isMobileDevice ? 5.0 : 12.0 }, // px\r\n        uFadeNear: { value: 1.5 }, // \r\n        uFadeFar: { value: 14.0 }, // \r\n        uColorNear: { value: new THREE.Color(0x72a1c4) }, // \r\n        uColorFar: { value: new THREE.Color(0x0a5270) }, // \r\n      },\r\n      vertexShader: PARTICLE_VERTEX_SHADER,\r\n      fragmentShader: PARTICLE_FRAGMENT_SHADER,\r\n    });\r\n\r\n    const baseTargetDistance = controls\r\n      ? camera.position.distanceTo(controls.target)\r\n      : camera.position.length();\r\n    material.userData = {\r\n      baseSpread: baseSpread.clone(),\r\n      baseMaxDistance,\r\n      baseTargetDistance: Math.max(baseTargetDistance, 0.1), // OrbitControls \r\n    };\r\n\r\n    this.particlePoints = new THREE.Points(geometry, material);\r\n    this.particlePoints.frustumCulled = false;\r\n    this.particlePoints.renderOrder = 2;\r\n    scene.add(this.particlePoints);\r\n\r\n    this.particleMaterial = material;\r\n    this.setWorldBasis(material.uniforms.uFlowDir.value);\r\n\r\n    // \r\n    material.uniforms.uOrigin.value.copy(this.worldOrigin);\r\n    this.update(camera, controls);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * uTime \r\n   */\r\n  setTime(timeSeconds) {\r\n    this.elapsedTime = timeSeconds ?? this.elapsedTime;\r\n    if (this.particleMaterial?.uniforms?.uTime) {\r\n      this.particleMaterial.uniforms.uTime.value = this.elapsedTime;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \r\n   */\r\n  advanceTime(deltaSeconds) {\r\n    if (!Number.isFinite(deltaSeconds) || deltaSeconds === 0) {\r\n      return;\r\n    }\r\n    this.elapsedTime += deltaSeconds;\r\n    if (this.particleMaterial?.uniforms?.uTime) {\r\n      this.particleMaterial.uniforms.uTime.value = this.elapsedTime;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * uniform \r\n   */\r\n  setWorldBasis(flowDir) {\r\n    if (!this.particleMaterial || !flowDir) {\r\n      return;\r\n    }\r\n\r\n    const dir = TEMP_DIR.copy(flowDir).normalize();\r\n    //  cross \r\n    const axis = Math.abs(dir.y) < 0.99\r\n      ? TEMP_AXIS.set(0, 1, 0)\r\n      : TEMP_AXIS.set(1, 0, 0);\r\n\r\n    const lat1 = TEMP_LAT1.copy(dir).cross(axis);\r\n    if (lat1.lengthSq() < 1e-6) {\r\n      lat1.set(0, 0, 1);\r\n      lat1.cross(dir);\r\n    }\r\n    lat1.normalize();\r\n\r\n    const lat2 = TEMP_LAT2.copy(dir).cross(lat1).normalize();\r\n\r\n    const uniforms = this.particleMaterial.uniforms;\r\n    uniforms.uFlowDir.value.copy(dir);\r\n    uniforms.uLat1.value.copy(lat1);\r\n    uniforms.uLat2.value.copy(lat2);\r\n  }\r\n\r\n  /**\r\n   *  uniform \r\n   */\r\n  update(camera, controls) {\r\n    const targetCamera = camera || this.camera;\r\n    if (!this.particleMaterial || !targetCamera) {\r\n      return;\r\n    }\r\n\r\n    const uniforms = this.particleMaterial.uniforms;\r\n\r\n    // uOrigin \r\n    // NOTE: \r\n    // uniforms.uOrigin  init() \r\n\r\n    const { baseSpread, baseMaxDistance, baseTargetDistance } = this.particleMaterial.userData || {};\r\n    if (!baseSpread || !baseMaxDistance) {\r\n      return;\r\n    }\r\n\r\n    // \r\n    uniforms.uSpread.value.copy(baseSpread);\r\n    uniforms.uMaxDistance.value = baseMaxDistance;\r\n  }\r\n\r\n  /**\r\n   * GPU\r\n   */\r\n  dispose(scene) {\r\n    const targetScene = scene || this.scene;\r\n    if (this.particlePoints && targetScene) {\r\n      targetScene.remove(this.particlePoints);\r\n    }\r\n    this.particlePoints?.geometry?.dispose();\r\n    this.particlePoints?.material?.dispose();\r\n\r\n    this.particlePoints = null;\r\n    this.particleMaterial = null;\r\n    this.scene = null;\r\n    this.renderer = null;\r\n    this.camera = null;\r\n    this.controls = null;\r\n  }\r\n\r\n  /**  */\r\n  getMaterial() {\r\n    return this.particleMaterial;\r\n  }\r\n}\r\n\r\nconst PARTICLE_VERTEX_SHADER = /* glsl */`\r\nprecision highp float;\r\nprecision highp int;\r\n\r\nuniform float uTime;\r\nuniform vec3 uOrigin;\r\nuniform vec3 uFlowDir;\r\nuniform vec3 uLat1;\r\nuniform vec3 uLat2;\r\nuniform vec3 uSpread;\r\nuniform float uMaxDistance;\r\nuniform float uBaseSpeed;\r\nuniform float uJitterAmp;\r\nuniform float uSizePx;\r\nuniform float uFadeNear;\r\nuniform float uFadeFar;\r\n\r\nout float vFade;\r\nout float vColorMix;\r\n\r\nuint hashUint(uint n) {\r\n  n ^= (n << 13);\r\n  n ^= (n >> 17);\r\n  n ^= (n << 5);\r\n  return n * 0x27d4eb2du;\r\n}\r\n\r\nfloat hashFloat(uint n) {\r\n  return float(hashUint(n)) / 4294967296.0;\r\n}\r\n\r\nvec3 hashVec3(uint n) {\r\n  return vec3(\r\n    hashFloat(n),\r\n    hashFloat(n * 1664525u + 1013904223u),\r\n    hashFloat(n * 22695477u + 1u)\r\n  );\r\n}\r\n\r\nvoid main() {\r\n  uint id = uint(gl_VertexID);\r\n  vec3 randSeed = hashVec3(id) - 0.5;\r\n\r\n  vec3 flowDir = normalize(uFlowDir);\r\n  vec3 lateral = uLat1 * (randSeed.x * uSpread.x)\r\n    + uLat2 * (randSeed.y * uSpread.y);\r\n\r\n  float speedSeed = hashFloat(id * 747796405u);\r\n  float speed = uBaseSpeed * (0.7 + 0.6 * speedSeed);\r\n  float flowCycle = max(uSpread.z, 1e-3);\r\n  float flowParam = randSeed.z + (uTime * speed) / flowCycle;\r\n  float wrappedZ = fract(flowParam) - 0.5;\r\n  vec3 pos = uOrigin + lateral + flowDir * (wrappedZ * flowCycle);\r\n\r\n  float phase = hashFloat(id * 1664525u) * 6.28318530718;\r\n  float driftSeed = hashFloat(id * 22695477u);\r\n  float triangle = 1.0 - abs(fract((phase + uTime * (0.8 + 0.4 * driftSeed)) / 3.14159265) * 2.0 - 1.0);\r\n\r\n  vec3 jitter1 = normalize(uLat1);\r\n  vec3 jitter2 = normalize(uLat2);\r\n  pos += jitter1 * ((triangle - 0.5) * uJitterAmp);\r\n  pos += jitter2 * ((hashFloat(id * 1103515245u) - 0.5) * uJitterAmp * 0.6);\r\n\r\n  vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\r\n  float dist = -mvPosition.z;\r\n  float forwardMask = step(0.0, dist);\r\n\r\n  vec4 clipPosition = projectionMatrix * mvPosition;\r\n  float invW = 1.0 / max(abs(clipPosition.w), 1e-3);\r\n  vec2 ndc = clipPosition.xy * invW;\r\n\r\n  float screenMask = 1.0 - smoothstep(0.96, 1.16, max(abs(ndc.x), abs(ndc.y)));\r\n  float rangeMask = 1.0 - smoothstep(uMaxDistance * 0.7, uMaxDistance, dist);\r\n\r\n  float fadeT = clamp((dist - uFadeNear) / max(uFadeFar - uFadeNear, 1e-3), 0.0, 1.0);\r\n  float fade = (1.0 - fadeT) * screenMask * rangeMask * forwardMask;\r\n  vFade = fade;\r\n  vColorMix = fade;\r\n\r\n  float sizeBase = uSizePx * projectionMatrix[1][1] / max(dist, 1e-3);\r\n  float attenuatedSize = sizeBase * fade;\r\n  gl_PointSize = max(attenuatedSize, 0.75) * step(0.001, fade);\r\n  gl_Position = clipPosition;\r\n}\r\n`;\r\n\r\nconst PARTICLE_FRAGMENT_SHADER = /* glsl */`\r\nprecision highp float;\r\n\r\nin float vFade;\r\nin float vColorMix;\r\n\r\nuniform vec3 uColorNear;\r\nuniform vec3 uColorFar;\r\n\r\nout vec4 fragColor;\r\n\r\nvoid main() {\r\n  vec2 coord = gl_PointCoord - vec2(0.5);\r\n  float falloff = exp(-8.0 * dot(coord, coord));\r\n  float alpha = vFade * falloff * 0.6;\r\n  if (alpha < 0.004) {\r\n    discard;\r\n  }\r\n  vec3 color = mix(uColorFar, uColorNear, vColorMix);\r\n  fragColor = vec4(color, alpha);\r\n}\r\n`;\r\n","/**\r\n * WASM \r\n * Vue  wasm \r\n * DataView  GC \r\n */\r\nexport class WasmtimeBridge {\r\n  constructor(wasmModule) {\r\n    if (!wasmModule) {\r\n      throw new Error('WasmtimeBridge: wasmModule ');\r\n    }\r\n\r\n    this.wasm = wasmModule;\r\n    this.latestStatePtr = 0;\r\n    this.latestStateHeaderPtr = 0;\r\n    this.latestStateHeaderView = null;\r\n    this.latestPositionsPtr = 0;\r\n    this.latestVelocitiesPtr = 0;\r\n    this.latestOrientationsPtr = 0;\r\n    this.latestBoidCount = 0;\r\n\r\n    this.cachedHeapBuffer = null;\r\n    this.cachedPositionsPtr = 0;\r\n    this.cachedOrientationsPtr = 0;\r\n    this.cachedVelocitiesPtr = 0;\r\n    this.cachedSpeciesIdsPtr = 0;\r\n    this.cachedPositionsView = null;\r\n    this.cachedOrientationsView = null;\r\n    this.cachedVelocitiesView = null;\r\n    this.cachedSpeciesIdsView = null;\r\n    this.cachedPositionsCount = 0;\r\n    this.cachedOrientationsCount = 0;\r\n    this.cachedVelocitiesCount = 0;\r\n    this.cachedSpeciesIdsCount = 0;\r\n    this.cachedSpeciesIdsBuffer = null;\r\n    this.cachedUnitDensityPtr = 0;\r\n    this.cachedUnitDensityCount = 0;\r\n    this.cachedUnitDensityView = null;\r\n    this.cachedSpeciesEnvelopePtr = 0;\r\n    this.cachedSpeciesEnvelopeCount = 0;\r\n    this.cachedSpeciesEnvelopeView = null;\r\n\r\n    this.cachedSpeciesClusterPtr = 0;\r\n    this.cachedSpeciesClusterCount = 0;\r\n    this.cachedSpeciesClusterView = null;\r\n\r\n    this.cachedSpeciesSchoolClusterPtr = 0;\r\n    this.cachedSpeciesSchoolClusterCount = 0;\r\n    this.cachedSpeciesSchoolClusterView = null;\r\n\r\n    // cwrap  wasm \r\n    this.stepSimulationHandle = createWrappedFunction(this.wasm, 'stepSimulation', 'number', ['number']);\r\n    // \r\n    this.buildHandle = createWrappedFunction(this.wasm, 'build', 'void', []);\r\n    this.exportTreeStructureHandle = createWrappedFunction(this.wasm, 'exportTreeStructure', 'object', []);\r\n    this.boidUnitMappingPtrHandle = createWrappedFunction(this.wasm, 'boidUnitMappingPtr', 'number', []);\r\n    this.currentFirstBoidXHandle = createWrappedFunction(this.wasm, 'currentFirstBoidX', 'number', []);\r\n    this.speciesIdsPtrHandle = createWrappedFunction(this.wasm, 'speciesIdsPtr', 'number', []);\r\n    this.syncReadToWriteBuffersHandle = createWrappedFunction(this.wasm, 'syncReadToWriteBuffers', 'void', []);\r\n    this.setSimulationTuningParamsHandle = createWrappedFunction(this.wasm, 'setSimulationTuningParams', 'void', ['object']);\r\n    this.unitSimpleDensityPtrHandle = createWrappedFunction(this.wasm, 'unitSimpleDensityPtr', 'number', []);\r\n    this.unitSimpleDensityCountHandle = createWrappedFunction(this.wasm, 'unitSimpleDensityCount', 'number', []);\r\n    this.speciesEnvelopesPtrHandle = createWrappedFunction(this.wasm, 'speciesEnvelopesPtr', 'number', []);\r\n    this.speciesEnvelopesCountHandle = createWrappedFunction(this.wasm, 'speciesEnvelopesCount', 'number', []);\r\n\r\n    // Species clusters debug export\r\n    this.speciesClustersPtrHandle = createWrappedFunction(this.wasm, 'speciesClustersPtr', 'number', []);\r\n    this.speciesClustersCountHandle = createWrappedFunction(this.wasm, 'speciesClustersCount', 'number', []);\r\n\r\n    // Species school clusters debug export\r\n    this.speciesSchoolClustersPtrHandle = createWrappedFunction(this.wasm, 'speciesSchoolClustersPtr', 'number', []);\r\n    this.speciesSchoolClustersCountHandle = createWrappedFunction(this.wasm, 'speciesSchoolClustersCount', 'number', []);\r\n\r\n    this.configureGroundPlaneHandle = createWrappedFunction(\r\n      this.wasm,\r\n      'configureGroundPlane',\r\n      'void',\r\n      ['boolean', 'number', 'number', 'number', 'number'],\r\n    );\r\n    this.cachedUnitMappingsPtr = 0;\r\n    this.cachedUnitMappingsCount = 0;\r\n    this.cachedUnitMappingsView = null;\r\n    this.cachedUnitMappingsBuffer = null;\r\n\r\n    // /GC\r\n    this.cachedDiagnostics = {\r\n      treeStructure: null,\r\n      firstBoidX: 0,\r\n      unitMappings: null,\r\n      unitDensities: null,\r\n      speciesEnvelopes: null,\r\n      speciesClusters: null,\r\n      speciesSchoolClusters: null,\r\n    };\r\n  }\r\n\r\n  /**  1  */\r\n  initializeFlock(settings, options = {}) {\r\n    if (!this.wasm) {\r\n      return 0;\r\n    }\r\n\r\n    const spatialScale = Number.isFinite(options.spatialScale)\r\n      ? Number(options.spatialScale)\r\n      : 1;\r\n    const posRange = Number.isFinite(options.posRange) ? Number(options.posRange) : 4;\r\n    const velRange = Number.isFinite(options.velRange) ? Number(options.velRange) : 0.25;\r\n\r\n    //  wasm  VectorSpeciesParams \r\n    const source = Array.isArray(settings) ? settings : Array.from(settings ?? []);\r\n    const vector = buildSpeciesParams(this.wasm, source);\r\n    if (!vector) {\r\n      return 0;\r\n    }\r\n\r\n    // wasm \r\n    try {\r\n      if (typeof this.wasm.callInitBoids !== 'function') {\r\n        throw new Error('WasmtimeBridge: callInitBoids ');\r\n      }\r\n      this.wasm.callInitBoids(vector, spatialScale, posRange, velRange);\r\n    } finally {\r\n      if (typeof vector.delete === 'function') {\r\n        vector.delete();\r\n      }\r\n    }\r\n\r\n    // \r\n    if (options.groundPlane) {\r\n      applyGroundPlane(this.configureGroundPlaneHandle, options.groundPlane);\r\n    }\r\n\r\n    // \r\n    ensureHandle(this.buildHandle, 'build')();\r\n\r\n    // \r\n    return this.stepSimulation(0);\r\n  }\r\n\r\n  /**  wasm vector/ */\r\n  applySpeciesParams(settings, options = {}) {\r\n    if (!this.wasm || typeof this.wasm.setGlobalSpeciesParamsFromJS !== 'function') {\r\n      return false;\r\n    }\r\n\r\n    const spatialScale = Number.isFinite(options.spatialScale)\r\n      ? Number(options.spatialScale)\r\n      : 1;\r\n\r\n    const source = Array.isArray(settings) ? settings : Array.from(settings ?? []);\r\n    const vector = buildSpeciesParams(this.wasm, source);\r\n    if (!vector) {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      this.wasm.setGlobalSpeciesParamsFromJS(vector, spatialScale);\r\n    } finally {\r\n      if (typeof vector.delete === 'function') {\r\n        vector.delete();\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**  */\r\n  applyTuningParams(params) {\r\n    if (!this.wasm) {\r\n      return;\r\n    }\r\n    if (!params) {\r\n      return;\r\n    }\r\n    const handle = ensureHandle(this.setSimulationTuningParamsHandle, 'setSimulationTuningParams');\r\n    const toNumber = (value, fallback) => {\r\n      const num = Number(value);\r\n      return Number.isFinite(num) ? num : fallback;\r\n    };\r\n    handle({\r\n      threatDecay: toNumber(params.threatDecay, 0.5),\r\n      maxEscapeWeight: toNumber(params.maxEscapeWeight, 1.0),\r\n      baseEscapeStrength: toNumber(params.baseEscapeStrength, 3.0),\r\n      fastAttractStrength: toNumber(params.fastAttractStrength, 1.0),\r\n      schoolPullCoefficient: Math.max(0, toNumber(params.schoolPullCoefficient, 0.0008)),\r\n\r\n      // \r\n      // NOTE: embind  value_object  0 \r\n      // \r\n      softBoundaryRadius: Math.max(0, toNumber(params.softBoundaryRadius, 200.0)),\r\n      softBoundaryStart: Math.max(0, toNumber(params.softBoundaryStart, 120.0)),\r\n      softBoundarySteer: Math.max(0, toNumber(params.softBoundarySteer, 0.25)),\r\n    });\r\n  }\r\n\r\n  /**  */\r\n  /** / */\r\n  getDiagnostics(options = {}) {\r\n    if (!this.wasm) {\r\n      return null;\r\n    }\r\n\r\n    const resolved = (options && typeof options === 'object') ? options : {};\r\n    const boidCount = Number.isFinite(resolved.boidCount) ? Math.max(0, Math.floor(resolved.boidCount)) : 0;\r\n    const includeTreeStructure = Boolean(resolved.treeStructure);\r\n    const includeFirstBoidX = Boolean(resolved.firstBoidX);\r\n    const includeUnitMappings = Boolean(resolved.unitMappings);\r\n    const includeUnitDensities = Boolean(resolved.unitDensities);\r\n    const includeSpeciesEnvelopes = Boolean(resolved.speciesEnvelopes);\r\n    const includeSpeciesClusters = Boolean(resolved.speciesClusters);\r\n    const includeSpeciesSchoolClusters = Boolean(resolved.speciesSchoolClusters);\r\n\r\n    const result = this.cachedDiagnostics;\r\n    result.treeStructure =\r\n      includeTreeStructure && typeof this.exportTreeStructureHandle === 'function'\r\n        ? this.exportTreeStructureHandle()\r\n        : null;\r\n\r\n    result.firstBoidX =\r\n      includeFirstBoidX && typeof this.currentFirstBoidXHandle === 'function'\r\n        ? this.currentFirstBoidXHandle()\r\n        : 0;\r\n\r\n    // boidIndex -> unitId\r\n    if (includeUnitMappings && boidCount > 0 && typeof this.boidUnitMappingPtrHandle === 'function') {\r\n      const ptr = this.boidUnitMappingPtrHandle();\r\n      const heapBufferI32 = this.wasm.HEAP32.buffer;\r\n      if (ptr && (\r\n        this.cachedUnitMappingsView === null ||\r\n        this.cachedUnitMappingsPtr !== ptr ||\r\n        this.cachedUnitMappingsCount !== boidCount ||\r\n        this.cachedUnitMappingsBuffer !== heapBufferI32\r\n      )) {\r\n        this.cachedUnitMappingsPtr = ptr;\r\n        this.cachedUnitMappingsCount = boidCount;\r\n        this.cachedUnitMappingsBuffer = heapBufferI32;\r\n        this.cachedUnitMappingsView = new Int32Array(heapBufferI32, ptr, boidCount * 2);\r\n      }\r\n      result.unitMappings = this.cachedUnitMappingsView;\r\n    } else {\r\n      result.unitMappings = null;\r\n    }\r\n\r\n    // \r\n    result.unitDensities = includeUnitDensities ? getUnitSimpleDensitiesInternal(this) : null;\r\n\r\n    // \r\n    result.speciesEnvelopes = includeSpeciesEnvelopes ? getSpeciesEnvelopesInternal(this) : null;\r\n    result.speciesClusters = includeSpeciesClusters ? getSpeciesClustersInternal(this) : null;\r\n    result.speciesSchoolClusters = includeSpeciesSchoolClusters ? getSpeciesSchoolClustersInternal(this) : null;\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   *  1 \r\n   * App.vue::stepSimulationAndUpdateState \r\n   */\r\n  stepSimulation(deltaTime) {\r\n    const handle = ensureHandle(this.stepSimulationHandle, 'stepSimulation');\r\n\r\n    const { wasm } = this;\r\n    const dt = Number.isFinite(deltaTime) ? deltaTime : 0;\r\n    const statePtr = handle(dt);\r\n    if (!statePtr) {\r\n      this.latestStatePtr = 0;\r\n      this.latestStateHeaderPtr = 0;\r\n      this.latestPositionsPtr = 0;\r\n      this.latestVelocitiesPtr = 0;\r\n      this.latestOrientationsPtr = 0;\r\n      this.latestStateHeaderView = null;\r\n      this.latestBoidCount = 0;\r\n      return 0;\r\n    }\r\n\r\n    const heapU8Buffer = wasm.HEAPU8.buffer;\r\n    if (\r\n      !this.latestStateHeaderView ||\r\n      this.latestStateHeaderPtr !== statePtr ||\r\n      this.latestStateHeaderView.buffer !== heapU8Buffer\r\n    ) {\r\n      this.latestStateHeaderView = new DataView(heapU8Buffer, statePtr, 16);\r\n      this.latestStateHeaderPtr = statePtr;\r\n    }\r\n\r\n    this.latestStatePtr = statePtr;\r\n    this.latestPositionsPtr = this.latestStateHeaderView.getUint32(0, true);\r\n    this.latestVelocitiesPtr = this.latestStateHeaderView.getUint32(4, true);\r\n    this.latestOrientationsPtr = this.latestStateHeaderView.getUint32(8, true);\r\n    this.latestBoidCount = this.latestStateHeaderView.getInt32(12, true);\r\n\r\n    return this.latestBoidCount;\r\n  }\r\n\r\n  /**\r\n   * wasm  positions / orientations \r\n   * buffer  TypedArray \r\n   */\r\n  getBuffers(count) {\r\n    if (!this.wasm) {\r\n      return {\r\n        positions: new Float32Array(0),\r\n        orientations: new Float32Array(0),\r\n        velocities: new Float32Array(0),\r\n        speciesIds: new Int32Array(0),\r\n      };\r\n    }\r\n\r\n    const heapBuffer = this.wasm.HEAPF32.buffer;\r\n    const heapBufferI32 = this.wasm.HEAP32.buffer;\r\n\r\n    if (this.cachedHeapBuffer !== heapBuffer || this.cachedSpeciesIdsBuffer !== heapBufferI32) {\r\n      this.cachedHeapBuffer = heapBuffer;\r\n      this.cachedSpeciesIdsBuffer = heapBufferI32;\r\n      this.cachedPositionsPtr = 0;\r\n      this.cachedOrientationsPtr = 0;\r\n      this.cachedVelocitiesPtr = 0;\r\n      this.cachedSpeciesIdsPtr = 0;\r\n      this.cachedPositionsView = null;\r\n      this.cachedOrientationsView = null;\r\n      this.cachedVelocitiesView = null;\r\n      this.cachedSpeciesIdsView = null;\r\n      this.cachedPositionsCount = 0;\r\n      this.cachedOrientationsCount = 0;\r\n      this.cachedVelocitiesCount = 0;\r\n      this.cachedSpeciesIdsCount = 0;\r\n      this.cachedUnitDensityPtr = 0;\r\n      this.cachedUnitDensityCount = 0;\r\n      this.cachedUnitDensityView = null;\r\n      this.cachedSpeciesEnvelopePtr = 0;\r\n      this.cachedSpeciesEnvelopeCount = 0;\r\n      this.cachedSpeciesEnvelopeView = null;\r\n\r\n      this.cachedSpeciesClusterPtr = 0;\r\n      this.cachedSpeciesClusterCount = 0;\r\n      this.cachedSpeciesClusterView = null;\r\n\r\n      this.cachedSpeciesSchoolClusterPtr = 0;\r\n      this.cachedSpeciesSchoolClusterCount = 0;\r\n      this.cachedSpeciesSchoolClusterView = null;\r\n    }\r\n\r\n    if (!this.latestPositionsPtr || !this.latestOrientationsPtr || !this.latestVelocitiesPtr || count <= 0) {\r\n      return {\r\n        positions: this.cachedPositionsView ?? new Float32Array(0),\r\n        orientations: this.cachedOrientationsView ?? new Float32Array(0),\r\n        velocities: this.cachedVelocitiesView ?? new Float32Array(0),\r\n        speciesIds: this.cachedSpeciesIdsView ?? new Int32Array(0),\r\n      };\r\n    }\r\n\r\n    if (\r\n      this.cachedPositionsView === null ||\r\n      this.cachedPositionsCount !== count ||\r\n      this.cachedPositionsPtr !== this.latestPositionsPtr\r\n    ) {\r\n      this.cachedPositionsPtr = this.latestPositionsPtr;\r\n      this.cachedPositionsView = new Float32Array(heapBuffer, this.cachedPositionsPtr, count * 3);\r\n      this.cachedPositionsCount = count;\r\n    }\r\n\r\n    if (\r\n      this.cachedOrientationsView === null ||\r\n      this.cachedOrientationsCount !== count ||\r\n      this.cachedOrientationsPtr !== this.latestOrientationsPtr\r\n    ) {\r\n      this.cachedOrientationsPtr = this.latestOrientationsPtr;\r\n      this.cachedOrientationsView = new Float32Array(heapBuffer, this.cachedOrientationsPtr, count * 4);\r\n      this.cachedOrientationsCount = count;\r\n    }\r\n\r\n    if (\r\n      this.cachedVelocitiesView === null ||\r\n      this.cachedVelocitiesCount !== count ||\r\n      this.cachedVelocitiesPtr !== this.latestVelocitiesPtr\r\n    ) {\r\n      this.cachedVelocitiesPtr = this.latestVelocitiesPtr;\r\n      this.cachedVelocitiesView = new Float32Array(heapBuffer, this.cachedVelocitiesPtr, count * 3);\r\n      this.cachedVelocitiesCount = count;\r\n    }\r\n\r\n    const speciesPtr = typeof this.speciesIdsPtrHandle === 'function' ? this.speciesIdsPtrHandle() : 0;\r\n    if (\r\n      speciesPtr && (\r\n        this.cachedSpeciesIdsView === null ||\r\n        this.cachedSpeciesIdsPtr !== speciesPtr ||\r\n        this.cachedSpeciesIdsCount !== count ||\r\n        this.cachedSpeciesIdsBuffer !== heapBufferI32\r\n      )\r\n    ) {\r\n      this.cachedSpeciesIdsPtr = speciesPtr;\r\n      this.cachedSpeciesIdsCount = count;\r\n      this.cachedSpeciesIdsBuffer = heapBufferI32;\r\n      this.cachedSpeciesIdsView = new Int32Array(heapBufferI32, speciesPtr, count);\r\n    }\r\n\r\n    return {\r\n      positions: this.cachedPositionsView,\r\n      orientations: this.cachedOrientationsView,\r\n      velocities: this.cachedVelocitiesView,\r\n      speciesIds: this.cachedSpeciesIdsView,\r\n    };\r\n  }\r\n\r\n  /** wasm  triple buffer  */\r\n  captureState() {\r\n    if (!this.wasm) {\r\n      return null;\r\n    }\r\n\r\n    const currentCount = this.stepSimulation(0);\r\n    if (!currentCount || currentCount <= 0) {\r\n      return { count: 0 };\r\n    }\r\n\r\n    const { positions, velocities, orientations, speciesIds } = this.getBuffers(currentCount);\r\n\r\n    return {\r\n      count: currentCount,\r\n      positions: positions ? new Float32Array(positions) : null,\r\n      velocities: velocities ? new Float32Array(velocities) : null,\r\n      orientations: orientations ? new Float32Array(orientations) : null,\r\n      speciesIds: speciesIds ? new Int32Array(speciesIds) : null,\r\n    };\r\n  }\r\n\r\n  /** restoreFlockState  */\r\n  /**  */\r\n  restoreState(previousState, oldSettings, newSettings) {\r\n    if (!previousState || previousState.count <= 0) {\r\n      return;\r\n    }\r\n\r\n    const currentCount = this.stepSimulation(0);\r\n    if (!currentCount || currentCount <= 0) {\r\n      return;\r\n    }\r\n\r\n    const { positions, velocities, orientations } = this.getBuffers(currentCount);\r\n    if (!positions || !velocities || !orientations) {\r\n      return;\r\n    }\r\n\r\n    const prevPositions = previousState.positions;\r\n    const prevVelocities = previousState.velocities;\r\n    const prevOrientations = previousState.orientations;\r\n\r\n    const oldRanges = buildSpeciesRanges(oldSettings);\r\n    const newRanges = buildSpeciesRanges(newSettings);\r\n    const oldRangeMap = new Map(oldRanges.map((info) => [info.name, info]));\r\n\r\n    let restored = 0;\r\n\r\n    for (const newInfo of newRanges) {\r\n      if (!newInfo.count) continue;\r\n      const oldInfo = oldRangeMap.get(newInfo.name);\r\n      if (!oldInfo || !oldInfo.count) continue;\r\n\r\n      const transferable = Math.min(oldInfo.count, newInfo.count);\r\n      for (let i = 0; i < transferable; i += 1) {\r\n        const srcIndex = oldInfo.start + i;\r\n        const dstIndex = newInfo.start + i;\r\n        if (srcIndex >= previousState.count || dstIndex >= currentCount) {\r\n          break;\r\n        }\r\n\r\n        if (prevPositions) {\r\n          const srcPosBase = srcIndex * 3;\r\n          const dstPosBase = dstIndex * 3;\r\n          positions[dstPosBase] = prevPositions[srcPosBase];\r\n          positions[dstPosBase + 1] = prevPositions[srcPosBase + 1];\r\n          positions[dstPosBase + 2] = prevPositions[srcPosBase + 2];\r\n        }\r\n\r\n        if (prevVelocities) {\r\n          const srcVelBase = srcIndex * 3;\r\n          const dstVelBase = dstIndex * 3;\r\n          velocities[dstVelBase] = prevVelocities[srcVelBase];\r\n          velocities[dstVelBase + 1] = prevVelocities[srcVelBase + 1];\r\n          velocities[dstVelBase + 2] = prevVelocities[srcVelBase + 2];\r\n        }\r\n\r\n        if (prevOrientations) {\r\n          const srcOriBase = srcIndex * 4;\r\n          const dstOriBase = dstIndex * 4;\r\n          orientations[dstOriBase] = prevOrientations[srcOriBase];\r\n          orientations[dstOriBase + 1] = prevOrientations[srcOriBase + 1];\r\n          orientations[dstOriBase + 2] = prevOrientations[srcOriBase + 2];\r\n          orientations[dstOriBase + 3] = prevOrientations[srcOriBase + 3];\r\n        }\r\n        restored += 1;\r\n      }\r\n    }\r\n\r\n    if (restored > 0) {\r\n      if (typeof this.syncReadToWriteBuffersHandle === 'function') {\r\n        this.syncReadToWriteBuffersHandle();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n//  {name,start,count} \r\nfunction buildSpeciesRanges(list = []) {\r\n  const ranges = [];\r\n  let offset = 0;\r\n  for (const item of list) {\r\n    if (!item) continue;\r\n    const count = Math.max(0, Number(item.count) || 0);\r\n    ranges.push({\r\n      name: item.species || '',\r\n      start: offset,\r\n      count,\r\n    });\r\n    offset += count;\r\n  }\r\n  return ranges;\r\n}\r\n\r\n// cwrap  null\r\nfunction createWrappedFunction(wasm, name, returnType, argTypes) {\r\n  if (!wasm) {\r\n    return null;\r\n  }\r\n\r\n  if (typeof wasm[name] === 'function') {\r\n    return wasm[name].bind(wasm);\r\n  }\r\n\r\n  if (typeof wasm.cwrap === 'function') {\r\n    try {\r\n      return wasm.cwrap(name, returnType, argTypes);\r\n    } catch (error) {\r\n      console.warn(`WasmtimeBridge: ${name} `, error);\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n// \r\nfunction ensureHandle(handle, name) {\r\n  if (typeof handle !== 'function') {\r\n    throw new Error(`WasmtimeBridge: ${name} `);\r\n  }\r\n  return handle;\r\n}\r\n\r\n// \r\nfunction applyGroundPlane(configureGroundPlaneHandle, options) {\r\n  if (!options) {\r\n    return;\r\n  }\r\n  const handle = ensureHandle(configureGroundPlaneHandle, 'configureGroundPlane');\r\n\r\n  const toNumber = (value, fallback) => {\r\n    const num = Number(value);\r\n    return Number.isFinite(num) ? num : fallback;\r\n  };\r\n\r\n  const enabled = options.enabled !== false;\r\n  const height = toNumber(options.height, 0);\r\n  const blendDistance = Math.max(0, toNumber(options.blendDistance, 2));\r\n  const stiffness = Math.max(0, toNumber(options.stiffness, 18));\r\n  const damping = Math.max(0, toNumber(options.damping, 8));\r\n  handle(enabled, height, blendDistance, stiffness, damping);\r\n}\r\n\r\n//  wasm VectorSpeciesParams \r\nfunction buildSpeciesParams(wasm, settings) {\r\n  if (!wasm || !Array.isArray(settings)) {\r\n    return null;\r\n  }\r\n\r\n  const vector = new wasm.VectorSpeciesParams();\r\n  settings.forEach((raw, index) => {\r\n    if (!raw) {\r\n      return;\r\n    }\r\n\r\n    const toNumber = (value, fallback = 0) => {\r\n      const num = Number(value);\r\n      return Number.isFinite(num) ? num : fallback;\r\n    };\r\n\r\n    vector.push_back({\r\n      species: typeof raw.species === 'string' ? raw.species : `Species ${index + 1}`,\r\n      count: Math.max(0, Math.floor(toNumber(raw.count, 0))),\r\n      speciesId: Math.max(0, Math.floor(toNumber(raw.speciesId, index))),\r\n      cohesion: toNumber(raw.cohesion, 0),\r\n      separation: toNumber(raw.separation, 0),\r\n      alignment: toNumber(raw.alignment, 0),\r\n      maxSpeed: toNumber(raw.maxSpeed, 1),\r\n      minSpeed: toNumber(raw.minSpeed, 0),\r\n      maxTurnAngle: toNumber(raw.maxTurnAngle, 0),\r\n      separationRange: toNumber(raw.separationRange, 0),\r\n      alignmentRange: toNumber(raw.alignmentRange, 0),\r\n      cohesionRange: toNumber(raw.cohesionRange, 0),\r\n      maxNeighbors: Math.max(0, Math.floor(toNumber(raw.maxNeighbors, 0))),\r\n      lambda: toNumber(raw.lambda, 0),\r\n      tau: toNumber(raw.tau, 0),\r\n      horizontalTorque: toNumber(raw.horizontalTorque, 0),\r\n      velocityEpsilon: toNumber(raw.velocityEpsilon, 0.0001),\r\n      torqueStrength: toNumber(raw.torqueStrength, 0),\r\n      // \r\n      bodyHeadLength: toNumber(raw.bodyHeadLength, -0.15),\r\n      bodyTailLength: toNumber(raw.bodyTailLength, 0.33),\r\n      bodyRadius: toNumber(raw.bodyRadius, 0.035),\r\n      predatorAlertRadius: toNumber(raw.predatorAlertRadius, 1.0),\r\n      isPredator: Boolean(raw.isPredator),\r\n      densityReturnStrength: toNumber(raw.densityReturnStrength ?? raw.centerAttractStrength, 0.0),\r\n    });\r\n  });\r\n\r\n  return vector;\r\n}\r\n\r\nfunction getUnitSimpleDensitiesInternal(bridge) {\r\n  if (!bridge?.wasm) {\r\n    return null;\r\n  }\r\n  if (\r\n    typeof bridge.unitSimpleDensityPtrHandle !== 'function' ||\r\n    typeof bridge.unitSimpleDensityCountHandle !== 'function'\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  const count = bridge.unitSimpleDensityCountHandle();\r\n  const ptr = bridge.unitSimpleDensityPtrHandle();\r\n  if (!ptr || !count || count <= 0) {\r\n    bridge.cachedUnitDensityPtr = 0;\r\n    bridge.cachedUnitDensityCount = 0;\r\n    bridge.cachedUnitDensityView = null;\r\n    return null;\r\n  }\r\n\r\n  const heapBuffer = bridge.wasm.HEAPF32.buffer;\r\n  if (\r\n    bridge.cachedUnitDensityView === null ||\r\n    bridge.cachedUnitDensityPtr !== ptr ||\r\n    bridge.cachedUnitDensityCount !== count ||\r\n    bridge.cachedHeapBuffer !== heapBuffer\r\n  ) {\r\n    bridge.cachedUnitDensityPtr = ptr;\r\n    bridge.cachedUnitDensityCount = count;\r\n    bridge.cachedUnitDensityView = new Float32Array(heapBuffer, ptr, count);\r\n  }\r\n\r\n  return bridge.cachedUnitDensityView;\r\n}\r\n\r\nfunction getSpeciesEnvelopesInternal(bridge) {\r\n  if (!bridge?.wasm) {\r\n    return null;\r\n  }\r\n  if (\r\n    typeof bridge.speciesEnvelopesPtrHandle !== 'function' ||\r\n    typeof bridge.speciesEnvelopesCountHandle !== 'function'\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  const floatCount = bridge.speciesEnvelopesCountHandle();\r\n  const ptr = bridge.speciesEnvelopesPtrHandle();\r\n  if (!ptr || !floatCount || floatCount <= 0) {\r\n    bridge.cachedSpeciesEnvelopePtr = 0;\r\n    bridge.cachedSpeciesEnvelopeCount = 0;\r\n    bridge.cachedSpeciesEnvelopeView = null;\r\n    return null;\r\n  }\r\n\r\n  const heapBuffer = bridge.wasm.HEAPF32.buffer;\r\n  if (\r\n    bridge.cachedSpeciesEnvelopeView === null ||\r\n    bridge.cachedSpeciesEnvelopePtr !== ptr ||\r\n    bridge.cachedSpeciesEnvelopeCount !== floatCount ||\r\n    bridge.cachedHeapBuffer !== heapBuffer\r\n  ) {\r\n    bridge.cachedSpeciesEnvelopePtr = ptr;\r\n    bridge.cachedSpeciesEnvelopeCount = floatCount;\r\n    bridge.cachedSpeciesEnvelopeView = new Float32Array(heapBuffer, ptr, floatCount);\r\n    bridge.cachedHeapBuffer = heapBuffer;\r\n  }\r\n\r\n  return {\r\n    buffer: bridge.cachedSpeciesEnvelopeView,\r\n    count: Math.floor(floatCount / 5),\r\n  };\r\n}\r\n\r\nfunction getSpeciesClustersInternal(bridge) {\r\n  if (!bridge?.wasm) {\r\n    return null;\r\n  }\r\n  if (\r\n    typeof bridge.speciesClustersPtrHandle !== 'function' ||\r\n    typeof bridge.speciesClustersCountHandle !== 'function'\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  const floatCount = bridge.speciesClustersCountHandle();\r\n  const ptr = bridge.speciesClustersPtrHandle();\r\n  if (!ptr || !floatCount || floatCount <= 0) {\r\n    bridge.cachedSpeciesClusterPtr = 0;\r\n    bridge.cachedSpeciesClusterCount = 0;\r\n    bridge.cachedSpeciesClusterView = null;\r\n    return null;\r\n  }\r\n\r\n  const heapBuffer = bridge.wasm.HEAPF32.buffer;\r\n  if (\r\n    bridge.cachedSpeciesClusterView === null ||\r\n    bridge.cachedSpeciesClusterPtr !== ptr ||\r\n    bridge.cachedSpeciesClusterCount !== floatCount ||\r\n    bridge.cachedHeapBuffer !== heapBuffer\r\n  ) {\r\n    bridge.cachedSpeciesClusterPtr = ptr;\r\n    bridge.cachedSpeciesClusterCount = floatCount;\r\n    bridge.cachedSpeciesClusterView = new Float32Array(heapBuffer, ptr, floatCount);\r\n    bridge.cachedHeapBuffer = heapBuffer;\r\n  }\r\n\r\n  return {\r\n    buffer: bridge.cachedSpeciesClusterView,\r\n    count: Math.floor(floatCount / 6),\r\n  };\r\n}\r\n\r\nfunction getSpeciesSchoolClustersInternal(bridge) {\r\n  if (!bridge?.wasm) {\r\n    return null;\r\n  }\r\n  if (\r\n    typeof bridge.speciesSchoolClustersPtrHandle !== 'function' ||\r\n    typeof bridge.speciesSchoolClustersCountHandle !== 'function'\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  const floatCount = bridge.speciesSchoolClustersCountHandle();\r\n  const ptr = bridge.speciesSchoolClustersPtrHandle();\r\n  if (!ptr || !floatCount || floatCount <= 0) {\r\n    bridge.cachedSpeciesSchoolClusterPtr = 0;\r\n    bridge.cachedSpeciesSchoolClusterCount = 0;\r\n    bridge.cachedSpeciesSchoolClusterView = null;\r\n    return null;\r\n  }\r\n\r\n  const heapBuffer = bridge.wasm.HEAPF32.buffer;\r\n  if (\r\n    bridge.cachedSpeciesSchoolClusterView === null ||\r\n    bridge.cachedSpeciesSchoolClusterPtr !== ptr ||\r\n    bridge.cachedSpeciesSchoolClusterCount !== floatCount ||\r\n    bridge.cachedHeapBuffer !== heapBuffer\r\n  ) {\r\n    bridge.cachedSpeciesSchoolClusterPtr = ptr;\r\n    bridge.cachedSpeciesSchoolClusterCount = floatCount;\r\n    bridge.cachedSpeciesSchoolClusterView = new Float32Array(heapBuffer, ptr, floatCount);\r\n    bridge.cachedHeapBuffer = heapBuffer;\r\n  }\r\n\r\n  return {\r\n    buffer: bridge.cachedSpeciesSchoolClusterView,\r\n    count: Math.floor(floatCount / 6),\r\n  };\r\n}\r\n","import { reactive, computed, toRaw } from 'vue';\r\n\r\nconst STORAGE_KEY = 'boids_settings';\r\n// \r\n// - // +1 \r\n// - =localStorage \r\n//   \r\nconst SETTINGS_SCHEMA_MAJOR_VERSION = 2;\r\nconst STORAGE_VERSION_KEY = 'boids_settings_schema_major';\r\nconst DEFAULT_SPECIES_FALLBACK = {\r\n  species: 'Species',\r\n  count: 10000,\r\n  cohesion: 12.5,\r\n  cohesionRange: 5,\r\n  separation: 2.15,\r\n  separationRange: 0.4,\r\n  alignment: 8.0,\r\n  alignmentRange: 1,\r\n  maxSpeed: 0.35,\r\n  minSpeed: 0,\r\n  // maxTurnAngle \r\n  maxTurnAngle: 0.75,\r\n  maxNeighbors: 4,\r\n  horizontalTorque: 0.03,\r\n  torqueStrength: 1.0,\r\n  lambda: 0.8,\r\n  tau: 0.8,\r\n  velocityEpsilon: 0.0001,\r\n  predatorAlertRadius: 1,\r\n  isPredator: false,\r\n  speciesId: 0,\r\n  densityReturnStrength: 10.0,\r\n};\r\n\r\n/**\r\n * Flock //\r\n * localStorage Vue \r\n */\r\nexport function createFlockSettingsStore(defaultSettings = [], defaultSystem = {}) {\r\n  const defaultTemplates = sanitizeSpeciesList(defaultSettings, defaultSettings);\r\n  const systemDefaults = { ...defaultSystem };\r\n  const settings = reactive([]);\r\n  const systemSettings = reactive({});\r\n\r\n  // \r\n  replaceSettings(defaultTemplates);\r\n  assignSystemSettings(systemDefaults);\r\n\r\n  // \r\n  // \r\n  if (shouldResetStorageBySchemaMajor()) {\r\n    // NOTE:\r\n    // (count)\r\n    // /\r\n    const previousCounts = tryLoadSpeciesCountsFromStorage();\r\n\r\n    clearSettingsStorage();\r\n    replaceSettings(defaultTemplates);\r\n    assignSystemSettings(systemDefaults);\r\n    applySpeciesCounts(settings, previousCounts);\r\n\r\n    // saveToStorage() \r\n    saveToStorage();\r\n  } else if (!loadFromStorage()) {\r\n    replaceSettings(defaultTemplates);\r\n    assignSystemSettings(systemDefaults);\r\n  }\r\n\r\n  const totalBoids = computed(() => getTotalBoidCount(settings));\r\n\r\n  function loadFromStorage() {\r\n    if (typeof localStorage === 'undefined') {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const saved = localStorage.getItem(STORAGE_KEY);\r\n      if (!saved) {\r\n        return false;\r\n      }\r\n      const parsed = JSON.parse(saved);\r\n      if (Array.isArray(parsed) && parsed.length > 0) {\r\n        replaceSettings(parsed);\r\n        return true;\r\n      }\r\n      if (parsed && typeof parsed === 'object') {\r\n        if (Array.isArray(parsed.species) && parsed.species.length > 0) {\r\n          replaceSettings(parsed.species);\r\n        }\r\n        if (parsed.system && typeof parsed.system === 'object') {\r\n          assignSystemSettings(parsed.system);\r\n        }\r\n        return true;\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to load settings from localStorage:', error);\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * localStorage \r\n   * - /{species, system}\r\n   */\r\n  function readStorageSnapshot() {\r\n    if (typeof localStorage === 'undefined') {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const saved = localStorage.getItem(STORAGE_KEY);\r\n      if (!saved) {\r\n        return null;\r\n      }\r\n      const parsed = JSON.parse(saved);\r\n      if (Array.isArray(parsed)) {\r\n        return { species: parsed, system: null };\r\n      }\r\n      if (parsed && typeof parsed === 'object') {\r\n        return {\r\n          species: Array.isArray(parsed.species) ? parsed.species : null,\r\n          system: parsed.system && typeof parsed.system === 'object' ? parsed.system : null,\r\n        };\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to parse settings snapshot from localStorage:', error);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * (count)\r\n   * - speciesId \r\n   * -  species  + predator \r\n   */\r\n  function tryLoadSpeciesCountsFromStorage() {\r\n    const snapshot = readStorageSnapshot();\r\n    const list = snapshot?.species;\r\n    if (!Array.isArray(list)) {\r\n      return new Map();\r\n    }\r\n\r\n    const counts = new Map();\r\n    list.forEach((entry) => {\r\n      if (!entry || typeof entry !== 'object') {\r\n        return;\r\n      }\r\n      const rawCount = Number(entry.count);\r\n      if (!Number.isFinite(rawCount)) {\r\n        return;\r\n      }\r\n      const count = Math.max(0, Math.floor(rawCount));\r\n      const isPredator = Boolean(entry.isPredator);\r\n      const species = typeof entry.species === 'string' ? entry.species : '';\r\n      const speciesId = Number(entry.speciesId);\r\n\r\n      if (Number.isFinite(speciesId)) {\r\n        counts.set(`id:${speciesId}|pred:${isPredator}`, count);\r\n      }\r\n      if (species) {\r\n        counts.set(`name:${species}|pred:${isPredator}`, count);\r\n      }\r\n    });\r\n    return counts;\r\n  }\r\n\r\n  /**\r\n   * settings \r\n   * - \r\n   */\r\n  function applySpeciesCounts(targetSettings, countsMap) {\r\n    if (!Array.isArray(targetSettings) || !(countsMap instanceof Map)) {\r\n      return;\r\n    }\r\n\r\n    targetSettings.forEach((entry) => {\r\n      if (!entry || typeof entry !== 'object') {\r\n        return;\r\n      }\r\n      const isPredator = Boolean(entry.isPredator);\r\n      const speciesId = Number(entry.speciesId);\r\n      const species = typeof entry.species === 'string' ? entry.species : '';\r\n\r\n      let nextCount;\r\n      if (Number.isFinite(speciesId)) {\r\n        nextCount = countsMap.get(`id:${speciesId}|pred:${isPredator}`);\r\n      }\r\n      if (!Number.isFinite(nextCount) && species) {\r\n        nextCount = countsMap.get(`name:${species}|pred:${isPredator}`);\r\n      }\r\n      if (Number.isFinite(nextCount)) {\r\n        entry.count = Math.max(0, Math.floor(nextCount));\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * localStorage \r\n   * NOTE:  saveToStorage() \r\n   */\r\n  function clearSettingsStorage() {\r\n    if (typeof localStorage === 'undefined') {\r\n      return false;\r\n    }\r\n    try {\r\n      localStorage.removeItem(STORAGE_KEY);\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('Failed to clear settings in localStorage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  true\r\n   * - \r\n   */\r\n  function shouldResetStorageBySchemaMajor() {\r\n    if (typeof localStorage === 'undefined') {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const raw = localStorage.getItem(STORAGE_VERSION_KEY);\r\n      if (!raw) {\r\n        // \r\n        return true;\r\n      }\r\n\r\n      const parsed = Number(raw);\r\n      if (!Number.isFinite(parsed)) {\r\n        return true;\r\n      }\r\n\r\n      return parsed !== SETTINGS_SCHEMA_MAJOR_VERSION;\r\n    } catch (error) {\r\n      // \r\n      console.warn('Failed to read settings schema version from localStorage:', error);\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function saveToStorage() {\r\n    if (typeof localStorage === 'undefined') {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const snapshot = {\r\n        species: settings.map((entry) => ({ ...toRaw(entry) })),\r\n        system: { ...toRaw(systemSettings) },\r\n      };\r\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));\r\n      // \r\n      localStorage.setItem(STORAGE_VERSION_KEY, String(SETTINGS_SCHEMA_MAJOR_VERSION));\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('Failed to save settings to localStorage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function replaceSettings(nextList) {\r\n    const sanitized = sanitizeSpeciesList(nextList, defaultTemplates);\r\n    settings.splice(0, settings.length, ...sanitized);\r\n    return sanitized;\r\n  }\r\n\r\n  function assignSystemSettings(patch = {}) {\r\n    const merged = { ...systemDefaults, ...(patch || {}) };\r\n    Object.keys(systemSettings).forEach((key) => {\r\n      if (!(key in merged)) {\r\n        delete systemSettings[key];\r\n      }\r\n    });\r\n    Object.entries(merged).forEach(([key, value]) => {\r\n      systemSettings[key] = value;\r\n    });\r\n    return systemSettings;\r\n  }\r\n\r\n  function resetToDefaults() {\r\n    replaceSettings(defaultTemplates);\r\n    assignSystemSettings(systemDefaults);\r\n    saveToStorage();\r\n  }\r\n\r\n  function addSpecies(template) {\r\n    const basePool = settings.length > 0 ? settings : defaultTemplates;\r\n    const fallbackTemplate =\r\n      basePool.find((item) => item && !item.isPredator) ||\r\n      defaultTemplates.find((item) => item && !item.isPredator) ||\r\n      DEFAULT_SPECIES_FALLBACK;\r\n\r\n    const candidate = template\r\n      ? sanitizeSpeciesEntry(template, fallbackTemplate)\r\n      : cloneSpeciesTemplate(fallbackTemplate);\r\n\r\n    candidate.isPredator = false;\r\n    candidate.count = 0;\r\n    candidate.species = ensureUniqueName(candidate.species, new Set(settings.map((s) => s.species)));\r\n    settings.push(candidate);\r\n    return candidate;\r\n  }\r\n\r\n  function removeSpecies(index) {\r\n    if (index < 0 || index >= settings.length) {\r\n      return null;\r\n    }\r\n    const removed = settings.splice(index, 1);\r\n    return removed.length ? removed[0] : null;\r\n  }\r\n\r\n  return {\r\n    settings,\r\n    systemSettings,\r\n    totalBoids,\r\n    loadFromStorage,\r\n    saveToStorage,\r\n    replaceSettings,\r\n    assignSystemSettings,\r\n    resetToDefaults,\r\n    addSpecies,\r\n    removeSpecies,\r\n  };\r\n}\r\n\r\nfunction getTotalBoidCount(list) {\r\n  return list.reduce((sum, entry) => sum + Math.max(0, Number(entry?.count) || 0), 0);\r\n}\r\n\r\nfunction sanitizeSpeciesList(list = [], fallbackList = []) {\r\n  if (!Array.isArray(list)) {\r\n    return [];\r\n  }\r\n\r\n  const sanitized = [];\r\n  const takenNames = new Set();\r\n\r\n  list.forEach((entry, index) => {\r\n    const fallback = fallbackList[index] || fallbackList[0] || DEFAULT_SPECIES_FALLBACK;\r\n    const clean = sanitizeSpeciesEntry(entry, fallback);\r\n    clean.species = ensureUniqueName(clean.species, takenNames);\r\n    sanitized.push(clean);\r\n  });\r\n\r\n  return sanitized;\r\n}\r\n\r\nfunction sanitizeSpeciesEntry(entry = {}, fallback = DEFAULT_SPECIES_FALLBACK) {\r\n  const base = { ...DEFAULT_SPECIES_FALLBACK, ...fallback };\r\n  const merged = { ...base, ...entry };\r\n\r\n  const toFinite = (value, fallbackValue = 0) => {\r\n    const num = Number(value);\r\n    return Number.isFinite(num) ? num : fallbackValue;\r\n  };\r\n\r\n  const result = { ...merged };\r\n  result.count = Math.max(0, Math.floor(toFinite(merged.count, base.count ?? 0)));\r\n  result.maxNeighbors = Math.max(0, Math.floor(toFinite(merged.maxNeighbors, base.maxNeighbors ?? 0)));\r\n  result.speciesId = Math.max(0, Math.floor(toFinite(merged.speciesId, base.speciesId ?? 0)));\r\n\r\n  result.cohesion = toFinite(merged.cohesion, base.cohesion ?? 0);\r\n  result.cohesionRange = Math.max(0, toFinite(merged.cohesionRange, base.cohesionRange ?? 0));\r\n  result.separation = toFinite(merged.separation, base.separation ?? 0);\r\n  result.separationRange = Math.max(0, toFinite(merged.separationRange, base.separationRange ?? 0));\r\n  result.alignment = toFinite(merged.alignment, base.alignment ?? 0);\r\n  result.alignmentRange = Math.max(0, toFinite(merged.alignmentRange, base.alignmentRange ?? 0));\r\n  result.maxSpeed = Math.max(0, toFinite(merged.maxSpeed, base.maxSpeed ?? 0));\r\n  result.minSpeed = Math.max(0, toFinite(merged.minSpeed, base.minSpeed ?? 0));\r\n  // maxTurnAngle \r\n  result.maxTurnAngle = Math.max(0, toFinite(merged.maxTurnAngle, base.maxTurnAngle ?? 0));\r\n  result.horizontalTorque = toFinite(merged.horizontalTorque, base.horizontalTorque ?? 0);\r\n  result.torqueStrength = toFinite(merged.torqueStrength, base.torqueStrength ?? 0);\r\n  result.lambda = toFinite(merged.lambda, base.lambda ?? 0);\r\n  result.tau = toFinite(merged.tau, base.tau ?? 0);\r\n  result.velocityEpsilon = Math.max(0, toFinite(merged.velocityEpsilon, base.velocityEpsilon ?? 0.0001));\r\n  result.predatorAlertRadius = Math.max(0, toFinite(merged.predatorAlertRadius, base.predatorAlertRadius ?? 1));\r\n  const baseReturnStrength = base.densityReturnStrength ?? base.centerAttractStrength ?? 0;\r\n  const mergedReturnStrength =\r\n    merged.densityReturnStrength ?? merged.centerAttractStrength ?? baseReturnStrength;\r\n  result.densityReturnStrength = Math.max(0, toFinite(mergedReturnStrength, baseReturnStrength));\r\n\r\n  const speciesName = typeof merged.species === 'string' ? merged.species.trim() : '';\r\n  result.species = speciesName || base.species || DEFAULT_SPECIES_FALLBACK.species;\r\n  result.isPredator = Boolean(merged.isPredator);\r\n\r\n  return result;\r\n}\r\n\r\nfunction ensureUniqueName(name, taken, defaultName = 'Species') {\r\n  const base = typeof name === 'string' && name.trim() ? name.trim() : defaultName;\r\n  let candidate = base;\r\n  let index = 2;\r\n  while (taken.has(candidate)) {\r\n    candidate = `${base} ${index}`;\r\n    index += 1;\r\n  }\r\n  taken.add(candidate);\r\n  return candidate;\r\n}\r\n\r\nfunction cloneSpeciesTemplate(template) {\r\n  return JSON.parse(JSON.stringify(template));\r\n}\r\n","<template>\r\n  <div id=\"app\">\r\n    <div class=\"ui-overlay\">\r\n      <div class=\"ui-panel\">\r\n        <h1>Boids Simulation</h1>\r\n        <details>\r\n          <summary>Settings</summary>\r\n          <div v-for=\"(s, i) in settings\" :key=\"i\">\r\n            <Settings\r\n              :settings=\"s\"\r\n              :can-remove=\"settings.length > 1\"\r\n              @remove=\"removeSpecies(i)\"\r\n            />\r\n          </div>\r\n          <button class=\"add-species-button\" @click=\"addSpecies\">\r\n            \r\n          </button>\r\n          <button @click=\"resetSettings\" style=\"margin-bottom: 1em\">\r\n            \r\n          </button>\r\n          <br />\r\n          <div class=\"settings tuning-settings\">\r\n            <details class=\"species-section\" :open=\"false\">\r\n              <summary class=\"species-header\">\r\n                <span class=\"species-title\">Adjustment</span>\r\n              </summary>\r\n              <div class=\"species-content\">\r\n                <div class=\"setting-row\">\r\n                  <label :title=\"tuningHelp.threatDecay\"><br />(threatDecay):</label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"5\"\r\n                    step=\"0.05\"\r\n                    v-model.number=\"systemSettings.threatDecay\"\r\n                    :title=\"tuningHelp.threatDecay\"\r\n                  />\r\n                  <input\r\n                    class=\"value-input\"\r\n                    type=\"number\"\r\n                    step=\"0.05\"\r\n                    v-model.number=\"systemSettings.threatDecay\"\r\n                    :title=\"tuningHelp.threatDecay\"\r\n                  />\r\n                </div>\r\n                <div class=\"setting-row\">\r\n                  <label :title=\"tuningHelp.maxEscapeWeight\"><br />(maxEscapeWeight):</label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"1\"\r\n                    step=\"0.01\"\r\n                    v-model.number=\"systemSettings.maxEscapeWeight\"\r\n                    :title=\"tuningHelp.maxEscapeWeight\"\r\n                  />\r\n                  <input\r\n                    class=\"value-input\"\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    v-model.number=\"systemSettings.maxEscapeWeight\"\r\n                    :title=\"tuningHelp.maxEscapeWeight\"\r\n                  />\r\n                </div>\r\n                <div class=\"setting-row\">\r\n                  <label :title=\"tuningHelp.baseEscapeStrength\"><br />(baseEscapeStrength):</label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"15\"\r\n                    step=\"0.1\"\r\n                    v-model.number=\"systemSettings.baseEscapeStrength\"\r\n                    :title=\"tuningHelp.baseEscapeStrength\"\r\n                  />\r\n                  <input\r\n                    class=\"value-input\"\r\n                    type=\"number\"\r\n                    step=\"0.1\"\r\n                    v-model.number=\"systemSettings.baseEscapeStrength\"\r\n                    :title=\"tuningHelp.baseEscapeStrength\"\r\n                  />\r\n                </div>\r\n                <div class=\"setting-row\">\r\n                  <label :title=\"tuningHelp.fastAttractStrength\"><br />(fastAttractStrength):</label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"3\"\r\n                    step=\"0.05\"\r\n                    v-model.number=\"systemSettings.fastAttractStrength\"\r\n                    :title=\"tuningHelp.fastAttractStrength\"\r\n                  />\r\n                  <input\r\n                    class=\"value-input\"\r\n                    type=\"number\"\r\n                    step=\"0.05\"\r\n                    v-model.number=\"systemSettings.fastAttractStrength\"\r\n                    :title=\"tuningHelp.fastAttractStrength\"\r\n                  />\r\n                </div>\r\n                <div class=\"setting-row\">\r\n                  <label :title=\"tuningHelp.schoolPullCoefficient\"><br />(schoolPullCoefficient):</label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"0.005\"\r\n                    step=\"0.00001\"\r\n                    v-model.number=\"systemSettings.schoolPullCoefficient\"\r\n                    :title=\"tuningHelp.schoolPullCoefficient\"\r\n                  />\r\n                  <input\r\n                    class=\"value-input\"\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    step=\"0.00001\"\r\n                    v-model.number=\"systemSettings.schoolPullCoefficient\"\r\n                    :title=\"tuningHelp.schoolPullCoefficient\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </details>\r\n          </div>\r\n          <br />\r\n          <div class=\"settings tuning-settings debug-settings\">\r\n            <details class=\"species-section\" :open=\"false\">\r\n              <summary class=\"species-header\">\r\n                <span class=\"species-title\">Debug</span>\r\n              </summary>\r\n              <div class=\"species-content debug-content\">\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.enableFogPipeline\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    v-model=\"debugControls.enableFogPipeline\"\r\n                    :title=\"debugHelp.enableFogPipeline\"\r\n                  />\r\n                  /SSAO/\r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.enableShadows\">\r\n                  <input type=\"checkbox\" v-model=\"debugControls.enableShadows\" :title=\"debugHelp.enableShadows\" />\r\n                  \r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.enableTailAnimation\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    v-model=\"debugControls.enableTailAnimation\"\r\n                    :title=\"debugHelp.enableTailAnimation\"\r\n                  />\r\n                  \r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.showSpeciesEnvelopes\">\r\n                  <input type=\"checkbox\" v-model=\"showSpeciesEnvelopes\" :title=\"debugHelp.showSpeciesEnvelopes\" />\r\n                  \r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.showSpeciesClusters\">\r\n                  <input type=\"checkbox\" v-model=\"showSpeciesClusters\" :title=\"debugHelp.showSpeciesClusters\" />\r\n                  \r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.showSpeciesSchoolClusters\">\r\n                  <input type=\"checkbox\" v-model=\"showSpeciesSchoolClusters\" :title=\"debugHelp.showSpeciesSchoolClusters\" />\r\n                  \r\n                </label>\r\n                <label class=\"debug-checkbox\" :title=\"debugHelp.showWorldAxisGrid\">\r\n                  <input type=\"checkbox\" v-model=\"showWorldAxisGrid\" :title=\"debugHelp.showWorldAxisGrid\" />\r\n                  /\r\n                </label>\r\n              </div>\r\n            </details>\r\n          </div>\r\n        </details>\r\n      <div class=\"info\">\r\n        <p>Boids Count: {{ totalBoids }}</p>\r\n      </div>\r\n    </div>\r\n    </div>\r\n\r\n    <!--\r\n      HUD\r\n      \r\n      - showSpeciesEnvelopes  ON \r\n      - \r\n    -->\r\n    <pre v-if=\"showSpeciesEnvelopes && speciesEnvelopeHudText\" class=\"debug-hud\">\r\n{{ speciesEnvelopeHudText }}\r\n    </pre>\r\n\r\n    <div ref=\"threeContainer\" class=\"three-container\" />\r\n    <audio\r\n      ref=\"backgroundAudio\"\r\n      src=\"/UnderWater.mp3\"\r\n      loop\r\n      style=\"display: none\"\r\n    />\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { inject, onMounted, onUnmounted, reactive, ref, watch, toRaw } from \"vue\";\r\nimport * as THREE from \"three\";\r\nimport { OrbitControls } from \"three/examples/jsm/controls/OrbitControls.js\";\r\nimport Settings from \"./components/Settings.vue\";\r\nimport StatsGl from \"stats-gl\";\r\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\";\r\nimport { BoidInstancing } from \"./rendering/BoidInstancing.js\";\r\nimport { FogPipeline } from \"./rendering/FogPipeline.js\";\r\nimport { LightRaysOverlay } from \"./rendering/LightRaysOverlay.js\";\r\nimport { ParticleField } from \"./rendering/ParticleField.js\";\r\nimport { WasmtimeBridge } from \"./simulation/WasmtimeBridge.js\";\r\nimport { createFlockSettingsStore } from \"./state/FlockSettingsStore.js\";\r\n\r\n// WASM posRange\r\nconst DEFAULT_SIMULATION_POS_RANGE = 4;\r\n\r\nconst wasmModule = inject(\"wasmModule\");\r\nif (!wasmModule) {\r\n  console.error(\"wasmModule not provided\");\r\n}\r\n\r\nconst wasmBridge = wasmModule ? new WasmtimeBridge(wasmModule) : null;\r\n\r\n// const getUnitCount = wasmModule.cwrap('getUnitCount', 'number', []);\r\n// const getUnitParentIndicesPtr = wasmModule.cwrap('getUnitParentIndicesPtr', 'number', []);\r\n\r\nfunction detectDeviceProfile() {\r\n  const profile = {\r\n    isMobile: false,\r\n    hasIntegratedGpu: false,\r\n  };\r\n\r\n  if (typeof navigator === \"undefined\") {\r\n    return profile;\r\n  }\r\n\r\n  // \r\n  profile.isMobile =\r\n    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\r\n      navigator.userAgent\r\n    );\r\n  if (profile.isMobile) {\r\n    return profile;\r\n  }\r\n\r\n  // IntelGPUPCGPU\r\n  try {\r\n    const canvas = document.createElement(\"canvas\");\r\n    const gl = canvas.getContext(\"webgl2\") || canvas.getContext(\"webgl\");\r\n    if (gl) {\r\n      const debugInfo = gl.getExtension(\"WEBGL_debug_renderer_info\");\r\n      if (debugInfo) {\r\n        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);\r\n        if (renderer && /intel/i.test(renderer)) {\r\n          console.log(\"Detected Intel integrated GPU:\", renderer);\r\n          profile.hasIntegratedGpu = true;\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"Failed to inspect GPU characteristics:\", error);\r\n  }\r\n\r\n  return profile;\r\n}\r\n\r\nfunction fetchTreeStructure() {\r\n  return wasmBridge?.getDiagnostics?.({ treeStructure: true })?.treeStructure ?? null;\r\n}\r\nconst deviceProfile = detectDeviceProfile();\r\nconst useLowSpecPreset =\r\n  deviceProfile.isMobile || deviceProfile.hasIntegratedGpu;\r\n\r\n// DPIdevicePixelRatio>1\r\n// GPU/\r\n// 60fps pixelRatio \r\nconst MAX_RENDER_PIXEL_RATIO = useLowSpecPreset ? 1.0 : 1.5;\r\n// \r\n// NOTE: \r\nconst defaultBoidCount = useLowSpecPreset ? 5000 : 10000;\r\n\r\nconst DEFAULT_SETTINGS = [\r\n  {\r\n    species: \"Boids\", // \r\n    count: defaultBoidCount, // \r\n    // \r\n    cohesion: 3.66, // \r\n    cohesionRange: 5, // \r\n    separation: 2.15, // \r\n    separationRange: 0.4, // \r\n    alignment: 8.0, // \r\n    alignmentRange: 1, // \r\n    maxSpeed: 0.35, // \r\n    maxTurnAngle: 0.75, // \r\n    maxNeighbors: 4, // \r\n    horizontalTorque: 0.03, // \r\n    torqueStrength: 1.0, // \r\n    lambda: 0.102, // \r\n    tau: 0.5, // \r\n    predatorAlertRadius: 1.0, // \r\n    densityReturnStrength: 0.0, // \r\n    isPredator: false,\r\n  },\r\n  {\r\n    species: \"Predator\",\r\n    count: 3,\r\n    cohesion: 0.0, // \r\n    cohesionRange: 5.0,\r\n    separation: 0.0,\r\n    separationRange: 0.1,\r\n    alignment: 0.0,\r\n    alignmentRange: 1.0,\r\n    predatorAlertRadius: 0.0,\r\n    densityReturnStrength: 0.0,\r\n    maxSpeed: 2.0,\r\n    minSpeed: 1.5,\r\n    maxTurnAngle: 0.4,\r\n    maxNeighbors: 0,\r\n    lambda: 0.05,\r\n    tau: 1.0, // \r\n    horizontalTorque: 0.01,\r\n    torqueStrength: 2.5,\r\n    isPredator: true, // \r\n  },\r\n];\r\n\r\nconst DEFAULT_TUNING_SETTINGS = {\r\n  threatDecay: 1.0, // 1/sec\r\n  maxEscapeWeight: 3.5, // 01\r\n  baseEscapeStrength: 5.0, // \r\n  fastAttractStrength: 2.0, // 0\r\n  schoolPullCoefficient: 0.00003, // \r\n};\r\n  \r\n//  title \r\n// NOTE: \r\nconst tuningHelp = {\r\n  threatDecay: '',\r\n  maxEscapeWeight: '011 ',\r\n  baseEscapeStrength: '',\r\n  fastAttractStrength: '0',\r\n  schoolPullCoefficient: '',\r\n};\r\n\r\n// /\r\nconst debugHelp = {\r\n  enableFogPipeline: '/SSAO/ OFF',\r\n  enableShadows: '',\r\n  enableTailAnimation: ' OFF',\r\n  showSpeciesEnvelopes: '/',\r\n  showSpeciesClusters: '',\r\n  showSpeciesSchoolClusters: '',\r\n  showWorldAxisGrid: '/',\r\n};\r\n\r\nconst flockStore = createFlockSettingsStore(\r\n  DEFAULT_SETTINGS,\r\n  DEFAULT_TUNING_SETTINGS\r\n);\r\nconst {\r\n  settings,\r\n  systemSettings,\r\n  assignSystemSettings: syncSystemSettings,\r\n  totalBoids,\r\n  replaceSettings,\r\n  resetToDefaults,\r\n  addSpecies: addSpeciesFromStore,\r\n  removeSpecies: removeSpeciesFromStore,\r\n  saveToStorage,\r\n} = flockStore;\r\n\r\nconst tuningInitialized = ref(false);\r\n\r\n// \r\nfunction sanitizeTuningParams(raw = {}) {\r\n  const sanitized = {};\r\n  for (const [key, fallback] of Object.entries(DEFAULT_TUNING_SETTINGS)) {\r\n    const value = Number(raw[key]);\r\n    sanitized[key] = Number.isFinite(value) ? value : fallback;\r\n  }\r\n  return sanitized;\r\n}\r\n\r\n// reactive  systemSettings  wasm \r\nfunction updateSystemSettings(newValues) {\r\n  const payload = sanitizeTuningParams(newValues);\r\n  syncSystemSettings(payload);\r\n  return payload;\r\n}\r\n\r\n// wasm \r\nfunction applySystemSettingsToWasm() {\r\n  if (!wasmBridge) {\r\n    return;\r\n  }\r\n  wasmBridge.applyTuningParams(sanitizeTuningParams(systemSettings));\r\n}\r\n\r\n// \r\nfunction snapshotSettingsList(list) {\r\n  return list.map((item) => JSON.parse(JSON.stringify(toRaw(item))));\r\n}\r\n\r\nlet cachedTotalBoidCount = totalBoids.value;\r\nlet lastSpeciesSignature = getSpeciesSignature(settings);\r\nlet previousSettingsSnapshot = snapshotSettingsList(settings);\r\nlet pendingStateForReinitialize = null; // \r\nlet pendingSettingsSnapshot = null; // \r\n\r\n// localStorage \r\nfunction applySettingsSnapshot(snapshot) {\r\n  if (!Array.isArray(snapshot) || snapshot.length === 0) {\r\n    return null;\r\n  }\r\n  const sanitized = replaceSettings(snapshot);\r\n  saveToStorage();\r\n  previousSettingsSnapshot = snapshotSettingsList(settings);\r\n  return sanitized;\r\n}\r\n\r\nfunction addSpecies(template) {\r\n  const added = addSpeciesFromStore(template);\r\n  saveToStorage();\r\n  return added;\r\n}\r\n\r\nfunction removeSpecies(index) {\r\n  if (settings.length <= 1) {\r\n    return null;\r\n  }\r\n  const removed = removeSpeciesFromStore(index);\r\n  if (removed) {\r\n    saveToStorage();\r\n  }\r\n  return removed;\r\n}\r\n\r\n// Three.js  DOM \r\nconst threeContainer = ref(null);\r\nconst backgroundAudio = ref(null);\r\nlet scene, camera, renderer, controls;\r\nlet fogPipeline = null; // \r\nlet particleField = null; // \r\nlet lightRaysOverlay = null; // \r\nlet dirLight = null; // \r\nlet groundMesh = null; // \r\n\r\n/*\r\n  \r\n   OrbitControls  target \r\n  - \r\n  - cluster  WASM \r\n  -  clusterData \r\n*/\r\nconst startupCameraLookAt = {\r\n  active: true,\r\n  userInteracted: false,\r\n  controlsHooked: false,\r\n  startedAtMs: 0,\r\n  maxDurationMs: 6000,\r\n  smoothingSpeed: 4.0, // \r\n};\r\n\r\n// GC Vector3 \r\nconst startupClusterTarget = new THREE.Vector3(0, 0, 0);\r\nconst startupClusterTargetScratch = new THREE.Vector3(0, 0, 0);\r\n\r\nconst paused = ref(false);\r\n\r\n// /\r\n// - \r\n// - (pause)/\r\nconst tabAudioAutoMuteState = {\r\n  active: false,\r\n  previousMuted: false,\r\n  previousVolume: 0.1,\r\n};\r\n\r\nfunction shouldAutoMuteByTabState() {\r\n  if (typeof document === \"undefined\") {\r\n    return false;\r\n  }\r\n  const hidden = Boolean(document.hidden);\r\n  const unfocused =\r\n    typeof document.hasFocus === \"function\" ? !document.hasFocus() : false;\r\n  return hidden || unfocused;\r\n}\r\n\r\nfunction applyBackgroundAudioAutoMute() {\r\n  const audioEl = backgroundAudio.value;\r\n  if (!audioEl) {\r\n    return;\r\n  }\r\n\r\n  const shouldMute = shouldAutoMuteByTabState();\r\n\r\n  if (shouldMute) {\r\n    // /\r\n    if (audioEl.muted || !(audioEl.volume > 0)) {\r\n      return;\r\n    }\r\n    if (!tabAudioAutoMuteState.active) {\r\n      tabAudioAutoMuteState.previousMuted = audioEl.muted;\r\n      tabAudioAutoMuteState.previousVolume = audioEl.volume;\r\n      tabAudioAutoMuteState.active = true;\r\n    }\r\n    audioEl.muted = true;\r\n    return;\r\n  }\r\n\r\n  // \r\n  if (tabAudioAutoMuteState.active) {\r\n    audioEl.muted = tabAudioAutoMuteState.previousMuted;\r\n    audioEl.volume = tabAudioAutoMuteState.previousVolume;\r\n    tabAudioAutoMuteState.active = false;\r\n  }\r\n}\r\n\r\n// HUDSpecies envelope /\r\nconst speciesEnvelopeHudText = ref(\"\");\r\n\r\n//  Unit \r\nconst showUnits = ref(true);\r\nconst showUnitSpheres = ref(false);\r\nconst showUnitLines = ref(false);\r\nconst showUnitColors = ref(false);\r\nconst showSpeciesEnvelopes = ref(false);\r\nconst showSpeciesClusters = ref(false);\r\nconst showSpeciesSchoolClusters = ref(false);\r\n\r\n// Blender/\r\n// - HUD3D\r\n// - ON/OFF\r\nconst showWorldAxisGrid = ref(false);\r\nconst unitLayer = ref(1);\r\n\r\nlet unitSpheres = []; // \r\nlet unitLines = []; // \r\nlet envelopeSpheres = []; // \r\nlet envelopeGeometry = null;\r\n\r\n// /\r\nlet worldGridHelper = null;\r\nlet worldAxesHelper = null;\r\n\r\n// Species clusters \r\nlet clusterMesh = null;\r\nlet clusterGeometry = null;\r\nlet clusterMaterial = null;\r\nlet clusterMaxInstances = 0;\r\n\r\n// Species school clusters/\r\n// /\r\nlet schoolClusterMesh = null;\r\nlet schoolClusterGeometry = null;\r\nlet schoolClusterMaterial = null;\r\nlet schoolClusterMaxInstances = 0;\r\n\r\n// InstancedMesh GC\r\nconst clusterDummy = new THREE.Object3D();\r\nconst clusterColor = new THREE.Color();\r\n\r\n// InstancedMesh GC\r\nconst schoolClusterDummy = new THREE.Object3D();\r\nconst schoolClusterColor = new THREE.Color();\r\n\r\n// GPU \r\nconst debugControls = reactive({\r\n  enableFogPipeline: !deviceProfile.isMobile,\r\n  enableShadows: true,\r\n  enableTailAnimation: true,\r\n});\r\n\r\n/**\r\n * Blender3D\r\n * - GridHelper: XZ/\r\n * - AxesHelper: XYZ\r\n */\r\nfunction applyWorldAxisGridState() {\r\n  if (!scene) {\r\n    return;\r\n  }\r\n\r\n  const enabled = showWorldAxisGrid.value;\r\n\r\n  if (enabled) {\r\n    // GC\r\n    if (!worldGridHelper) {\r\n      // size=200, divisions=200 -> 1\r\n      // \r\n      worldGridHelper = new THREE.GridHelper(\r\n        200,\r\n        200,\r\n        toHex(OCEAN_COLORS.AMBIENT_LIGHT),\r\n        toHex(OCEAN_COLORS.BOTTOM_LIGHT)\r\n      );\r\n    }\r\n    if (!worldAxesHelper) {\r\n      // \r\n      worldAxesHelper = new THREE.AxesHelper(12);\r\n    }\r\n\r\n    if (!worldGridHelper.parent) {\r\n      scene.add(worldGridHelper);\r\n    }\r\n    if (!worldAxesHelper.parent) {\r\n      scene.add(worldAxesHelper);\r\n    }\r\n  } else {\r\n    // removeON\r\n    if (worldGridHelper?.parent) {\r\n      scene.remove(worldGridHelper);\r\n    }\r\n    if (worldAxesHelper?.parent) {\r\n      scene.remove(worldAxesHelper);\r\n    }\r\n  }\r\n}\r\n\r\nlet maxDepth = 1;\r\nlet stats = null; // stats-gl \r\nlet glContext = null;\r\nlet frameCounter = 0;\r\nlet flockReinitTimer = null; // \r\n\r\n// WebGL context\r\nlet rendererCanvas = null;\r\nlet webglContextLost = false;\r\nlet webglRecoveryTimer = null;\r\nlet webglRecoveryAttempt = 0;\r\nlet boidAssetsReady = false;\r\nlet resizeHooked = false;\r\n// WebGL2  WebGL1 \r\nlet forceWebgl1 = false;\r\n\r\nlet animationTimer = null;\r\n// requestAnimationFrame  vsync \r\n// setTimeout \r\nconst COUNT_REINIT_DELAY_MS = 400; // \r\n\r\nfunction applyRendererPixelRatio() {\r\n  if (!renderer || typeof window === \"undefined\") {\r\n    return;\r\n  }\r\n  const dpr = window.devicePixelRatio || 1;\r\n  renderer.setPixelRatio(Math.min(dpr, MAX_RENDER_PIXEL_RATIO));\r\n}\r\n\r\nfunction positionStatsOverlay(element) {\r\n  if (!element) return;\r\n  element.style.position = \"fixed\";\r\n  element.style.top = \"0px\";\r\n  element.style.right = \"0px\";\r\n  element.style.left = \"auto\";\r\n  element.style.bottom = \"auto\";\r\n  element.style.zIndex = \"9999\";\r\n  element.style.width = \"270px\";\r\n  element.style.height = \"48px\";\r\n  element.style.pointerEvents = \"auto\";\r\n  element.style.transform = \"none\";\r\n}\r\n\r\n/**\r\n * Species envelope+ HUD \r\n * - \r\n * - xyz \r\n */\r\nfunction updateSpeciesEnvelopeHud(envelopeData) {\r\n  const buffer = envelopeData?.buffer;\r\n  const floatCount = buffer?.length ?? 0;\r\n  const envelopeCount = Math.floor(floatCount / 5);\r\n\r\n  if (!buffer || envelopeCount <= 0) {\r\n    speciesEnvelopeHudText.value = \"\";\r\n    return;\r\n  }\r\n\r\n  // \r\n  // env[i] : center=(x,y,z) radius=r count=n\r\n  const lines = [];\r\n  for (let i = 0; i < envelopeCount; i += 1) {\r\n    const base = i * 5;\r\n    const cx = buffer[base];\r\n    const cy = buffer[base + 1];\r\n    const cz = buffer[base + 2];\r\n    const radius = buffer[base + 3];\r\n    const population = buffer[base + 4];\r\n\r\n    // 0\r\n    // \r\n    if (!(radius > 0.0001) || !(population > 0.0)) {\r\n      continue;\r\n    }\r\n\r\n    lines.push(\r\n      `env[${i}] center=(${cx.toFixed(2)}, ${cy.toFixed(2)}, ${cz.toFixed(\r\n        2\r\n      )}) radius=${radius.toFixed(2)} count=${Math.floor(population)}`\r\n    );\r\n  }\r\n\r\n  speciesEnvelopeHudText.value = lines.join(\"\\n\");\r\n}\r\n\r\n// \r\nfunction calcMaxDepth(unit, depth = 0) {\r\n  if (\r\n    !unit ||\r\n    !unit.children ||\r\n    typeof unit.children.size !== \"function\" ||\r\n    unit.children.size() === 0\r\n  ) {\r\n    return depth;\r\n  }\r\n  let max = depth;\r\n  for (let i = 0; i < unit.children.size(); i++) {\r\n    const child = unit.children.get(i);\r\n    max = Math.max(max, calcMaxDepth(child, depth + 1));\r\n  }\r\n  return max;\r\n}\r\n\r\nfunction handleKeydown(e) {\r\n  if (e.code === \"Space\") {\r\n    paused.value = !paused.value;\r\n  }\r\n}\r\n\r\nfunction applyTailAnimationDebugState() {\r\n  const enabled = debugControls.enableTailAnimation ? 1 : 0;\r\n  if (tailAnimation?.uniforms?.uTailEnable) {\r\n    tailAnimation.uniforms.uTailEnable.value = enabled;\r\n  }\r\n}\r\n\r\nfunction applyShadowDebugState() {\r\n  const enabled = debugControls.enableShadows;\r\n  if (renderer) {\r\n    renderer.shadowMap.enabled = enabled;\r\n  }\r\n  if (dirLight) {\r\n    dirLight.castShadow = enabled;\r\n    if (dirLight.shadow) {\r\n      dirLight.shadow.autoUpdate = enabled;\r\n      // ON  shadow map \r\n      // autoUpdate  OFF  shadow map \r\n      dirLight.shadow.needsUpdate = true;\r\n    }\r\n  }\r\n  if (groundMesh) {\r\n    groundMesh.receiveShadow = enabled;\r\n  }\r\n  if (instancedMeshHigh) {\r\n    instancedMeshHigh.castShadow = enabled;\r\n    instancedMeshHigh.receiveShadow = enabled;\r\n  }\r\n  if (instancedMeshLow) {\r\n    instancedMeshLow.castShadow = enabled;\r\n    instancedMeshLow.receiveShadow = enabled;\r\n  }\r\n  const predatorMeshes =\r\n    typeof boidInstancing.getPredatorMeshes === \"function\"\r\n      ? boidInstancing.getPredatorMeshes()\r\n      : [];\r\n  for (const mesh of predatorMeshes) {\r\n    if (!mesh) {\r\n      continue;\r\n    }\r\n    mesh.traverse?.((child) => {\r\n      if (child.isMesh) {\r\n        child.castShadow = enabled;\r\n        child.receiveShadow = enabled;\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction rebuildFogPipeline() {\r\n  if (!renderer || !scene || !camera) {\r\n    if (!debugControls.enableFogPipeline && fogPipeline) {\r\n      fogPipeline.dispose();\r\n      fogPipeline = null;\r\n    }\r\n    return;\r\n  }\r\n\r\n  const supportsPostProcess = renderer.capabilities?.isWebGL2;\r\n  const shouldEnable = Boolean(\r\n    debugControls.enableFogPipeline && supportsPostProcess\r\n  );\r\n\r\n  if (shouldEnable) {\r\n    if (!fogPipeline) {\r\n      fogPipeline = new FogPipeline(heightFogConfig);\r\n    }\r\n    const size = new THREE.Vector2();\r\n    renderer.getSize(size);\r\n    fogPipeline.init(renderer, scene, camera, size.x, size.y);\r\n  } else if (fogPipeline) {\r\n    fogPipeline.dispose();\r\n    fogPipeline = null;\r\n  }\r\n}\r\n\r\nfunction clearWebglRecoveryTimer() {\r\n  if (webglRecoveryTimer) {\r\n    clearTimeout(webglRecoveryTimer);\r\n    webglRecoveryTimer = null;\r\n  }\r\n}\r\n\r\nfunction detachRendererCanvas() {\r\n  const canvas = renderer?.domElement ?? rendererCanvas;\r\n  if (!canvas) {\r\n    return;\r\n  }\r\n  if (canvas.parentElement) {\r\n    canvas.parentElement.removeChild(canvas);\r\n  }\r\n}\r\n\r\nfunction disposeRendererAndPipeline() {\r\n  if (fogPipeline) {\r\n    fogPipeline.dispose();\r\n    fogPipeline = null;\r\n  }\r\n\r\n  if (lightRaysOverlay) {\r\n    lightRaysOverlay.dispose();\r\n    lightRaysOverlay = null;\r\n  }\r\n\r\n  if (renderer) {\r\n    rendererCanvas = renderer.domElement;\r\n    renderer.dispose?.();\r\n  }\r\n  renderer = null;\r\n  glContext = null;\r\n}\r\n\r\nfunction createWebglContext(canvas, preferWebgl2) {\r\n  const attrs = {\r\n    alpha: false,\r\n    antialias: true,\r\n    depth: true,\r\n    stencil: false,\r\n    preserveDrawingBuffer: false,\r\n    powerPreference: 'high-performance',\r\n    failIfMajorPerformanceCaveat: false,\r\n  };\r\n\r\n  if (preferWebgl2) {\r\n    const gl2 = canvas.getContext('webgl2', attrs);\r\n    if (gl2) {\r\n      return gl2;\r\n    }\r\n  }\r\n\r\n  // WebGL2 \r\n  return canvas.getContext('webgl', attrs) || canvas.getContext('experimental-webgl', attrs);\r\n}\r\n\r\nfunction onWebglContextLost(event) {\r\n  // \r\n  event?.preventDefault?.();\r\n  webglContextLost = true;\r\n  console.warn('WebGL context lost. Scheduling recovery...');\r\n\r\n  // \r\n  if (animationTimer && typeof cancelAnimationFrame === 'function') {\r\n    cancelAnimationFrame(animationTimer);\r\n    animationTimer = null;\r\n  }\r\n\r\n  // GPU/\r\n  // NOTE: WebGL2 \r\n  //  WebGL2  WebGL1 \r\n  if (renderer?.capabilities?.isWebGL2) {\r\n    forceWebgl1 = true;\r\n    // WebGL2  canvas  WebGL1 \r\n    rendererCanvas = null;\r\n  }\r\n  disposeRendererAndPipeline();\r\n  scheduleWebglRecovery('contextlost');\r\n}\r\n\r\nfunction onWebglContextRestored() {\r\n  webglContextLost = false;\r\n  console.warn('WebGL context restored. Reinitializing renderer...');\r\n  scheduleWebglRecovery('contextrestored');\r\n}\r\n\r\nfunction scheduleWebglRecovery(reason) {\r\n  if (webglRecoveryTimer) {\r\n    return;\r\n  }\r\n\r\n  // \r\n  const delayMs = Math.min(8000, 500 * Math.pow(2, webglRecoveryAttempt));\r\n  webglRecoveryAttempt = Math.min(webglRecoveryAttempt + 1, 6);\r\n\r\n  webglRecoveryTimer = setTimeout(() => {\r\n    webglRecoveryTimer = null;\r\n    try {\r\n      const ok = initThreeJS();\r\n      if (!ok) {\r\n        scheduleWebglRecovery('retry:' + reason);\r\n        return;\r\n      }\r\n\r\n      // stats-gl  renderer \r\n      if (stats && typeof stats.patchThreeRenderer === 'function') {\r\n        stats.patchThreeRenderer(renderer);\r\n      }\r\n\r\n      // GPUboids update() \r\n      // \r\n      if (boidAssetsReady) {\r\n        initInstancedBoids(cachedTotalBoidCount || totalBoids.value || 0);\r\n      }\r\n\r\n      // \r\n      if (!animationTimer) {\r\n        scheduleNextFrame();\r\n      }\r\n\r\n      // \r\n      webglRecoveryAttempt = 0;\r\n      clearWebglRecoveryTimer();\r\n    } catch (error) {\r\n      console.warn('WebGL recovery failed:', error);\r\n      scheduleWebglRecovery('error:' + reason);\r\n    }\r\n  }, delayMs);\r\n}\r\n\r\nfunction initThreeJS() {\r\n  const width = window.innerWidth;\r\n  const height = window.innerHeight;\r\n\r\n  // context lost \r\n  detachRendererCanvas();\r\n  disposeRendererAndPipeline();\r\n\r\n  //  scene \r\n  scene = null;\r\n  camera = null;\r\n  controls = null;\r\n\r\n  scene = new THREE.Scene();\r\n  scene.background = new THREE.Color(OCEAN_COLORS.DEEP_BLUE);\r\n  createOceanSphere();\r\n\r\n  camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);\r\n  camera.position.set(3, -5, 3);\r\n  camera.lookAt(0, 0, 0);\r\n\r\n  //  WebGL2  WebGL1 \r\n  // NOTE:  WebGL2 //\r\n  const canvas = rendererCanvas || document.createElement('canvas');\r\n  const preferWebgl2 = !forceWebgl1;\r\n  const context = createWebglContext(canvas, preferWebgl2);\r\n  if (!context) {\r\n    console.warn('Failed to create WebGL context (webgl2/webgl).');\r\n    rendererCanvas = canvas;\r\n    // \r\n    scheduleWebglRecovery('init');\r\n    return false;\r\n  }\r\n\r\n  // WebGL2  WebGL1  WebGL1 \r\n  // WebGL2 \r\n  const isWebgl2 = (typeof WebGL2RenderingContext !== 'undefined') && (context instanceof WebGL2RenderingContext);\r\n  if (preferWebgl2 && !isWebgl2) {\r\n    forceWebgl1 = true;\r\n  }\r\n\r\n  renderer = new THREE.WebGLRenderer({\r\n    canvas,\r\n    context,\r\n    antialias: true,\r\n    depth: true,\r\n  });\r\n  //  sRGB \r\n  renderer.outputColorSpace = THREE.SRGBColorSpace;\r\n  // \r\n  renderer.toneMapping = THREE.CineonToneMapping;\r\n  renderer.toneMappingExposure = 1.5;\r\n  applyRendererPixelRatio();\r\n  renderer.setSize(width, height);\r\n  renderer.shadowMap.enabled = debugControls.enableShadows;\r\n  renderer.shadowMap.type = THREE.PCFShadowMap; // \r\n\r\n  glContext = renderer.getContext();\r\n\r\n  // context lost/restore \r\n  // canvas\r\n  rendererCanvas = renderer.domElement;\r\n  rendererCanvas.addEventListener('webglcontextlost', onWebglContextLost, false);\r\n  rendererCanvas.addEventListener('webglcontextrestored', onWebglContextRestored, false);\r\n\r\n  threeContainer.value.appendChild(renderer.domElement);\r\n\r\n  camera.aspect = width / height;\r\n  camera.updateProjectionMatrix();\r\n\r\n  controls = new OrbitControls(camera, renderer.domElement);\r\n  controls.enableDamping = true; // \r\n  controls.dampingFactor = 0.1;\r\n\r\n  // \r\n  // OrbitControls  start \r\n  startupCameraLookAt.active = true;\r\n  startupCameraLookAt.userInteracted = false;\r\n  startupCameraLookAt.startedAtMs = performance.now();\r\n  if (!startupCameraLookAt.controlsHooked) {\r\n    startupCameraLookAt.controlsHooked = true;\r\n    controls.addEventListener(\"start\", () => {\r\n      startupCameraLookAt.userInteracted = true;\r\n    });\r\n  }\r\n\r\n  // \r\n  const groundGeo = new THREE.PlaneGeometry(300, 300);\r\n  const groundMat = createFadeOutGroundMaterial();\r\n  groundMat.depthTest = true;\r\n  groundMesh = new THREE.Mesh(groundGeo, groundMat);\r\n  groundMesh.rotation.x = -Math.PI / 2;\r\n  groundMesh.position.y = -10;\r\n  groundMesh.receiveShadow = true; // \r\n  scene.add(groundMesh);\r\n\r\n  // \r\n  const ambientLight = new THREE.AmbientLight(\r\n    toHex(OCEAN_COLORS.AMBIENT_LIGHT),\r\n    0.8\r\n  );\r\n  scene.add(ambientLight);\r\n\r\n  // DirectionalLight\r\n  dirLight = new THREE.DirectionalLight(toHex(OCEAN_COLORS.SUN_LIGHT), 12); // \r\n  dirLight.position.set(300, 500, 200); // \r\n  dirLight.castShadow = true;\r\n\r\n  // \r\n  dirLight.shadow.camera.left = -100;\r\n  dirLight.shadow.camera.right = 100;\r\n  dirLight.shadow.camera.top = 100;\r\n  dirLight.shadow.camera.bottom = -100;\r\n  dirLight.shadow.camera.near = 1;\r\n  dirLight.shadow.camera.far = 1200;\r\n  dirLight.shadow.camera.updateProjectionMatrix();\r\n\r\n  dirLight.shadow.mapSize.width = 768;\r\n  dirLight.shadow.mapSize.height = 768;\r\n  dirLight.shadow.bias = -0.01;\r\n  dirLight.shadow.normalBias = 0.01;\r\n\r\n  scene.add(dirLight);\r\n\r\n  // \r\n  // NOTE: //SSAO/Bloom \r\n  lightRaysOverlay = new LightRaysOverlay({\r\n    color: new THREE.Color(OCEAN_COLORS.SKY_HIGHLIGHT),\r\n  });\r\n  lightRaysOverlay.init();\r\n\r\n  initParticleSystem();\r\n  rebuildFogPipeline();\r\n  applyShadowDebugState();\r\n  applyTailAnimationDebugState();\r\n  applyWorldAxisGridState();\r\n  // \r\n  if (!resizeHooked) {\r\n    resizeHooked = true;\r\n    window.addEventListener(\"resize\", onWindowResize);\r\n  }\r\n\r\n  webglContextLost = false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * species clusters 6 float/1 cluster\r\n * : (speciesId, cx, cy, cz, radius, weight)\r\n * - weight \r\n * -  clusterweight>0\r\n */\r\nfunction computeSpeciesClusterWeightedCenter(clusterData, outCenter) {\r\n  const buffer = clusterData?.buffer;\r\n  const floatCount = buffer?.length ?? 0;\r\n  const clusterCount = Math.floor(floatCount / 6);\r\n\r\n  if (!buffer || clusterCount <= 0) {\r\n    return false;\r\n  }\r\n\r\n  let sumX = 0;\r\n  let sumY = 0;\r\n  let sumZ = 0;\r\n  let sumW = 0;\r\n\r\n  for (let i = 0; i < clusterCount; i += 1) {\r\n    const base = i * 6;\r\n    const cx = buffer[base + 1];\r\n    const cy = buffer[base + 2];\r\n    const cz = buffer[base + 3];\r\n    const weight = Math.max(0, buffer[base + 5] || 0);\r\n\r\n    if (!(weight > 0.0)) {\r\n      continue;\r\n    }\r\n\r\n    // weight \r\n    const clamped = Math.min(weight, 50000);\r\n    sumX += cx * clamped;\r\n    sumY += cy * clamped;\r\n    sumZ += cz * clamped;\r\n    sumW += clamped;\r\n  }\r\n\r\n  if (!(sumW > 0)) {\r\n    return false;\r\n  }\r\n\r\n  outCenter.set(sumX / sumW, sumY / sumW, sumZ / sumW);\r\n  return true;\r\n}\r\n\r\nfunction shouldAutoLookAtClusterCenter() {\r\n  if (!startupCameraLookAt.active || startupCameraLookAt.userInteracted) {\r\n    return false;\r\n  }\r\n  if (!camera || !controls) {\r\n    return false;\r\n  }\r\n  const elapsed = performance.now() - startupCameraLookAt.startedAtMs;\r\n  return elapsed >= 0 && elapsed <= startupCameraLookAt.maxDurationMs;\r\n}\r\n\r\nfunction updateStartupCameraLookAt(clusterData, deltaTime) {\r\n  if (!shouldAutoLookAtClusterCenter()) {\r\n    return;\r\n  }\r\n\r\n  // deltaTime \r\n  const safeDeltaTime = Math.min(Math.max(deltaTime, 0), 0.1);\r\n  const smoothing = 1.0 - Math.exp(-startupCameraLookAt.smoothingSpeed * safeDeltaTime);\r\n\r\n  const hasTarget = computeSpeciesClusterWeightedCenter(\r\n    clusterData,\r\n    startupClusterTargetScratch\r\n  );\r\n\r\n  if (hasTarget) {\r\n    startupClusterTarget.copy(startupClusterTargetScratch);\r\n  }\r\n\r\n  //  cluster \r\n  controls.target.lerp(startupClusterTarget, smoothing);\r\n}\r\n\r\nfunction onWindowResize() {\r\n  const width = window.innerWidth;\r\n  const height = window.innerHeight;\r\n  camera.aspect = width / height;\r\n  camera.updateProjectionMatrix();\r\n  applyRendererPixelRatio();\r\n  renderer.setSize(width, height);\r\n  fogPipeline?.resize(width, height);\r\n}\r\n\r\nfunction createSinCosLutTexture(size) {\r\n  const data = new Uint8Array(size * 4);\r\n  for (let i = 0; i < size; i++) {\r\n    const angle = (i / size) * Math.PI * 2;\r\n    const sinValue = Math.sin(angle);\r\n    const cosValue = Math.cos(angle);\r\n    data[i * 4] = Math.round((sinValue * 0.5 + 0.5) * 255);\r\n    data[i * 4 + 1] = Math.round((cosValue * 0.5 + 0.5) * 255);\r\n    data[i * 4 + 2] = 0;\r\n    data[i * 4 + 3] = 255;\r\n  }\r\n  const texture = new THREE.DataTexture(data, size, 1, THREE.RGBAFormat);\r\n  texture.needsUpdate = true;\r\n  texture.wrapS = THREE.RepeatWrapping;\r\n  texture.wrapT = THREE.ClampToEdgeWrapping;\r\n  texture.magFilter = THREE.LinearFilter;\r\n  texture.minFilter = THREE.LinearFilter;\r\n  texture.generateMipmaps = false;\r\n  texture.flipY = false;\r\n  return texture;\r\n}\r\n\r\nconst TRIPLE_BUFFER_SIZE = 3; // BoidInstancing \r\nconst HIDDEN_POSITION = 1e6; // \r\nconst IDENTITY_QUATERNION = [0, 0, 0, 1]; // \r\nconst SIN_LUT_SIZE = 256; //  LUT \r\nconst sinCosLutTexture = createSinCosLutTexture(SIN_LUT_SIZE);\r\n// LOD: LOD+LOD\r\nconst LOD_DISTANCE_PRESET = deviceProfile.isMobile\r\n  ? { nearSq: 1.5, midSq: 9 } // LOD\r\n  : { nearSq: 4, midSq: 25 }; // PC \r\nconst LOD_NEAR_DISTANCE_SQ = LOD_DISTANCE_PRESET.nearSq;\r\nconst LOD_MID_DISTANCE_SQ = LOD_DISTANCE_PRESET.midSq;\r\nconst tailAnimation = {\r\n  uniforms: {\r\n    uTailTime: { value: 0 }, // \r\n    uTailAmplitude: { value: 0.14 }, // \r\n    uTailFrequency: { value: 10.0 }, // \r\n    uTailPhaseStride: { value: 5.0 }, // \r\n    uTailTurnStrength: { value: 0.1 }, // \r\n    uTailSpeedScale: { value: 1 }, // \r\n    uTailRight: { value: new THREE.Vector3(1, 0, 0) }, // \r\n    uTailForward: { value: new THREE.Vector3(0, 0, 1) }, // \r\n    uTailUp: { value: new THREE.Vector3(0, 1, 0) }, // \r\n    uTailEnable: { value: 1 }, // /\r\n    uSinLut: { value: sinCosLutTexture },\r\n    uLutSize: { value: SIN_LUT_SIZE },\r\n  },\r\n};\r\n\r\nconst boidInstancing = new BoidInstancing({\r\n  tailAnimation,\r\n  tripleBufferSize: TRIPLE_BUFFER_SIZE,\r\n  hiddenPosition: HIDDEN_POSITION,\r\n  identityQuaternion: IDENTITY_QUATERNION,\r\n  lodNearDistanceSq: LOD_NEAR_DISTANCE_SQ,\r\n  lodMidDistanceSq: LOD_MID_DISTANCE_SQ,\r\n});\r\n\r\nlet instancedMeshHigh = null;\r\nlet instancedMeshLow = null;\r\n\r\n// \r\nconst OCEAN_COLORS = {\r\n  SKY_HIGHLIGHT: \"#4fbaff\",\r\n  SKY_BLUE: \"#15a1ff\",\r\n  DEEP_BLUE: \"#05337a\",\r\n  SEAFLOOR: \"#777465\",\r\n  AMBIENT_LIGHT: \"#59a5eb\",\r\n  SUN_LIGHT: \"#5389b7\",\r\n  SIDE_LIGHT1: \"#6ba3d0\",\r\n  SIDE_LIGHT2: \"#2d5f7a\",\r\n  BOTTOM_LIGHT: \"#0f2635\",\r\n};\r\n\r\n// '#rrggbb'  three.js \r\nconst toHex = (colorStr) => parseInt(colorStr.replace(\"#\", \"0x\"), 16);\r\n\r\n// \r\nconst heightFogConfig = {\r\n  color: new THREE.Color(OCEAN_COLORS.DEEP_BLUE), // \r\n  distanceStart: 2.0, // \r\n  distanceEnd: 20.0, // \r\n  // \r\n  distanceExponent: 0.4, // \r\n  distanceControlPoint1: new THREE.Vector2(0.15, 0.20), // \r\n  distanceControlPoint2: new THREE.Vector2(0.88, 0.90), // \r\n  surfaceLevel: 100.0, // \r\n  heightFalloff: 0.015, // \r\n  heightExponent: 1, // \r\n  maxOpacity: 0.4, // \r\n};\r\n\r\nfunction createOceanSphere() {\r\n  if (!scene) return null;\r\n\r\n  // \r\n  const canvas = document.createElement(\"canvas\");\r\n  const context = canvas.getContext(\"2d\");\r\n  canvas.width = 512;\r\n  canvas.height = 512;\r\n\r\n  const gradient = context.createLinearGradient(0, 0, 0, canvas.height);\r\n  gradient.addColorStop(0, OCEAN_COLORS.SKY_HIGHLIGHT);\r\n  gradient.addColorStop(0.2, OCEAN_COLORS.SKY_BLUE);\r\n  gradient.addColorStop(0.6, OCEAN_COLORS.DEEP_BLUE);\r\n  gradient.addColorStop(1, OCEAN_COLORS.DEEP_BLUE);\r\n\r\n  context.fillStyle = gradient;\r\n  context.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n  const texture = new THREE.CanvasTexture(canvas);\r\n  texture.colorSpace = THREE.SRGBColorSpace;\r\n  texture.generateMipmaps = false;\r\n  texture.minFilter = THREE.LinearFilter;\r\n  texture.magFilter = THREE.LinearFilter;\r\n\r\n  const sphereGeo = new THREE.SphereGeometry(300, 32, 32);\r\n  const sphereMat = new THREE.MeshBasicMaterial({\r\n    map: texture,\r\n    side: THREE.BackSide,\r\n    fog: false,\r\n  });\r\n\r\n  const oceanSphere = new THREE.Mesh(sphereGeo, sphereMat);\r\n  scene.add(oceanSphere);\r\n  return oceanSphere;\r\n}\r\n\r\nfunction createFadeOutGroundMaterial() {\r\n  const textureLoader = new THREE.TextureLoader();\r\n  const alphaMap = textureLoader.load(\"./models/groundAlfa.png\");\r\n\r\n  alphaMap.minFilter = THREE.LinearFilter;\r\n  alphaMap.magFilter = THREE.LinearFilter;\r\n  alphaMap.wrapS = THREE.ClampToEdgeWrapping;\r\n  alphaMap.wrapT = THREE.ClampToEdgeWrapping;\r\n\r\n  const material = new THREE.MeshStandardMaterial({\r\n    color: toHex(OCEAN_COLORS.SEAFLOOR),\r\n    transparent: true,\r\n    alphaMap,\r\n    depthWrite: true,\r\n  });\r\n\r\n  material.roughness = 0.85;\r\n  material.metalness = 0.0;\r\n  return material;\r\n}\r\n\r\nfunction updateInstancingMaterialUniforms(time) {\r\n  boidInstancing.setTailUniformTime(time);\r\n  particleField?.setTime(time);\r\n}\r\n\r\nlet shaderTime = 0;\r\n\r\n// WebGL2\r\nfunction initParticleSystem() {\r\n  if (!scene || !renderer) {\r\n    return;\r\n  }\r\n  if (!particleField) {\r\n    particleField = new ParticleField(useLowSpecPreset);\r\n  }\r\n  particleField.init(scene, renderer, camera, controls);\r\n}\r\n\r\n// \r\nfunction updateParticleUniforms() {\r\n  particleField?.update(camera, controls);\r\n}\r\n\r\nfunction initBackgroundAudioPlayback() {\r\n  const audioEl = backgroundAudio.value;\r\n  if (!audioEl) {\r\n    return;\r\n  }\r\n\r\n  audioEl.volume = 0.1;\r\n  audioEl.loop = true;\r\n\r\n  const tryPlay = () => {\r\n    const playResult = audioEl.play();\r\n    if (playResult && typeof playResult.then === \"function\") {\r\n      playResult.catch(() => {\r\n        const resume = () => {\r\n          document.removeEventListener(\"pointerdown\", resume);\r\n          document.removeEventListener(\"keydown\", resume);\r\n          audioEl.play().catch(() => {\r\n            /* ignored */\r\n          });\r\n        };\r\n        document.addEventListener(\"pointerdown\", resume, { once: true });\r\n        document.addEventListener(\"keydown\", resume, { once: true });\r\n      });\r\n    }\r\n  };\r\n\r\n  tryPlay();\r\n\r\n  // \r\n  applyBackgroundAudioAutoMute();\r\n}\r\n\r\nfunction stepSimulationAndUpdateState(deltaTime) {\r\n  if (!wasmBridge) {\r\n    return 0;\r\n  }\r\n  return wasmBridge.stepSimulation(deltaTime);\r\n}\r\n\r\nfunction getWasmViews(count) {\r\n  if (!wasmBridge) {\r\n    return {\r\n      positions: new Float32Array(0),\r\n      orientations: new Float32Array(0),\r\n      velocities: new Float32Array(0),\r\n      speciesIds: new Int32Array(0),\r\n    };\r\n  }\r\n  return wasmBridge.getBuffers(count);\r\n}\r\n\r\n// \r\nfunction captureFlockState() {\r\n  return wasmBridge?.captureState() ?? null;\r\n}\r\n\r\n// \r\nfunction restoreFlockState(previousState, oldSettings, newSettings) {\r\n  wasmBridge?.restoreState(previousState, oldSettings, newSettings);\r\n}\r\n\r\n// 3D \r\nlet boidModel = null;\r\nlet boidModelLod = null;\r\nlet originalMaterial = null;\r\nlet originalMaterialLod = null;\r\nlet predatorModel = null;\r\nlet predatorMaterial = null;\r\n\r\n//  Unit OFFON \r\nlet lastShowUnitColors = false;\r\n\r\n// \r\nfunction getPredatorCount() {\r\n  return settings.reduce(\r\n    (sum, s) => sum + (s.isPredator && s.count ? s.count : 0),\r\n    0\r\n  );\r\n}\r\n\r\n//  Boid \r\nfunction getTotalBoidCount() {\r\n  return totalBoids.value;\r\n}\r\n\r\n// \r\nfunction getSpeciesSignature(specList = settings) {\r\n  if (!Array.isArray(specList)) {\r\n    return \"\";\r\n  }\r\n  return specList\r\n    .map(\r\n      (s, index) =>\r\n        `${index}:${(s && s.count) || 0}:${s && s.isPredator ? 1 : 0}`\r\n    )\r\n    .join(\"|\");\r\n}\r\n\r\n// \r\nfunction reinitializeFlockNow() {\r\n  if (!wasmModule || !wasmBridge) return;\r\n\r\n  const pendingState = pendingStateForReinitialize?.state || null;\r\n  const oldSettingsRef =\r\n    pendingStateForReinitialize?.oldSettings || previousSettingsSnapshot;\r\n  const newSettingsRef =\r\n    pendingSettingsSnapshot || snapshotSettingsList(settings);\r\n  const targetSignature = getSpeciesSignature(newSettingsRef);\r\n\r\n  try {\r\n    //  Bridge \r\n    wasmBridge.initializeFlock(newSettingsRef, {\r\n      spatialScale: 1,\r\n      posRange: DEFAULT_SIMULATION_POS_RANGE,\r\n      velRange: 0.25,\r\n      groundPlane: {\r\n        enabled: true,\r\n        height: groundMesh?.position?.y ?? -10,\r\n        blendDistance: 1,\r\n        stiffness: 22,\r\n        damping: 10,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"\", error);\r\n    applySettingsSnapshot(previousSettingsSnapshot);\r\n    pendingStateForReinitialize = null;\r\n    pendingSettingsSnapshot = null;\r\n    return;\r\n  }\r\n  const total = getTotalBoidCount();\r\n  cachedTotalBoidCount = total;\r\n  initInstancedBoids(total);\r\n\r\n  if (pendingState?.count > 0) {\r\n    restoreFlockState(pendingState, oldSettingsRef, newSettingsRef);\r\n  }\r\n\r\n  lastSpeciesSignature = targetSignature;\r\n  previousSettingsSnapshot = newSettingsRef;\r\n  pendingStateForReinitialize = null;\r\n  pendingSettingsSnapshot = null;\r\n}\r\n\r\n// \r\nfunction scheduleFlockReinitialize() {\r\n  if (flockReinitTimer) {\r\n    clearTimeout(flockReinitTimer);\r\n  }\r\n\r\n  if (!pendingStateForReinitialize) {\r\n    pendingStateForReinitialize = {\r\n      state: captureFlockState(),\r\n      oldSettings: previousSettingsSnapshot,\r\n    };\r\n  }\r\n\r\n  pendingSettingsSnapshot = snapshotSettingsList(settings);\r\n\r\n  flockReinitTimer = setTimeout(() => {\r\n    flockReinitTimer = null;\r\n    reinitializeFlockNow();\r\n  }, COUNT_REINIT_DELAY_MS);\r\n}\r\n\r\n// \r\nfunction initInstancedBoids(count) {\r\n  if (\r\n    !scene ||\r\n    !boidModel ||\r\n    !boidModelLod ||\r\n    !originalMaterial ||\r\n    !originalMaterialLod\r\n  ) {\r\n    console.warn(\"initInstancedBoids: required assets are not ready\");\r\n    return;\r\n  }\r\n\r\n  const initialized = boidInstancing.init(scene, {\r\n    count,\r\n    boidModel,\r\n    boidModelLod,\r\n    highMaterial: originalMaterial,\r\n    lowMaterial: originalMaterialLod,\r\n    predatorModel,\r\n  });\r\n\r\n  if (!initialized) {\r\n    console.error(\"Failed to initialize boid instancing\");\r\n    return;\r\n  }\r\n\r\n  const meshes = boidInstancing.getMeshes();\r\n  instancedMeshHigh = meshes.high;\r\n  instancedMeshLow = meshes.low;\r\n\r\n  // \r\n  const predatorCount = getPredatorCount();\r\n  if (typeof boidInstancing.ensurePredatorMeshes === \"function\") {\r\n    boidInstancing.ensurePredatorMeshes(predatorCount);\r\n  }\r\n\r\n  applyShadowDebugState();\r\n\r\n  if (instancedMeshHigh?.instanceColor) {\r\n    instancedMeshHigh.instanceColor.needsUpdate = true;\r\n  }\r\n  if (instancedMeshLow?.instanceColor) {\r\n    instancedMeshLow.instanceColor.needsUpdate = true;\r\n  }\r\n}\r\n\r\nfunction loadBoidModel(callback) {\r\n  const loader = new GLTFLoader();\r\n  const basePath = process.env.BASE_URL || \"/\"; // publicPath \r\n  const textureLoader = new THREE.TextureLoader();\r\n  let pendingAssets = 3;\r\n  const notifyReady = () => {\r\n    pendingAssets = Math.max(0, pendingAssets - 1);\r\n    if (pendingAssets === 0) {\r\n      callback();\r\n    }\r\n  };\r\n  const texture = textureLoader.load(\r\n    \"./models/fish.png\", // \r\n    () => {\r\n      console.log(\"Texture loaded successfully.\");\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\"An error occurred while loading the texture:\", error);\r\n    }\r\n  );\r\n  const textureLod = textureLoader.load(\r\n    \"./models/fish_lod.png\", // \r\n    () => {\r\n      console.log(\"Texture loaded successfully.\");\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\"An error occurred while loading the texture:\", error);\r\n    }\r\n  );\r\n  texture.flipY = false;\r\n  texture.colorSpace = THREE.SRGBColorSpace; // sRGB\r\n  textureLod.flipY = false;\r\n  textureLod.colorSpace = THREE.SRGBColorSpace;\r\n\r\n  const predatorTexture = textureLoader.load(\r\n    \"./models/fishPredetor.png\",\r\n    () => {\r\n      console.log(\"Predator texture loaded successfully.\");\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\r\n        \"An error occurred while loading the predator texture:\",\r\n        error\r\n      );\r\n    }\r\n  );\r\n  predatorTexture.flipY = false;\r\n  predatorTexture.colorSpace = THREE.SRGBColorSpace;\r\n\r\n  let boidMaterial = new THREE.MeshStandardMaterial({\r\n    color: 0xffffff, // \r\n    roughness: 0.3,\r\n    metalness: 0.3,\r\n    transparent: false, // \r\n    alphaTest: 0.5, // \r\n    map: texture, // \r\n    vertexColors: false, // \r\n    vertexColor: 0xffffff,\r\n  });\r\n\r\n  let boidLodMaterial = new THREE.MeshStandardMaterial({\r\n    color: 0xffffff, // \r\n    roughness: 0.5,\r\n    metalness: 0.2,\r\n    transparent: false, // \r\n    alphaTest: 0.5, // \r\n    map: textureLod, // \r\n    vertexColors: false, // \r\n    vertexColor: 0xffffff,\r\n  });\r\n\r\n  originalMaterial = boidMaterial;\r\n  originalMaterialLod = boidLodMaterial;\r\n  predatorMaterial = new THREE.MeshStandardMaterial({\r\n    color: 0xffffff,\r\n    roughness: 0.5,\r\n    metalness: 0,\r\n    transparent: false,\r\n    alphaTest: 0.5,\r\n    map: predatorTexture,\r\n    vertexColors: false,\r\n    vertexColor: 0xffffff,\r\n  });\r\n  loader.load(\r\n    `./models/boidModel.glb`, // \r\n    (gltf) => {\r\n      boidModel = gltf.scene;\r\n\r\n      //  transparent  alphaTest \r\n      boidModel.traverse((child) => {\r\n        if (child.isMesh) {\r\n          child.material = boidMaterial; // \r\n        }\r\n      });\r\n\r\n      notifyReady();\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\"An error occurred while loading the model:\", error);\r\n      notifyReady();\r\n    }\r\n  );\r\n\r\n  loader.load(\r\n    `./models/boidModel_lod.glb`, // LOD\r\n    (gltf) => {\r\n      boidModelLod = gltf.scene;\r\n\r\n      //  transparent  alphaTest \r\n      boidModelLod.traverse((child) => {\r\n        if (child.isMesh) {\r\n          child.material = boidLodMaterial; // \r\n        }\r\n      });\r\n\r\n      notifyReady();\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\"An error occurred while loading the LOD model:\", error);\r\n      notifyReady();\r\n    }\r\n  );\r\n\r\n  loader.load(\r\n    `./models/boidPredetorModel.glb`,\r\n    (gltf) => {\r\n      predatorModel = gltf.scene;\r\n      predatorModel.traverse((child) => {\r\n        if (child.isMesh) {\r\n          child.material = predatorMaterial;\r\n          child.castShadow = true;\r\n          child.receiveShadow = true;\r\n        }\r\n      });\r\n      notifyReady();\r\n    },\r\n    undefined,\r\n    (error) => {\r\n      console.error(\r\n        \"An error occurred while loading the predator model:\",\r\n        error\r\n      );\r\n      notifyReady();\r\n    }\r\n  );\r\n}\r\n\r\nfunction clearUnitVisuals() {\r\n  for (const mesh of unitSpheres) scene.remove(mesh);\r\n  for (const line of unitLines) scene.remove(line);\r\n  unitSpheres = [];\r\n  unitLines = [];\r\n}\r\n\r\nfunction clearSpeciesEnvelopeVisuals() {\r\n  for (const mesh of envelopeSpheres) scene.remove(mesh);\r\n  envelopeSpheres = [];\r\n}\r\n\r\nfunction clearClusterVisuals(disposeSharedResources = true) {\r\n  if (clusterMesh) {\r\n    scene.remove(clusterMesh);\r\n    // InstancedMesh geometry/material \r\n    // disposeSharedResources=true \r\n    clusterMesh = null;\r\n    clusterMaxInstances = 0;\r\n  }\r\n  if (disposeSharedResources) {\r\n    clusterGeometry?.dispose?.();\r\n    clusterMaterial?.dispose?.();\r\n    clusterGeometry = null;\r\n    clusterMaterial = null;\r\n  }\r\n}\r\n\r\nfunction clearSchoolClusterVisuals(disposeSharedResources = true) {\r\n  if (schoolClusterMesh) {\r\n    scene.remove(schoolClusterMesh);\r\n    // InstancedMesh geometry/material \r\n    // disposeSharedResources=true \r\n    schoolClusterMesh = null;\r\n    schoolClusterMaxInstances = 0;\r\n  }\r\n\r\n  if (disposeSharedResources) {\r\n    schoolClusterGeometry?.dispose?.();\r\n    schoolClusterMaterial?.dispose?.();\r\n    schoolClusterGeometry = null;\r\n    schoolClusterMaterial = null;\r\n  }\r\n}\r\n\r\n// \r\nfunction drawUnitTree(unit, layer = 0) {\r\n  // : \r\n  if (\r\n    layer >= maxDepth - unitLayer.value + 1 &&\r\n    (unit.children == null || unit.children.size() === 0 || layer === maxDepth)\r\n  ) {\r\n    let sphere;\r\n    if (unitSpheres.length > 0) {\r\n      sphere = unitSpheres.pop(); // \r\n      sphere.visible = true;\r\n    } else {\r\n      const geometry = new THREE.SphereGeometry(unit.radius, 16, 16);\r\n      const material = new THREE.MeshBasicMaterial({\r\n        color: new THREE.Color().setHSL(0.1, 1, 0.7 - 0.4 * (layer / maxDepth)),\r\n        wireframe: true,\r\n        opacity: 0.3,\r\n        transparent: true,\r\n      });\r\n      sphere = new THREE.Mesh(geometry, material);\r\n      scene.add(sphere);\r\n    }\r\n    sphere.position.set(unit.center.x, unit.center.y, unit.center.z);\r\n    unitSpheres.push(sphere);\r\n  }\r\n\r\n  // : \r\n  if (\r\n    showUnitLines.value &&\r\n    unit.children &&\r\n    typeof unit.children.size === \"function\" &&\r\n    unit.children.size() > 0\r\n  ) {\r\n    for (let i = 0; i < unit.children.size(); i++) {\r\n      const child = unit.children.get(i);\r\n      let line;\r\n      if (unitLines.length > 0) {\r\n        line = unitLines.pop(); // \r\n        line.visible = true;\r\n      } else {\r\n        const lineGeometry = new THREE.BufferGeometry();\r\n        const lineMaterial = new THREE.LineBasicMaterial({\r\n          color: new THREE.Color().setHSL(\r\n            0.35,\r\n            1,\r\n            0.7 - 0.4 * (layer / maxDepth)\r\n          ),\r\n        });\r\n        line = new THREE.Line(lineGeometry, lineMaterial);\r\n        scene.add(line);\r\n      }\r\n      const points = [\r\n        new THREE.Vector3(unit.center.x, unit.center.y, unit.center.z),\r\n        new THREE.Vector3(child.center.x, child.center.y, child.center.z),\r\n      ];\r\n      line.geometry.setFromPoints(points);\r\n      unitLines.push(line);\r\n    }\r\n  }\r\n\r\n  // \r\n  if (\r\n    unit.children &&\r\n    typeof unit.children.size === \"function\" &&\r\n    unit.children.size() > 0\r\n  ) {\r\n    for (let i = 0; i < unit.children.size(); i++) {\r\n      const child = unit.children.get(i);\r\n      drawUnitTree(child, layer + 1);\r\n    }\r\n  }\r\n}\r\n\r\nfunction renderSpeciesEnvelopes(envelopeData) {\r\n  if (!showSpeciesEnvelopes.value) {\r\n    clearSpeciesEnvelopeVisuals();\r\n    return;\r\n  }\r\n\r\n  const buffer = envelopeData?.buffer;\r\n  const floatCount = buffer?.length ?? 0;\r\n  const envelopeCount = Math.floor(floatCount / 5);\r\n\r\n  if (!buffer || envelopeCount <= 0) {\r\n    clearSpeciesEnvelopeVisuals();\r\n    return;\r\n  }\r\n\r\n  if (!envelopeGeometry) {\r\n    envelopeGeometry = new THREE.SphereGeometry(1, 24, 18);\r\n  }\r\n\r\n  const hueSpan = 0.65;\r\n  for (let i = 0; i < envelopeCount; i += 1) {\r\n    const base = i * 5;\r\n    const radius = buffer[base + 3];\r\n    const population = buffer[base + 4];\r\n    if (radius <= 0.0001 || population <= 0.0) {\r\n      if (envelopeSpheres[i]) {\r\n        envelopeSpheres[i].visible = false;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    let mesh = envelopeSpheres[i];\r\n    if (!mesh) {\r\n      const material = new THREE.MeshBasicMaterial({\r\n        color: new THREE.Color().setHSL(0.6, 0.8, 0.45),\r\n        wireframe: true,\r\n        transparent: true,\r\n        opacity: 0.3,\r\n        depthWrite: false,\r\n      });\r\n      mesh = new THREE.Mesh(envelopeGeometry, material);\r\n      scene.add(mesh);\r\n      envelopeSpheres[i] = mesh;\r\n    }\r\n\r\n    mesh.visible = true;\r\n    mesh.position.set(buffer[base], buffer[base + 1], buffer[base + 2]);\r\n    mesh.scale.set(radius, radius, radius);\r\n    mesh.material.color.setHSL((i % 7) / 7 * hueSpan, 0.85, 0.5);\r\n    mesh.material.opacity = 0.22 + Math.min(population / 1000, 1) * 0.25;\r\n  }\r\n\r\n  for (let i = envelopeCount; i < envelopeSpheres.length; i += 1) {\r\n    if (envelopeSpheres[i]) {\r\n      envelopeSpheres[i].visible = false;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Species clusters \r\n * - 1 = 1\r\n * -  cluster.radius \r\n * - speciesId \r\n */\r\nfunction renderSpeciesClusters(clusterData) {\r\n  if (!showSpeciesClusters.value) {\r\n    clearClusterVisuals();\r\n    return;\r\n  }\r\n\r\n  const buffer = clusterData?.buffer;\r\n  const floatCount = buffer?.length ?? 0;\r\n  const clusterCount = Math.floor(floatCount / 6);\r\n\r\n  if (!buffer || clusterCount <= 0) {\r\n    clearClusterVisuals();\r\n    return;\r\n  }\r\n\r\n  if (!clusterGeometry) {\r\n    // \r\n    // InstancedMesh 1\r\n    clusterGeometry = new THREE.SphereGeometry(1, 24, 18);\r\n  }\r\n  if (!clusterMaterial) {\r\n    clusterMaterial = new THREE.MeshBasicMaterial({\r\n      transparent: true,\r\n      //   \r\n      opacity: 0.3,\r\n      depthWrite: false,\r\n      vertexColors: true,\r\n      wireframe: true,\r\n    });\r\n  }\r\n\r\n  // InstancedMesh capacity\r\n  if (!clusterMesh || clusterMaxInstances < clusterCount) {\r\n    clearClusterVisuals(false);\r\n    clusterMesh = new THREE.InstancedMesh(\r\n      clusterGeometry,\r\n      clusterMaterial,\r\n      clusterCount\r\n    );\r\n    clusterMesh.frustumCulled = false;\r\n    clusterMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);\r\n    scene.add(clusterMesh);\r\n    clusterMaxInstances = clusterCount;\r\n  }\r\n\r\n  // clusterCount \r\n  clusterMesh.count = clusterCount;\r\n\r\n  const hueSpan = 0.65;\r\n  // \r\n  // \r\n  const radiusVisualScale = 0.5;\r\n  const minRadius = 0.25;\r\n\r\n  for (let i = 0; i < clusterCount; i += 1) {\r\n    const base = i * 6;\r\n    const speciesId = Math.max(0, Math.floor(buffer[base] || 0));\r\n    const cx = buffer[base + 1];\r\n    const cy = buffer[base + 2];\r\n    const cz = buffer[base + 3];\r\n    const radius = Math.max(minRadius, (buffer[base + 4] || 0) * radiusVisualScale);\r\n    const weight = Math.max(0, buffer[base + 5] || 0);\r\n\r\n    clusterDummy.position.set(cx, cy + 0.02, cz);\r\n    clusterDummy.scale.setScalar(radius);\r\n    clusterDummy.updateMatrix();\r\n    clusterMesh.setMatrixAt(i, clusterDummy.matrix);\r\n\r\n    // weight \r\n    const normalized = Math.min(weight / 5000, 1);\r\n    const hue = (speciesId % 7) / 7 * hueSpan;\r\n    clusterColor.setHSL(hue, 0.9, 0.18 + normalized * 0.62);\r\n    clusterMesh.setColorAt(i, clusterColor);\r\n  }\r\n\r\n  clusterMesh.instanceMatrix.needsUpdate = true;\r\n  if (clusterMesh.instanceColor) {\r\n    clusterMesh.instanceColor.needsUpdate = true;\r\n  }\r\n}\r\n\r\n/**\r\n * Species school clusters/\r\n * - 1 = 1\r\n * -  cluster.radius \r\n * -  wireframe \r\n */\r\nfunction renderSpeciesSchoolClusters(clusterData) {\r\n  if (!showSpeciesSchoolClusters.value) {\r\n    clearSchoolClusterVisuals();\r\n    return;\r\n  }\r\n\r\n  const buffer = clusterData?.buffer;\r\n  const floatCount = buffer?.length ?? 0;\r\n  const clusterCount = Math.floor(floatCount / 6);\r\n\r\n  if (!buffer || clusterCount <= 0) {\r\n    clearSchoolClusterVisuals();\r\n    return;\r\n  }\r\n\r\n  if (!schoolClusterGeometry) {\r\n    // \r\n    schoolClusterGeometry = new THREE.SphereGeometry(1, 24, 18);\r\n  }\r\n  if (!schoolClusterMaterial) {\r\n    schoolClusterMaterial = new THREE.MeshBasicMaterial({\r\n      transparent: true,\r\n      opacity: 0.3,\r\n      depthWrite: false,\r\n      vertexColors: true,\r\n      wireframe: true,\r\n    });\r\n  }\r\n\r\n  // InstancedMesh capacity\r\n  if (!schoolClusterMesh || schoolClusterMaxInstances < clusterCount) {\r\n    clearSchoolClusterVisuals(false);\r\n    schoolClusterMesh = new THREE.InstancedMesh(\r\n      schoolClusterGeometry,\r\n      schoolClusterMaterial,\r\n      clusterCount\r\n    );\r\n    schoolClusterMesh.frustumCulled = false;\r\n    schoolClusterMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);\r\n    scene.add(schoolClusterMesh);\r\n    schoolClusterMaxInstances = clusterCount;\r\n  }\r\n\r\n  // clusterCount \r\n  schoolClusterMesh.count = clusterCount;\r\n\r\n  const hueSpan = 0.65;\r\n  // \r\n  const radiusVisualScale = 0.6;\r\n  const minRadius = 0.6;\r\n\r\n  for (let i = 0; i < clusterCount; i += 1) {\r\n    const base = i * 6;\r\n    const speciesId = Math.max(0, Math.floor(buffer[base] || 0));\r\n    const cx = buffer[base + 1];\r\n    const cy = buffer[base + 2];\r\n    const cz = buffer[base + 3];\r\n    const radius = Math.max(minRadius, (buffer[base + 4] || 0) * radiusVisualScale);\r\n    const weight = Math.max(0, buffer[base + 5] || 0);\r\n\r\n    schoolClusterDummy.position.set(cx, cy + 0.03, cz);\r\n    schoolClusterDummy.scale.setScalar(radius);\r\n    schoolClusterDummy.updateMatrix();\r\n    schoolClusterMesh.setMatrixAt(i, schoolClusterDummy.matrix);\r\n\r\n    // weight \r\n    const normalized = Math.min(weight / 12000, 1);\r\n    const hue = (speciesId % 7) / 7 * hueSpan;\r\n    schoolClusterColor.setHSL(hue, 0.85, 0.12 + normalized * 0.75);\r\n    schoolClusterMesh.setColorAt(i, schoolClusterColor);\r\n  }\r\n\r\n  schoolClusterMesh.instanceMatrix.needsUpdate = true;\r\n  if (schoolClusterMesh.instanceColor) {\r\n    schoolClusterMesh.instanceColor.needsUpdate = true;\r\n  }\r\n}\r\nlet lastTime = performance.now(); // \r\nlet unitIdScratch = null;\r\nlet unitIdScratchSize = 0;\r\nconst unitColor = new THREE.Color();\r\n\r\nfunction scheduleNextFrame() {\r\n  if (webglContextLost || !renderer || !scene || !camera) {\r\n    // \r\n    if (!renderer) {\r\n      scheduleWebglRecovery('raf');\r\n    }\r\n    return;\r\n  }\r\n  if (typeof requestAnimationFrame === \"function\") {\r\n    animationTimer = requestAnimationFrame(animate);\r\n  }\r\n}\r\n\r\nfunction animate(frameTimeMs) {\r\n  if (webglContextLost || !renderer || !scene || !camera) {\r\n    scheduleWebglRecovery('animate');\r\n    return;\r\n  }\r\n  stats?.begin();\r\n  const currentTime =\r\n    typeof frameTimeMs === \"number\" ? frameTimeMs : performance.now();\r\n  const deltaTime = (currentTime - lastTime) / 1000;\r\n  lastTime = currentTime;\r\n\r\n  if (!paused.value) {\r\n    shaderTime += deltaTime;\r\n  }\r\n  updateInstancingMaterialUniforms(shaderTime);\r\n\r\n  const count = stepSimulationAndUpdateState(paused.value ? 0 : deltaTime);\r\n\r\n  const meshes = boidInstancing.getMeshes();\r\n  instancedMeshHigh = meshes.high;\r\n  instancedMeshLow = meshes.low;\r\n  const pipelineReady = fogPipeline?.isReady?.() ?? false;\r\n\r\n  if (!instancedMeshHigh || !instancedMeshLow) {\r\n    controls.update();\r\n    updateParticleUniforms();\r\n    if (pipelineReady) {\r\n      fogPipeline.updateCameraUniforms(camera);\r\n      fogPipeline.render(deltaTime);\r\n    } else {\r\n      renderer.render(scene, camera);\r\n    }\r\n\r\n    // \r\n    lightRaysOverlay?.update(deltaTime, controls?.target, camera);\r\n    lightRaysOverlay?.render(renderer, camera);\r\n\r\n    stats?.end();\r\n    if ((frameCounter & 1) === 0) {\r\n      stats?.update();\r\n    }\r\n    scheduleNextFrame();\r\n    return;\r\n  }\r\n\r\n  const { positions, orientations, velocities } = getWasmViews(count);\r\n  if ((frameCounter++ & 63) === 0) {\r\n    wasmBridge?.getDiagnostics?.({ firstBoidX: true });\r\n  }\r\n\r\n  const predatorCount = getPredatorCount();\r\n  const updateInfo = boidInstancing.update({\r\n    count,\r\n    positions,\r\n    orientations,\r\n    velocities,\r\n    cameraPosition: camera.position,\r\n    originPosition: controls?.target,\r\n    predatorCount,\r\n    posRange: DEFAULT_SIMULATION_POS_RANGE,\r\n  });\r\n\r\n  const visibleCount =\r\n    updateInfo.visibleCount ?? Math.max(0, count - predatorCount);\r\n\r\n  if (\r\n    showUnitColors.value &&\r\n    instancedMeshHigh.instanceColor &&\r\n    instancedMeshLow.instanceColor\r\n  ) {\r\n    const diagnostics = wasmBridge?.getDiagnostics?.({ boidCount: count, unitMappings: true, unitDensities: true }) ?? null;\r\n    const unitMappings = diagnostics?.unitMappings ?? null;\r\n    const highCount = updateInfo?.highCount ?? visibleCount;\r\n    const lowCount = updateInfo?.lowCount ?? visibleCount;\r\n    const highMap = updateInfo?.highInstanceToBoid ?? null;\r\n    const lowMap = updateInfo?.lowInstanceToBoid ?? null;\r\n\r\n    if (unitMappings) {\r\n      if (unitIdScratchSize !== count) {\r\n        unitIdScratch = new Int32Array(count);\r\n        unitIdScratchSize = count;\r\n      }\r\n      unitIdScratch.fill(-1);\r\n      for (let j = 0; j < unitMappings.length; j += 2) {\r\n        const boidIndex = unitMappings[j];\r\n        if (boidIndex >= 0 && boidIndex < unitIdScratchSize) {\r\n          unitIdScratch[boidIndex] = unitMappings[j + 1];\r\n        }\r\n      }\r\n\r\n      const unitDensities = diagnostics?.unitDensities ?? null;\r\n      const densityCount = unitDensities?.length ?? 0;\r\n      const densityScale = 0.18;\r\n      const hueSpan = 0.45;\r\n      const hueMax = 0.58;\r\n\r\n      const applyDensityColor = Boolean(unitDensities && densityCount > 0);\r\n\r\n      for (let inst = 0; inst < highCount; inst++) {\r\n        const boidIndex = highMap ? highMap[inst] : inst;\r\n        const unitId =\r\n          boidIndex >= 0 && boidIndex < unitIdScratchSize\r\n            ? unitIdScratch[boidIndex]\r\n            : -1;\r\n\r\n        if (applyDensityColor && unitId >= 0 && unitId < densityCount) {\r\n          const density = unitDensities[unitId];\r\n          const normalized = Math.min(Math.max(density * densityScale, 0), 1);\r\n          const hue = hueMax - normalized * hueSpan;\r\n          unitColor.setHSL(hue, 0.85, 0.55);\r\n        } else if (unitId >= 0) {\r\n          unitColor.setHSL((unitId % 100) / 100, 0.8, 0.6);\r\n        } else {\r\n          unitColor.setRGB(1, 0, 0);\r\n        }\r\n\r\n        instancedMeshHigh.setColorAt(inst, unitColor);\r\n      }\r\n\r\n      for (let inst = 0; inst < lowCount; inst++) {\r\n        const boidIndex = lowMap ? lowMap[inst] : inst;\r\n        const unitId =\r\n          boidIndex >= 0 && boidIndex < unitIdScratchSize\r\n            ? unitIdScratch[boidIndex]\r\n            : -1;\r\n\r\n        if (applyDensityColor && unitId >= 0 && unitId < densityCount) {\r\n          const density = unitDensities[unitId];\r\n          const normalized = Math.min(Math.max(density * densityScale, 0), 1);\r\n          const hue = hueMax - normalized * hueSpan;\r\n          unitColor.setHSL(hue, 0.85, 0.55);\r\n        } else if (unitId >= 0) {\r\n          unitColor.setHSL((unitId % 100) / 100, 0.8, 0.6);\r\n        } else {\r\n          unitColor.setRGB(1, 0, 0);\r\n        }\r\n\r\n        instancedMeshLow.setColorAt(inst, unitColor);\r\n      }\r\n\r\n      instancedMeshHigh.instanceColor.needsUpdate = true;\r\n      instancedMeshLow.instanceColor.needsUpdate = true;\r\n    }\r\n  } else if (\r\n    lastShowUnitColors &&\r\n    instancedMeshHigh.instanceColor &&\r\n    instancedMeshLow.instanceColor\r\n  ) {\r\n    const whiteColor = new THREE.Color(1, 1, 1);\r\n    const highCount = updateInfo?.highCount ?? visibleCount;\r\n    const lowCount = updateInfo?.lowCount ?? visibleCount;\r\n\r\n    for (let i = 0; i < highCount; i++) {\r\n      instancedMeshHigh.setColorAt(i, whiteColor);\r\n    }\r\n    for (let i = 0; i < lowCount; i++) {\r\n      instancedMeshLow.setColorAt(i, whiteColor);\r\n    }\r\n    instancedMeshHigh.instanceColor.needsUpdate = true;\r\n    instancedMeshLow.instanceColor.needsUpdate = true;\r\n    console.log(\" Reset vertex colors to white (OFF mode)\");\r\n  }\r\n\r\n  lastShowUnitColors = showUnitColors.value;\r\n\r\n  // species envelope ON\r\n  let envelopeData = null;\r\n  if (wasmBridge && showSpeciesEnvelopes.value) {\r\n    envelopeData = wasmBridge.getDiagnostics?.({ speciesEnvelopes: true })?.speciesEnvelopes ?? null;\r\n  }\r\n\r\n  if (showSpeciesEnvelopes.value) {\r\n    renderSpeciesEnvelopes(envelopeData);\r\n\r\n    // HUD \r\n    if ((frameCounter & 3) === 0) {\r\n      updateSpeciesEnvelopeHud(envelopeData);\r\n    }\r\n  } else if (envelopeSpheres.length > 0) {\r\n    clearSpeciesEnvelopeVisuals();\r\n    speciesEnvelopeHudText.value = \"\";\r\n  }\r\n\r\n  // \r\n  let startupClusterData = null;\r\n  if (wasmBridge && shouldAutoLookAtClusterCenter()) {\r\n    startupClusterData = wasmBridge.getDiagnostics?.({ speciesClusters: true })?.speciesClusters ?? null;\r\n  }\r\n  updateStartupCameraLookAt(startupClusterData, deltaTime);\r\n\r\n  // \r\n  if (showSpeciesClusters.value && wasmBridge) {\r\n    if ((frameCounter & 3) === 0) {\r\n      const clusterData = wasmBridge.getDiagnostics?.({ speciesClusters: true })?.speciesClusters ?? null;\r\n      renderSpeciesClusters(clusterData);\r\n    }\r\n  } else if (clusterMesh) {\r\n    clearClusterVisuals();\r\n  }\r\n\r\n  // \r\n  if (showSpeciesSchoolClusters.value && wasmBridge) {\r\n    if ((frameCounter & 3) === 0) {\r\n      const schoolClusterData = wasmBridge.getDiagnostics?.({ speciesSchoolClusters: true })?.speciesSchoolClusters ?? null;\r\n      renderSpeciesSchoolClusters(schoolClusterData);\r\n    }\r\n  } else if (schoolClusterMesh) {\r\n    clearSchoolClusterVisuals();\r\n  }\r\n\r\n  controls.update();\r\n  updateParticleUniforms();\r\n  if (pipelineReady) {\r\n    fogPipeline.updateCameraUniforms(camera);\r\n    fogPipeline.render(deltaTime);\r\n  } else {\r\n    renderer.render(scene, camera);\r\n  }\r\n\r\n  // \r\n  lightRaysOverlay?.update(deltaTime, controls?.target, camera);\r\n  lightRaysOverlay?.render(renderer, camera);\r\n\r\n  stats?.end();\r\n  stats?.update();\r\n\r\n  scheduleNextFrame();\r\n}\r\n\r\nfunction drawTreeStructure(treeData) {\r\n  const drawNode = (node, parentPosition = null) => {\r\n    const position = new THREE.Vector3(\r\n      node.center[0],\r\n      node.center[1],\r\n      node.center[2]\r\n    );\r\n    if (parentPosition) {\r\n      controls.update();\r\n      updateParticleUniforms();\r\n      const geometry = new THREE.BufferGeometry().setFromPoints([\r\n        parentPosition,\r\n        position,\r\n      ]);\r\n      const material = new THREE.LineBasicMaterial({ color: 0xffffff });\r\n      const line = new THREE.Line(geometry, material);\r\n      scene.add(line);\r\n    }\r\n\r\n    if (node.children) {\r\n      node.children.forEach((child) => drawNode(child, position));\r\n    }\r\n  };\r\n\r\n  treeData.forEach((rootNode) => drawNode(rootNode));\r\n}\r\n\r\n//  + \r\nfunction startSimulation() {\r\n  reinitializeFlockNow();\r\n  // WebGL \r\n  scheduleNextFrame();\r\n}\r\n\r\nonMounted(() => {\r\n  //  WASM \r\n  if (!tuningInitialized.value) {\r\n    updateSystemSettings(toRaw(systemSettings));\r\n    tuningInitialized.value = true;\r\n    applySystemSettingsToWasm();\r\n    saveToStorage();\r\n  }\r\n\r\n  initThreeJS();\r\n  loadBoidModel(() => {\r\n    console.log(\"Boid model loaded successfully.\");\r\n\r\n    boidAssetsReady = true;\r\n\r\n    stats = new StatsGl({\r\n      trackGPU: true,\r\n      trackHz: true,\r\n      trackCPT: true,\r\n      logsPerSecond: 4,\r\n      graphsPerSecond: 30,\r\n      samplesLog: 40,\r\n      samplesGraph: 10,\r\n      precision: 2,\r\n      horizontal: true,\r\n      minimal: false,\r\n      mode: 0,\r\n    });\r\n\r\n    const statsInitTarget = renderer?.domElement ?? document.body;\r\n\r\n    const ensureStatsOverlay = () => {\r\n      const statsElement =\r\n        (typeof stats?.domElement !== \"undefined\" ? stats.domElement : null) ||\r\n        (typeof stats?.getDom === \"function\" ? stats.getDom() : null) ||\r\n        stats?.dom ||\r\n        stats?.container ||\r\n        stats?.wrapper ||\r\n        null;\r\n\r\n      if (statsElement) {\r\n        if (!statsElement.parentElement) {\r\n          document.body.appendChild(statsElement);\r\n        }\r\n        positionStatsOverlay(statsElement);\r\n      }\r\n    };\r\n\r\n    const initPromise =\r\n      stats && typeof stats.init === \"function\"\r\n        ? Promise.resolve(stats.init(statsInitTarget))\r\n        : Promise.resolve();\r\n\r\n    initPromise\r\n      .then(() => {\r\n        // WebGL context  renderer  null \r\n        //  scheduleWebglRecovery  renderer  patch \r\n        if (renderer && typeof stats?.patchThreeRenderer === \"function\") {\r\n          stats.patchThreeRenderer(renderer);\r\n        }\r\n        ensureStatsOverlay();\r\n      })\r\n      .catch((error) => {\r\n        console.error(\"Failed to initialize stats-gl:\", error);\r\n        ensureStatsOverlay();\r\n      });\r\n\r\n    startSimulation();\r\n    initBackgroundAudioPlayback();\r\n  });\r\n\r\n  window.addEventListener(\"keydown\", handleKeydown);\r\n\r\n  // /\r\n  // visibilitychange: /\r\n  // blur/focus: \r\n  document.addEventListener(\"visibilitychange\", applyBackgroundAudioAutoMute);\r\n  window.addEventListener(\"blur\", applyBackgroundAudioAutoMute);\r\n  window.addEventListener(\"focus\", applyBackgroundAudioAutoMute);\r\n\r\n  //  context \r\n  document.addEventListener('visibilitychange', () => {\r\n    if (!document.hidden) {\r\n      scheduleWebglRecovery('visibility');\r\n    }\r\n  });\r\n  window.addEventListener('focus', () => {\r\n    scheduleWebglRecovery('focus');\r\n  });\r\n});\r\n\r\nonUnmounted(() => {\r\n  window.removeEventListener(\"keydown\", handleKeydown);\r\n  document.removeEventListener(\"visibilitychange\", applyBackgroundAudioAutoMute);\r\n  window.removeEventListener(\"blur\", applyBackgroundAudioAutoMute);\r\n  window.removeEventListener(\"focus\", applyBackgroundAudioAutoMute);\r\n\r\n  if (animationTimer && typeof cancelAnimationFrame === \"function\") {\r\n    cancelAnimationFrame(animationTimer);\r\n    animationTimer = null;\r\n  }\r\n\r\n  clearWebglRecoveryTimer();\r\n  disposeRendererAndPipeline();\r\n});\r\n\r\nwatch(\r\n  () => debugControls.enableFogPipeline,\r\n  () => {\r\n    rebuildFogPipeline();\r\n  }\r\n);\r\n\r\nwatch(\r\n  () => debugControls.enableShadows,\r\n  () => {\r\n    applyShadowDebugState();\r\n  }\r\n);\r\n\r\nwatch(\r\n  () => debugControls.enableTailAnimation,\r\n  () => {\r\n    applyTailAnimationDebugState();\r\n  }\r\n);\r\n\r\nwatch(showWorldAxisGrid, () => {\r\n  // ON/OFF\r\n  applyWorldAxisGridState();\r\n});\r\n\r\n// wasm \r\nwatch(\r\n  systemSettings,\r\n  () => {\r\n    if (!tuningInitialized.value) {\r\n      return;\r\n    }\r\n    applySystemSettingsToWasm();\r\n    saveToStorage();\r\n  },\r\n  { deep: true }\r\n);\r\n\r\n// WASM  + \r\nwatch(\r\n  settings,\r\n  () => {\r\n    wasmBridge?.applySpeciesParams(toRaw(settings), { spatialScale: 1 });\r\n\r\n    saveToStorage();\r\n\r\n    // \r\n    const signature = getSpeciesSignature(settings);\r\n    if (signature !== lastSpeciesSignature) {\r\n      scheduleFlockReinitialize();\r\n    } else {\r\n      if (flockReinitTimer) {\r\n        clearTimeout(flockReinitTimer);\r\n        flockReinitTimer = null;\r\n      }\r\n      pendingStateForReinitialize = null;\r\n      pendingSettingsSnapshot = null;\r\n      previousSettingsSnapshot = snapshotSettingsList(settings);\r\n    }\r\n\r\n    const predators = getPredatorCount();\r\n    if (typeof boidInstancing.ensurePredatorMeshes === \"function\") {\r\n      boidInstancing.ensurePredatorMeshes(predators);\r\n    }\r\n    const predatorMeshes =\r\n      typeof boidInstancing.getPredatorMeshes === \"function\"\r\n        ? boidInstancing.getPredatorMeshes()\r\n        : [];\r\n    for (const mesh of predatorMeshes) {\r\n      mesh.visible = false;\r\n    }\r\n  },\r\n  { deep: true }\r\n);\r\n\r\n// \r\nfunction resetSettings(presetList) {\r\n  if (Array.isArray(presetList) && presetList.length > 0) {\r\n    applySettingsSnapshot(presetList);\r\n  } else {\r\n    resetToDefaults();\r\n  }\r\n  updateSystemSettings(DEFAULT_TUNING_SETTINGS);\r\n  saveToStorage();\r\n  if (tuningInitialized.value) {\r\n    applySystemSettingsToWasm();\r\n  }\r\n}\r\n\r\n// Unit \r\nwatch(showUnits, (newValue) => {\r\n  console.log(\"showUnits changed to:\", newValue);\r\n  if (!newValue) {\r\n    // Unit\r\n    clearUnitVisuals();\r\n  }\r\n});\r\n\r\nwatch(showSpeciesEnvelopes, (enabled) => {\r\n  if (!enabled) {\r\n    clearSpeciesEnvelopeVisuals();\r\n  }\r\n});\r\n\r\n// Unit\r\nwatch([showUnitSpheres, showUnitLines], ([newSpheres, newLines]) => {\r\n  console.log(\r\n    \"Unit display mode changed - Spheres:\",\r\n    newSpheres,\r\n    \"Lines:\",\r\n    newLines\r\n  );\r\n  // \r\n  if (showUnits.value) {\r\n    clearUnitVisuals();\r\n  }\r\n});\r\n</script>\r\n\r\n<style>\r\n#app {\r\n  font-family: Arial, sans-serif;\r\n  padding: 0;\r\n  margin: 0;\r\n  position: relative;\r\n  z-index: 1;\r\n}\r\n\r\n.settings {\r\n  margin-bottom: 20px;\r\n  pointer-events: none;\r\n}\r\n\r\n.settings {\r\n  margin-bottom: 20px;\r\n  pointer-events: none;\r\n  display: inline-block;\r\n}\r\n\r\n.settings > * {\r\n  pointer-events: auto;\r\n  display: inline-block;\r\n}\r\n\r\n.three-container {\r\n  position: fixed;\r\n  left: 0;\r\n  top: 0;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  z-index: 0;\r\n  display: block;\r\n  border: none;\r\n  overflow: hidden;\r\n  background: #0a1e3a;\r\n}\r\n\r\n.ui-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  padding: 20px;\r\n  box-sizing: border-box;\r\n  color: #fff;\r\n  z-index: 2;\r\n  pointer-events: none;\r\n}\r\n\r\n/*\r\n  UI \r\n  (ui-panel)\r\n  details 100%\r\n  pointer \r\n*/\r\n.ui-panel {\r\n  display: inline-block;\r\n  pointer-events: auto;\r\n}\r\n\r\n/*\r\n   title \r\n  - OS/UI\r\n*/\r\n\r\n/*\r\n  HUD\r\n  - \r\n  - pointer-events: none\r\n*/\r\n.debug-hud {\r\n  position: fixed;\r\n  left: 12px;\r\n  bottom: 12px;\r\n  z-index: 3;\r\n  pointer-events: none;\r\n\r\n  max-width: 520px;\r\n  max-height: 45vh;\r\n  overflow: hidden;\r\n  white-space: pre;\r\n\r\n  padding: 10px 12px;\r\n  border: 1px solid rgba(255, 255, 255, 0.2);\r\n  border-radius: 5px;\r\n  background-color: rgba(255, 255, 255, 0.05);\r\n  color: #fff;\r\n\r\n  font-size: 12px;\r\n  line-height: 1.35;\r\n}\r\n\r\n.add-species-button {\r\n  margin-top: 10px;\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.tuning-settings {\r\n  pointer-events: none;\r\n  display: inline-block;\r\n  margin-top: 10px;\r\n}\r\n\r\n.tuning-settings * {\r\n  pointer-events: auto;\r\n}\r\n\r\n.tuning-settings .species-section {\r\n  border: 1px solid rgba(255, 255, 255, 0.2);\r\n  border-radius: 5px;\r\n  background-color: rgba(255, 255, 255, 0.05);\r\n  pointer-events: auto;\r\n  position: relative;\r\n  overflow: visible;\r\n  max-width: 100%;\r\n  width: fit-content;\r\n  min-width: 260px;\r\n}\r\n\r\n.tuning-settings .species-header {\r\n  padding: 10px;\r\n  font-weight: bold;\r\n  cursor: pointer;\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  border-radius: 5px 5px 0 0;\r\n  user-select: none;\r\n  pointer-events: auto;\r\n  display: flex;\r\n  align-items: center;\r\n}\r\n\r\n.tuning-settings .species-header:hover {\r\n  background-color: rgba(255, 255, 255, 0.15);\r\n}\r\n\r\n.tuning-settings .species-title {\r\n  flex: 1;\r\n}\r\n\r\n.tuning-settings .species-content {\r\n  padding: 10px;\r\n  pointer-events: auto;\r\n  box-sizing: border-box;\r\n  width: 100%;\r\n}\r\n\r\n.tuning-settings .setting-row {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n  width: 100%;\r\n}\r\n\r\n.tuning-settings .setting-row label {\r\n  width: 150px;\r\n  text-align: left;\r\n  margin-right: 10px;\r\n  flex-shrink: 0;\r\n  line-height: 1.3;\r\n}\r\n\r\n.tuning-settings .setting-row input[type=\"range\"] {\r\n  width: 140px;\r\n  min-width: 100px;\r\n  max-width: 220px;\r\n  margin: 0 10px;\r\n}\r\n\r\n.tuning-settings .value-input {\r\n  width: 70px;\r\n  padding: 2px 4px;\r\n  border: 1px solid #ccc;\r\n  border-radius: 3px;\r\n  background: transparent;\r\n  color: inherit;\r\n  font-size: inherit;\r\n}\r\n\r\n.tuning-settings .value-input:focus {\r\n  outline: none;\r\n  border-color: #007bff;\r\n  box-shadow: 0 0 3px rgba(0, 123, 255, 0.3);\r\n}\r\n</style>","import script from \"./App.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./App.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./App.vue?vue&type=style&index=0&id=06230aea&lang=css\"\n\nconst __exports__ = script;\n\nexport default __exports__","import { createApp } from 'vue';\r\nimport App from './App.vue';\r\n\r\n// SharedArrayBuffer  COOP/COEP  wasm \r\nconst publicBase = (process.env.BASE_URL || '/').replace(/\\/*$/, '/');\r\nconst wasmPublicBase = `${publicBase}static/js`;\r\nconst wasmJsUrl = `${wasmPublicBase}/wasm_boids.js`;\r\nconst wasmBinaryUrl = `${wasmPublicBase}/wasm_boids.wasm`;\r\n\r\nasync function bootstrap() {\r\n    try {\r\n        const BoidsModule = await import(/* webpackIgnore: true */ wasmJsUrl);\r\n        if (!BoidsModule?.default) {\r\n            throw new Error(`WASM module loader not found at: ${wasmJsUrl}`);\r\n        }\r\n\r\n        const Module = await BoidsModule.default({\r\n            locateFile: (path) => (path.endsWith('.wasm') ? wasmBinaryUrl : path),\r\n        });\r\n\r\n        // \r\n        if (typeof window !== 'undefined') {\r\n            window.wasmModule = Module;\r\n        }\r\n        console.log('Wasm module initialized:', Module);\r\n\r\n        const app = createApp(App);\r\n        app.provide('wasmModule', Module);\r\n        app.mount('#app');\r\n    } catch (error) {\r\n        console.error('Failed to initialise WASM module:', error);\r\n    }\r\n}\r\n\r\nbootstrap();","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","var deferred = [];\n__webpack_require__.O = (result, chunkIds, fn, priority) => {\n\tif(chunkIds) {\n\t\tpriority = priority || 0;\n\t\tfor(var i = deferred.length; i > 0 && deferred[i - 1][2] > priority; i--) deferred[i] = deferred[i - 1];\n\t\tdeferred[i] = [chunkIds, fn, priority];\n\t\treturn;\n\t}\n\tvar notFulfilled = Infinity;\n\tfor (var i = 0; i < deferred.length; i++) {\n\t\tvar [chunkIds, fn, priority] = deferred[i];\n\t\tvar fulfilled = true;\n\t\tfor (var j = 0; j < chunkIds.length; j++) {\n\t\t\tif ((priority & 1 === 0 || notFulfilled >= priority) && Object.keys(__webpack_require__.O).every((key) => (__webpack_require__.O[key](chunkIds[j])))) {\n\t\t\t\tchunkIds.splice(j--, 1);\n\t\t\t} else {\n\t\t\t\tfulfilled = false;\n\t\t\t\tif(priority < notFulfilled) notFulfilled = priority;\n\t\t\t}\n\t\t}\n\t\tif(fulfilled) {\n\t\t\tdeferred.splice(i--, 1)\n\t\t\tvar r = fn();\n\t\t\tif (r !== undefined) result = r;\n\t\t}\n\t}\n\treturn result;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t57: 0\n};\n\n// no chunk on demand loading\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n__webpack_require__.O.j = (chunkId) => (installedChunks[chunkId] === 0);\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\treturn __webpack_require__.O(result);\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunkwasm_boids\"] = self[\"webpackChunkwasm_boids\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","// startup\n// Load entry module and return exports\n// This entry module depends on other loaded chunks and execution need to be delayed\nvar __webpack_exports__ = __webpack_require__.O(undefined, [504], () => (__webpack_require__(365)))\n__webpack_exports__ = __webpack_require__.O(__webpack_exports__);\n"],"names":["props","emit","emitRemove","settingHelp","species","count","cohesion","cohesionRange","separation","separationRange","alignment","alignmentRange","predatorAlertRadius","densityReturnStrength","maxSpeed","maxTurnAngle","maxNeighbors","horizontalTorque","torqueStrength","lambda","tau","isPredator","countDraft","settings","editingCount","countInput","startEditCount","value","focus","commitCountFromSlider","commitCountFromInput","cancelCountEdit","startEditNumber","editingFlag","inputRef","stopEditNumber","newCount","editingCohesion","cohesionInput","startEditCohesion","stopEditCohesion","editingCohesionRange","cohesionRangeInput","startEditCohesionRange","stopEditCohesionRange","editingSeparation","separationInput","startEditSeparation","stopEditSeparation","editingSeparationRange","separationRangeInput","startEditSeparationRange","stopEditSeparationRange","editingAlignment","alignmentInput","startEditAlignment","stopEditAlignment","editingAlignmentRange","alignmentRangeInput","startEditAlignmentRange","stopEditAlignmentRange","editingPredatorAlertRadius","predatorAlertRadiusInput","startEditPredatorAlertRadius","stopEditPredatorAlertRadius","editingDensityReturnStrength","densityReturnStrengthInput","startEditDensityReturnStrength","stopEditDensityReturnStrength","editingMaxSpeed","maxSpeedInput","startEditMaxSpeed","stopEditMaxSpeed","editingMaxTurnAngle","maxTurnAngleInput","startEditMaxTurnAngle","stopEditMaxTurnAngle","editingMaxNeighbors","maxNeighborsInput","startEditMaxNeighbors","stopEditMaxNeighbors","editingHorizontalTorque","horizontalTorqueInput","startEditHorizontalTorque","stopEditHorizontalTorque","editingTorqueStrength","torqueStrengthInput","startEditTorqueStrength","stopEditTorqueStrength","editingLambda","lambdaInput","startEditLambda","stopEditLambda","editingTau","tauInput","startEditTau","stopEditTau","__exports__","BoidInstancing","constructor","tailAnimation","tripleBufferSize","hiddenPosition","identityQuaternion","lodNearDistanceSq","lodMidDistanceSq","this","streamUsage","scene","instancedMeshHigh","instancedMeshLow","instancingMaterials","Set","bufferSetHigh","bufferSetLow","tailPhaseSeeds","bufferCursor","previousVelocities","previousLodFlags","predatorModel","predatorMeshes","predatorMeshCountCache","positionQuantization","extent","originSnap","positionQuantUniforms","uInstanceOrigin","uInstanceExtent","init","boidModel","boidModelLod","highMaterial","lowMaterial","console","error","children","length","geometry","dispose","highMaterialClone","clone","lowMaterialClone","patchMaterial","highGeometry","lowGeometry","ensureBodyCoordAttribute","configureInstancedMesh","add","createBufferSet","resetBufferSetToHidden","createTailPhaseArray","applyTailPhaseSeeds","applyBufferSet","instanceMatrix","setUsage","ensurePredatorMeshes","update","positions","orientations","velocities","cameraPosition","predatorCount","posRange","originPosition","visibleCount","lodFlags","currentIndex","nextIndex","ensureTailRuntimeBuffers","ensureTailSeedCapacity","ensureLodFlagBuffer","highPosAttr","pos","highQuatAttr","quat","highTailParamsAttr","tailParams","highTailPhaseAttr","tailPhase","lowPosAttr","lowQuatAttr","lowTailParamsAttr","lowTailPhaseAttr","highPosArray","array","highQuatArray","highTailParamsArray","highTailPhaseArray","lowPosArray","lowQuatArray","lowTailParamsArray","lowTailPhaseArray","highTransformTouched","lowTransformTouched","highTailTouched","lowTailTouched","highTailPhaseTouched","lowTailPhaseTouched","camX","x","camY","y","camZ","z","originBaseX","originBaseY","originBaseZ","extentFromPosRange","Number","isFinite","Math","max","snap","originX","floor","originY","originZ","set","invExtent","predatorStartIndex","mesh","visible","prevVel","tailSeeds","highWrite","lowWrite","highInstanceToBoid","Uint32Array","lowInstanceToBoid","i","basePos","baseQuat","px","py","pz","qx","qy","qz","qw","predatorLocalIndex","predatorMesh","position","quaternion","dx","dy","dz","distSq","isNear","isMid","animateTail","vx","vy","vz","speed","hypot","prevVx","prevVy","prevVz","prevLen","turnAmount","crossY","dot","atan2","tailSpeedValue","tailTurnValue","driveValue","writeIndex","outPos","outQuat","outTail","lx","min","ly","lz","nx","ny","nz","seedValue","needsUpdate","highCount","lowCount","forEachInstancingMaterial","callback","material","getMeshes","high","low","getPredatorMeshes","setTailUniformTime","time","uniforms","uTailTime","userData","instancingPatched","warn","onBeforeCompile","shader","Object","entries","forEach","key","uniform","vertexShader","replace","createDepthMaterial","sourceMaterial","depthMaterial","depthPacking","alphaTest","map","alphaMap","transparent","createDistanceMaterial","distanceMaterial","castShadow","receiveShadow","frustumCulled","customDepthMaterial","customDistanceMaterial","white","setColorAt","instanceColor","createAttributeSet","itemSize","ArrayType","Float32Array","attributes","attr","push","createNormalizedAttributeSet","Uint16Array","bufferSet","fill","index","setAttribute","random","PI","seeds","targetLength","Uint8Array","currentLength","next","subarray","getAttribute","minX","Infinity","minY","minZ","maxX","maxY","maxZ","ix","rangeX","rangeY","rangeZ","axis","range","bodyCoord","denom","target","pop","remove","traverse","child","isMesh","clear","FogPipeline","fogConfig","config","composer","heightFogPass","heightFogRenderTarget","renderer","camera","internalScale","heightFog","width","height","scale","scaledWidth","scaledHeight","rtOptions","depthBuffer","stencilBuffer","depthTexture","format","type","EffectComposer","renderPass","RenderPass","addPass","ssaoPass","SSAOPass","kernelRadius","minDistance","maxDistance","bloomStrength","bloomRadius","bloomThreshold","bloomPass","UnrealBloomPass","createHeightFogShader","ShaderPass","originalRender","render","bind","passRenderer","writeBuffer","readBuffer","deltaTime","maskActive","tDepth","needsSwap","applyFogConfigToUniforms","depthTest","depthWrite","blending","toneMapped","renderToScreen","resize","setSize","delta","isReady","updateCameraUniforms","pass","targetCamera","uExposure","exposure","toneMappingExposure","cameraNear","near","cameraFar","far","projectionMatrixInverse","copy","cameraMatrixWorld","matrixWorld","updateConfig","nextConfig","lut","tDistanceCurveLut","defaults","buildFogDefaults","finalConfig","distanceCurveLut","createOrUpdateDistanceCurveLutTexture","cloneVector2","distanceControlPoint1","distanceControlPoint2","tDiffuse","fogColor","cloneColor","color","distanceStart","distanceEnd","distanceExponent","surfaceLevel","heightFalloff","heightExponent","maxOpacity","fragmentShader","existingTexture","controlPoint1","controlPoint2","size","needsNew","image","c1","c2","last","same","c1x","c1y","c2x","c2y","data","bezier1D","t","p0","p1","p2","p3","u","uu","tt","bezierDerivative1D","iter","current","slope","abs","v","round","base","texture","wrapS","wrapT","minFilter","magFilter","generateMipmaps","LightRaysOverlay","options","intensity","rayDensity","raySoftness","planeCount","planeWidth","planeHeight","placementRadius","topOffsetY","meshes","anchor","anchorSmoothed","tmp","timeSeconds","uTime","uIntensity","uColor","uRayDensity","uRaySoftness","uSeed","mat","matrixAutoUpdate","deltaSeconds","anchorPosition","dt","smooth","exp","lerp","hasCamera","phase","radius","ox","cos","oz","sin","setScalar","lookAt","prevAutoClear","autoClear","PARTICLE_BASE_SPREAD_DESKTOP","PARTICLE_BASE_SPREAD_MOBILE","PARTICLE_BASE_MAX_DISTANCE_DESKTOP","PARTICLE_BASE_MAX_DISTANCE_MOBILE","FLOW_TILT_DEGREES","DEFAULT_FLOW_DIR","degToRad","DEFAULT_LAT1","DEFAULT_LAT2","TEMP_DIR","TEMP_AXIS","TEMP_LAT1","TEMP_LAT2","ParticleField","isMobileDevice","Boolean","controls","particlePoints","particleMaterial","elapsedTime","worldOrigin","capabilities","isWebGL2","setDrawRange","baseSpread","baseMaxDistance","glslVersion","uOrigin","uFlowDir","uLat1","uLat2","uSpread","uMaxDistance","uBaseSpeed","uJitterAmp","uSizePx","uFadeNear","uFadeFar","uColorNear","uColorFar","PARTICLE_VERTEX_SHADER","PARTICLE_FRAGMENT_SHADER","baseTargetDistance","distanceTo","renderOrder","setWorldBasis","setTime","advanceTime","flowDir","dir","normalize","lat1","cross","lengthSq","lat2","targetScene","getMaterial","WasmtimeBridge","wasmModule","Error","wasm","latestStatePtr","latestStateHeaderPtr","latestStateHeaderView","latestPositionsPtr","latestVelocitiesPtr","latestOrientationsPtr","latestBoidCount","cachedHeapBuffer","cachedPositionsPtr","cachedOrientationsPtr","cachedVelocitiesPtr","cachedSpeciesIdsPtr","cachedPositionsView","cachedOrientationsView","cachedVelocitiesView","cachedSpeciesIdsView","cachedPositionsCount","cachedOrientationsCount","cachedVelocitiesCount","cachedSpeciesIdsCount","cachedSpeciesIdsBuffer","cachedUnitDensityPtr","cachedUnitDensityCount","cachedUnitDensityView","cachedSpeciesEnvelopePtr","cachedSpeciesEnvelopeCount","cachedSpeciesEnvelopeView","cachedSpeciesClusterPtr","cachedSpeciesClusterCount","cachedSpeciesClusterView","cachedSpeciesSchoolClusterPtr","cachedSpeciesSchoolClusterCount","cachedSpeciesSchoolClusterView","stepSimulationHandle","createWrappedFunction","buildHandle","exportTreeStructureHandle","boidUnitMappingPtrHandle","currentFirstBoidXHandle","speciesIdsPtrHandle","syncReadToWriteBuffersHandle","setSimulationTuningParamsHandle","unitSimpleDensityPtrHandle","unitSimpleDensityCountHandle","speciesEnvelopesPtrHandle","speciesEnvelopesCountHandle","speciesClustersPtrHandle","speciesClustersCountHandle","speciesSchoolClustersPtrHandle","speciesSchoolClustersCountHandle","configureGroundPlaneHandle","cachedUnitMappingsPtr","cachedUnitMappingsCount","cachedUnitMappingsView","cachedUnitMappingsBuffer","cachedDiagnostics","treeStructure","firstBoidX","unitMappings","unitDensities","speciesEnvelopes","speciesClusters","speciesSchoolClusters","initializeFlock","spatialScale","velRange","source","Array","isArray","from","vector","buildSpeciesParams","callInitBoids","delete","groundPlane","applyGroundPlane","ensureHandle","stepSimulation","applySpeciesParams","setGlobalSpeciesParamsFromJS","applyTuningParams","params","handle","toNumber","fallback","num","threatDecay","maxEscapeWeight","baseEscapeStrength","fastAttractStrength","schoolPullCoefficient","softBoundaryRadius","softBoundaryStart","softBoundarySteer","getDiagnostics","resolved","boidCount","includeTreeStructure","includeFirstBoidX","includeUnitMappings","includeUnitDensities","includeSpeciesEnvelopes","includeSpeciesClusters","includeSpeciesSchoolClusters","result","ptr","heapBufferI32","HEAP32","buffer","Int32Array","getUnitSimpleDensitiesInternal","getSpeciesEnvelopesInternal","getSpeciesClustersInternal","getSpeciesSchoolClustersInternal","statePtr","heapU8Buffer","HEAPU8","DataView","getUint32","getInt32","getBuffers","speciesIds","heapBuffer","HEAPF32","speciesPtr","captureState","currentCount","restoreState","previousState","oldSettings","newSettings","prevPositions","prevVelocities","prevOrientations","oldRanges","buildSpeciesRanges","newRanges","oldRangeMap","Map","info","name","restored","newInfo","oldInfo","get","transferable","srcIndex","start","dstIndex","srcPosBase","dstPosBase","srcVelBase","dstVelBase","srcOriBase","dstOriBase","list","ranges","offset","item","returnType","argTypes","cwrap","enabled","blendDistance","stiffness","damping","VectorSpeciesParams","raw","push_back","speciesId","minSpeed","velocityEpsilon","bodyHeadLength","bodyTailLength","bodyRadius","centerAttractStrength","bridge","floatCount","STORAGE_KEY","SETTINGS_SCHEMA_MAJOR_VERSION","STORAGE_VERSION_KEY","DEFAULT_SPECIES_FALLBACK","createFlockSettingsStore","defaultSettings","defaultSystem","defaultTemplates","sanitizeSpeciesList","systemDefaults","systemSettings","replaceSettings","assignSystemSettings","shouldResetStorageBySchemaMajor","previousCounts","tryLoadSpeciesCountsFromStorage","clearSettingsStorage","applySpeciesCounts","saveToStorage","loadFromStorage","totalBoids","getTotalBoidCount","localStorage","saved","getItem","parsed","JSON","parse","system","readStorageSnapshot","snapshot","counts","entry","rawCount","targetSettings","countsMap","nextCount","removeItem","setItem","stringify","String","nextList","sanitized","splice","patch","merged","keys","resetToDefaults","addSpecies","template","basePool","fallbackTemplate","find","candidate","sanitizeSpeciesEntry","cloneSpeciesTemplate","ensureUniqueName","s","removeSpecies","removed","reduce","sum","fallbackList","takenNames","clean","toFinite","fallbackValue","baseReturnStrength","mergedReturnStrength","speciesName","trim","taken","defaultName","has","DEFAULT_SIMULATION_POS_RANGE","COUNT_REINIT_DELAY_MS","TRIPLE_BUFFER_SIZE","HIDDEN_POSITION","SIN_LUT_SIZE","wasmBridge","detectDeviceProfile","profile","isMobile","hasIntegratedGpu","navigator","test","userAgent","canvas","document","createElement","gl","getContext","debugInfo","getExtension","getParameter","UNMASKED_RENDERER_WEBGL","log","deviceProfile","useLowSpecPreset","MAX_RENDER_PIXEL_RATIO","defaultBoidCount","DEFAULT_SETTINGS","DEFAULT_TUNING_SETTINGS","tuningHelp","debugHelp","enableFogPipeline","enableShadows","enableTailAnimation","showSpeciesEnvelopes","showSpeciesClusters","showSpeciesSchoolClusters","showWorldAxisGrid","flockStore","syncSystemSettings","addSpeciesFromStore","removeSpeciesFromStore","tuningInitialized","sanitizeTuningParams","updateSystemSettings","newValues","payload","applySystemSettingsToWasm","snapshotSettingsList","cachedTotalBoidCount","lastSpeciesSignature","getSpeciesSignature","previousSettingsSnapshot","pendingStateForReinitialize","pendingSettingsSnapshot","applySettingsSnapshot","added","threeContainer","backgroundAudio","fogPipeline","particleField","lightRaysOverlay","dirLight","groundMesh","startupCameraLookAt","active","userInteracted","controlsHooked","startedAtMs","maxDurationMs","smoothingSpeed","startupClusterTarget","startupClusterTargetScratch","paused","tabAudioAutoMuteState","previousMuted","previousVolume","shouldAutoMuteByTabState","hidden","unfocused","hasFocus","applyBackgroundAudioAutoMute","audioEl","shouldMute","muted","volume","speciesEnvelopeHudText","showUnits","showUnitSpheres","showUnitLines","showUnitColors","unitSpheres","unitLines","envelopeSpheres","envelopeGeometry","worldGridHelper","worldAxesHelper","clusterMesh","clusterGeometry","clusterMaterial","clusterMaxInstances","schoolClusterMesh","schoolClusterGeometry","schoolClusterMaterial","schoolClusterMaxInstances","clusterDummy","clusterColor","schoolClusterDummy","schoolClusterColor","debugControls","applyWorldAxisGridState","toHex","OCEAN_COLORS","AMBIENT_LIGHT","BOTTOM_LIGHT","parent","stats","glContext","frameCounter","flockReinitTimer","rendererCanvas","webglContextLost","webglRecoveryTimer","webglRecoveryAttempt","boidAssetsReady","resizeHooked","forceWebgl1","animationTimer","applyRendererPixelRatio","window","dpr","devicePixelRatio","setPixelRatio","positionStatsOverlay","element","style","top","right","left","bottom","zIndex","pointerEvents","transform","updateSpeciesEnvelopeHud","envelopeData","envelopeCount","lines","cx","cy","cz","population","toFixed","join","handleKeydown","e","code","applyTailAnimationDebugState","uTailEnable","applyShadowDebugState","shadowMap","shadow","autoUpdate","boidInstancing","rebuildFogPipeline","supportsPostProcess","shouldEnable","heightFogConfig","getSize","clearWebglRecoveryTimer","clearTimeout","detachRendererCanvas","domElement","parentElement","removeChild","disposeRendererAndPipeline","createWebglContext","preferWebgl2","attrs","alpha","antialias","depth","stencil","preserveDrawingBuffer","powerPreference","failIfMajorPerformanceCaveat","gl2","onWebglContextLost","event","preventDefault","cancelAnimationFrame","scheduleWebglRecovery","onWebglContextRestored","reason","delayMs","pow","setTimeout","ok","initThreeJS","patchThreeRenderer","initInstancedBoids","scheduleNextFrame","innerWidth","innerHeight","background","DEEP_BLUE","createOceanSphere","context","isWebgl2","WebGL2RenderingContext","outputColorSpace","toneMapping","addEventListener","appendChild","aspect","updateProjectionMatrix","OrbitControls","enableDamping","dampingFactor","performance","now","groundGeo","groundMat","createFadeOutGroundMaterial","rotation","ambientLight","SUN_LIGHT","mapSize","bias","normalBias","SKY_HIGHLIGHT","initParticleSystem","onWindowResize","computeSpeciesClusterWeightedCenter","clusterData","outCenter","clusterCount","sumX","sumY","sumZ","sumW","weight","clamped","shouldAutoLookAtClusterCenter","elapsed","updateStartupCameraLookAt","safeDeltaTime","smoothing","hasTarget","createSinCosLutTexture","angle","sinValue","cosValue","flipY","IDENTITY_QUATERNION","sinCosLutTexture","LOD_DISTANCE_PRESET","nearSq","midSq","LOD_NEAR_DISTANCE_SQ","LOD_MID_DISTANCE_SQ","uTailAmplitude","uTailFrequency","uTailPhaseStride","uTailTurnStrength","uTailSpeedScale","uTailRight","uTailForward","uTailUp","uSinLut","uLutSize","SKY_BLUE","SEAFLOOR","SIDE_LIGHT1","SIDE_LIGHT2","colorStr","parseInt","gradient","createLinearGradient","addColorStop","fillStyle","fillRect","colorSpace","sphereGeo","sphereMat","side","fog","oceanSphere","textureLoader","load","roughness","metalness","updateInstancingMaterialUniforms","shaderTime","updateParticleUniforms","initBackgroundAudioPlayback","loop","tryPlay","playResult","play","then","catch","resume","removeEventListener","once","stepSimulationAndUpdateState","getWasmViews","captureFlockState","restoreFlockState","originalMaterial","originalMaterialLod","predatorMaterial","lastShowUnitColors","getPredatorCount","specList","reinitializeFlockNow","pendingState","state","oldSettingsRef","newSettingsRef","targetSignature","total","scheduleFlockReinitialize","initialized","loadBoidModel","loader","GLTFLoader","pendingAssets","notifyReady","undefined","textureLod","predatorTexture","boidMaterial","vertexColors","vertexColor","boidLodMaterial","gltf","clearUnitVisuals","line","clearSpeciesEnvelopeVisuals","clearClusterVisuals","disposeSharedResources","clearSchoolClusterVisuals","renderSpeciesEnvelopes","hueSpan","setHSL","wireframe","opacity","renderSpeciesClusters","radiusVisualScale","minRadius","updateMatrix","setMatrixAt","matrix","normalized","hue","renderSpeciesSchoolClusters","lastTime","unitIdScratch","unitIdScratchSize","unitColor","requestAnimationFrame","animate","frameTimeMs","begin","currentTime","pipelineReady","end","updateInfo","diagnostics","highMap","lowMap","j","boidIndex","densityCount","densityScale","hueMax","applyDensityColor","inst","unitId","density","setRGB","whiteColor","startupClusterData","schoolClusterData","startSimulation","resetSettings","presetList","trackGPU","trackHz","trackCPT","logsPerSecond","graphsPerSecond","samplesLog","samplesGraph","precision","horizontal","minimal","mode","statsInitTarget","body","ensureStatsOverlay","statsElement","getDom","dom","container","wrapper","initPromise","Promise","resolve","deep","signature","predators","newValue","newSpheres","newLines","publicBase","wasmPublicBase","wasmJsUrl","wasmBinaryUrl","async","bootstrap","BoidsModule","import","default","Module","locateFile","path","endsWith","app","App","provide","mount","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","module","__webpack_modules__","m","deferred","O","chunkIds","fn","priority","notFulfilled","fulfilled","every","r","d","definition","o","defineProperty","enumerable","g","globalThis","Function","obj","prop","prototype","hasOwnProperty","call","installedChunks","chunkId","webpackJsonpCallback","parentChunkLoadingFunction","moreModules","runtime","some","id","chunkLoadingGlobal","self","__webpack_exports__"],"sourceRoot":""}