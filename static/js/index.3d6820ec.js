(()=>{var e={307:(e,n,t)=>{var a=t(751),o=t(641),l=t(33),r=t(953),i=t(922),u=t(437),s=t(24);const c={class:"settings"},d={class:"species-section",open:!1},p={class:"species-header"},m={class:"species-title"},f={class:"species-content"},v={class:"setting-row"},g={class:"setting-row"},h={class:"setting-row"},b={class:"setting-row"},y={class:"setting-row"},w={class:"setting-row"},x={class:"setting-row"},R={class:"setting-row"},k={class:"setting-row"},S={class:"setting-row"},C={class:"setting-row"},T={class:"setting-row"},P={class:"setting-row"},L={class:"setting-row"},E={class:"setting-row"},U={class:"setting-row"},A={__name:"Settings",props:{settings:{type:Object,required:!0},canRemove:{type:Boolean,default:!1}},emits:["remove"],setup(e,{emit:n}){const t=n,i=e,u=i.settings,s=(0,r.KR)(!1),A=(0,r.KR)(!1),_=(0,r.KR)(!1),F=(0,r.KR)(!1),M=(0,r.KR)(!1),I=(0,r.KR)(!1),W=(0,r.KR)(!1),B=(0,r.KR)(!1),K=(0,r.KR)(!1),D=(0,r.KR)(!1),z=(0,r.KR)(!1),q=(0,r.KR)(!1),X=(0,r.KR)(!1),O=(0,r.KR)(!1),j=(0,r.KR)(null),Q=(0,r.KR)(null),V=(0,r.KR)(null),J=(0,r.KR)(null),N=(0,r.KR)(null),Y=(0,r.KR)(null),H=(0,r.KR)(null),G=(0,r.KR)(null),$=(0,r.KR)(null),Z=(0,r.KR)(null),ee=(0,r.KR)(null),ne=(0,r.KR)(null),te=(0,r.KR)(null),ae=(0,r.KR)(null),oe=(0,r.KR)(u.count??0);async function le(){s.value=!0,oe.value=u.count??0,await(0,o.dY)(),j.value&&(j.value.focus(),j.value.select())}function re(){s.value=!1,oe.value=u.count??0}function ie(){const e=Math.max(0,Math.round(Number.isFinite(oe.value)?oe.value:0));u.count!==e&&(u.count=e)}function ue(){ie()}function se(){ie(),re()}function ce(){t("remove")}async function de(){A.value=!0,await(0,o.dY)(),Q.value&&(Q.value.focus(),Q.value.select())}async function pe(){_.value=!0,await(0,o.dY)(),V.value&&(V.value.focus(),V.value.select())}async function me(){F.value=!0,await(0,o.dY)(),J.value&&(J.value.focus(),J.value.select())}async function fe(){M.value=!0,await(0,o.dY)(),N.value&&(N.value.focus(),N.value.select())}async function ve(){I.value=!0,await(0,o.dY)(),Y.value&&(Y.value.focus(),Y.value.select())}async function ge(){W.value=!0,await(0,o.dY)(),H.value&&(H.value.focus(),H.value.select())}async function he(){B.value=!0,await(0,o.dY)(),G.value&&(G.value.focus(),G.value.select())}async function be(){K.value=!0,await(0,o.dY)(),$.value&&($.value.focus(),$.value.select())}async function ye(){D.value=!0,await(0,o.dY)(),Z.value&&(Z.value.focus(),Z.value.select())}async function we(){z.value=!0,await(0,o.dY)(),ee.value&&(ee.value.focus(),ee.value.select())}async function xe(){q.value=!0,await(0,o.dY)(),ne.value&&(ne.value.focus(),ne.value.select())}async function Re(){X.value=!0,await(0,o.dY)(),te.value&&(te.value.focus(),te.value.select())}async function ke(){O.value=!0,await(0,o.dY)(),ae.value&&(ae.value.focus(),ae.value.select())}function Se(){A.value=!1}function Ce(){_.value=!1}function Te(){F.value=!1}function Pe(){M.value=!1}function Le(){I.value=!1}function Ee(){W.value=!1}function Ue(){B.value=!1}function Ae(){K.value=!1}function _e(){D.value=!1}function Fe(){z.value=!1}function Me(){q.value=!1}function Ie(){X.value=!1}function We(){O.value=!1}return(0,o.wB)((()=>u.count),(e=>{s.value||(oe.value=e??0)})),(n,t)=>((0,o.uX)(),(0,o.CE)("div",c,[(0,o.Lk)("details",d,[(0,o.Lk)("summary",p,[(0,o.Lk)("span",m,(0,l.v_)((0,r.R1)(u).species)+" ("+(0,l.v_)((0,r.R1)(u).count)+"匹)",1),e.canRemove?((0,o.uX)(),(0,o.CE)("button",{key:0,class:"species-remove",type:"button",onClick:(0,a.D$)(ce,["stop"])},"削除")):(0,o.Q3)("",!0)]),(0,o.Lk)("div",f,[(0,o.Lk)("div",v,[t[29]||(t[29]=(0,o.Lk)("label",null,[(0,o.eW)("種族名"),(0,o.Lk)("br"),(0,o.eW)("(Species):")],-1)),(0,o.Lk)("span",null,(0,l.v_)((0,r.R1)(u).species),1)]),(0,o.Lk)("div",g,[t[30]||(t[30]=(0,o.Lk)("label",null,[(0,o.eW)("群れの数(要更新)"),(0,o.Lk)("br"),(0,o.eW)("(Count):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[0]||(t[0]=e=>oe.value=e),min:"0",max:"50000",step:"1",onChange:ue},null,544),[[a.Jo,oe.value,void 0,{number:!0}]]),s.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:le,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).count),1)),s.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[1]||(t[1]=e=>oe.value=e),min:"0",max:"20000",class:"value-input",onBlur:re,onKeyup:(0,a.jR)(se,["enter"]),ref_key:"countInput",ref:j},null,544)),[[a.Jo,oe.value,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",h,[t[31]||(t[31]=(0,o.Lk)("label",null,[(0,o.eW)("凝集"),(0,o.Lk)("br"),(0,o.eW)("(Cohesion):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[2]||(t[2]=e=>(0,r.R1)(u).cohesion=e),min:"0",max:"40",step:"0.01"},null,512),[[a.Jo,(0,r.R1)(u).cohesion,void 0,{number:!0}]]),A.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:de,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).cohesion),1)),A.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[3]||(t[3]=e=>(0,r.R1)(u).cohesion=e),min:"0",max:"40",step:"0.01",class:"value-input",onBlur:Se,onKeyup:(0,a.jR)(Se,["enter"]),ref_key:"cohesionInput",ref:Q},null,544)),[[a.Jo,(0,r.R1)(u).cohesion,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",b,[t[32]||(t[32]=(0,o.Lk)("label",null,[(0,o.eW)("凝集範囲"),(0,o.Lk)("br"),(0,o.eW)("(Cohesion Range):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[4]||(t[4]=e=>(0,r.R1)(u).cohesionRange=e),min:"1",max:"300",step:"1"},null,512),[[a.Jo,(0,r.R1)(u).cohesionRange,void 0,{number:!0}]]),_.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:pe,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).cohesionRange),1)),_.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[5]||(t[5]=e=>(0,r.R1)(u).cohesionRange=e),min:"1",max:"300",step:"1",class:"value-input",onBlur:Ce,onKeyup:(0,a.jR)(Ce,["enter"]),ref_key:"cohesionRangeInput",ref:V},null,544)),[[a.Jo,(0,r.R1)(u).cohesionRange,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",y,[t[33]||(t[33]=(0,o.Lk)("label",null,[(0,o.eW)("分離"),(0,o.Lk)("br"),(0,o.eW)("(Separation):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[6]||(t[6]=e=>(0,r.R1)(u).separation=e),min:"0",max:"10",step:"0.01"},null,512),[[a.Jo,(0,r.R1)(u).separation,void 0,{number:!0}]]),F.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:me,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).separation),1)),F.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[7]||(t[7]=e=>(0,r.R1)(u).separation=e),min:"0",max:"10",step:"0.01",class:"value-input",onBlur:Te,onKeyup:(0,a.jR)(Te,["enter"]),ref_key:"separationInput",ref:J},null,544)),[[a.Jo,(0,r.R1)(u).separation,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",w,[t[34]||(t[34]=(0,o.Lk)("label",null,[(0,o.eW)("分離範囲"),(0,o.Lk)("br"),(0,o.eW)("(Separation Range):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[8]||(t[8]=e=>(0,r.R1)(u).separationRange=e),min:"0.1",max:"10",step:"0.1"},null,512),[[a.Jo,(0,r.R1)(u).separationRange,void 0,{number:!0}]]),M.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:fe,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).separationRange),1)),M.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[9]||(t[9]=e=>(0,r.R1)(u).separationRange=e),min:"0.1",max:"10",step:"0.1",class:"value-input",onBlur:Pe,onKeyup:(0,a.jR)(Pe,["enter"]),ref_key:"separationRangeInput",ref:N},null,544)),[[a.Jo,(0,r.R1)(u).separationRange,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),t[45]||(t[45]=(0,o.eW)()),(0,o.Lk)("div",x,[t[35]||(t[35]=(0,o.Lk)("label",null,[(0,o.eW)("整列"),(0,o.Lk)("br"),(0,o.eW)("(Alignment):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[10]||(t[10]=e=>(0,r.R1)(u).alignment=e),min:"0",max:"20",step:"0.01"},null,512),[[a.Jo,(0,r.R1)(u).alignment,void 0,{number:!0}]]),I.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:ve,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).alignment),1)),I.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[11]||(t[11]=e=>(0,r.R1)(u).alignment=e),min:"0",max:"20",step:"0.01",class:"value-input",onBlur:Le,onKeyup:(0,a.jR)(Le,["enter"]),ref_key:"alignmentInput",ref:Y},null,544)),[[a.Jo,(0,r.R1)(u).alignment,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",R,[t[36]||(t[36]=(0,o.Lk)("label",null,[(0,o.eW)("整列範囲"),(0,o.Lk)("br"),(0,o.eW)("(Alignment Range):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[12]||(t[12]=e=>(0,r.R1)(u).alignmentRange=e),min:"1",max:"100",step:"1"},null,512),[[a.Jo,(0,r.R1)(u).alignmentRange,void 0,{number:!0}]]),W.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:ge,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).alignmentRange),1)),W.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[13]||(t[13]=e=>(0,r.R1)(u).alignmentRange=e),min:"1",max:"100",step:"1",class:"value-input",onBlur:Ee,onKeyup:(0,a.jR)(Ee,["enter"]),ref_key:"alignmentRangeInput",ref:H},null,544)),[[a.Jo,(0,r.R1)(u).alignmentRange,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",k,[t[37]||(t[37]=(0,o.Lk)("label",null,[(0,o.eW)("最大速度"),(0,o.Lk)("br"),(0,o.eW)("(Max Speed):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[14]||(t[14]=e=>(0,r.R1)(u).maxSpeed=e),min:"0.1",max:"2",step:"0.01"},null,512),[[a.Jo,(0,r.R1)(u).maxSpeed,void 0,{number:!0}]]),B.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:he,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).maxSpeed),1)),B.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[15]||(t[15]=e=>(0,r.R1)(u).maxSpeed=e),min:"0.1",max:"2",step:"0.01",class:"value-input",onBlur:Ue,onKeyup:(0,a.jR)(Ue,["enter"]),ref_key:"maxSpeedInput",ref:G},null,544)),[[a.Jo,(0,r.R1)(u).maxSpeed,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),t[46]||(t[46]=(0,o.eW)()),(0,o.Lk)("div",S,[t[38]||(t[38]=(0,o.Lk)("label",null,[(0,o.eW)("最大旋回角"),(0,o.Lk)("br"),(0,o.eW)("(Max Turn Angle):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[16]||(t[16]=e=>(0,r.R1)(u).maxTurnAngle=e),min:"0.001",max:"0.3",step:"0.001"},null,512),[[a.Jo,(0,r.R1)(u).maxTurnAngle,void 0,{number:!0}]]),K.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:be,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).maxTurnAngle),1)),K.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[17]||(t[17]=e=>(0,r.R1)(u).maxTurnAngle=e),min:"0.001",max:"0.3",step:"0.001",class:"value-input",onBlur:Ae,onKeyup:(0,a.jR)(Ae,["enter"]),ref_key:"maxTurnAngleInput",ref:$},null,544)),[[a.Jo,(0,r.R1)(u).maxTurnAngle,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",C,[t[39]||(t[39]=(0,o.Lk)("label",null,[(0,o.eW)("最大近傍数"),(0,o.Lk)("br"),(0,o.eW)("(Max Neighbors):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[18]||(t[18]=e=>(0,r.R1)(u).maxNeighbors=e),min:"0",max:"32",step:"1"},null,512),[[a.Jo,(0,r.R1)(u).maxNeighbors,void 0,{number:!0}]]),D.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:ye,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).maxNeighbors),1)),D.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[19]||(t[19]=e=>(0,r.R1)(u).maxNeighbors=e),min:"0",max:"32",step:"1",class:"value-input",onBlur:_e,onKeyup:(0,a.jR)(_e,["enter"]),ref_key:"maxNeighborsInput",ref:Z},null,544)),[[a.Jo,(0,r.R1)(u).maxNeighbors,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",T,[t[40]||(t[40]=(0,o.Lk)("label",null,[(0,o.eW)("水平化トルク"),(0,o.Lk)("br"),(0,o.eW)("(Horizontal Torque):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[20]||(t[20]=e=>(0,r.R1)(u).horizontalTorque=e),min:"0.0",max:"0.2",step:"0.001"},null,512),[[a.Jo,(0,r.R1)(u).horizontalTorque,void 0,{number:!0}]]),z.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:we,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).horizontalTorque),1)),z.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[21]||(t[21]=e=>(0,r.R1)(u).horizontalTorque=e),min:"0.0",max:"0.2",step:"0.001",class:"value-input",onBlur:Fe,onKeyup:(0,a.jR)(Fe,["enter"]),ref_key:"horizontalTorqueInput",ref:ee},null,544)),[[a.Jo,(0,r.R1)(u).horizontalTorque,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",P,[t[41]||(t[41]=(0,o.Lk)("label",null,[(0,o.eW)("回転トルク強度"),(0,o.Lk)("br"),(0,o.eW)("(Torque Strength):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[22]||(t[22]=e=>(0,r.R1)(u).torqueStrength=e),min:"0.0",max:"20",step:"0.001"},null,512),[[a.Jo,(0,r.R1)(u).torqueStrength,void 0,{number:!0}]]),q.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:xe,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).torqueStrength),1)),q.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[23]||(t[23]=e=>(0,r.R1)(u).torqueStrength=e),min:"0.0",max:"5",step:"0.001",class:"value-input",onBlur:Me,onKeyup:(0,a.jR)(Me,["enter"]),ref_key:"torqueStrengthInput",ref:ne},null,544)),[[a.Jo,(0,r.R1)(u).torqueStrength,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",L,[t[42]||(t[42]=(0,o.Lk)("label",null,[(0,o.eW)("減衰係数"),(0,o.Lk)("br"),(0,o.eW)("(Damping Coefficient):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[24]||(t[24]=e=>(0,r.R1)(u).lambda=e),min:"0",max:"1",step:"0.001"},null,512),[[a.Jo,(0,r.R1)(u).lambda,void 0,{number:!0}]]),X.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:Re,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).lambda),1)),X.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[25]||(t[25]=e=>(0,r.R1)(u).lambda=e),min:"0",max:"1",step:"0.001",class:"value-input",onBlur:Ie,onKeyup:(0,a.jR)(Ie,["enter"]),ref_key:"lambdaInput",ref:te},null,544)),[[a.Jo,(0,r.R1)(u).lambda,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",E,[t[43]||(t[43]=(0,o.Lk)("label",null,[(0,o.eW)("記憶時間"),(0,o.Lk)("br"),(0,o.eW)("(Memory Time):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"range","onUpdate:modelValue":t[26]||(t[26]=e=>(0,r.R1)(u).tau=e),min:"0",max:"5",step:"0.01"},null,512),[[a.Jo,(0,r.R1)(u).tau,void 0,{number:!0}]]),O.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("span",{key:0,class:"editable-value",onClick:ke,title:"クリックして編集"},(0,l.v_)((0,r.R1)(u).tau),1)),O.value?(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:1,type:"number","onUpdate:modelValue":t[27]||(t[27]=e=>(0,r.R1)(u).tau=e),min:"0",max:"5",step:"0.01",class:"value-input",onBlur:We,onKeyup:(0,a.jR)(We,["enter"]),ref_key:"tauInput",ref:ae},null,544)),[[a.Jo,(0,r.R1)(u).tau,void 0,{number:!0}]]):(0,o.Q3)("",!0)]),(0,o.Lk)("div",U,[t[44]||(t[44]=(0,o.Lk)("label",null,[(0,o.eW)("捕食者フラグ"),(0,o.Lk)("br"),(0,o.eW)("(Is Predator):")],-1)),(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[28]||(t[28]=e=>(0,r.R1)(u).isPredator=e)},null,512),[[a.lH,(0,r.R1)(u).isPredator]]),(0,o.Lk)("span",null,(0,l.v_)((0,r.R1)(u).isPredator),1)])])])]))}};var _=t(262);const F=(0,_.A)(A,[["__scopeId","data-v-5992d372"]]),M=F;var I=t(800),W=t(794),B=t(804),K=t(741),D=t(579),z=t(185),q=t(763);const X={id:"app"},O={class:"ui-overlay"},j={style:{"margin-left":"1em"}},Q={style:{"margin-left":"1em"}},V={style:{"margin-left":"1em"}},J={style:{"margin-left":"1em"}},N={class:"info"},Y=1,H=400,G=3,$=1e6,Z=256,ee=4,ne=25,te={__name:"App",setup(e){const n=(0,o.WQ)("wasmModule");n||console.error("wasmModule not provided");const t=n.cwrap("stepSimulation","number",["number"]),c=n.cwrap("build","void",["number","number"]),d=(n.cwrap("exportTreeStructure","object",[]),n.cwrap("boidUnitMappingPtr","number",[])),p=n.cwrap("currentFirstBoidX","number",[]),m=n.cwrap("speciesIdsPtr","number",[]),f=n.cwrap("syncReadToWriteBuffers","void",[]);function v(){return"undefined"!==typeof navigator&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}const g=v()?6e3:1e4,h=[{species:"Boids",count:g,cohesion:32,cohesionRange:30,separation:8,separationRange:.6,alignment:17,alignmentRange:6,maxSpeed:.26,maxTurnAngle:.25,maxNeighbors:6,horizontalTorque:.019,torqueStrength:10,lambda:.62,tau:1.5},{species:"Predator",count:1,cohesion:5.58,separation:0,alignment:0,maxSpeed:1.37,minSpeed:.4,maxTurnAngle:.2,separationRange:14,alignmentRange:11,cohesionRange:77,maxNeighbors:0,lambda:.05,tau:1,horizontalTorque:.022,torqueStrength:0,isPredator:!0}];function b(){try{const e=localStorage.getItem("boids_settings");if(e){const n=JSON.parse(e);if(Array.isArray(n))return n}}catch(e){console.error("Failed to load settings from localStorage:",e)}return h}function y(e){return e.map((e=>JSON.parse(JSON.stringify((0,r.ux)(e)))))}let w=0,x="";const R=(0,o.EW)((()=>Vn())),k=(0,r.Kh)(b());w=Vn(),x=Jn(k);let S=y(k),C=null,T=null;function P(e){const n=new Set(k.map((e=>e.species)));if(e||(e="Species"),!n.has(e))return e;let t=2,a=`${e} ${t}`;while(n.has(a))t+=1,a=`${e} ${t}`;return a}function L(e){return JSON.parse(JSON.stringify(e))}function E(){const e=h[0]?L(h[0]):{species:"Species",count:0,cohesion:20,cohesionRange:30,separation:5,separationRange:1,alignment:10,alignmentRange:6,maxSpeed:.3,maxTurnAngle:.2,maxNeighbors:6,horizontalTorque:.02,torqueStrength:5,lambda:.5,tau:1.5},n=L(e);n.isPredator=!1,n.species=P(n.species),n.count=0,k.push(n)}function U(e){e<0||e>=k.length||k.splice(e,1)}const A=(0,r.KR)(null);let _,F,te,ae,oe,le=null,re=null;const ie=(0,r.KR)(!1),ue=(0,r.KR)(!0),se=(0,r.KR)(!1),ce=(0,r.KR)(!1),de=(0,r.KR)(!1),pe=(0,r.KR)(1);let me=[],fe=[],ve=null,ge=null,he=0,be=0,ye=null,we=0,xe=0,Re=0,ke=0,Se=0,Ce=null,Te=null;function Pe(e){e&&(e.style.position="fixed",e.style.padding="80px",e.style.pointerEvents="none",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-end",e.style.gap="6px",e.style.maxWidth="200px",e.style.width="auto",e.style.boxSizing="border-box",e.style.zIndex=1e3)}function Le(e){"Space"===e.code&&(ie.value=!ie.value)}function Ee(){const e=window.innerWidth,n=window.innerHeight;_=new i.Z58,_.background=new i.Q1f(De.DEEP_BLUE),Oe(),F=new i.ubm(75,e/n,.1,1e3),F.position.set(3,-5,3),F.lookAt(0,0,0),te=new u.JeP({antialias:!0,depth:!0}),te.setPixelRatio(window.devicePixelRatio),te.setSize(e,n),te.shadowMap.enabled=!0,te.shadowMap.type=i.Wk7,ge=te.getContext(),A.value.appendChild(te.domElement),F.aspect=e/n,F.updateProjectionMatrix(),ae=new s.N(F,te.domElement),ae.enableDamping=!0,ae.dampingFactor=.1;const t=new i.bdM(300,300),a=je();a.depthTest=!0;const o=new i.eaF(t,a);o.rotation.x=-Math.PI/2,o.position.y=-10,o.receiveShadow=!0,_.add(o);const l=new i.$p8(ze(De.AMBIENT_LIGHT),.9);_.add(l);const r=new i.ZyN(ze(De.SUN_LIGHT),20);if(r.position.set(300,500,200),r.castShadow=!0,r.shadow.camera.left=-100,r.shadow.camera.right=100,r.shadow.camera.top=100,r.shadow.camera.bottom=-100,r.shadow.camera.near=1,r.shadow.camera.far=1e3,r.shadow.mapSize.width=1024,r.shadow.mapSize.height=1024,r.shadow.bias=-.01,r.shadow.normalBias=.01,_.add(r),!v()){const t={depthBuffer:!0,stencilBuffer:!1};re=new i.nWS(e,n,t),re.depthTexture=new i.VCu(e,n,i.RQf),re.depthTexture.format=i.zdS,re.depthTexture.type=i.RQf,re.depthTexture.needsUpdate=!0,oe=new W.s(te,re);const a=new B.A(_,F);oe.addPass(a);const o=new K.C(_,F,e,n);o.kernelRadius=5,o.minDistance=.01,o.maxDistance=.3,oe.addPass(o);const l=new D.C(new i.I9Y(e,n),1.5,.4,.85);oe.addPass(l),le=new z.p(Xe),le.uniforms.tDepth.value=re.depthTexture,le.uniforms.fogColor.value.copy(qe.color),le.uniforms.distanceStart.value=qe.distanceStart,le.uniforms.distanceEnd.value=qe.distanceEnd,le.uniforms.distanceExponent.value=qe.distanceExponent,le.uniforms.distanceControlPoint1.value.copy(qe.distanceControlPoint1),le.uniforms.distanceControlPoint2.value.copy(qe.distanceControlPoint2),le.uniforms.surfaceLevel.value=qe.surfaceLevel,le.uniforms.heightFalloff.value=qe.heightFalloff,le.uniforms.heightExponent.value=qe.heightExponent,le.uniforms.maxOpacity.value=qe.maxOpacity,le.material.depthTest=!1,le.material.depthWrite=!1,le.material.transparent=!1,le.material.blending=i.XIg,le.material.toneMapped=!0,le.material.needsUpdate=!0,le.renderToScreen=!0,oe.addPass(le)}window.addEventListener("resize",Ue)}function Ue(){const e=window.innerWidth,n=window.innerHeight;F.aspect=e/n,F.updateProjectionMatrix(),te.setSize(e,n),oe&&oe.setSize(e,n),re&&re.setSize(e,n)}let Ae=null,_e=null;const Fe=new Set;function Me(e){const n=new Uint8Array(4*e);for(let a=0;a<e;a++){const t=a/e*Math.PI*2,o=Math.sin(t),l=Math.cos(t);n[4*a]=Math.round(255*(.5*o+.5)),n[4*a+1]=Math.round(255*(.5*l+.5)),n[4*a+2]=0,n[4*a+3]=255}const t=new i.GYF(n,e,1,i.GWd);return t.needsUpdate=!0,t.wrapS=i.GJx,t.wrapT=i.ghU,t.magFilter=i.k6q,t.minFilter=i.k6q,t.generateMipmaps=!1,t.flipY=!1,t}const Ie=[0,0,0,1],We=Me(Z),Be=i.Ktl??i.Vnu,Ke={uniforms:{uTailTime:{value:0},uTailAmplitude:{value:.14},uTailFrequency:{value:10},uTailPhaseStride:{value:5},uTailTurnStrength:{value:.1},uTailSpeedScale:{value:1},uTailRight:{value:new i.Pq0(1,0,0)},uTailForward:{value:new i.Pq0(0,0,1)},uTailUp:{value:new i.Pq0(0,1,0)},uTailEnable:{value:1},uSinLut:{value:We},uLutSize:{value:Z}}},De={SKY_HIGHLIGHT:"#4fbaff",SKY_BLUE:"#15a1ff",DEEP_BLUE:"#002968",SEAFLOOR:"#777465",FOG:"#153a6c",AMBIENT_LIGHT:"#2c9aff",SUN_LIGHT:"#5389b7",SIDE_LIGHT1:"#6ba3d0",SIDE_LIGHT2:"#2d5f7a",BOTTOM_LIGHT:"#0f2635"},ze=e=>parseInt(e.replace("#","0x"),16),qe={color:new i.Q1f(De.DEEP_BLUE),distanceStart:4,distanceEnd:60,distanceExponent:.4,distanceControlPoint1:new i.I9Y(.2,.8),distanceControlPoint2:new i.I9Y(.75,.95),surfaceLevel:100,heightFalloff:.01,heightExponent:1,maxOpacity:1.2},Xe={uniforms:{tDiffuse:{value:null},tDepth:{value:null},cameraNear:{value:.1},cameraFar:{value:1e3},projectionMatrixInverse:{value:new i.kn4},cameraMatrixWorld:{value:new i.kn4},fogColor:{value:qe.color.clone()},distanceStart:{value:qe.distanceStart},distanceEnd:{value:qe.distanceEnd},distanceExponent:{value:qe.distanceExponent},distanceControlPoint1:{value:qe.distanceControlPoint1.clone()},distanceControlPoint2:{value:qe.distanceControlPoint2.clone()},surfaceLevel:{value:qe.surfaceLevel},heightFalloff:{value:qe.heightFalloff},heightExponent:{value:qe.heightExponent},maxOpacity:{value:qe.maxOpacity}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n      vUv = uv;\n      gl_Position = vec4(position.xy, 0.0, 1.0);\n    }\n  ",fragmentShader:"\n    precision highp float;\n    varying vec2 vUv;\n\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tDepth;\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform vec3 fogColor;\n    uniform float distanceStart;\n    uniform float distanceEnd;\n    uniform float distanceExponent;\n    uniform vec2 distanceControlPoint1;\n    uniform vec2 distanceControlPoint2;\n    uniform float surfaceLevel;\n    uniform float heightFalloff;\n    uniform float heightExponent;\n    uniform float maxOpacity;\n    uniform mat4 projectionMatrixInverse;\n    uniform mat4 cameraMatrixWorld;\n\n    float cubicBezier1D(float t, float p0, float p1, float p2, float p3) {\n      float u = 1.0 - t;\n      float uu = u * u;\n      float tt = t * t;\n      return u * uu * p0 + 3.0 * uu * t * p1 + 3.0 * u * tt * p2 + tt * t * p3;\n    }\n\n    float cubicBezierDerivative1D(float t, float p0, float p1, float p2, float p3) {\n      float u = 1.0 - t;\n      return 3.0 * u * u * (p1 - p0)\n           + 6.0 * u * t * (p2 - p1)\n           + 3.0 * t * t * (p3 - p2);\n    }\n\n    float cubicBezierInverse(float x, vec2 c1, vec2 c2) {\n      float t = clamp(x, 0.0, 1.0);\n      for (int i = 0; i < 5; i++) {\n        float current = cubicBezier1D(t, 0.0, c1.x, c2.x, 1.0) - x;\n        float slope = cubicBezierDerivative1D(t, 0.0, c1.x, c2.x, 1.0);\n        if (abs(slope) < 1e-5) {\n          break;\n        }\n        t -= current / slope;\n        t = clamp(t, 0.0, 1.0);\n      }\n      return t;\n    }\n\n    float sampleDistanceCurve(float x, vec2 c1, vec2 c2) {\n      float t = cubicBezierInverse(x, c1, c2);\n      return cubicBezier1D(t, 0.0, c1.y, c2.y, 1.0);\n    }\n\n    void main() {\n      vec4 baseColor = texture2D(tDiffuse, vUv);\n      float depth = texture2D(tDepth, vUv).x;\n\n      if (depth >= 1.0) {\n        gl_FragColor = baseColor;\n        return;\n      }\n\n      vec2 ndc = vUv * 2.0 - 1.0;\n      float ndcZ = depth * 2.0 - 1.0;\n      vec4 clipPos = vec4(ndc, ndcZ, 1.0);\n      vec4 viewPos = projectionMatrixInverse * clipPos;\n      viewPos /= max(viewPos.w, 1e-5);\n      vec4 worldPos = cameraMatrixWorld * viewPos;\n\n      float viewDistance = length(viewPos.xyz);\n      float distanceFogNorm = clamp(\n        (viewDistance - distanceStart) / max(distanceEnd - distanceStart, 1e-5),\n        0.0,\n        1.0\n      );\n      float distanceFog = sampleDistanceCurve(distanceFogNorm, distanceControlPoint1, distanceControlPoint2);\n      distanceFog = pow(distanceFog, distanceExponent);\n\n      float depthBelowSurface = max(surfaceLevel - worldPos.y, 0.0);\n      float heightFactor = 1.0 - exp(-depthBelowSurface * heightFalloff);\n      heightFactor = clamp(pow(heightFactor, heightExponent), 0.0, 1.0);\n\n      float fogFactor = clamp(distanceFog * heightFactor, 0.0, 1.0);\n      fogFactor = mix(0.0, maxOpacity, fogFactor);\n\n      vec3 fogged = mix(baseColor.rgb, fogColor, fogFactor);\n      gl_FragColor = vec4(fogged, baseColor.a);\n      #include <tonemapping_fragment>\n      #include <colorspace_fragment>\n    }\n  "};function Oe(){if(!_)return null;const e=document.createElement("canvas"),n=e.getContext("2d");e.width=512,e.height=512;const t=n.createLinearGradient(0,0,0,e.height);t.addColorStop(0,De.SKY_HIGHLIGHT),t.addColorStop(.2,De.SKY_BLUE),t.addColorStop(.6,De.DEEP_BLUE),t.addColorStop(1,De.DEEP_BLUE),n.fillStyle=t,n.fillRect(0,0,e.width,e.height);const a=new i.GOR(e);a.colorSpace=i.er$,a.generateMipmaps=!1,a.minFilter=i.k6q,a.magFilter=i.k6q;const o=new i.Gu$(300,32,32),l=new i.V9B({map:a,side:i.hsX,fog:!1}),r=new i.eaF(o,l);return _.add(r),r}function je(){const e=new i.Tap,n=e.load("./models/groundAlfa.png");n.minFilter=i.k6q,n.magFilter=i.k6q,n.wrapS=i.ghU,n.wrapT=i.ghU;const t=new i._4j({color:ze(De.SEAFLOOR),transparent:!0,alphaMap:n,depthWrite:!0});return t.roughness=.85,t.metalness=0,t}function Qe(e){Ke.uniforms.uTailTime.value=e}let Ve=0,Je=null,Ne=null,Ye=null,He=0,Ge=0,$e=null,Ze=null,en=0,nn=0,tn=0,an=0,on=null,ln=0,rn=null,un=null,sn=null,cn=0,dn=0,pn=null,mn=null;function fn(){return Float32Array}function vn(e,n,t=Float32Array){const a=e*n,o=[];for(let l=0;l<G;l++){const e=new i.uWO(new t(a),n);e.setUsage(Be),o.push(e)}return o}function gn(e){return{pos:vn(e,3),quat:vn(e,4),tailPhase:vn(e,1),tailParams:vn(e,3,fn())}}function hn(e){for(const n of e.pos){const e=n.array;for(let n=0;n<e.length;n+=3)e[n]=$,e[n+1]=$,e[n+2]=$}for(const n of e.quat){const e=n.array;for(let n=0;n<e.length;n+=4)e[n]=0,e[n+1]=0,e[n+2]=0,e[n+3]=1}for(const n of e.tailPhase)n.array.fill(0);for(const n of e.tailParams)n.array.fill(0)}function bn(e,n,t){e.geometry.setAttribute("instancePos",n.pos[t]),e.geometry.setAttribute("instanceQuat",n.quat[t]),e.geometry.setAttribute("instanceTailPhase",n.tailPhase[t]),e.geometry.setAttribute("instanceTailParams",n.tailParams[t])}function yn(e){e.userData?.instancingPatched||(e.onBeforeCompile=n=>{Object.entries(Ke.uniforms).forEach((([e,t])=>{n.uniforms[e]=t})),n.vertexShader=n.vertexShader.replace("#include <common>","#include <common>\nattribute vec3 instancePos;\nattribute vec4 instanceQuat;\nattribute float aBodyCoord;\nattribute float instanceTailPhase;\nattribute vec3 instanceTailParams;\nuniform float uTailTime;\nuniform float uTailAmplitude;\nuniform float uTailFrequency;\nuniform float uTailPhaseStride;\nuniform float uTailTurnStrength;\nuniform float uTailSpeedScale;\nuniform vec3 uTailRight;\nuniform vec3 uTailForward;\nuniform vec3 uTailUp;\nuniform float uTailEnable;\nuniform sampler2D uSinLut;\nuniform float uLutSize;\nvec3 quatTransform(vec3 v, vec4 q) {\n  vec3 t = 2.0 * cross(q.xyz, v);\n  return v + q.w * t + cross(q.xyz, t);\n}\nvec2 sampleSinCos(float angle) {\n  float u = fract(angle * 0.15915494309189535);\n  u = u * (uLutSize - 1.0) + 0.5;\n  vec4 lutSample = texture(uSinLut, vec2(u / uLutSize, 0.5));\n  return lutSample.rg * 2.0 - 1.0;\n}").replace("#include <instancing_vertex>","#ifdef USE_INSTANCING\n#endif").replace("#include <begin_vertex>","#include <begin_vertex>\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 originalPos = transformed;\n    vec3 right = normalize(uTailRight);\n    vec3 forward = normalize(uTailForward);\n    vec3 up = normalize(uTailUp);\n\n    float localX = dot(originalPos, right);\n    float localY = dot(originalPos, forward);\n    float localZ = dot(originalPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    transformed = rotated;\n  }\n}\ntransformed = quatTransform(transformed, instanceQuat) + instancePos;").replace("#include <beginnormal_vertex>","#include <beginnormal_vertex>\nobjectNormal = quatTransform(objectNormal, instanceQuat);").replace("#include <project_vertex>","#include <project_vertex>\n#ifdef DEPTH_PACKING\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 viewPos = mvPosition.xyz;\n    mat3 normalMatrix3 = mat3(normalMatrix);\n    vec3 right = normalize(normalMatrix3 * uTailRight);\n    vec3 forward = normalize(normalMatrix3 * uTailForward);\n    vec3 up = normalize(normalMatrix3 * uTailUp);\n\n    float localX = dot(viewPos, right);\n    float localY = dot(viewPos, forward);\n    float localZ = dot(viewPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    mvPosition.xyz = rotated;\n    gl_Position = projectionMatrix * mvPosition;\n  }\n}\n#endif"),e.userData={...e.userData||{},instancingPatched:!0}},e.needsUpdate=!0,Fe.add(e))}function wn(e){const n=new i.CSG({depthPacking:i.N5j,alphaTest:e.alphaTest??0});return n.map=e.map??null,n.alphaMap=e.alphaMap??null,n.transparent=e.transparent??!1,yn(n),n}function xn(e){const n=new i.aVO({alphaTest:e.alphaTest??0});return n.map=e.map??null,n.alphaMap=e.alphaMap??null,n.transparent=e.transparent??!1,yn(n),n}function Rn(e){const a=t(e);if(!a)return ke;he=a;const o=n.HEAPU8.buffer;return ye&&be===a&&ye.buffer===o||(ye=new DataView(o,a,16),be=a),we=ye.getUint32(0,!0),xe=ye.getUint32(4,!0),Re=ye.getUint32(8,!0),ke=ye.getInt32(12,!0),ke}function kn(e){const t=n.HEAPF32.buffer;Ye!==t&&(Ye=t,He=0,Ge=0,an=0,$e=null,Ze=null,on=null,en=0,nn=0,ln=0);const a=we,o=Re,l=xe;return!a||!o||!l||e<=0?{positions:$e??new Float32Array(0),orientations:Ze??new Float32Array(0),velocities:on??new Float32Array(0)}:(null!==$e&&en===e&&He===a||(He=a,$e=new Float32Array(t,He,3*e),en=e),null!==Ze&&nn===e&&Ge===o||(Ge=o,Ze=new Float32Array(t,Ge,4*e),nn=e),null!==on&&ln===e&&an===l||(an=l,on=new Float32Array(t,an,3*e),ln=e),{positions:$e,orientations:Ze,velocities:on})}function Sn(e){const t=m?m():0;if(!t||e<=0)return sn??new Int32Array(0);const a=n.HEAP32.buffer;return null!==sn&&cn===t&&dn===e&&pn===a||(cn=t,dn=e,pn=a,sn=new Int32Array(a,t,e)),sn}function Cn(e=[]){const n=[];let t=0;for(const a of e){if(!a)continue;const e=Math.max(0,Number(a.count)||0);n.push({name:a.species||"",start:t,count:e}),t+=e}return n}function Tn(){if(!n)return null;const e=Rn(0);if(!e||e<=0)return{count:0};const{positions:t,velocities:a,orientations:o}=kn(e),l=Sn(e);return{count:e,positions:t?new Float32Array(t):null,velocities:a?new Float32Array(a):null,orientations:o?new Float32Array(o):null,speciesIds:l?new Int32Array(l):null}}function Pn(e,n,t){if(!e||e.count<=0)return;const a=Rn(0);if(!a||a<=0)return;const{positions:o,velocities:l,orientations:r}=kn(a);if(!o||!l||!r)return;const i=e.positions,u=e.velocities,s=e.orientations,c=Cn(n),d=Cn(t),p=new Map(c.map((e=>[e.name,e])));let m=0;for(const f of d){if(!f.count)continue;const n=p.get(f.name);if(!n||!n.count)continue;const t=Math.min(n.count,f.count);for(let c=0;c<t;c+=1){const t=n.start+c,d=f.start+c;if(t>=e.count||d>=a)break;if(i){const e=3*t,n=3*d;o[n]=i[e],o[n+1]=i[e+1],o[n+2]=i[e+2]}if(u){const e=3*t,n=3*d;l[n]=u[e],l[n+1]=u[e+1],l[n+2]=u[e+2]}if(s){const e=4*t,n=4*d;r[n]=s[e],r[n+1]=s[e+1],r[n+2]=s[e+2],r[n+3]=s[e+3]}m+=1}}m>0&&"function"===typeof f&&f()}const Ln=new i.Gu$(1,8,8),En=new i.Gu$(1,3,2);Ln.scale(.5,.5,2),En.scale(.5,.5,2);let Un=null,An=null,_n=null,Fn=null,Mn=null,In=null,Wn=[],Bn=-1,Kn=!1;function Dn(){return k.reduce(((e,n)=>e+(n.isPredator&&n.count?n.count:0)),0)}function zn(e){if(!Mn)return!1;while(Wn.length>e){const e=Wn.pop();e&&_.remove(e)}while(Wn.length<e){const e=Mn.clone(!0);e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),e.visible=!1,_.add(e),Wn.push(e)}return Wn.length===e}function qn(e){const n=new Float32Array(e);for(let t=0;t<e;t++)n[t]=Math.random()*Math.PI*2;return n}function Xn(e,n){if(e&&e.tailPhase)for(const t of e.tailPhase)t.array.set(n),t.needsUpdate=!0}function On(e){un&&un.length===3*e||(un=new Float32Array(3*e))}function jn(e){return e<=0?(mn=null,null):(mn&&mn.length===e||(mn=new Uint8Array(e)),mn)}function Qn(e){if(e.getAttribute("aBodyCoord"))return;const n=e.getAttribute("position");if(!n)return;const t=n.count,a=n.array;let o=1/0,l=1/0,r=1/0,u=-1/0,s=-1/0,c=-1/0;for(let i=0;i<t;i++){const e=3*i,n=a[e],t=a[e+1],d=a[e+2];n<o&&(o=n),n>u&&(u=n),t<l&&(l=t),t>s&&(s=t),d<r&&(r=d),d>c&&(c=d)}const d=u-o,p=s-l,m=c-r;let f="z",v=r,g=m;d>p&&d>m?(f="x",v=o,g=d):p>m&&(f="y",v=l,g=p);const h=new Float32Array(t),b=g>0?g:1;for(let i=0;i<t;i++){const e=3*i,n="x"===f?a[e]:"y"===f?a[e+1]:a[e+2];h[i]=(n-v)/b}e.setAttribute("aBodyCoord",new i.THS(h,1))}function Vn(){return k.reduce(((e,n)=>e+(n.count||0)),0)}function Jn(e=k){return Array.isArray(e)?e.map(((e,n)=>`${n}:${e&&e.count||0}:${e&&e.isPredator?1:0}`)).join("|"):""}function Nn(){const e=new n.VectorSpeciesParams;return k.forEach(((n,t)=>{const a="number"===typeof n.tau?n.tau:0;e.push_back({species:n.species||`Species ${t+1}`,count:n.count||0,speciesId:t,cohesion:n.cohesion||0,separation:n.separation||0,alignment:n.alignment||0,maxSpeed:n.maxSpeed||1,minSpeed:n.minSpeed||0,maxTurnAngle:n.maxTurnAngle||0,separationRange:n.separationRange||0,alignmentRange:n.alignmentRange||0,cohesionRange:n.cohesionRange||0,maxNeighbors:n.maxNeighbors||0,lambda:n.lambda||0,horizontalTorque:n.horizontalTorque||0,velocityEpsilon:n.velocityEpsilon||0,torqueStrength:n.torqueStrength||0,tau:a,isPredator:n.isPredator||!1})})),e}function Yn(){if(!n)return;const e=C?.state||null,t=C?.oldSettings||S,a=T||y(k),o=Jn(a),l=Nn();n.callInitBoids(l,1,6,.25),c(16,0);const r=Vn();w=r,Gn(r),e?.count>0&&Pn(e,t,a),x=o,S=a,C=null,T=null}function Hn(){Ce&&clearTimeout(Ce),C||(C={state:Tn(),oldSettings:S}),T=y(k),Ce=setTimeout((()=>{Ce=null,Yn()}),H)}function Gn(e){if(!Un.children||!Un.children[0])return void console.error("Boid model does not have valid children.");Ae&&(_.remove(Ae),Fe.delete(Ae.material)),_e&&(_.remove(_e),Fe.delete(_e.material)),Fe.clear();const n=_n.clone();n.vertexColors=!1;const t=Fn.clone();t.vertexColors=!1,yn(n),yn(t);const a=Un.children[0].geometry,o=An.children[0].geometry;Qn(a),Qn(o),Ae=new i.ZLX(a,n,e),Ae.castShadow=!0,Ae.receiveShadow=!0,Ae.frustumCulled=!1,Ae.customDepthMaterial=wn(n),Ae.customDistanceMaterial=xn(n),_e=new i.ZLX(o,t,e),_e.castShadow=!0,_e.receiveShadow=!0,_e.frustumCulled=!1,_e.customDepthMaterial=wn(t),_e.customDistanceMaterial=xn(t);const l=new i.Q1f(1,1,1);for(let i=0;i<e;i++)Ae.setColorAt(i,l),_e.setColorAt(i,l);Ae.instanceColor.needsUpdate=!0,_e.instanceColor.needsUpdate=!0,_.add(Ae),_.add(_e),Je=gn(e),Ne=gn(e),hn(Je),hn(Ne),rn=qn(e),Xn(Je,rn),Xn(Ne,rn),Ve=0,bn(Ae,Je,Ve),bn(_e,Ne,Ve),Ae.instanceMatrix.setUsage(i.agE),_e.instanceMatrix.setUsage(i.agE),Ae.count=e,_e.count=e,$e=null,Ze=null,en=0,nn=0,He=0,Ge=0,on=null,ln=0,an=0,un=null,tn=0,sn=null,cn=0,dn=0,pn=null,On(e);const r=jn(e);r&&r.fill(0);const u=Dn();zn(u)&&(Bn=u);for(const i of Wn)i.visible=!1;console.log("InstancedMeshes created with vertex colors enabled")}function $n(e){const n=new q.B,t=new i.Tap;let a=3;const o=()=>{a=Math.max(0,a-1),0===a&&e()},l=t.load("./models/fish.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)})),r=t.load("./models/fish_lod.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)}));l.flipY=!1,l.colorSpace=i.er$,r.flipY=!1,r.colorSpace=i.er$;const u=t.load("./models/fishPredetor.png",(()=>{console.log("Predator texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the predator texture:",e)}));u.flipY=!1,u.colorSpace=i.er$;let s=new i._4j({color:16777215,roughness:.5,metalness:.2,transparent:!1,alphaTest:.5,map:l,vertexColors:!0,vertexColor:16777215}),c=new i._4j({color:16777215,roughness:.5,metalness:.2,transparent:!1,alphaTest:.5,map:r,vertexColors:!1,vertexColor:16777215});_n=s,Fn=c,In=new i._4j({color:16777215,roughness:.5,metalness:0,transparent:!1,alphaTest:.5,map:u,vertexColors:!1,vertexColor:16777215}),n.load("./models/boidModel.glb",(e=>{Un=e.scene,Un.traverse((e=>{e.isMesh&&(e.material=s)})),o()}),void 0,(e=>{console.error("An error occurred while loading the model:",e),o()})),n.load("./models/boidModel_lod.glb",(e=>{An=e.scene,An.traverse((e=>{e.isMesh&&(e.material=c)})),o()}),void 0,(e=>{console.error("An error occurred while loading the LOD model:",e),o()})),n.load("./models/boidPredetorModel.glb",(e=>{Mn=e.scene,Mn.traverse((e=>{e.isMesh&&(e.material=In,e.castShadow=!0,e.receiveShadow=!0)})),Bn=-1,o()}),void 0,(e=>{console.error("An error occurred while loading the predator model:",e),o()}))}function Zn(){for(const e of me)_.remove(e);for(const e of fe)_.remove(e);me=[],fe=[]}let et=performance.now();function nt(){ve?.begin();const e=performance.now(),t=(e-et)/1e3;et=e,ie.value||(tn+=t),Qe(tn);const a=Rn(ie.value?0:t);if(!Ae||!_e||!Je||!Ne)return ae.update(),(v()?te:oe).render(_,F),ve?.end(),ve?.update(),void(Te=setTimeout(nt,Y));const{positions:o,orientations:l,velocities:r}=kn(a);0===(63&Se++)&&p(),On(a);const u=Ve,s=(u+1)%G,c=Je.pos[u],m=Je.quat[u],f=Ne.pos[u],g=Ne.quat[u],h=Je.tailParams[u],b=Ne.tailParams[u],y=c.array,w=m.array,x=f.array,R=g.array,k=h.array,S=b.array,C=jn(a);let T=!1,P=!1,L=!1,E=!1;const U=F.position,A=U.x,M=U.y,I=U.z,W=Dn(),B=W>0?Math.max(0,a-W):a;Bn!==W&&zn(W)&&(Bn=W);for(const n of Wn)n.visible=!1;const K=$;for(let n=0;n<a;++n){const e=3*n,t=o[e],a=o[e+1],i=o[e+2],u=r?r[e]:0,s=r?r[e+1]:0,c=r?r[e+2]:0,d=t-A,p=a-M,m=i-I,f=d*d+p*p+m*m,v=f<ee,g=!v&&f<ne,h=v||g,b=4*n,U=l[b],_=l[b+1],F=l[b+2],D=l[b+3],z=3*n,q=n>=B&&W>0;if(q){const o=n-B,l=Wn[o];l&&(l.visible=!0,l.position.set(t,a,i),l.quaternion.set(U,_,F,D));const r=y[e]!==K||y[e+1]!==K||y[e+2]!==K||w[b]!==Ie[0]||w[b+1]!==Ie[1]||w[b+2]!==Ie[2]||w[b+3]!==Ie[3];r&&(y[e]=K,y[e+1]=K,y[e+2]=K,w[b]=Ie[0],w[b+1]=Ie[1],w[b+2]=Ie[2],w[b+3]=Ie[3],T=!0);const u=x[e]!==K||x[e+1]!==K||x[e+2]!==K||R[b]!==Ie[0]||R[b+1]!==Ie[1]||R[b+2]!==Ie[2]||R[b+3]!==Ie[3];u&&(x[e]=K,x[e+1]=K,x[e+2]=K,R[b]=Ie[0],R[b+1]=Ie[1],R[b+2]=Ie[2],R[b+3]=Ie[3],P=!0);const s=0!==k[z]||0!==k[z+1]||0!==k[z+2];s&&(k[z]=0,k[z+1]=0,k[z+2]=0,L=!0);const c=0!==S[z]||0!==S[z+1]||0!==S[z+2];c&&(S[z]=0,S[z+1]=0,S[z+2]=0,E=!0),C&&(C[n]=0),un&&(un[e]=0,un[e+1]=0,un[e+2]=0);continue}const X=Math.hypot(u,s,c),O=un?un[e]:0,j=un?un[e+1]:0,Q=un?un[e+2]:0,V=Math.hypot(O,j,Q);let J=0;if(V>1e-5&&X>1e-5){const e=Q*u-O*c,n=O*u+j*s+Q*c;J=Math.atan2(e,n)}const N=X,Y=J;if(v){y[e]=t,y[e+1]=a,y[e+2]=i,w[b]=U,w[b+1]=_,w[b+2]=F,w[b+3]=D,T=!0;const n=x[e]!==K||x[e+1]!==K||x[e+2]!==K||R[b]!==Ie[0]||R[b+1]!==Ie[1]||R[b+2]!==Ie[2]||R[b+3]!==Ie[3];n&&(x[e]=K,x[e+1]=K,x[e+2]=K,R[b]=Ie[0],R[b+1]=Ie[1],R[b+2]=Ie[2],R[b+3]=Ie[3],P=!0);const o=0!==S[z]||0!==S[z+1]||0!==S[z+2];o&&(S[z]=0,S[z+1]=0,S[z+2]=0,E=!0)}else{x[e]=t,x[e+1]=a,x[e+2]=i,R[b]=U,R[b+1]=_,R[b+2]=F,R[b+3]=D,P=!0;const n=y[e]!==K||y[e+1]!==K||y[e+2]!==K||w[b]!==Ie[0]||w[b+1]!==Ie[1]||w[b+2]!==Ie[2]||w[b+3]!==Ie[3];n&&(y[e]=K,y[e+1]=K,y[e+2]=K,w[b]=Ie[0],w[b+1]=Ie[1],w[b+2]=Ie[2],w[b+3]=Ie[3],T=!0);const o=0!==k[z]||0!==k[z+1]||0!==k[z+2];o&&(k[z]=0,k[z+1]=0,k[z+2]=0,L=!0)}const H=h?N:0,G=h?Y:0,$=h?1:0;if(v){k[z]=H,k[z+1]=G,k[z+2]=$,L=!0;const e=0!==S[z]||0!==S[z+1]||0!==S[z+2];e&&(S[z]=0,S[z+1]=0,S[z+2]=0,E=!0)}else{S[z]=H,S[z+1]=G,S[z+2]=$,E=!0;const e=0!==k[z]||0!==k[z+1]||0!==k[z+2];e&&(k[z]=0,k[z+1]=0,k[z+2]=0,L=!0)}C&&(C[n]=v?1:2),un&&(un[e]=u,un[e+1]=s,un[e+2]=c)}const D=W>0?Math.max(0,a-W):a;if(Ae.count=D,_e.count=D,bn(Ae,Je,u),bn(_e,Ne,u),c.needsUpdate=T,m.needsUpdate=T,f.needsUpdate=P,g.needsUpdate=P,h.needsUpdate=L,b.needsUpdate=E,Ve=s,de.value){const e=d(),t=n.HEAP32.buffer,o=new Int32Array(t,e,2*a);for(let n=0;n<D;n++){let e=-1;for(let a=0;a<o.length;a+=2)if(o[a]===n){e=o[a+1];break}const t=e>=0?(new i.Q1f).setHSL(e%100/100,.8,.6):new i.Q1f(1,0,0);Ae.setColorAt(n,t),_e.setColorAt(n,t)}Ae.instanceColor.needsUpdate=!0,_e.instanceColor.needsUpdate=!0}else if(Kn){const e=new i.Q1f(1,1,1);for(let n=0;n<D;n++)Ae.setColorAt(n,e),_e.setColorAt(n,e);Ae.instanceColor.needsUpdate=!0,_e.instanceColor.needsUpdate=!0,console.log("✓ Reset vertex colors to white (OFF mode)")}Kn=de.value,ae.update(),le&&(le.uniforms.cameraNear.value=F.near,le.uniforms.cameraFar.value=F.far,le.uniforms.projectionMatrixInverse.value.copy(F.projectionMatrixInverse),le.uniforms.cameraMatrixWorld.value.copy(F.matrixWorld),re?.depthTexture&&(le.uniforms.tDepth.value=re.depthTexture)),v()||!oe?te.render(_,F):oe.render(),ve?.end(),ve?.update(),Te=setTimeout(nt,Y)}function tt(){Yn(),nt()}function at(){k.length=0,h.forEach((e=>k.push({...e})))}return(0,o.sV)((()=>{Ee(),$n((()=>{console.log("Boid model loaded successfully."),ve=new I.A({trackGPU:!0,trackHz:!0,trackCPT:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,precision:2,horizontal:!0,minimal:!1,mode:0});const e=te?.domElement??document.body,n=()=>{const e=("undefined"!==typeof ve?.domElement?ve.domElement:null)||("function"===typeof ve?.getDom?ve.getDom():null)||ve?.dom||ve?.container||ve?.wrapper||null;e&&(e.parentElement||document.body.appendChild(e),Pe(e))},t=ve&&"function"===typeof ve.init?Promise.resolve(ve.init(e)):Promise.resolve();t.then((()=>{"function"===typeof ve?.patchThreeRenderer&&ve.patchThreeRenderer(te),n()})).catch((e=>{console.error("Failed to initialize stats-gl:",e),n()})),tt()})),window.addEventListener("keydown",Le)})),(0,o.wB)(k,(()=>{if(n&&n.setGlobalSpeciesParamsFromJS){n.setGlobalSpeciesParamsFromJS(Nn(),1);try{const e=k.map((e=>({...(0,r.ux)(e)})));localStorage.setItem("boids_settings",JSON.stringify(e))}catch(a){console.error("Failed to save settings to localStorage:",a)}}const e=Jn(k);e!==x?Hn():(Ce&&(clearTimeout(Ce),Ce=null),C=null,T=null,S=y(k));const t=Dn();zn(t)&&(Bn=t);for(const n of Wn)n.visible=!1}),{deep:!0}),(0,o.wB)(ue,(e=>{console.log("showUnits changed to:",e),e||Zn()})),(0,o.wB)([se,ce],(([e,n])=>{console.log("Unit display mode changed - Spheres:",e,"Lines:",n),ue.value&&Zn()})),(e,n)=>((0,o.uX)(),(0,o.CE)("div",X,[(0,o.Lk)("div",O,[n[11]||(n[11]=(0,o.Lk)("h1",null,"Boids Simulation",-1)),(0,o.Lk)("details",null,[n[10]||(n[10]=(0,o.Lk)("summary",null,"Settings",-1)),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(k,((e,n)=>((0,o.uX)(),(0,o.CE)("div",{key:n},[(0,o.bF)(M,{settings:e,"can-remove":k.length>1,onRemove:e=>U(n)},null,8,["settings","can-remove","onRemove"])])))),128)),(0,o.Lk)("button",{class:"add-species-button",onClick:E},"種族を追加"),(0,o.Lk)("button",{onClick:at,style:{"margin-bottom":"1em"}},"リセット"),(0,o.Lk)("div",null,[(0,o.Lk)("label",null,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[0]||(n[0]=e=>ue.value=e)},null,512),[[a.lH,ue.value]]),n[5]||(n[5]=(0,o.eW)(" Unit可視化 "))]),(0,o.Lk)("label",j,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[1]||(n[1]=e=>se.value=e)},null,512),[[a.lH,se.value]]),n[6]||(n[6]=(0,o.eW)(" スフィアのみ表示 "))]),(0,o.Lk)("label",Q,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[2]||(n[2]=e=>ce.value=e)},null,512),[[a.lH,ce.value]]),n[7]||(n[7]=(0,o.eW)(" 線のみ表示 "))]),(0,o.Lk)("label",V,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[3]||(n[3]=e=>de.value=e)},null,512),[[a.lH,de.value]]),n[8]||(n[8]=(0,o.eW)(" Unit色分け "))]),(0,o.Lk)("label",J,[n[9]||(n[9]=(0,o.eW)(" 表示レイヤ下限: ")),(0,o.bo)((0,o.Lk)("input",{type:"range",min:"1",max:"20","onUpdate:modelValue":n[4]||(n[4]=e=>pe.value=e)},null,512),[[a.Jo,pe.value]]),(0,o.eW)(" "+(0,l.v_)(pe.value),1)])])]),(0,o.Lk)("div",N,[(0,o.Lk)("p",null,"Boids Count: "+(0,l.v_)(R.value),1)])]),(0,o.Lk)("div",{ref_key:"threeContainer",ref:A,class:"three-container"},null,512)]))}},ae=te,oe=ae,le="/wasm-boids/".replace(/\/*$/,"/"),re=`${le}static/js`,ie=`${re}/wasm_boids.js`,ue=`${re}/wasm_boids.wasm`;import(ie).then((e=>{if(!e?.default)throw new Error("WASM module loader not found at: "+ie);return e.default({locateFile:e=>e.endsWith(".wasm")?ue:e})})).then((e=>{"undefined"!==typeof window&&(window.wasmModule=e),console.log("Wasm module initialized:",e);const n=(0,a.Ef)(oe);n.provide("wasmModule",e),n.mount("#app")})).catch((e=>{console.error("Failed to initialise WASM module:",e)}))}},n={};function t(a){var o=n[a];if(void 0!==o)return o.exports;var l=n[a]={exports:{}};return e[a](l,l.exports,t),l.exports}t.m=e,(()=>{var e=[];t.O=(n,a,o,l)=>{if(!a){var r=1/0;for(c=0;c<e.length;c++){for(var[a,o,l]=e[c],i=!0,u=0;u<a.length;u++)(!1&l||r>=l)&&Object.keys(t.O).every((e=>t.O[e](a[u])))?a.splice(u--,1):(i=!1,l<r&&(r=l));if(i){e.splice(c--,1);var s=o();void 0!==s&&(n=s)}}return n}l=l||0;for(var c=e.length;c>0&&e[c-1][2]>l;c--)e[c]=e[c-1];e[c]=[a,o,l]}})(),(()=>{t.d=(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})}})(),(()=>{t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n)})(),(()=>{var e={57:0};t.O.j=n=>0===e[n];var n=(n,a)=>{var o,l,[r,i,u]=a,s=0;if(r.some((n=>0!==e[n]))){for(o in i)t.o(i,o)&&(t.m[o]=i[o]);if(u)var c=u(t)}for(n&&n(a);s<r.length;s++)l=r[s],t.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return t.O(c)},a=self["webpackChunkwasm_boids"]=self["webpackChunkwasm_boids"]||[];a.forEach(n.bind(null,0)),a.push=n.bind(null,a.push.bind(a))})();var a=t.O(void 0,[504],(()=>t(307)));a=t.O(a)})();
//# sourceMappingURL=index.3d6820ec.js.map