(()=>{var e={544:(e,t,n)=>{var a=n(751),i=n(641),s=n(953),o=n(33),r=n(922),l=n(437),u=n(24);const c={class:"settings"},d={class:"species-section",open:!1},h={class:"species-header"},p={class:"species-title"},f={class:"species-content"},m={class:"setting-row"},g={class:"setting-row"},v={class:"setting-row"},b={class:"setting-row"},y={class:"setting-row"},S={class:"setting-row"},w={class:"setting-row"},P={class:"setting-row"},C={class:"setting-row"},x={class:"setting-row"},M={class:"setting-row"},R={class:"setting-row"},L={class:"setting-row"},k={class:"setting-row"},T={class:"setting-row"},F={class:"setting-row"},V={class:"setting-row"},B={class:"setting-row"},H={__name:"Settings",props:{settings:{type:Object,required:!0},canRemove:{type:Boolean,default:!1}},emits:["remove"],setup(e,{emit:t}){const n=t,r=e,l=r.settings,u=(0,s.KR)(!1),H=(0,s.KR)(!1),E=(0,s.KR)(!1),A=(0,s.KR)(!1),U=(0,s.KR)(!1),D=(0,s.KR)(!1),W=(0,s.KR)(!1),I=(0,s.KR)(!1),G=(0,s.KR)(!1),_=(0,s.KR)(!1),q=(0,s.KR)(!1),z=(0,s.KR)(!1),O=(0,s.KR)(!1),K=(0,s.KR)(!1),J=(0,s.KR)(!1),N=(0,s.KR)(!1),Q=(0,s.KR)(null),j=(0,s.KR)(null),X=(0,s.KR)(null),Y=(0,s.KR)(null),$=(0,s.KR)(null),Z=(0,s.KR)(null),ee=(0,s.KR)(null),te=(0,s.KR)(null),ne=(0,s.KR)(null),ae=(0,s.KR)(null),ie=(0,s.KR)(null),se=(0,s.KR)(null),oe=(0,s.KR)(null),re=(0,s.KR)(null),le=(0,s.KR)(null),ue=(0,s.KR)(null),ce=(0,s.KR)(l.count??0);async function de(){u.value=!0,ce.value=l.count??0,await(0,i.dY)(),Q.value&&(Q.value.focus(),Q.value.select())}function he(){u.value=!1,ce.value=l.count??0}function pe(){const e=Math.max(0,Math.round(Number.isFinite(ce.value)?ce.value:0));l.count!==e&&(l.count=e)}function fe(){pe()}function me(){pe(),he()}function ge(){n("remove")}async function ve(){H.value=!0,await(0,i.dY)(),j.value&&(j.value.focus(),j.value.select())}async function be(){E.value=!0,await(0,i.dY)(),X.value&&(X.value.focus(),X.value.select())}async function ye(){A.value=!0,await(0,i.dY)(),Y.value&&(Y.value.focus(),Y.value.select())}async function Se(){U.value=!0,await(0,i.dY)(),$.value&&($.value.focus(),$.value.select())}async function we(){D.value=!0,await(0,i.dY)(),Z.value&&(Z.value.focus(),Z.value.select())}async function Pe(){W.value=!0,await(0,i.dY)(),ee.value&&(ee.value.focus(),ee.value.select())}async function Ce(){J.value=!0,await(0,i.dY)(),le.value&&(le.value.focus(),le.value.select())}async function xe(){N.value=!0,await(0,i.dY)(),ue.value&&(ue.value.focus(),ue.value.select())}async function Me(){I.value=!0,await(0,i.dY)(),te.value&&(te.value.focus(),te.value.select())}async function Re(){G.value=!0,await(0,i.dY)(),ne.value&&(ne.value.focus(),ne.value.select())}async function Le(){_.value=!0,await(0,i.dY)(),ae.value&&(ae.value.focus(),ae.value.select())}async function ke(){q.value=!0,await(0,i.dY)(),ie.value&&(ie.value.focus(),ie.value.select())}async function Te(){z.value=!0,await(0,i.dY)(),se.value&&(se.value.focus(),se.value.select())}async function Fe(){O.value=!0,await(0,i.dY)(),oe.value&&(oe.value.focus(),oe.value.select())}async function Ve(){K.value=!0,await(0,i.dY)(),re.value&&(re.value.focus(),re.value.select())}function Be(){H.value=!1}function He(){E.value=!1}function Ee(){A.value=!1}function Ae(){U.value=!1}function Ue(){D.value=!1}function De(){W.value=!1}function We(){J.value=!1}function Ie(){N.value=!1}function Ge(){I.value=!1}function _e(){G.value=!1}function qe(){_.value=!1}function ze(){q.value=!1}function Oe(){z.value=!1}function Ke(){O.value=!1}function Je(){K.value=!1}return(0,i.wB)((()=>l.count),(e=>{u.value||(ce.value=e??0)})),(t,n)=>((0,i.uX)(),(0,i.CE)("div",c,[(0,i.Lk)("details",d,[(0,i.Lk)("summary",h,[(0,i.Lk)("span",p,(0,o.v_)((0,s.R1)(l).species)+" ("+(0,o.v_)((0,s.R1)(l).count)+"匹)",1),e.canRemove?((0,i.uX)(),(0,i.CE)("button",{key:0,class:"species-remove",type:"button",onClick:(0,a.D$)(ge,["stop"])},"削除")):(0,i.Q3)("",!0)]),(0,i.Lk)("div",f,[(0,i.Lk)("div",m,[n[33]||(n[33]=(0,i.Lk)("label",null,[(0,i.eW)("種族名"),(0,i.Lk)("br"),(0,i.eW)("(Species):")],-1)),(0,i.Lk)("span",null,(0,o.v_)((0,s.R1)(l).species),1)]),(0,i.Lk)("div",g,[n[34]||(n[34]=(0,i.Lk)("label",null,[(0,i.eW)("群れの数(要更新)"),(0,i.Lk)("br"),(0,i.eW)("(Count):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[0]||(n[0]=e=>ce.value=e),min:"0",max:"50000",step:"1",onChange:fe},null,544),[[a.Jo,ce.value,void 0,{number:!0}]]),u.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:de,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).count),1)),u.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[1]||(n[1]=e=>ce.value=e),min:"0",max:"20000",class:"value-input",onBlur:he,onKeyup:(0,a.jR)(me,["enter"]),ref_key:"countInput",ref:Q},null,544)),[[a.Jo,ce.value,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",v,[n[35]||(n[35]=(0,i.Lk)("label",null,[(0,i.eW)("凝集"),(0,i.Lk)("br"),(0,i.eW)("(Cohesion):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[2]||(n[2]=e=>(0,s.R1)(l).cohesion=e),min:"0",max:"40",step:"0.01"},null,512),[[a.Jo,(0,s.R1)(l).cohesion,void 0,{number:!0}]]),H.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:ve,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).cohesion),1)),H.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[3]||(n[3]=e=>(0,s.R1)(l).cohesion=e),min:"0",max:"40",step:"0.01",class:"value-input",onBlur:Be,onKeyup:(0,a.jR)(Be,["enter"]),ref_key:"cohesionInput",ref:j},null,544)),[[a.Jo,(0,s.R1)(l).cohesion,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",b,[n[36]||(n[36]=(0,i.Lk)("label",null,[(0,i.eW)("凝集範囲"),(0,i.Lk)("br"),(0,i.eW)("(Cohesion Range):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[4]||(n[4]=e=>(0,s.R1)(l).cohesionRange=e),min:"1",max:"300",step:"1"},null,512),[[a.Jo,(0,s.R1)(l).cohesionRange,void 0,{number:!0}]]),E.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:be,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).cohesionRange),1)),E.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[5]||(n[5]=e=>(0,s.R1)(l).cohesionRange=e),min:"1",max:"300",step:"1",class:"value-input",onBlur:He,onKeyup:(0,a.jR)(He,["enter"]),ref_key:"cohesionRangeInput",ref:X},null,544)),[[a.Jo,(0,s.R1)(l).cohesionRange,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",y,[n[37]||(n[37]=(0,i.Lk)("label",null,[(0,i.eW)("分離"),(0,i.Lk)("br"),(0,i.eW)("(Separation):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[6]||(n[6]=e=>(0,s.R1)(l).separation=e),min:"0",max:"10",step:"0.01"},null,512),[[a.Jo,(0,s.R1)(l).separation,void 0,{number:!0}]]),A.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:ye,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).separation),1)),A.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[7]||(n[7]=e=>(0,s.R1)(l).separation=e),min:"0",max:"10",step:"0.01",class:"value-input",onBlur:Ee,onKeyup:(0,a.jR)(Ee,["enter"]),ref_key:"separationInput",ref:Y},null,544)),[[a.Jo,(0,s.R1)(l).separation,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",S,[n[38]||(n[38]=(0,i.Lk)("label",null,[(0,i.eW)("分離範囲"),(0,i.Lk)("br"),(0,i.eW)("(Separation Range):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[8]||(n[8]=e=>(0,s.R1)(l).separationRange=e),min:"0.1",max:"10",step:"0.1"},null,512),[[a.Jo,(0,s.R1)(l).separationRange,void 0,{number:!0}]]),U.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Se,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).separationRange),1)),U.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[9]||(n[9]=e=>(0,s.R1)(l).separationRange=e),min:"0.1",max:"10",step:"0.1",class:"value-input",onBlur:Ae,onKeyup:(0,a.jR)(Ae,["enter"]),ref_key:"separationRangeInput",ref:$},null,544)),[[a.Jo,(0,s.R1)(l).separationRange,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),n[51]||(n[51]=(0,i.eW)()),(0,i.Lk)("div",w,[n[39]||(n[39]=(0,i.Lk)("label",null,[(0,i.eW)("整列"),(0,i.Lk)("br"),(0,i.eW)("(Alignment):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[10]||(n[10]=e=>(0,s.R1)(l).alignment=e),min:"0",max:"20",step:"0.01"},null,512),[[a.Jo,(0,s.R1)(l).alignment,void 0,{number:!0}]]),D.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:we,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).alignment),1)),D.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[11]||(n[11]=e=>(0,s.R1)(l).alignment=e),min:"0",max:"20",step:"0.01",class:"value-input",onBlur:Ue,onKeyup:(0,a.jR)(Ue,["enter"]),ref_key:"alignmentInput",ref:Z},null,544)),[[a.Jo,(0,s.R1)(l).alignment,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",P,[n[40]||(n[40]=(0,i.Lk)("label",null,[(0,i.eW)("整列範囲"),(0,i.Lk)("br"),(0,i.eW)("(Alignment Range):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[12]||(n[12]=e=>(0,s.R1)(l).alignmentRange=e),min:"1",max:"100",step:"1"},null,512),[[a.Jo,(0,s.R1)(l).alignmentRange,void 0,{number:!0}]]),W.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Pe,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).alignmentRange),1)),W.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[13]||(n[13]=e=>(0,s.R1)(l).alignmentRange=e),min:"1",max:"100",step:"1",class:"value-input",onBlur:De,onKeyup:(0,a.jR)(De,["enter"]),ref_key:"alignmentRangeInput",ref:ee},null,544)),[[a.Jo,(0,s.R1)(l).alignmentRange,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",C,[n[41]||(n[41]=(0,i.Lk)("label",null,[(0,i.eW)("逃避開始距離"),(0,i.Lk)("br"),(0,i.eW)("(Predator Alert):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[14]||(n[14]=e=>(0,s.R1)(l).predatorAlertRadius=e),min:"0",max:"10",step:"0.05"},null,512),[[a.Jo,(0,s.R1)(l).predatorAlertRadius,void 0,{number:!0}]]),J.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Ce,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).predatorAlertRadius),1)),J.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[15]||(n[15]=e=>(0,s.R1)(l).predatorAlertRadius=e),min:"0",max:"20",step:"0.05",class:"value-input",onBlur:We,onKeyup:(0,a.jR)(We,["enter"]),ref_key:"predatorAlertRadiusInput",ref:le},null,544)),[[a.Jo,(0,s.R1)(l).predatorAlertRadius,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",x,[n[42]||(n[42]=(0,i.Lk)("label",null,[(0,i.eW)("密度復帰強度"),(0,i.Lk)("br"),(0,i.eW)("(Density Return):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[16]||(n[16]=e=>(0,s.R1)(l).densityReturnStrength=e),min:"0",max:"80",step:"0.5"},null,512),[[a.Jo,(0,s.R1)(l).densityReturnStrength,void 0,{number:!0}]]),N.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:xe,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).densityReturnStrength),1)),N.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[17]||(n[17]=e=>(0,s.R1)(l).densityReturnStrength=e),min:"0",max:"120",step:"0.5",class:"value-input",onBlur:Ie,onKeyup:(0,a.jR)(Ie,["enter"]),ref_key:"densityReturnStrengthInput",ref:ue},null,544)),[[a.Jo,(0,s.R1)(l).densityReturnStrength,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",M,[n[43]||(n[43]=(0,i.Lk)("label",null,[(0,i.eW)("最大速度"),(0,i.Lk)("br"),(0,i.eW)("(Max Speed):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[18]||(n[18]=e=>(0,s.R1)(l).maxSpeed=e),min:"0.1",max:"2",step:"0.01"},null,512),[[a.Jo,(0,s.R1)(l).maxSpeed,void 0,{number:!0}]]),I.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Me,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).maxSpeed),1)),I.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[19]||(n[19]=e=>(0,s.R1)(l).maxSpeed=e),min:"0.1",max:"2",step:"0.01",class:"value-input",onBlur:Ge,onKeyup:(0,a.jR)(Ge,["enter"])},null,544)),[[a.Jo,(0,s.R1)(l).maxSpeed,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",R,[n[44]||(n[44]=(0,i.Lk)("label",null,[(0,i.eW)("最大旋回速度"),(0,i.Lk)("br"),(0,i.eW)("(Max Turn Rate, rad/s):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[20]||(n[20]=e=>(0,s.R1)(l).maxTurnAngle=e),min:"0",max:"30",step:"0.1"},null,512),[[a.Jo,(0,s.R1)(l).maxTurnAngle,void 0,{number:!0}]]),G.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Re,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).maxTurnAngle),1)),G.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[21]||(n[21]=e=>(0,s.R1)(l).maxTurnAngle=e),min:"0",max:"60",step:"0.1",class:"value-input",onBlur:_e,onKeyup:(0,a.jR)(_e,["enter"]),ref_key:"maxTurnAngleInput",ref:ne},null,544)),[[a.Jo,(0,s.R1)(l).maxTurnAngle,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",L,[n[45]||(n[45]=(0,i.Lk)("label",null,[(0,i.eW)("最大近傍数"),(0,i.Lk)("br"),(0,i.eW)("(Max Neighbors):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[22]||(n[22]=e=>(0,s.R1)(l).maxNeighbors=e),min:"0",max:"32",step:"1"},null,512),[[a.Jo,(0,s.R1)(l).maxNeighbors,void 0,{number:!0}]]),_.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Le,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).maxNeighbors),1)),_.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[23]||(n[23]=e=>(0,s.R1)(l).maxNeighbors=e),min:"0",max:"32",step:"1",class:"value-input",onBlur:qe,onKeyup:(0,a.jR)(qe,["enter"]),ref_key:"maxNeighborsInput",ref:ae},null,544)),[[a.Jo,(0,s.R1)(l).maxNeighbors,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",k,[n[46]||(n[46]=(0,i.Lk)("label",null,[(0,i.eW)("水平化トルク"),(0,i.Lk)("br"),(0,i.eW)("(Horizontal Torque):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[24]||(n[24]=e=>(0,s.R1)(l).horizontalTorque=e),min:"0.0",max:"0.2",step:"0.001"},null,512),[[a.Jo,(0,s.R1)(l).horizontalTorque,void 0,{number:!0}]]),q.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:ke,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).horizontalTorque),1)),q.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[25]||(n[25]=e=>(0,s.R1)(l).horizontalTorque=e),min:"0.0",max:"0.2",step:"0.001",class:"value-input",onBlur:ze,onKeyup:(0,a.jR)(ze,["enter"]),ref_key:"horizontalTorqueInput",ref:ie},null,544)),[[a.Jo,(0,s.R1)(l).horizontalTorque,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",T,[n[47]||(n[47]=(0,i.Lk)("label",null,[(0,i.eW)("回転トルク強度"),(0,i.Lk)("br"),(0,i.eW)("(Torque Strength):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[26]||(n[26]=e=>(0,s.R1)(l).torqueStrength=e),min:"0.0",max:"20",step:"0.001"},null,512),[[a.Jo,(0,s.R1)(l).torqueStrength,void 0,{number:!0}]]),z.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Te,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).torqueStrength),1)),z.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[27]||(n[27]=e=>(0,s.R1)(l).torqueStrength=e),min:"0.0",max:"5",step:"0.001",class:"value-input",onBlur:Oe,onKeyup:(0,a.jR)(Oe,["enter"]),ref_key:"torqueStrengthInput",ref:se},null,544)),[[a.Jo,(0,s.R1)(l).torqueStrength,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",F,[n[48]||(n[48]=(0,i.Lk)("label",null,[(0,i.eW)("減衰係数"),(0,i.Lk)("br"),(0,i.eW)("(Damping Coefficient):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[28]||(n[28]=e=>(0,s.R1)(l).lambda=e),min:"0",max:"1",step:"0.001"},null,512),[[a.Jo,(0,s.R1)(l).lambda,void 0,{number:!0}]]),O.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Fe,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).lambda),1)),O.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[29]||(n[29]=e=>(0,s.R1)(l).lambda=e),min:"0",max:"1",step:"0.001",class:"value-input",onBlur:Ke,onKeyup:(0,a.jR)(Ke,["enter"]),ref_key:"lambdaInput",ref:oe},null,544)),[[a.Jo,(0,s.R1)(l).lambda,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",V,[n[49]||(n[49]=(0,i.Lk)("label",null,[(0,i.eW)("記憶時間"),(0,i.Lk)("br"),(0,i.eW)("(Memory Time):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range","onUpdate:modelValue":n[30]||(n[30]=e=>(0,s.R1)(l).tau=e),min:"0",max:"5",step:"0.01"},null,512),[[a.Jo,(0,s.R1)(l).tau,void 0,{number:!0}]]),K.value?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("span",{key:0,class:"editable-value",onClick:Ve,title:"クリックして編集"},(0,o.v_)((0,s.R1)(l).tau),1)),K.value?(0,i.bo)(((0,i.uX)(),(0,i.CE)("input",{key:1,type:"number","onUpdate:modelValue":n[31]||(n[31]=e=>(0,s.R1)(l).tau=e),min:"0",max:"5",step:"0.01",class:"value-input",onBlur:Je,onKeyup:(0,a.jR)(Je,["enter"]),ref_key:"tauInput",ref:re},null,544)),[[a.Jo,(0,s.R1)(l).tau,void 0,{number:!0}]]):(0,i.Q3)("",!0)]),(0,i.Lk)("div",B,[n[50]||(n[50]=(0,i.Lk)("label",null,[(0,i.eW)("捕食者フラグ"),(0,i.Lk)("br"),(0,i.eW)("(Is Predator):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[32]||(n[32]=e=>(0,s.R1)(l).isPredator=e)},null,512),[[a.lH,(0,s.R1)(l).isPredator]]),(0,i.Lk)("span",null,(0,o.v_)((0,s.R1)(l).isPredator),1)])])])]))}};var E=n(262);const A=(0,E.A)(H,[["__scopeId","data-v-7ee52c0e"]]),U=A;var D=n(800),W=n(763);class I{constructor({tailAnimation:e,tripleBufferSize:t=3,hiddenPosition:n=1e6,identityQuaternion:a=[0,0,0,1],lodNearDistanceSq:i=4,lodMidDistanceSq:s=25}={}){this.tailAnimation=e,this.tripleBufferSize=t,this.hiddenPosition=n,this.identityQuaternion=a,this.lodNearDistanceSq=i,this.lodMidDistanceSq=s,this.streamUsage=r.Ktl??r.Vnu,this.scene=null,this.count=0,this.instancedMeshHigh=null,this.instancedMeshLow=null,this.instancingMaterials=new Set,this.bufferSetHigh=null,this.bufferSetLow=null,this.tailPhaseSeeds=null,this.bufferCursor=0,this.previousVelocities=null,this.previousLodFlags=null,this.predatorModel=null,this.predatorMeshes=[],this.predatorMeshCountCache=-1}init(e,{count:t,boidModel:n,boidModelLod:a,highMaterial:i,lowMaterial:s,predatorModel:o=null}){if(!e||!n||!a||!i||!s)return console.error("BoidInstancing.init: missing required arguments."),!1;if(!n.children?.length||!n.children[0].geometry)return console.error("BoidInstancing.init: invalid high model."),!1;if(!a.children?.length||!a.children[0].geometry)return console.error("BoidInstancing.init: invalid LOD model."),!1;this.dispose(e),this.scene=e,this.count=t,o&&(this.predatorModel=o);const l=i.clone(),u=s.clone();this.patchMaterial(l),this.patchMaterial(u);const c=n.children[0].geometry.clone(),d=a.children[0].geometry.clone();return this.ensureBodyCoordAttribute(c),this.ensureBodyCoordAttribute(d),this.instancedMeshHigh=new r.ZLX(c,l,t),this.configureInstancedMesh(this.instancedMeshHigh,l),this.instancedMeshLow=new r.ZLX(d,u,t),this.configureInstancedMesh(this.instancedMeshLow,u),e.add(this.instancedMeshHigh),e.add(this.instancedMeshLow),this.bufferSetHigh=this.createBufferSet(t),this.bufferSetLow=this.createBufferSet(t),this.resetBufferSetToHidden(this.bufferSetHigh),this.resetBufferSetToHidden(this.bufferSetLow),this.tailPhaseSeeds=this.createTailPhaseArray(t),this.applyTailPhaseSeeds(this.bufferSetHigh,this.tailPhaseSeeds),this.applyTailPhaseSeeds(this.bufferSetLow,this.tailPhaseSeeds),this.bufferCursor=0,this.applyBufferSet(this.instancedMeshHigh,this.bufferSetHigh,this.bufferCursor),this.applyBufferSet(this.instancedMeshLow,this.bufferSetLow,this.bufferCursor),this.instancedMeshHigh.instanceMatrix.setUsage(r.agE),this.instancedMeshLow.instanceMatrix.setUsage(r.agE),this.instancedMeshHigh.count=t,this.instancedMeshLow.count=t,this.previousVelocities=null,this.previousLodFlags=null,this.scene&&this.predatorModel&&this.ensurePredatorMeshes(0),!0}update({count:e,positions:t,orientations:n,velocities:a,cameraPosition:i,predatorCount:s=0}){if(!this.instancedMeshHigh||!this.instancedMeshLow||!this.bufferSetHigh||!this.bufferSetLow)return{visibleCount:0,lodFlags:null};if(!t||!n)return{visibleCount:0,lodFlags:null};const o=this.bufferCursor,r=(o+1)%this.tripleBufferSize;this.ensureTailRuntimeBuffers(e),this.ensureTailSeedCapacity(e);const l=this.ensureLodFlagBuffer(e),u=this.bufferSetHigh.pos[o],c=this.bufferSetHigh.quat[o],d=this.bufferSetHigh.tailParams[o],h=this.bufferSetHigh.tailPhase[o],p=this.bufferSetLow.pos[o],f=this.bufferSetLow.quat[o],m=this.bufferSetLow.tailParams[o],g=this.bufferSetLow.tailPhase[o],v=u.array,b=c.array,y=d.array,S=h.array,w=p.array,P=f.array,C=m.array,x=g.array;let M=!1,R=!1,L=!1,k=!1,T=!1,F=!1;const V=i?.x??0,B=i?.y??0,H=i?.z??0,E=s>0?Math.max(0,e-s):e;if(this.scene&&this.predatorModel){this.ensurePredatorMeshes(s)&&(this.predatorMeshCountCache=s);for(const e of this.predatorMeshes)e.visible=!1}const A=this.previousVelocities,U=this.tailPhaseSeeds;let D=0,W=0;(!this.highInstanceToBoid||this.highInstanceToBoid.length<e)&&(this.highInstanceToBoid=new Uint32Array(e),this.lowInstanceToBoid=new Uint32Array(e));for(let G=0;G<e;G++){const e=3*G,i=4*G,s=t[e],o=t[e+1],r=t[e+2],u=n[i],c=n[i+1],d=n[i+2],h=n[i+3];if(G>=E){if(this.scene&&this.predatorModel){const e=G-E,t=this.predatorMeshes[e];t&&(t.visible=!0,t.position.set(s,o,r),t.quaternion.set(u,c,d,h))}l&&(l[G]=0);continue}const p=s-V,f=o-B,m=r-H,g=p*p+f*f+m*m,I=g<this.lodNearDistanceSq,_=!I&&g<this.lodMidDistanceSq,q=I||_,z=a?a[e]:0,O=a?a[e+1]:0,K=a?a[e+2]:0,J=Math.hypot(z,O,K),N=A?A[e]:0,Q=A?A[e+1]:0,j=A?A[e+2]:0,X=Math.hypot(N,Q,j);let Y=0;if(X>1e-5&&J>1e-5){const e=j*z-N*K,t=N*z+Q*O+j*K;Y=Math.atan2(e,t)}const $=q?J:0,Z=q?Y:0,ee=q?1:0;if(I){const e=D,t=3*e,n=4*e,a=3*e;v[t]=s,v[t+1]=o,v[t+2]=r,b[n]=u,b[n+1]=c,b[n+2]=d,b[n+3]=h,y[a]=$,y[a+1]=Z,y[a+2]=ee;const i=U&&G<U.length?U[G]:0;S[e]=i,this.highInstanceToBoid[e]=G,D++,M=!0,L=!0,T=!0}else{const e=W,t=3*e,n=4*e,a=3*e;w[t]=s,w[t+1]=o,w[t+2]=r,P[n]=u,P[n+1]=c,P[n+2]=d,P[n+3]=h,C[a]=$,C[a+1]=Z,C[a+2]=ee;const i=U&&G<U.length?U[G]:0;x[e]=i,this.lowInstanceToBoid[e]=G,W++,R=!0,k=!0,F=!0}l&&(l[G]=I?1:2),A&&(A[e]=z,A[e+1]=O,A[e+2]=K)}const I=s>0?Math.max(0,e-s):e;return this.instancedMeshHigh.count=D,this.instancedMeshLow.count=W,this.applyBufferSet(this.instancedMeshHigh,this.bufferSetHigh,o),this.applyBufferSet(this.instancedMeshLow,this.bufferSetLow,o),u.needsUpdate=M,c.needsUpdate=M,p.needsUpdate=R,f.needsUpdate=R,d.needsUpdate=L,m.needsUpdate=k,h.needsUpdate=T,g.needsUpdate=F,this.bufferCursor=r,{visibleCount:I,lodFlags:l,highCount:D,lowCount:W,highInstanceToBoid:this.highInstanceToBoid,lowInstanceToBoid:this.lowInstanceToBoid}}forEachInstancingMaterial(e){for(const t of this.instancingMaterials)e(t)}getMeshes(){return{high:this.instancedMeshHigh,low:this.instancedMeshLow}}getPredatorMeshes(){return this.predatorMeshes}setTailUniformTime(e){this.tailAnimation?.uniforms&&this.tailAnimation.uniforms.uTailTime&&(this.tailAnimation.uniforms.uTailTime.value=e)}patchMaterial(e){if(!e||e.userData?.instancingPatched)return;const t=this.tailAnimation?.uniforms;t||console.warn("BoidInstancing.patchMaterial: tailAnimation.uniforms が未設定です"),e.onBeforeCompile=n=>{t&&Object.entries(t).forEach((([e,t])=>{n.uniforms[e]=t})),n.vertexShader=n.vertexShader.replace("#include <common>","#include <common>\nattribute vec3 instancePos;\nattribute vec4 instanceQuat;\nattribute float aBodyCoord;\nattribute float instanceTailPhase;\nattribute vec3 instanceTailParams;\nuniform float uTailTime;\nuniform float uTailAmplitude;\nuniform float uTailFrequency;\nuniform float uTailPhaseStride;\nuniform float uTailTurnStrength;\nuniform float uTailSpeedScale;\nuniform vec3 uTailRight;\nuniform vec3 uTailForward;\nuniform vec3 uTailUp;\nuniform float uTailEnable;\nuniform sampler2D uSinLut;\nuniform float uLutSize;\nvec3 quatTransform(vec3 v, vec4 q) {\n  vec3 t = 2.0 * cross(q.xyz, v);\n  return v + q.w * t + cross(q.xyz, t);\n}\nvec2 sampleSinCos(float angle) {\n  float u = fract(angle * 0.15915494309189535);\n  u = u * (uLutSize - 1.0) + 0.5;\n  vec4 lutSample = texture(uSinLut, vec2(u / uLutSize, 0.5));\n  return lutSample.rg * 2.0 - 1.0;\n}").replace("#include <instancing_vertex>","#ifdef USE_INSTANCING\n#endif\n#ifdef USE_INSTANCING_COLOR\n  vColor.xyz *= instanceColor.xyz;\n#endif").replace("#include <begin_vertex>","#include <begin_vertex>\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 originalPos = transformed;\n    vec3 right = normalize(uTailRight);\n    vec3 forward = normalize(uTailForward);\n    vec3 up = normalize(uTailUp);\n\n    float localX = dot(originalPos, right);\n    float localY = dot(originalPos, forward);\n    float localZ = dot(originalPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    transformed = rotated;\n  }\n}\ntransformed = quatTransform(transformed, instanceQuat) + instancePos;").replace("#include <beginnormal_vertex>","#include <beginnormal_vertex>\nobjectNormal = quatTransform(objectNormal, instanceQuat);").replace("#include <project_vertex>","#include <project_vertex>\n#ifdef DEPTH_PACKING\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 viewPos = mvPosition.xyz;\n    mat3 normalMatrix3 = mat3(normalMatrix);\n    vec3 right = normalize(normalMatrix3 * uTailRight);\n    vec3 forward = normalize(normalMatrix3 * uTailForward);\n    vec3 up = normalize(normalMatrix3 * uTailUp);\n\n    float localX = dot(viewPos, right);\n    float localY = dot(viewPos, forward);\n    float localZ = dot(viewPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    mvPosition.xyz = rotated;\n    gl_Position = projectionMatrix * mvPosition;\n  }\n}\n#endif"),e.userData={...e.userData||{},instancingPatched:!0}},e.needsUpdate=!0,this.instancingMaterials.add(e)}createDepthMaterial(e){const t=new r.CSG({depthPacking:r.N5j,alphaTest:e.alphaTest??0});return t.map=e.map??null,t.alphaMap=e.alphaMap??null,t.transparent=e.transparent??!1,this.patchMaterial(t),t}createDistanceMaterial(e){const t=new r.aVO({alphaTest:e.alphaTest??0});return t.map=e.map??null,t.alphaMap=e.alphaMap??null,t.transparent=e.transparent??!1,this.patchMaterial(t),t}configureInstancedMesh(e,t){e.castShadow=!0,e.receiveShadow=!0,e.frustumCulled=!1,e.customDepthMaterial=this.createDepthMaterial(t),e.customDistanceMaterial=this.createDistanceMaterial(t);const n=new r.Q1f(1,1,1);for(let a=0;a<e.count;a++)e.setColorAt(a,n);e.instanceColor&&(e.instanceColor.needsUpdate=!0)}createAttributeSet(e,t,n=Float32Array){const a=e*t,i=[];for(let s=0;s<this.tripleBufferSize;s++){const e=new r.uWO(new n(a),t);e.setUsage(this.streamUsage),i.push(e)}return i}createBufferSet(e){return{pos:this.createAttributeSet(e,3),quat:this.createAttributeSet(e,4),tailPhase:this.createAttributeSet(e,1),tailParams:this.createAttributeSet(e,3)}}resetBufferSetToHidden(e){for(const t of e.pos){const e=t.array;for(let t=0;t<e.length;t+=3)e[t]=this.hiddenPosition,e[t+1]=this.hiddenPosition,e[t+2]=this.hiddenPosition}for(const t of e.quat){const e=t.array;for(let t=0;t<e.length;t+=4)e[t]=this.identityQuaternion[0],e[t+1]=this.identityQuaternion[1],e[t+2]=this.identityQuaternion[2],e[t+3]=this.identityQuaternion[3]}for(const t of e.tailPhase)t.array.fill(0);for(const t of e.tailParams)t.array.fill(0)}applyBufferSet(e,t,n){e.geometry.setAttribute("instancePos",t.pos[n]),e.geometry.setAttribute("instanceQuat",t.quat[n]),e.geometry.setAttribute("instanceTailPhase",t.tailPhase[n]),e.geometry.setAttribute("instanceTailParams",t.tailParams[n])}createTailPhaseArray(e){const t=new Float32Array(e);for(let n=0;n<e;n++)t[n]=Math.random()*Math.PI*2;return t}applyTailPhaseSeeds(e,t){if(e?.tailPhase)for(const n of e.tailPhase)n.array.set(t),n.needsUpdate=!0}ensureTailRuntimeBuffers(e){const t=3*e;this.previousVelocities&&this.previousVelocities.length===t||(this.previousVelocities=new Float32Array(t))}ensureLodFlagBuffer(e){return e<=0?(this.previousLodFlags=null,null):(this.previousLodFlags&&this.previousLodFlags.length===e||(this.previousLodFlags=new Uint8Array(e)),this.previousLodFlags)}ensureTailSeedCapacity(e){if(e<=0)return;const t=this.tailPhaseSeeds?this.tailPhaseSeeds.length:0;if(!this.tailPhaseSeeds||t<e){const n=new Float32Array(e);this.tailPhaseSeeds&&t>0&&n.set(this.tailPhaseSeeds.subarray(0,t));for(let a=t;a<e;a++)n[a]=Math.random()*Math.PI*2;this.tailPhaseSeeds=n}}ensureBodyCoordAttribute(e){if(e.getAttribute("aBodyCoord"))return;const t=e.getAttribute("position");if(!t)return;const n=t.count,a=t.array;let i=1/0,s=1/0,o=1/0,l=-1/0,u=-1/0,c=-1/0;for(let r=0;r<n;r++){const e=3*r,t=a[e],n=a[e+1],d=a[e+2];t<i&&(i=t),t>l&&(l=t),n<s&&(s=n),n>u&&(u=n),d<o&&(o=d),d>c&&(c=d)}const d=l-i,h=u-s,p=c-o;let f="z",m=o,g=p;d>h&&d>p?(f="x",m=i,g=d):h>p&&(f="y",m=s,g=h);const v=new Float32Array(n),b=g>0?g:1;for(let r=0;r<n;r++){const e=3*r,t="x"===f?a[e]:"y"===f?a[e+1]:a[e+2];v[r]=(t-m)/b}e.setAttribute("aBodyCoord",new r.THS(v,1))}ensurePredatorMeshes(e){if(!this.scene||!this.predatorModel)return!1;const t=Math.max(0,e);while(this.predatorMeshes.length>t){const e=this.predatorMeshes.pop();e&&this.scene.remove(e)}while(this.predatorMeshes.length<t){const e=this.predatorModel.clone(!0);e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),e.visible=!1,this.scene.add(e),this.predatorMeshes.push(e)}return this.predatorMeshes.length===t}dispose(e=this.scene){if(this.instancedMeshHigh&&(e?.remove(this.instancedMeshHigh),this.instancedMeshHigh.geometry?.dispose?.(),this.instancedMeshHigh.material?.dispose?.(),this.instancedMeshHigh=null),this.instancedMeshLow&&(e?.remove(this.instancedMeshLow),this.instancedMeshLow.geometry?.dispose?.(),this.instancedMeshLow.material?.dispose?.(),this.instancedMeshLow=null),e)for(const t of this.predatorMeshes)e.remove(t);this.instancingMaterials.clear(),this.bufferSetHigh=null,this.bufferSetLow=null,this.tailPhaseSeeds=null,this.bufferCursor=0,this.previousVelocities=null,this.previousLodFlags=null,this.predatorMeshes=[],this.predatorMeshCountCache=-1,this.scene=e??null,this.count=0}}var G=n(794),_=n(804),q=n(741),z=n(579),O=n(185);class K{constructor(e){this.config=e,this.composer=null,this.heightFogPass=null,this.heightFogRenderTarget=null,this.renderer=null,this.scene=null,this.camera=null}get heightFog(){return this.heightFogPass}init(e,t,n,a,i){if(!e||!t||!n)return void console.warn("FogPipeline.init: renderer / scene / camera が未設定です");this.dispose(),this.renderer=e,this.scene=t,this.camera=n;const s={depthBuffer:!0,stencilBuffer:!1};this.heightFogRenderTarget=new r.nWS(a,i,s),this.heightFogRenderTarget.depthTexture=new r.VCu(a,i,r.RQf),this.heightFogRenderTarget.depthTexture.format=r.zdS,this.heightFogRenderTarget.depthTexture.type=r.RQf,this.heightFogRenderTarget.depthTexture.needsUpdate=!0,this.composer=new G.s(e,this.heightFogRenderTarget);const o=new _.A(t,n);this.composer.addPass(o);const l=new q.C(t,n,a,i);l.kernelRadius=5,l.minDistance=.01,l.maxDistance=.3,this.composer.addPass(l);const u=1,c=.25,d=.85,h=new z.C(new r.I9Y(a,i),u,c,d);this.composer.addPass(h);const p=J(this.config);this.heightFogPass=new O.p(p);const f=this.heightFogPass.render.bind(this.heightFogPass);this.heightFogPass.render=(e,t,n,a,i)=>{if(this.heightFogPass.uniforms.tDepth){const e=n?.depthTexture??this.heightFogRenderTarget?.depthTexture??null;e&&(this.heightFogPass.uniforms.tDepth.value=e)}f(e,t,n,a,i)},this.heightFogPass.needsSwap=!1,this.heightFogPass.uniforms.tDepth.value=this.heightFogRenderTarget.depthTexture,X(this.heightFogPass.uniforms,this.config);const m=this.heightFogPass.material;m&&(m.depthTest=!1,m.depthWrite=!1,m.transparent=!1,m.blending=r.XIg,m.toneMapped=!0,m.needsUpdate=!0),this.heightFogPass.renderToScreen=!0,this.composer.addPass(this.heightFogPass)}resize(e,t){this.composer&&(this.composer.setSize(e,t),this.heightFogRenderTarget?.setSize(e,t))}render(e){this.composer&&this.composer.render(e)}isReady(){return!!this.composer}updateCameraUniforms(e){const t=this.heightFogPass,n=e||this.camera;if(!t||!n)return;const{uniforms:a}=t;a.cameraNear&&(a.cameraNear.value=n.near),a.cameraFar&&(a.cameraFar.value=n.far),a.projectionMatrixInverse?.value&&a.projectionMatrixInverse.value.copy(n.projectionMatrixInverse),a.cameraMatrixWorld?.value&&a.cameraMatrixWorld.value.copy(n.matrixWorld)}updateConfig(e={}){this.config={...this.config,...e},this.heightFogPass&&X(this.heightFogPass.uniforms,this.config)}dispose(){this.heightFogPass=null,this.composer?.dispose?.(),this.composer=null,this.heightFogRenderTarget?.dispose?.(),this.heightFogRenderTarget=null,this.renderer=null,this.scene=null,this.camera=null}}function J(e={}){const t=N(),n={...t,...e};return{uniforms:{tDiffuse:{value:null},tDepth:{value:null},cameraNear:{value:.1},cameraFar:{value:1e3},projectionMatrixInverse:{value:new r.kn4},cameraMatrixWorld:{value:new r.kn4},fogColor:{value:Q(n.color)},distanceStart:{value:n.distanceStart},distanceEnd:{value:n.distanceEnd},distanceExponent:{value:n.distanceExponent},distanceControlPoint1:{value:j(n.distanceControlPoint1)},distanceControlPoint2:{value:j(n.distanceControlPoint2)},surfaceLevel:{value:n.surfaceLevel},heightFalloff:{value:n.heightFalloff},heightExponent:{value:n.heightExponent},maxOpacity:{value:n.maxOpacity}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n      vUv = uv;\n      gl_Position = vec4(position.xy, 0.0, 1.0);\n    }\n  ",fragmentShader:"\n    precision highp float;\n    varying vec2 vUv;\n\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tDepth;\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform vec3 fogColor;\n    uniform float distanceStart;\n    uniform float distanceEnd;\n    uniform float distanceExponent;\n    uniform vec2 distanceControlPoint1;\n    uniform vec2 distanceControlPoint2;\n    uniform float surfaceLevel;\n    uniform float heightFalloff;\n    uniform float heightExponent;\n    uniform float maxOpacity;\n    uniform mat4 projectionMatrixInverse;\n    uniform mat4 cameraMatrixWorld;\n\n    float cubicBezier1D(float t, float p0, float p1, float p2, float p3) {\n      float u = 1.0 - t;\n      float uu = u * u;\n      float tt = t * t;\n      return u * uu * p0 + 3.0 * uu * t * p1 + 3.0 * u * tt * p2 + tt * t * p3;\n    }\n\n    float cubicBezierDerivative1D(float t, float p0, float p1, float p2, float p3) {\n      float u = 1.0 - t;\n      return 3.0 * u * u * (p1 - p0)\n           + 6.0 * u * t * (p2 - p1)\n           + 3.0 * t * t * (p3 - p2);\n    }\n\n    float cubicBezierInverse(float x, vec2 c1, vec2 c2) {\n      float t = clamp(x, 0.0, 1.0);\n      for (int i = 0; i < 5; i++) {\n        float current = cubicBezier1D(t, 0.0, c1.x, c2.x, 1.0) - x;\n        float slope = cubicBezierDerivative1D(t, 0.0, c1.x, c2.x, 1.0);\n        if (abs(slope) < 1e-5) {\n          break;\n        }\n        t -= current / slope;\n        t = clamp(t, 0.0, 1.0);\n      }\n      return t;\n    }\n\n    float sampleDistanceCurve(float x, vec2 c1, vec2 c2) {\n      float t = cubicBezierInverse(x, c1, c2);\n      return cubicBezier1D(t, 0.0, c1.y, c2.y, 1.0);\n    }\n\n    void main() {\n      vec4 baseColor = texture2D(tDiffuse, vUv);\n      float depth = texture2D(tDepth, vUv).x;\n\n      if (depth >= 1.0) {\n        gl_FragColor = baseColor;\n        return;\n      }\n\n      vec2 ndc = vUv * 2.0 - 1.0;\n      float ndcZ = depth * 2.0 - 1.0;\n      vec4 clipPos = vec4(ndc, ndcZ, 1.0);\n      vec4 viewPos = projectionMatrixInverse * clipPos;\n      viewPos /= max(viewPos.w, 1e-5);\n      vec4 worldPos = cameraMatrixWorld * viewPos;\n\n      float viewDistance = length(viewPos.xyz);\n      float distanceFogNorm = clamp(\n        (viewDistance - distanceStart) / max(distanceEnd - distanceStart, 1e-5),\n        0.0,\n        1.0\n      );\n      float distanceFog = sampleDistanceCurve(distanceFogNorm, distanceControlPoint1, distanceControlPoint2);\n      distanceFog = pow(distanceFog, distanceExponent);\n\n      float depthBelowSurface = max(surfaceLevel - worldPos.y, 0.0);\n      float heightFactor = 1.0 - exp(-depthBelowSurface * heightFalloff);\n      heightFactor = clamp(pow(heightFactor, heightExponent), 0.0, 1.0);\n\n      float fogFactor = clamp(distanceFog * heightFactor, 0.0, 1.0);\n      fogFactor = mix(0.0, maxOpacity, fogFactor);\n\n      vec3 fogged = mix(baseColor.rgb, fogColor, fogFactor);\n      gl_FragColor = vec4(fogged, baseColor.a);\n      #include <tonemapping_fragment>\n      #include <colorspace_fragment>\n    }\n  "}}J();function N(){return{color:new r.Q1f("#153a6c"),distanceStart:4,distanceEnd:60,distanceExponent:.4,distanceControlPoint1:new r.I9Y(.4,.75),distanceControlPoint2:new r.I9Y(.75,.95),surfaceLevel:100,heightFalloff:.01,heightExponent:1,maxOpacity:1}}function Q(e){return e instanceof r.Q1f?e.clone():"string"===typeof e||"number"===typeof e?new r.Q1f(e):new r.Q1f("#000000")}function j(e){return e instanceof r.I9Y?e.clone():e&&"number"===typeof e.x&&"number"===typeof e.y?new r.I9Y(e.x,e.y):new r.I9Y}function X(e,t={}){const n=N(),a={...n,...t};e.fogColor?.value&&e.fogColor.value.copy(Q(a.color)),e.distanceStart&&(e.distanceStart.value=a.distanceStart),e.distanceEnd&&(e.distanceEnd.value=a.distanceEnd),e.distanceExponent&&(e.distanceExponent.value=a.distanceExponent),e.distanceControlPoint1?.value&&e.distanceControlPoint1.value.copy(j(a.distanceControlPoint1)),e.distanceControlPoint2?.value&&e.distanceControlPoint2.value.copy(j(a.distanceControlPoint2)),e.surfaceLevel&&(e.surfaceLevel.value=a.surfaceLevel),e.heightFalloff&&(e.heightFalloff.value=a.heightFalloff),e.heightExponent&&(e.heightExponent.value=a.heightExponent),e.maxOpacity&&(e.maxOpacity.value=a.maxOpacity)}const Y=new r.Pq0(24,12,26),$=new r.Pq0(16,9,18),Z=1.2*Y.z,ee=1.2*$.z,te=30,ne=new r.Pq0(Math.cos(r.cj9.degToRad(te)),-Math.sin(r.cj9.degToRad(te)),0),ae=new r.Pq0(0,0,1),ie=new r.Pq0(0,1,0),se=new r.Pq0,oe=new r.Pq0,re=new r.Pq0,le=new r.Pq0;class ue{constructor(e){this.isMobileDevice=Boolean(e),this.scene=null,this.renderer=null,this.camera=null,this.controls=null,this.particlePoints=null,this.particleMaterial=null,this.elapsedTime=0}init(e,t,n,a){if(!e||!t?.capabilities?.isWebGL2)return console.warn("Skipping particle system: WebGL2 required."),!1;this.dispose(e),this.scene=e,this.renderer=t,this.camera=n,this.controls=a,this.elapsedTime=0;const i=this.isMobileDevice?800:2e3,s=new r.LoY;s.setAttribute("position",new r.THS(new Float32Array(3*i),3)),s.setDrawRange(0,i);const o=(this.isMobileDevice?$:Y).clone(),l=this.isMobileDevice?ee:Z,u=new r.BKk({glslVersion:r.Wdf,transparent:!0,depthWrite:!1,depthTest:!0,blending:r.EZo,uniforms:{uTime:{value:0},uOrigin:{value:new r.Pq0},uFlowDir:{value:ne.clone()},uLat1:{value:ae.clone()},uLat2:{value:ie.clone()},uSpread:{value:o.clone()},uMaxDistance:{value:l},uBaseSpeed:{value:.6},uJitterAmp:{value:.22},uSizePx:{value:this.isMobileDevice?5:12},uFadeNear:{value:1.5},uFadeFar:{value:14},uColorNear:{value:new r.Q1f(7512516)},uColorFar:{value:new r.Q1f(676464)}},vertexShader:ce,fragmentShader:de}),c=a?n.position.distanceTo(a.target):n.position.length();return u.userData={baseSpread:o.clone(),baseMaxDistance:l,baseTargetDistance:Math.max(c,.1)},this.particlePoints=new r.ONl(s,u),this.particlePoints.frustumCulled=!1,this.particlePoints.renderOrder=2,e.add(this.particlePoints),this.particleMaterial=u,this.setWorldBasis(u.uniforms.uFlowDir.value),this.update(n,a),!0}setTime(e){this.elapsedTime=e??this.elapsedTime,this.particleMaterial?.uniforms?.uTime&&(this.particleMaterial.uniforms.uTime.value=this.elapsedTime)}advanceTime(e){Number.isFinite(e)&&0!==e&&(this.elapsedTime+=e,this.particleMaterial?.uniforms?.uTime&&(this.particleMaterial.uniforms.uTime.value=this.elapsedTime))}setWorldBasis(e){if(!this.particleMaterial||!e)return;const t=se.copy(e).normalize(),n=Math.abs(t.y)<.99?oe.set(0,1,0):oe.set(1,0,0),a=re.copy(t).cross(n);a.lengthSq()<1e-6&&(a.set(0,0,1),a.cross(t)),a.normalize();const i=le.copy(t).cross(a).normalize(),s=this.particleMaterial.uniforms;s.uFlowDir.value.copy(t),s.uLat1.value.copy(a),s.uLat2.value.copy(i)}update(e,t){const n=e||this.camera;if(!this.particleMaterial||!n)return;const a=this.particleMaterial.uniforms;a.uOrigin.value.copy(n.position);const{baseSpread:i,baseMaxDistance:s,baseTargetDistance:o}=this.particleMaterial.userData||{};i&&s&&(a.uSpread.value.copy(i),a.uMaxDistance.value=s)}dispose(e){const t=e||this.scene;this.particlePoints&&t&&t.remove(this.particlePoints),this.particlePoints?.geometry?.dispose(),this.particlePoints?.material?.dispose(),this.particlePoints=null,this.particleMaterial=null,this.scene=null,this.renderer=null,this.camera=null,this.controls=null}getMaterial(){return this.particleMaterial}}const ce="\nprecision highp float;\nprecision highp int;\n\nuniform float uTime;\nuniform vec3 uOrigin;\nuniform vec3 uFlowDir;\nuniform vec3 uLat1;\nuniform vec3 uLat2;\nuniform vec3 uSpread;\nuniform float uMaxDistance;\nuniform float uBaseSpeed;\nuniform float uJitterAmp;\nuniform float uSizePx;\nuniform float uFadeNear;\nuniform float uFadeFar;\n\nout float vFade;\nout float vColorMix;\n\nuint hashUint(uint n) {\n  n ^= (n << 13);\n  n ^= (n >> 17);\n  n ^= (n << 5);\n  return n * 0x27d4eb2du;\n}\n\nfloat hashFloat(uint n) {\n  return float(hashUint(n)) / 4294967296.0;\n}\n\nvec3 hashVec3(uint n) {\n  return vec3(\n    hashFloat(n),\n    hashFloat(n * 1664525u + 1013904223u),\n    hashFloat(n * 22695477u + 1u)\n  );\n}\n\nvoid main() {\n  uint id = uint(gl_VertexID);\n  vec3 randSeed = hashVec3(id) - 0.5;\n\n  vec3 flowDir = normalize(uFlowDir);\n  vec3 lateral = uLat1 * (randSeed.x * uSpread.x)\n    + uLat2 * (randSeed.y * uSpread.y);\n\n  float speedSeed = hashFloat(id * 747796405u);\n  float speed = uBaseSpeed * (0.7 + 0.6 * speedSeed);\n  float flowCycle = max(uSpread.z, 1e-3);\n  float flowParam = randSeed.z + (uTime * speed) / flowCycle;\n  float wrappedZ = fract(flowParam) - 0.5;\n  vec3 pos = uOrigin + lateral + flowDir * (wrappedZ * flowCycle);\n\n  float phase = hashFloat(id * 1664525u) * 6.28318530718;\n  float driftSeed = hashFloat(id * 22695477u);\n  float triangle = 1.0 - abs(fract((phase + uTime * (0.8 + 0.4 * driftSeed)) / 3.14159265) * 2.0 - 1.0);\n\n  vec3 jitter1 = normalize(uLat1);\n  vec3 jitter2 = normalize(uLat2);\n  pos += jitter1 * ((triangle - 0.5) * uJitterAmp);\n  pos += jitter2 * ((hashFloat(id * 1103515245u) - 0.5) * uJitterAmp * 0.6);\n\n  vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n  float dist = -mvPosition.z;\n  float forwardMask = step(0.0, dist);\n\n  vec4 clipPosition = projectionMatrix * mvPosition;\n  float invW = 1.0 / max(abs(clipPosition.w), 1e-3);\n  vec2 ndc = clipPosition.xy * invW;\n\n  float screenMask = 1.0 - smoothstep(0.96, 1.16, max(abs(ndc.x), abs(ndc.y)));\n  float rangeMask = 1.0 - smoothstep(uMaxDistance * 0.7, uMaxDistance, dist);\n\n  float fadeT = clamp((dist - uFadeNear) / max(uFadeFar - uFadeNear, 1e-3), 0.0, 1.0);\n  float fade = (1.0 - fadeT) * screenMask * rangeMask * forwardMask;\n  vFade = fade;\n  vColorMix = fade;\n\n  float sizeBase = uSizePx * projectionMatrix[1][1] / max(dist, 1e-3);\n  float attenuatedSize = sizeBase * fade;\n  gl_PointSize = max(attenuatedSize, 0.75) * step(0.001, fade);\n  gl_Position = clipPosition;\n}\n",de="\nprecision highp float;\n\nin float vFade;\nin float vColorMix;\n\nuniform vec3 uColorNear;\nuniform vec3 uColorFar;\n\nout vec4 fragColor;\n\nvoid main() {\n  vec2 coord = gl_PointCoord - vec2(0.5);\n  float falloff = exp(-8.0 * dot(coord, coord));\n  float alpha = vFade * falloff * 0.6;\n  if (alpha < 0.004) {\n    discard;\n  }\n  vec3 color = mix(uColorFar, uColorNear, vColorMix);\n  fragColor = vec4(color, alpha);\n}\n";class he{constructor(e){if(!e)throw new Error("WasmtimeBridge: wasmModule が未定義です");this.wasm=e,this.latestStatePtr=0,this.latestStateHeaderPtr=0,this.latestStateHeaderView=null,this.latestPositionsPtr=0,this.latestVelocitiesPtr=0,this.latestOrientationsPtr=0,this.latestBoidCount=0,this.cachedHeapBuffer=null,this.cachedPositionsPtr=0,this.cachedOrientationsPtr=0,this.cachedVelocitiesPtr=0,this.cachedSpeciesIdsPtr=0,this.cachedPositionsView=null,this.cachedOrientationsView=null,this.cachedVelocitiesView=null,this.cachedSpeciesIdsView=null,this.cachedPositionsCount=0,this.cachedOrientationsCount=0,this.cachedVelocitiesCount=0,this.cachedSpeciesIdsCount=0,this.cachedSpeciesIdsBuffer=null,this.cachedUnitDensityPtr=0,this.cachedUnitDensityCount=0,this.cachedUnitDensityView=null,this.cachedSpeciesEnvelopePtr=0,this.cachedSpeciesEnvelopeCount=0,this.cachedSpeciesEnvelopeView=null,this.cachedSpeciesClusterPtr=0,this.cachedSpeciesClusterCount=0,this.cachedSpeciesClusterView=null,this.cachedSpeciesSchoolClusterPtr=0,this.cachedSpeciesSchoolClusterCount=0,this.cachedSpeciesSchoolClusterView=null,this.cachedHeatGridMetaPtr=0,this.cachedHeatGridMetaCount=0,this.cachedHeatGridMetaView=null,this.cachedHeatGridValuesPtr=0,this.cachedHeatGridValuesCount=0,this.cachedHeatGridValuesView=null,this.stepSimulationHandle=this.createWrappedFunction("stepSimulation","number",["number"]),this.buildHandle=this.createWrappedFunction("build","void",["number","number"]),this.exportTreeStructureHandle=this.createWrappedFunction("exportTreeStructure","object",[]),this.boidUnitMappingPtrHandle=this.createWrappedFunction("boidUnitMappingPtr","number",[]),this.currentFirstBoidXHandle=this.createWrappedFunction("currentFirstBoidX","number",[]),this.speciesIdsPtrHandle=this.createWrappedFunction("speciesIdsPtr","number",[]),this.syncReadToWriteBuffersHandle=this.createWrappedFunction("syncReadToWriteBuffers","void",[]),this.getSimulationTuningParamsHandle=this.createWrappedFunction("getSimulationTuningParams","object",[]),this.setSimulationTuningParamsHandle=this.createWrappedFunction("setSimulationTuningParams","void",["object"]),this.unitSimpleDensityPtrHandle=this.createWrappedFunction("unitSimpleDensityPtr","number",[]),this.unitSimpleDensityCountHandle=this.createWrappedFunction("unitSimpleDensityCount","number",[]),this.speciesEnvelopesPtrHandle=this.createWrappedFunction("speciesEnvelopesPtr","number",[]),this.speciesEnvelopesCountHandle=this.createWrappedFunction("speciesEnvelopesCount","number",[]),this.speciesClustersPtrHandle=this.createWrappedFunction("speciesClustersPtr","number",[]),this.speciesClustersCountHandle=this.createWrappedFunction("speciesClustersCount","number",[]),this.speciesSchoolClustersPtrHandle=this.createWrappedFunction("speciesSchoolClustersPtr","number",[]),this.speciesSchoolClustersCountHandle=this.createWrappedFunction("speciesSchoolClustersCount","number",[]),this.heatGridMetaPtrHandle=this.createWrappedFunction("heatGridMetaPtr","number",[]),this.heatGridMetaCountHandle=this.createWrappedFunction("heatGridMetaCount","number",[]),this.heatGridValuesPtrHandle=this.createWrappedFunction("heatGridValuesPtr","number",[]),this.heatGridValuesCountHandle=this.createWrappedFunction("heatGridValuesCount","number",[])}getSimulationTuningParams(){if(!this.wasm)return null;const e=this.ensureHandle(this.getSimulationTuningParamsHandle,"getSimulationTuningParams");return e?e():null}setSimulationTuningParams(e){if(!this.wasm)return;const t=this.ensureHandle(this.setSimulationTuningParamsHandle,"setSimulationTuningParams");if(!t||!e)return;const n=(e,t)=>{const n=Number(e);return Number.isFinite(n)?n:t};t({threatDecay:n(e.threatDecay,.5),threatGain:n(e.threatGain,2),maxEscapeWeight:n(e.maxEscapeWeight,1),baseEscapeStrength:n(e.baseEscapeStrength,3),escapeStrengthPerThreat:n(e.escapeStrengthPerThreat,10),cohesionBoost:n(e.cohesionBoost,2),separationMinFactor:n(e.separationMinFactor,1),alignmentBoost:n(e.alignmentBoost,1.2),fastAttractStrength:n(e.fastAttractStrength,1),heatDepositDecay:n(e.heatDepositDecay,.08),heatPassiveDecay:n(e.heatPassiveDecay,.005),heatBlendRatio:n(e.heatBlendRatio,.35)})}buildSpeciesParams(e){if(!Array.isArray(e))return null;const t=new this.wasm.VectorSpeciesParams;return e.forEach(((e,n)=>{if(!e)return;const a=(e,t=0)=>{const n=Number(e);return Number.isFinite(n)?n:t};t.push_back({species:"string"===typeof e.species?e.species:`Species ${n+1}`,count:Math.max(0,Math.floor(a(e.count,0))),speciesId:Math.max(0,Math.floor(a(e.speciesId,n))),cohesion:a(e.cohesion,0),separation:a(e.separation,0),alignment:a(e.alignment,0),maxSpeed:a(e.maxSpeed,1),minSpeed:a(e.minSpeed,0),maxTurnAngle:a(e.maxTurnAngle,0),separationRange:a(e.separationRange,0),alignmentRange:a(e.alignmentRange,0),cohesionRange:a(e.cohesionRange,0),maxNeighbors:Math.max(0,Math.floor(a(e.maxNeighbors,0))),lambda:a(e.lambda,0),tau:a(e.tau,0),horizontalTorque:a(e.horizontalTorque,0),velocityEpsilon:a(e.velocityEpsilon,1e-4),torqueStrength:a(e.torqueStrength,0),bodyHeadLength:a(e.bodyHeadLength,-.15),bodyTailLength:a(e.bodyTailLength,.33),bodyRadius:a(e.bodyRadius,.035),predatorAlertRadius:a(e.predatorAlertRadius,1),isPredator:Boolean(e.isPredator),densityReturnStrength:a(e.densityReturnStrength??e.centerAttractStrength,0)})})),t}stepSimulation(e){const t=this.ensureHandle(this.stepSimulationHandle,"stepSimulation"),{wasm:n}=this,a=Number.isFinite(e)?e:0,i=t(a);if(!i)return this.latestStatePtr=0,this.latestStateHeaderPtr=0,this.latestPositionsPtr=0,this.latestVelocitiesPtr=0,this.latestOrientationsPtr=0,this.latestStateHeaderView=null,this.latestBoidCount=0,0;const s=n.HEAPU8.buffer;return this.latestStateHeaderView&&this.latestStateHeaderPtr===i&&this.latestStateHeaderView.buffer===s||(this.latestStateHeaderView=new DataView(s,i,16),this.latestStateHeaderPtr=i),this.latestStatePtr=i,this.latestPositionsPtr=this.latestStateHeaderView.getUint32(0,!0),this.latestVelocitiesPtr=this.latestStateHeaderView.getUint32(4,!0),this.latestOrientationsPtr=this.latestStateHeaderView.getUint32(8,!0),this.latestBoidCount=this.latestStateHeaderView.getInt32(12,!0),this.latestBoidCount}getBuffers(e){if(!this.wasm)return{positions:new Float32Array(0),orientations:new Float32Array(0),velocities:new Float32Array(0),speciesIds:new Int32Array(0)};const t=this.wasm.HEAPF32.buffer,n=this.wasm.HEAP32.buffer;if(this.cachedHeapBuffer===t&&this.cachedSpeciesIdsBuffer===n||(this.cachedHeapBuffer=t,this.cachedSpeciesIdsBuffer=n,this.cachedPositionsPtr=0,this.cachedOrientationsPtr=0,this.cachedVelocitiesPtr=0,this.cachedSpeciesIdsPtr=0,this.cachedPositionsView=null,this.cachedOrientationsView=null,this.cachedVelocitiesView=null,this.cachedSpeciesIdsView=null,this.cachedPositionsCount=0,this.cachedOrientationsCount=0,this.cachedVelocitiesCount=0,this.cachedSpeciesIdsCount=0,this.cachedUnitDensityPtr=0,this.cachedUnitDensityCount=0,this.cachedUnitDensityView=null,this.cachedSpeciesEnvelopePtr=0,this.cachedSpeciesEnvelopeCount=0,this.cachedSpeciesEnvelopeView=null,this.cachedSpeciesClusterPtr=0,this.cachedSpeciesClusterCount=0,this.cachedSpeciesClusterView=null,this.cachedSpeciesSchoolClusterPtr=0,this.cachedSpeciesSchoolClusterCount=0,this.cachedSpeciesSchoolClusterView=null),!this.latestPositionsPtr||!this.latestOrientationsPtr||!this.latestVelocitiesPtr||e<=0)return{positions:this.cachedPositionsView??new Float32Array(0),orientations:this.cachedOrientationsView??new Float32Array(0),velocities:this.cachedVelocitiesView??new Float32Array(0),speciesIds:this.cachedSpeciesIdsView??new Int32Array(0)};null!==this.cachedPositionsView&&this.cachedPositionsCount===e&&this.cachedPositionsPtr===this.latestPositionsPtr||(this.cachedPositionsPtr=this.latestPositionsPtr,this.cachedPositionsView=new Float32Array(t,this.cachedPositionsPtr,3*e),this.cachedPositionsCount=e),null!==this.cachedOrientationsView&&this.cachedOrientationsCount===e&&this.cachedOrientationsPtr===this.latestOrientationsPtr||(this.cachedOrientationsPtr=this.latestOrientationsPtr,this.cachedOrientationsView=new Float32Array(t,this.cachedOrientationsPtr,4*e),this.cachedOrientationsCount=e),null!==this.cachedVelocitiesView&&this.cachedVelocitiesCount===e&&this.cachedVelocitiesPtr===this.latestVelocitiesPtr||(this.cachedVelocitiesPtr=this.latestVelocitiesPtr,this.cachedVelocitiesView=new Float32Array(t,this.cachedVelocitiesPtr,3*e),this.cachedVelocitiesCount=e);const a="function"===typeof this.speciesIdsPtrHandle?this.speciesIdsPtrHandle():0;return!a||null!==this.cachedSpeciesIdsView&&this.cachedSpeciesIdsPtr===a&&this.cachedSpeciesIdsCount===e&&this.cachedSpeciesIdsBuffer===n||(this.cachedSpeciesIdsPtr=a,this.cachedSpeciesIdsCount=e,this.cachedSpeciesIdsBuffer=n,this.cachedSpeciesIdsView=new Int32Array(n,a,e)),{positions:this.cachedPositionsView,orientations:this.cachedOrientationsView,velocities:this.cachedVelocitiesView,speciesIds:this.cachedSpeciesIdsView}}captureState(){if(!this.wasm)return null;const e=this.stepSimulation(0);if(!e||e<=0)return{count:0};const{positions:t,velocities:n,orientations:a,speciesIds:i}=this.getBuffers(e);return{count:e,positions:t?new Float32Array(t):null,velocities:n?new Float32Array(n):null,orientations:a?new Float32Array(a):null,speciesIds:i?new Int32Array(i):null}}restoreState(e,t,n){if(!e||e.count<=0)return;const a=this.stepSimulation(0);if(!a||a<=0)return;const{positions:i,velocities:s,orientations:o}=this.getBuffers(a);if(!i||!s||!o)return;const r=e.positions,l=e.velocities,u=e.orientations,c=pe(t),d=pe(n),h=new Map(c.map((e=>[e.name,e])));let p=0;for(const f of d){if(!f.count)continue;const t=h.get(f.name);if(!t||!t.count)continue;const n=Math.min(t.count,f.count);for(let c=0;c<n;c+=1){const n=t.start+c,d=f.start+c;if(n>=e.count||d>=a)break;if(r){const e=3*n,t=3*d;i[t]=r[e],i[t+1]=r[e+1],i[t+2]=r[e+2]}if(l){const e=3*n,t=3*d;s[t]=l[e],s[t+1]=l[e+1],s[t+2]=l[e+2]}if(u){const e=4*n,t=4*d;o[t]=u[e],o[t+1]=u[e+1],o[t+2]=u[e+2],o[t+3]=u[e+3]}p+=1}}p>0&&this.syncReadToWriteBuffers()}buildSpatialIndex(e,t){const n=this.ensureHandle(this.buildHandle,"build");n(e,t)}exportTreeStructure(){return"function"!==typeof this.exportTreeStructureHandle?null:this.exportTreeStructureHandle()}currentFirstBoidX(){return"function"!==typeof this.currentFirstBoidXHandle?0:this.currentFirstBoidXHandle()}getUnitMappings(e){if(!e||e<=0||"function"!==typeof this.boidUnitMappingPtrHandle)return null;const t=this.boidUnitMappingPtrHandle();return t?new Int32Array(this.wasm.HEAP32.buffer,t,2*e):null}getUnitSimpleDensities(){if(!this.wasm)return null;if("function"!==typeof this.unitSimpleDensityPtrHandle||"function"!==typeof this.unitSimpleDensityCountHandle)return null;const e=this.unitSimpleDensityCountHandle(),t=this.unitSimpleDensityPtrHandle();if(!t||!e||e<=0)return this.cachedUnitDensityPtr=0,this.cachedUnitDensityCount=0,this.cachedUnitDensityView=null,null;const n=this.wasm.HEAPF32.buffer;return null!==this.cachedUnitDensityView&&this.cachedUnitDensityPtr===t&&this.cachedUnitDensityCount===e&&this.cachedHeapBuffer===n||(this.cachedUnitDensityPtr=t,this.cachedUnitDensityCount=e,this.cachedUnitDensityView=new Float32Array(n,t,e)),this.cachedUnitDensityView}getSpeciesEnvelopes(){if(!this.wasm)return null;if("function"!==typeof this.speciesEnvelopesPtrHandle||"function"!==typeof this.speciesEnvelopesCountHandle)return null;const e=this.speciesEnvelopesCountHandle(),t=this.speciesEnvelopesPtrHandle();if(!t||!e||e<=0)return this.cachedSpeciesEnvelopePtr=0,this.cachedSpeciesEnvelopeCount=0,this.cachedSpeciesEnvelopeView=null,null;const n=this.wasm.HEAPF32.buffer;null!==this.cachedSpeciesEnvelopeView&&this.cachedSpeciesEnvelopePtr===t&&this.cachedSpeciesEnvelopeCount===e&&this.cachedHeapBuffer===n||(this.cachedSpeciesEnvelopePtr=t,this.cachedSpeciesEnvelopeCount=e,this.cachedSpeciesEnvelopeView=new Float32Array(n,t,e),this.cachedHeapBuffer=n);const a=Math.floor(e/5);return{buffer:this.cachedSpeciesEnvelopeView,count:a}}getSpeciesClusters(){if(!this.wasm)return null;if("function"!==typeof this.speciesClustersPtrHandle||"function"!==typeof this.speciesClustersCountHandle)return null;const e=this.speciesClustersCountHandle(),t=this.speciesClustersPtrHandle();if(!t||!e||e<=0)return this.cachedSpeciesClusterPtr=0,this.cachedSpeciesClusterCount=0,this.cachedSpeciesClusterView=null,null;const n=this.wasm.HEAPF32.buffer;null!==this.cachedSpeciesClusterView&&this.cachedSpeciesClusterPtr===t&&this.cachedSpeciesClusterCount===e&&this.cachedHeapBuffer===n||(this.cachedSpeciesClusterPtr=t,this.cachedSpeciesClusterCount=e,this.cachedSpeciesClusterView=new Float32Array(n,t,e),this.cachedHeapBuffer=n);const a=Math.floor(e/6);return{buffer:this.cachedSpeciesClusterView,count:a}}getSpeciesSchoolClusters(){if(!this.wasm)return null;if("function"!==typeof this.speciesSchoolClustersPtrHandle||"function"!==typeof this.speciesSchoolClustersCountHandle)return null;const e=this.speciesSchoolClustersCountHandle(),t=this.speciesSchoolClustersPtrHandle();if(!t||!e||e<=0)return this.cachedSpeciesSchoolClusterPtr=0,this.cachedSpeciesSchoolClusterCount=0,this.cachedSpeciesSchoolClusterView=null,null;const n=this.wasm.HEAPF32.buffer;null!==this.cachedSpeciesSchoolClusterView&&this.cachedSpeciesSchoolClusterPtr===t&&this.cachedSpeciesSchoolClusterCount===e&&this.cachedHeapBuffer===n||(this.cachedSpeciesSchoolClusterPtr=t,this.cachedSpeciesSchoolClusterCount=e,this.cachedSpeciesSchoolClusterView=new Float32Array(n,t,e),this.cachedHeapBuffer=n);const a=Math.floor(e/6);return{buffer:this.cachedSpeciesSchoolClusterView,count:a}}getHeatGridDebugBuffers(){if(!this.wasm)return null;if("function"!==typeof this.heatGridMetaPtrHandle||"function"!==typeof this.heatGridMetaCountHandle||"function"!==typeof this.heatGridValuesPtrHandle||"function"!==typeof this.heatGridValuesCountHandle)return null;const e=this.heatGridMetaCountHandle(),t=this.heatGridMetaPtrHandle(),n=this.heatGridValuesCountHandle(),a=this.heatGridValuesPtrHandle();if(!t||!e||e<=0||!a||!n||n<=0)return this.cachedHeatGridMetaPtr=0,this.cachedHeatGridMetaCount=0,this.cachedHeatGridMetaView=null,this.cachedHeatGridValuesPtr=0,this.cachedHeatGridValuesCount=0,this.cachedHeatGridValuesView=null,null;const i=this.wasm.HEAPF32.buffer;null!==this.cachedHeatGridMetaView&&this.cachedHeatGridMetaPtr===t&&this.cachedHeatGridMetaCount===e&&this.cachedHeapBuffer===i||(this.cachedHeatGridMetaPtr=t,this.cachedHeatGridMetaCount=e,this.cachedHeatGridMetaView=new Float32Array(i,t,e),this.cachedHeapBuffer=i),null!==this.cachedHeatGridValuesView&&this.cachedHeatGridValuesPtr===a&&this.cachedHeatGridValuesCount===n&&this.cachedHeapBuffer===i||(this.cachedHeatGridValuesPtr=a,this.cachedHeatGridValuesCount=n,this.cachedHeatGridValuesView=new Float32Array(i,a,n),this.cachedHeapBuffer=i);const s=Math.floor(e/6);return{meta:this.cachedHeatGridMetaView,values:this.cachedHeatGridValuesView,speciesCount:s}}syncReadToWriteBuffers(){"function"===typeof this.syncReadToWriteBuffersHandle&&this.syncReadToWriteBuffersHandle()}createWrappedFunction(e,t,n){const{wasm:a}=this;if(!a)return null;if("function"===typeof a[e])return a[e].bind(a);if("function"===typeof a.cwrap)try{return a.cwrap(e,t,n)}catch(i){console.warn(`WasmtimeBridge: ${e} のラップに失敗`,i)}return null}ensureHandle(e,t){if("function"!==typeof e)throw new Error(`WasmtimeBridge: ${t} ハンドルが初期化されていません`);return e}}function pe(e=[]){const t=[];let n=0;for(const a of e){if(!a)continue;const e=Math.max(0,Number(a.count)||0);t.push({name:a.species||"",start:n,count:e}),n+=e}return t}const fe="boids_settings",me={species:"Species",count:1e4,cohesion:24.1,cohesionRange:5,separation:3.4,separationRange:.4,alignment:17.05,alignmentRange:2,maxSpeed:.33,minSpeed:0,maxTurnAngle:14,maxNeighbors:6,horizontalTorque:.02,torqueStrength:4.487,lambda:.801,tau:.1,velocityEpsilon:1e-4,predatorAlertRadius:1,isPredator:!1,speciesId:0,densityReturnStrength:0};function ge(e=[],t={}){const n=be(e,e),a={...t},o=(0,s.Kh)([]),r=(0,s.Kh)({});d(n),h(a),u()||(d(n),h(a));const l=(0,i.EW)((()=>ve(o)));function u(){if("undefined"===typeof localStorage)return!1;try{const e=localStorage.getItem(fe);if(!e)return!1;const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0)return d(t),!0;if(t&&"object"===typeof t)return Array.isArray(t.species)&&t.species.length>0&&d(t.species),t.system&&"object"===typeof t.system&&h(t.system),!0}catch(e){console.warn("Failed to load settings from localStorage:",e)}return!1}function c(){if("undefined"===typeof localStorage)return!1;try{const e={species:o.map((e=>({...(0,s.ux)(e)}))),system:{...(0,s.ux)(r)}};return localStorage.setItem(fe,JSON.stringify(e)),!0}catch(e){return console.warn("Failed to save settings to localStorage:",e),!1}}function d(e){const t=be(e,n);return o.splice(0,o.length,...t),t}function h(e={}){const t={...a,...e||{}};return Object.keys(r).forEach((e=>{e in t||delete r[e]})),Object.entries(t).forEach((([e,t])=>{r[e]=t})),r}function p(){d(n),h(a),c()}function f(e){const t=o.length>0?o:n,a=t.find((e=>e&&!e.isPredator))||n.find((e=>e&&!e.isPredator))||me,i=e?ye(e,a):we(a);return i.isPredator=!1,i.count=0,i.species=Se(i.species,new Set(o.map((e=>e.species)))),o.push(i),i}function m(e){if(e<0||e>=o.length)return null;const t=o.splice(e,1);return t.length?t[0]:null}return{settings:o,systemSettings:r,totalBoids:l,loadFromStorage:u,saveToStorage:c,replaceSettings:d,assignSystemSettings:h,resetToDefaults:p,addSpecies:f,removeSpecies:m}}function ve(e){return e.reduce(((e,t)=>e+Math.max(0,Number(t?.count)||0)),0)}function be(e=[],t=[]){if(!Array.isArray(e))return[];const n=[],a=new Set;return e.forEach(((e,i)=>{const s=t[i]||t[0]||me,o=ye(e,s);o.species=Se(o.species,a),n.push(o)})),n}function ye(e={},t=me){const n={...me,...t},a={...n,...e},i=(e,t=0)=>{const n=Number(e);return Number.isFinite(n)?n:t},s={...a};s.count=Math.max(0,Math.floor(i(a.count,n.count??0))),s.maxNeighbors=Math.max(0,Math.floor(i(a.maxNeighbors,n.maxNeighbors??0))),s.speciesId=Math.max(0,Math.floor(i(a.speciesId,n.speciesId??0))),s.cohesion=i(a.cohesion,n.cohesion??0),s.cohesionRange=Math.max(0,i(a.cohesionRange,n.cohesionRange??0)),s.separation=i(a.separation,n.separation??0),s.separationRange=Math.max(0,i(a.separationRange,n.separationRange??0)),s.alignment=i(a.alignment,n.alignment??0),s.alignmentRange=Math.max(0,i(a.alignmentRange,n.alignmentRange??0)),s.maxSpeed=Math.max(0,i(a.maxSpeed,n.maxSpeed??0)),s.minSpeed=Math.max(0,i(a.minSpeed,n.minSpeed??0)),s.maxTurnAngle=i(a.maxTurnAngle,n.maxTurnAngle??0),s.maxTurnAngle>0&&s.maxTurnAngle<=1&&(n.maxTurnAngle??0)>1&&(s.maxTurnAngle*=60),s.horizontalTorque=i(a.horizontalTorque,n.horizontalTorque??0),s.torqueStrength=i(a.torqueStrength,n.torqueStrength??0),s.lambda=i(a.lambda,n.lambda??0),s.tau=i(a.tau,n.tau??0),s.velocityEpsilon=Math.max(0,i(a.velocityEpsilon,n.velocityEpsilon??1e-4)),s.predatorAlertRadius=Math.max(0,i(a.predatorAlertRadius,n.predatorAlertRadius??1));const o=n.densityReturnStrength??n.centerAttractStrength??0,r=a.densityReturnStrength??a.centerAttractStrength??o;s.densityReturnStrength=Math.max(0,i(r,o));const l="string"===typeof a.species?a.species.trim():"";return s.species=l||n.species||me.species,s.isPredator=Boolean(a.isPredator),s}function Se(e,t,n="Species"){const a="string"===typeof e&&e.trim()?e.trim():n;let i=a,s=2;while(t.has(i))i=`${a} ${s}`,s+=1;return t.add(i),i}function we(e){return JSON.parse(JSON.stringify(e))}const Pe={id:"app"},Ce={class:"ui-overlay"},xe={class:"ui-panel"},Me={class:"settings tuning-settings"},Re={class:"species-section",open:!1},Le={class:"species-content"},ke={class:"setting-row"},Te={class:"setting-row"},Fe={class:"setting-row"},Ve={class:"setting-row"},Be={class:"setting-row"},He={class:"setting-row"},Ee={class:"setting-row"},Ae={class:"setting-row"},Ue={class:"setting-row"},De={class:"setting-row"},We={class:"setting-row"},Ie={class:"setting-row"},Ge={class:"setting-row"},_e={class:"settings tuning-settings debug-settings"},qe={class:"species-section",open:!1},ze={class:"species-content debug-content"},Oe={class:"debug-checkbox"},Ke={class:"debug-checkbox"},Je={class:"debug-checkbox"},Ne={class:"debug-checkbox"},Qe={class:"debug-checkbox"},je={class:"debug-checkbox"},Xe={class:"debug-checkbox"},Ye={class:"info"},$e=1,Ze=400,et=3,tt=1e6,nt=256,at={__name:"App",setup(e){const t=(0,i.WQ)("wasmModule");t||console.error("wasmModule not provided");const n=t?new he(t):null;function c(){const e={isMobile:!1,hasIntegratedGpu:!1};if("undefined"===typeof navigator)return e;if(e.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e.isMobile)return e;try{const t=document.createElement("canvas"),n=t.getContext("webgl2")||t.getContext("webgl");if(n){const t=n.getExtension("WEBGL_debug_renderer_info");if(t){const a=n.getParameter(t.UNMASKED_RENDERER_WEBGL);a&&/intel/i.test(a)&&(console.log("Detected Intel integrated GPU:",a),e.hasIntegratedGpu=!0)}}}catch(t){console.warn("Failed to inspect GPU characteristics:",t)}return e}"undefined"!==typeof window&&n&&(window.readLbvhStats=()=>n.getLbvhQueryStatsSnapshot());const d=c(),h=d.isMobile||d.hasIntegratedGpu,p=h?6e3:1e4,f=[{species:"Boids",count:p,cohesion:24.1,cohesionRange:5,separation:3.4,separationRange:.4,alignment:17.05,alignmentRange:2,maxSpeed:.33,maxTurnAngle:.233,maxNeighbors:6,horizontalTorque:.02,torqueStrength:4.487,lambda:.801,tau:.1,predatorAlertRadius:1,densityReturnStrength:0},{species:"Predator",count:1,cohesion:5.58,separation:0,alignment:0,maxSpeed:1.37,minSpeed:.4,maxTurnAngle:.13,separationRange:14,alignmentRange:11,cohesionRange:77,maxNeighbors:0,lambda:.05,tau:1,horizontalTorque:.022,torqueStrength:0,isPredator:!0}],m={threatDecay:.75,threatGain:2,maxEscapeWeight:1,baseEscapeStrength:3,escapeStrengthPerThreat:10,cohesionBoost:2,separationMinFactor:1,alignmentBoost:1.2,antiMillGain:.15,fastAttractStrength:1,heatDepositDecay:.08,heatPassiveDecay:.005,heatBlendRatio:.35},g=ge(f,m),{settings:v,systemSettings:b,assignSystemSettings:y,totalBoids:S,replaceSettings:w,resetToDefaults:P,addSpecies:C,removeSpecies:x,saveToStorage:M}=g,R=(0,s.KR)(!1);function L(e={}){const t={};for(const[n,a]of Object.entries(m)){const i=Number(e[n]);t[n]=Number.isFinite(i)?i:a}return t}function k(e){const t=L(e);return y(t),t}function T(){if(!n)return;const e=L(b);n.setSimulationTuningParams(e)}function F(e){return e.map((e=>JSON.parse(JSON.stringify((0,s.ux)(e)))))}let V=S.value,B=ln(v),H=F(v),E=null,A=null;function G(e){if(!Array.isArray(e)||0===e.length)return null;const t=w(e);return M(),H=F(v),t}function _(e){const t=C(e);return M(),t}function q(e){if(v.length<=1)return null;const t=x(e);return t&&M(),t}const z=(0,s.KR)(null),O=(0,s.KR)(null);let J,N,Q,j,X=null,Y=null,$=null,Z=null;const ee=(0,s.KR)(!1),te=(0,s.KR)(!0),ne=(0,s.KR)(!1),ae=(0,s.KR)(!1),ie=(0,s.KR)(!1),se=(0,s.KR)(!1),oe=(0,s.KR)(!1),re=(0,s.KR)(!1),le=(0,s.KR)(!1);(0,s.KR)(1);let ce=[],de=[],pe=[],fe=null,me=null,ve=null,be=null,ye=0,Se=null,we=null,at=null,it=0,st=null,ot=null,rt=null,lt=0;const ut=new r.B69,ct=new r.Q1f,dt=new r.B69,ht=new r.Q1f,pt=new r.B69,ft=new r.Q1f,mt=(0,s.Kh)({enableFogPipeline:!d.isMobile,enableShadows:!0,enableTailAnimation:!0});let gt=null,vt=null,bt=0,yt=null,St=null;function wt(e){e&&(e.style.position="fixed",e.style.top="0px",e.style.right="0px",e.style.left="auto",e.style.bottom="auto",e.style.zIndex="9999",e.style.width="270px",e.style.height="48px",e.style.pointerEvents="auto",e.style.transform="none")}function Pt(e){"Space"===e.code&&(ee.value=!ee.value)}function Ct(){const e=mt.enableTailAnimation?1:0;Et?.uniforms?.uTailEnable&&(Et.uniforms.uTailEnable.value=e)}function xt(){const e=mt.enableShadows;Q&&(Q.shadowMap.enabled=e),$&&($.castShadow=e,$.shadow&&($.shadow.autoUpdate=e)),Z&&(Z.receiveShadow=e),Ut&&(Ut.castShadow=e,Ut.receiveShadow=e),Dt&&(Dt.castShadow=e,Dt.receiveShadow=e);const t="function"===typeof At.getPredatorMeshes?At.getPredatorMeshes():[];for(const n of t)n&&n.traverse?.((t=>{t.isMesh&&(t.castShadow=e,t.receiveShadow=e)}))}function Mt(){if(!Q||!J||!N)return void(!mt.enableFogPipeline&&X&&(X.dispose(),X=null));const e=Q.capabilities?.isWebGL2,t=Boolean(mt.enableFogPipeline&&e);if(t){X||(X=new K(Gt));const e=new r.I9Y;Q.getSize(e),X.init(Q,J,N,e.x,e.y)}else X&&(X.dispose(),X=null)}function Rt(){const e=window.innerWidth,t=window.innerHeight;J=new r.Z58,J.background=new r.Q1f(Wt.DEEP_BLUE),_t(),N=new r.ubm(75,e/t,.1,1e3),N.position.set(3,-5,3),N.lookAt(0,0,0),Q=new l.JeP({antialias:!0,depth:!0}),Q.toneMapping=r.nNL,Q.toneMappingExposure=.8,Q.setPixelRatio(window.devicePixelRatio),Q.setSize(e,t),Q.shadowMap.enabled=mt.enableShadows,Q.shadowMap.type=r.QP0,vt=Q.getContext(),z.value.appendChild(Q.domElement),N.aspect=e/t,N.updateProjectionMatrix(),j=new u.N(N,Q.domElement),j.enableDamping=!0,j.dampingFactor=.1;const n=new r.bdM(300,300),a=qt();a.depthTest=!0,Z=new r.eaF(n,a),Z.rotation.x=-Math.PI/2,Z.position.y=-10,Z.receiveShadow=!0,J.add(Z);const i=new r.$p8(It(Wt.AMBIENT_LIGHT),.9);J.add(i),$=new r.ZyN(It(Wt.SUN_LIGHT),20),$.position.set(300,500,200),$.castShadow=!0,$.shadow.camera.left=-100,$.shadow.camera.right=100,$.shadow.camera.top=100,$.shadow.camera.bottom=-100,$.shadow.camera.near=1,$.shadow.camera.far=400,$.shadow.mapSize.width=768,$.shadow.mapSize.height=768,$.shadow.bias=-.01,$.shadow.normalBias=.01,J.add($),Kt(),Mt(),xt(),Ct(),window.addEventListener("resize",Lt)}function Lt(){const e=window.innerWidth,t=window.innerHeight;N.aspect=e/t,N.updateProjectionMatrix(),Q.setSize(e,t),X?.resize(e,t)}function kt(e){const t=new Uint8Array(4*e);for(let a=0;a<e;a++){const n=a/e*Math.PI*2,i=Math.sin(n),s=Math.cos(n);t[4*a]=Math.round(255*(.5*i+.5)),t[4*a+1]=Math.round(255*(.5*s+.5)),t[4*a+2]=0,t[4*a+3]=255}const n=new r.GYF(t,e,1,r.GWd);return n.needsUpdate=!0,n.wrapS=r.GJx,n.wrapT=r.ghU,n.magFilter=r.k6q,n.minFilter=r.k6q,n.generateMipmaps=!1,n.flipY=!1,n}const Tt=[0,0,0,1],Ft=kt(nt),Vt=d.isMobile?{nearSq:1.5,midSq:9}:{nearSq:4,midSq:25},Bt=Vt.nearSq,Ht=Vt.midSq,Et={uniforms:{uTailTime:{value:0},uTailAmplitude:{value:.14},uTailFrequency:{value:10},uTailPhaseStride:{value:5},uTailTurnStrength:{value:.1},uTailSpeedScale:{value:1},uTailRight:{value:new r.Pq0(1,0,0)},uTailForward:{value:new r.Pq0(0,0,1)},uTailUp:{value:new r.Pq0(0,1,0)},uTailEnable:{value:1},uSinLut:{value:Ft},uLutSize:{value:nt}}},At=new I({tailAnimation:Et,tripleBufferSize:et,hiddenPosition:tt,identityQuaternion:Tt,lodNearDistanceSq:Bt,lodMidDistanceSq:Ht});let Ut=null,Dt=null;const Wt={SKY_HIGHLIGHT:"#4fbaff",SKY_BLUE:"#15a1ff",DEEP_BLUE:"#002968",SEAFLOOR:"#777465",FOG:"#153a6c",AMBIENT_LIGHT:"#59a5eb",SUN_LIGHT:"#5389b7",SIDE_LIGHT1:"#6ba3d0",SIDE_LIGHT2:"#2d5f7a",BOTTOM_LIGHT:"#0f2635"},It=e=>parseInt(e.replace("#","0x"),16),Gt={color:new r.Q1f(Wt.DEEP_BLUE),distanceStart:4,distanceEnd:60,distanceExponent:.4,distanceControlPoint1:new r.I9Y(.2,.8),distanceControlPoint2:new r.I9Y(.75,.95),surfaceLevel:100,heightFalloff:.01,heightExponent:1,maxOpacity:1.2};function _t(){if(!J)return null;const e=document.createElement("canvas"),t=e.getContext("2d");e.width=512,e.height=512;const n=t.createLinearGradient(0,0,0,e.height);n.addColorStop(0,Wt.SKY_HIGHLIGHT),n.addColorStop(.2,Wt.SKY_BLUE),n.addColorStop(.6,Wt.DEEP_BLUE),n.addColorStop(1,Wt.DEEP_BLUE),t.fillStyle=n,t.fillRect(0,0,e.width,e.height);const a=new r.GOR(e);a.colorSpace=r.er$,a.generateMipmaps=!1,a.minFilter=r.k6q,a.magFilter=r.k6q;const i=new r.Gu$(300,32,32),s=new r.V9B({map:a,side:r.hsX,fog:!1}),o=new r.eaF(i,s);return J.add(o),o}function qt(){const e=new r.Tap,t=e.load("./models/groundAlfa.png");t.minFilter=r.k6q,t.magFilter=r.k6q,t.wrapS=r.ghU,t.wrapT=r.ghU;const n=new r._4j({color:It(Wt.SEAFLOOR),transparent:!0,alphaMap:t,depthWrite:!0});return n.roughness=.85,n.metalness=0,n}function zt(e){At.setTailUniformTime(e),Y?.setTime(e)}let Ot=0;function Kt(){J&&Q&&(Y||(Y=new ue(h)),Y.init(J,Q,N,j))}function Jt(){Y?.update(N,j)}function Nt(){const e=O.value;if(!e)return;e.volume=.1,e.loop=!0;const t=()=>{const t=e.play();t&&"function"===typeof t.then&&t.catch((()=>{const t=()=>{document.removeEventListener("pointerdown",t),document.removeEventListener("keydown",t),e.play().catch((()=>{}))};document.addEventListener("pointerdown",t,{once:!0}),document.addEventListener("keydown",t,{once:!0})}))};t()}function Qt(e){return n?n.stepSimulation(e):0}function jt(e){return n?n.getBuffers(e):{positions:new Float32Array(0),orientations:new Float32Array(0),velocities:new Float32Array(0),speciesIds:new Int32Array(0)}}function Xt(){return n?.captureState()??null}function Yt(e,t,a){n?.restoreState(e,t,a)}let $t=null,Zt=null,en=null,tn=null,nn=null,an=null,sn=!1;function on(){return v.reduce(((e,t)=>e+(t.isPredator&&t.count?t.count:0)),0)}function rn(){return S.value}function ln(e=v){return Array.isArray(e)?e.map(((e,t)=>`${t}:${e&&e.count||0}:${e&&e.isPredator?1:0}`)).join("|"):""}function un(){if(!n)return console.warn("WasmtimeBridge が初期化されていません"),null;const e=(0,s.ux)(v),t=Array.isArray(e)?e:Array.from(v??[]),a=n.buildSpeciesParams(t);return a||console.warn("WasmtimeBridge.buildSpeciesParams の呼び出しに失敗しました"),a}function cn(){if(!t||!n)return;const e=E?.state||null,a=E?.oldSettings||H,i=A||F(v),s=ln(i),o=un();if(!o)return console.error("Failed to create species parameter vector"),G(H),E=null,void(A=null);try{t.callInitBoids(o,1,4,.25)}finally{"function"===typeof o.delete&&o.delete()}try{n.buildSpatialIndex(16,0)}catch(l){console.error("WasmtimeBridge.buildSpatialIndex の呼び出しに失敗しました",l)}const r=rn();V=r,hn(r),e?.count>0&&Yt(e,a,i),B=s,H=i,E=null,A=null}function dn(){yt&&clearTimeout(yt),E||(E={state:Xt(),oldSettings:H}),A=F(v),yt=setTimeout((()=>{yt=null,cn()}),Ze)}function hn(e){if(!J||!$t||!Zt||!en||!tn)return void console.warn("initInstancedBoids: required assets are not ready");const t=At.init(J,{count:e,boidModel:$t,boidModelLod:Zt,highMaterial:en,lowMaterial:tn,predatorModel:nn});if(!t)return void console.error("Failed to initialize boid instancing");const n=At.getMeshes();Ut=n.high,Dt=n.low;const a=on();"function"===typeof At.ensurePredatorMeshes&&At.ensurePredatorMeshes(a),xt(),Ut?.instanceColor&&(Ut.instanceColor.needsUpdate=!0),Dt?.instanceColor&&(Dt.instanceColor.needsUpdate=!0)}function pn(e){const t=new W.B,n=new r.Tap;let a=3;const i=()=>{a=Math.max(0,a-1),0===a&&e()},s=n.load("./models/fish.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)})),o=n.load("./models/fish_lod.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)}));s.flipY=!1,s.colorSpace=r.er$,o.flipY=!1,o.colorSpace=r.er$;const l=n.load("./models/fishPredetor.png",(()=>{console.log("Predator texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the predator texture:",e)}));l.flipY=!1,l.colorSpace=r.er$;let u=new r._4j({color:16777215,roughness:.5,metalness:.2,transparent:!1,alphaTest:.5,map:s,vertexColors:!1,vertexColor:16777215}),c=new r._4j({color:16777215,roughness:.5,metalness:.2,transparent:!1,alphaTest:.5,map:o,vertexColors:!1,vertexColor:16777215});en=u,tn=c,an=new r._4j({color:16777215,roughness:.5,metalness:0,transparent:!1,alphaTest:.5,map:l,vertexColors:!1,vertexColor:16777215}),t.load("./models/boidModel.glb",(e=>{$t=e.scene,$t.traverse((e=>{e.isMesh&&(e.material=u)})),i()}),void 0,(e=>{console.error("An error occurred while loading the model:",e),i()})),t.load("./models/boidModel_lod.glb",(e=>{Zt=e.scene,Zt.traverse((e=>{e.isMesh&&(e.material=c)})),i()}),void 0,(e=>{console.error("An error occurred while loading the LOD model:",e),i()})),t.load("./models/boidPredetorModel.glb",(e=>{nn=e.scene,nn.traverse((e=>{e.isMesh&&(e.material=an,e.castShadow=!0,e.receiveShadow=!0)})),i()}),void 0,(e=>{console.error("An error occurred while loading the predator model:",e),i()}))}function fn(){for(const e of ce)J.remove(e);for(const e of de)J.remove(e);ce=[],de=[]}function mn(){for(const e of pe)J.remove(e);pe=[]}function gn(e=!0){me&&(J.remove(me),me=null,ye=0),e&&(ve?.dispose?.(),be?.dispose?.(),ve=null,be=null)}function vn(e=!0){Se&&(J.remove(Se),Se=null,it=0),e&&(we?.dispose?.(),at?.dispose?.(),we=null,at=null)}function bn(e=!0){st&&(J.remove(st),st=null,lt=0),e&&(ot?.dispose?.(),rt?.dispose?.(),ot=null,rt=null)}function yn(e){if(!se.value)return void mn();const t=e?.buffer,n=t?.length??0,a=Math.floor(n/5);if(!t||a<=0)return void mn();fe||(fe=new r.Gu$(1,24,18));const i=.65;for(let s=0;s<a;s+=1){const e=5*s,n=t[e+3],a=t[e+4];if(n<=1e-4||a<=0){pe[s]&&(pe[s].visible=!1);continue}let o=pe[s];if(!o){const e=new r.V9B({color:(new r.Q1f).setHSL(.6,.8,.45),wireframe:!0,transparent:!0,opacity:.3,depthWrite:!1});o=new r.eaF(fe,e),J.add(o),pe[s]=o}o.visible=!0,o.position.set(t[e],t[e+1],t[e+2]),o.scale.set(n,n,n),o.material.color.setHSL(s%7/7*i,.85,.5),o.material.opacity=.22+.25*Math.min(a/1e3,1)}for(let s=a;s<pe.length;s+=1)pe[s]&&(pe[s].visible=!1)}function Sn(e){if(!oe.value)return void gn();const t=e?.meta,n=e?.values,a=e?.speciesCount??0;if(!t||!n||a<=0)return void gn();const i=6,s=Math.floor(n.length/Math.max(a,1)),o=Math.max(1,Math.floor(Math.sqrt(s))),l=o*o,u=a*l;ve||(ve=new r.Gu$(1,10,8)),be||(be=new r.V9B({transparent:!0,opacity:.5,depthWrite:!1,vertexColors:!0})),me&&ye===u||(gn(!1),me=new r.ZLX(ve,be,u),me.frustumCulled=!1,me.instanceMatrix.setUsage(r.Vnu),J.add(me),ye=u);const c=.65,d=.45,h=.06;let p=0;for(let r=0;r<a;r+=1){const e=r*i,a=t[e],s=t[e+1],u=t[e+2],f=Math.max(t[e+3],1e-6),m=Math.floor(t[e+4]||0),g=t[e+5]>.5,v=r*l,b=Math.max(u*d,.001),y=Math.max(u*h,.001);for(let t=0;t<o;t+=1)for(let e=0;e<o;e+=1){const i=t*o+e,l=g&&t<m&&e<m&&n[v+i]||0,d=Math.min(Math.max(l/f,0),1),h=a+(e+.5)*u,S=s+(t+.5)*u,w=y+b*Math.sqrt(d);ut.position.set(h,.02,S),ut.scale.setScalar(w),ut.updateMatrix(),me.setMatrixAt(p,ut.matrix);const P=r%7/7*c,C=g?.9:.15,x=g?.18+.62*d:.22;ct.setHSL(P,C,x),me.setColorAt(p,ct),p+=1}}me.instanceMatrix.needsUpdate=!0,me.instanceColor&&(me.instanceColor.needsUpdate=!0)}function wn(e){if(!re.value)return void vn();const t=e?.buffer,n=t?.length??0,a=Math.floor(n/6);if(!t||a<=0)return void vn();we||(we=new r.Gu$(1,12,10)),at||(at=new r.V9B({transparent:!0,opacity:.55,depthWrite:!1,vertexColors:!0})),(!Se||it<a)&&(vn(!1),Se=new r.ZLX(we,at,a),Se.frustumCulled=!1,Se.instanceMatrix.setUsage(r.Vnu),J.add(Se),it=a),Se.count=a;const i=.65,s=.5,o=.25;for(let r=0;r<a;r+=1){const e=6*r,n=Math.max(0,Math.floor(t[e]||0)),a=t[e+1],l=t[e+2],u=t[e+3],c=Math.max(o,(t[e+4]||0)*s),d=Math.max(0,t[e+5]||0);dt.position.set(a,l+.02,u),dt.scale.setScalar(c),dt.updateMatrix(),Se.setMatrixAt(r,dt.matrix);const h=Math.min(d/5e3,1),p=n%7/7*i;ht.setHSL(p,.9,.18+.62*h),Se.setColorAt(r,ht)}Se.instanceMatrix.needsUpdate=!0,Se.instanceColor&&(Se.instanceColor.needsUpdate=!0)}function Pn(e){if(!le.value)return void bn();const t=e?.buffer,n=t?.length??0,a=Math.floor(n/6);if(!t||a<=0)return void bn();ot||(ot=new r.Gu$(1,14,12)),rt||(rt=new r.V9B({transparent:!0,opacity:.35,depthWrite:!1,depthTest:!1,vertexColors:!0,wireframe:!0,blending:r.EZo})),(!st||lt<a)&&(bn(!1),st=new r.ZLX(ot,rt,a),st.frustumCulled=!1,st.renderOrder=20,st.instanceMatrix.setUsage(r.Vnu),J.add(st),lt=a),st.count=a;const i=.65,s=.6,o=.6;for(let r=0;r<a;r+=1){const e=6*r,n=Math.max(0,Math.floor(t[e]||0)),a=t[e+1],l=t[e+2],u=t[e+3],c=Math.max(o,(t[e+4]||0)*s),d=Math.max(0,t[e+5]||0);pt.position.set(a,l+.03,u),pt.scale.setScalar(c),pt.updateMatrix(),st.setMatrixAt(r,pt.matrix);const h=Math.min(d/12e3,1),p=n%7/7*i;ft.setHSL(p,.85,.12+.75*h),st.setColorAt(r,ft)}st.instanceMatrix.needsUpdate=!0,st.instanceColor&&(st.instanceColor.needsUpdate=!0)}let Cn=performance.now(),xn=null,Mn=0;const Rn=new r.Q1f;function Ln(){gt?.begin();const e=performance.now(),t=(e-Cn)/1e3;Cn=e,ee.value||(Ot+=t),zt(Ot);const a=Qt(ee.value?0:t),i=At.getMeshes();Ut=i.high,Dt=i.low;const s=X?.isReady?.()??!1;if(!Ut||!Dt)return j.update(),Jt(),s?(X.updateCameraUniforms(N),X.render(t)):Q.render(J,N),gt?.end(),gt?.update(),void(St=setTimeout(Ln,$e));const{positions:o,orientations:l,velocities:u}=jt(a);0===(63&bt++)&&n?.currentFirstBoidX();const c=on(),d=At.update({count:a,positions:o,orientations:l,velocities:u,cameraPosition:N.position,predatorCount:c}),h=d.visibleCount??Math.max(0,a-c);if(ie.value&&Ut.instanceColor&&Dt.instanceColor){const e=n?.getUnitMappings(a),t=d?.highCount??h,i=d?.lowCount??h,s=d?.highInstanceToBoid??null,o=d?.lowInstanceToBoid??null;if(e){Mn!==a&&(xn=new Int32Array(a),Mn=a),xn.fill(-1);for(let t=0;t<e.length;t+=2){const n=e[t];n>=0&&n<Mn&&(xn[n]=e[t+1])}const r=n?.getUnitSimpleDensities?.(),l=r?.length??0,u=.18,c=.45,d=.58,h=Boolean(r&&l>0);for(let e=0;e<t;e++){const t=s?s[e]:e,n=t>=0&&t<Mn?xn[t]:-1;if(h&&n>=0&&n<l){const e=r[n],t=Math.min(Math.max(e*u,0),1),a=d-t*c;Rn.setHSL(a,.85,.55)}else n>=0?Rn.setHSL(n%100/100,.8,.6):Rn.setRGB(1,0,0);Ut.setColorAt(e,Rn)}for(let e=0;e<i;e++){const t=o?o[e]:e,n=t>=0&&t<Mn?xn[t]:-1;if(h&&n>=0&&n<l){const e=r[n],t=Math.min(Math.max(e*u,0),1),a=d-t*c;Rn.setHSL(a,.85,.55)}else n>=0?Rn.setHSL(n%100/100,.8,.6):Rn.setRGB(1,0,0);Dt.setColorAt(e,Rn)}Ut.instanceColor.needsUpdate=!0,Dt.instanceColor.needsUpdate=!0}}else if(sn&&Ut.instanceColor&&Dt.instanceColor){const e=new r.Q1f(1,1,1),t=d?.highCount??h,n=d?.lowCount??h;for(let a=0;a<t;a++)Ut.setColorAt(a,e);for(let a=0;a<n;a++)Dt.setColorAt(a,e);Ut.instanceColor.needsUpdate=!0,Dt.instanceColor.needsUpdate=!0,console.log("✓ Reset vertex colors to white (OFF mode)")}if(sn=ie.value,se.value&&n){const e=n.getSpeciesEnvelopes?.();yn(e)}else pe.length>0&&mn();if(oe.value&&n){if(0===(3&bt)){const e=n.getHeatGridDebugBuffers?.();Sn(e)}}else me&&gn();if(re.value&&n){if(0===(3&bt)){const e=n.getSpeciesClusters?.();wn(e)}}else Se&&vn();if(le.value&&n){if(0===(3&bt)){const e=n.getSpeciesSchoolClusters?.();Pn(e)}}else st&&bn();j.update(),Jt(),s?(X.updateCameraUniforms(N),X.render(t)):Q.render(J,N),gt?.end(),gt?.update(),St=setTimeout(Ln,$e)}function kn(){cn(),Ln()}function Tn(e){Array.isArray(e)&&e.length>0?G(e):P(),k(m),M(),R.value&&T()}return(0,i.sV)((()=>{R.value||(k((0,s.ux)(b)),R.value=!0,T(),M()),Rt(),pn((()=>{console.log("Boid model loaded successfully."),gt=new D.A({trackGPU:!0,trackHz:!0,trackCPT:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,precision:2,horizontal:!0,minimal:!1,mode:0});const e=Q?.domElement??document.body,t=()=>{const e=("undefined"!==typeof gt?.domElement?gt.domElement:null)||("function"===typeof gt?.getDom?gt.getDom():null)||gt?.dom||gt?.container||gt?.wrapper||null;e&&(e.parentElement||document.body.appendChild(e),wt(e))},n=gt&&"function"===typeof gt.init?Promise.resolve(gt.init(e)):Promise.resolve();n.then((()=>{"function"===typeof gt?.patchThreeRenderer&&gt.patchThreeRenderer(Q),t()})).catch((e=>{console.error("Failed to initialize stats-gl:",e),t()})),kn(),Nt()})),window.addEventListener("keydown",Pt)})),(0,i.wB)((()=>mt.enableFogPipeline),(()=>{Mt()})),(0,i.wB)((()=>mt.enableShadows),(()=>{xt()})),(0,i.wB)((()=>mt.enableTailAnimation),(()=>{Ct()})),(0,i.wB)(b,(()=>{R.value&&(T(),M())}),{deep:!0}),(0,i.wB)(v,(()=>{if(t&&t.setGlobalSpeciesParamsFromJS){const e=un();if(e)try{t.setGlobalSpeciesParamsFromJS(e,1)}finally{"function"===typeof e.delete&&e.delete()}}M();const e=ln(v);e!==B?dn():(yt&&(clearTimeout(yt),yt=null),E=null,A=null,H=F(v));const n=on();"function"===typeof At.ensurePredatorMeshes&&At.ensurePredatorMeshes(n);const a="function"===typeof At.getPredatorMeshes?At.getPredatorMeshes():[];for(const t of a)t.visible=!1}),{deep:!0}),(0,i.wB)(te,(e=>{console.log("showUnits changed to:",e),e||fn()})),(0,i.wB)(se,(e=>{e||mn()})),(0,i.wB)([ne,ae],(([e,t])=>{console.log("Unit display mode changed - Spheres:",e,"Lines:",t),te.value&&fn()})),(e,t)=>((0,i.uX)(),(0,i.CE)("div",Pe,[(0,i.Lk)("div",Ce,[(0,i.Lk)("div",xe,[t[58]||(t[58]=(0,i.Lk)("h1",null,"Boids Simulation",-1)),(0,i.Lk)("details",null,[t[55]||(t[55]=(0,i.Lk)("summary",null,"Settings",-1)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)((0,s.R1)(v),((e,t)=>((0,i.uX)(),(0,i.CE)("div",{key:t},[(0,i.bF)(U,{settings:e,"can-remove":(0,s.R1)(v).length>1,onRemove:e=>q(t)},null,8,["settings","can-remove","onRemove"])])))),128)),(0,i.Lk)("button",{class:"add-species-button",onClick:_}," 種族を追加 "),(0,i.Lk)("button",{onClick:Tn,style:{"margin-bottom":"1em"}}," リセット "),t[56]||(t[56]=(0,i.Lk)("br",null,null,-1)),(0,i.Lk)("div",Me,[(0,i.Lk)("details",Re,[t[46]||(t[46]=(0,i.Lk)("summary",{class:"species-header"},[(0,i.Lk)("span",{class:"species-title"},"Adjustment")],-1)),(0,i.Lk)("div",Le,[(0,i.Lk)("div",ke,[t[33]||(t[33]=(0,i.Lk)("label",null,[(0,i.eW)("脅威減衰"),(0,i.Lk)("br"),(0,i.eW)("(threatDecay):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"5",step:"0.05","onUpdate:modelValue":t[0]||(t[0]=e=>(0,s.R1)(b).threatDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).threatDecay,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[1]||(t[1]=e=>(0,s.R1)(b).threatDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).threatDecay,void 0,{number:!0}]])]),(0,i.Lk)("div",Te,[t[34]||(t[34]=(0,i.Lk)("label",null,[(0,i.eW)("脅威増幅"),(0,i.Lk)("br"),(0,i.eW)("(threatGain):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"5",step:"0.05","onUpdate:modelValue":t[2]||(t[2]=e=>(0,s.R1)(b).threatGain=e)},null,512),[[a.Jo,(0,s.R1)(b).threatGain,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[3]||(t[3]=e=>(0,s.R1)(b).threatGain=e)},null,512),[[a.Jo,(0,s.R1)(b).threatGain,void 0,{number:!0}]])]),(0,i.Lk)("div",Fe,[t[35]||(t[35]=(0,i.Lk)("label",null,[(0,i.eW)("最大逃避重み"),(0,i.Lk)("br"),(0,i.eW)("(maxEscapeWeight):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"1",step:"0.01","onUpdate:modelValue":t[4]||(t[4]=e=>(0,s.R1)(b).maxEscapeWeight=e)},null,512),[[a.Jo,(0,s.R1)(b).maxEscapeWeight,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.01","onUpdate:modelValue":t[5]||(t[5]=e=>(0,s.R1)(b).maxEscapeWeight=e)},null,512),[[a.Jo,(0,s.R1)(b).maxEscapeWeight,void 0,{number:!0}]])]),(0,i.Lk)("div",Ve,[t[36]||(t[36]=(0,i.Lk)("label",null,[(0,i.eW)("基本逃避強度"),(0,i.Lk)("br"),(0,i.eW)("(baseEscapeStrength):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"15",step:"0.1","onUpdate:modelValue":t[6]||(t[6]=e=>(0,s.R1)(b).baseEscapeStrength=e)},null,512),[[a.Jo,(0,s.R1)(b).baseEscapeStrength,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.1","onUpdate:modelValue":t[7]||(t[7]=e=>(0,s.R1)(b).baseEscapeStrength=e)},null,512),[[a.Jo,(0,s.R1)(b).baseEscapeStrength,void 0,{number:!0}]])]),(0,i.Lk)("div",Be,[t[37]||(t[37]=(0,i.Lk)("label",null,[(0,i.eW)("脅威ごとの逃避"),(0,i.Lk)("br"),(0,i.eW)("(escapeStrengthPerThreat):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"40",step:"0.5","onUpdate:modelValue":t[8]||(t[8]=e=>(0,s.R1)(b).escapeStrengthPerThreat=e)},null,512),[[a.Jo,(0,s.R1)(b).escapeStrengthPerThreat,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.5","onUpdate:modelValue":t[9]||(t[9]=e=>(0,s.R1)(b).escapeStrengthPerThreat=e)},null,512),[[a.Jo,(0,s.R1)(b).escapeStrengthPerThreat,void 0,{number:!0}]])]),(0,i.Lk)("div",He,[t[38]||(t[38]=(0,i.Lk)("label",null,[(0,i.eW)("凝集ブースト"),(0,i.Lk)("br"),(0,i.eW)("(cohesionBoost):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"3",step:"0.05","onUpdate:modelValue":t[10]||(t[10]=e=>(0,s.R1)(b).cohesionBoost=e)},null,512),[[a.Jo,(0,s.R1)(b).cohesionBoost,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[11]||(t[11]=e=>(0,s.R1)(b).cohesionBoost=e)},null,512),[[a.Jo,(0,s.R1)(b).cohesionBoost,void 0,{number:!0}]])]),(0,i.Lk)("div",Ee,[t[39]||(t[39]=(0,i.Lk)("label",null,[(0,i.eW)("分離下限係数"),(0,i.Lk)("br"),(0,i.eW)("(separationMinFactor):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"1",step:"0.01","onUpdate:modelValue":t[12]||(t[12]=e=>(0,s.R1)(b).separationMinFactor=e)},null,512),[[a.Jo,(0,s.R1)(b).separationMinFactor,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.01","onUpdate:modelValue":t[13]||(t[13]=e=>(0,s.R1)(b).separationMinFactor=e)},null,512),[[a.Jo,(0,s.R1)(b).separationMinFactor,void 0,{number:!0}]])]),(0,i.Lk)("div",Ae,[t[40]||(t[40]=(0,i.Lk)("label",null,[(0,i.eW)("整列ブースト"),(0,i.Lk)("br"),(0,i.eW)("(alignmentBoost):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"2",step:"0.05","onUpdate:modelValue":t[14]||(t[14]=e=>(0,s.R1)(b).alignmentBoost=e)},null,512),[[a.Jo,(0,s.R1)(b).alignmentBoost,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[15]||(t[15]=e=>(0,s.R1)(b).alignmentBoost=e)},null,512),[[a.Jo,(0,s.R1)(b).alignmentBoost,void 0,{number:!0}]])]),(0,i.Lk)("div",Ue,[t[41]||(t[41]=(0,i.Lk)("label",null,[(0,i.eW)("補助凝集強度"),(0,i.Lk)("br"),(0,i.eW)("(fastAttractStrength):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"3",step:"0.05","onUpdate:modelValue":t[16]||(t[16]=e=>(0,s.R1)(b).fastAttractStrength=e)},null,512),[[a.Jo,(0,s.R1)(b).fastAttractStrength,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[17]||(t[17]=e=>(0,s.R1)(b).fastAttractStrength=e)},null,512),[[a.Jo,(0,s.R1)(b).fastAttractStrength,void 0,{number:!0}]])]),(0,i.Lk)("div",De,[t[42]||(t[42]=(0,i.Lk)("label",null,[(0,i.eW)("ヒート学習速度"),(0,i.Lk)("br"),(0,i.eW)("(heatDepositDecay):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"0.3",step:"0.002","onUpdate:modelValue":t[18]||(t[18]=e=>(0,s.R1)(b).heatDepositDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).heatDepositDecay,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",min:"0",max:"0.3",step:"0.002","onUpdate:modelValue":t[19]||(t[19]=e=>(0,s.R1)(b).heatDepositDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).heatDepositDecay,void 0,{number:!0}]])]),(0,i.Lk)("div",We,[t[43]||(t[43]=(0,i.Lk)("label",null,[(0,i.eW)("長期影響割合"),(0,i.Lk)("br"),(0,i.eW)("(heatBlendRatio):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"1",step:"0.01","onUpdate:modelValue":t[20]||(t[20]=e=>(0,s.R1)(b).heatBlendRatio=e)},null,512),[[a.Jo,(0,s.R1)(b).heatBlendRatio,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",min:"0",max:"1",step:"0.01","onUpdate:modelValue":t[21]||(t[21]=e=>(0,s.R1)(b).heatBlendRatio=e)},null,512),[[a.Jo,(0,s.R1)(b).heatBlendRatio,void 0,{number:!0}]])]),(0,i.Lk)("div",Ie,[t[44]||(t[44]=(0,i.Lk)("label",null,[(0,i.eW)("ヒート忘却速度"),(0,i.Lk)("br"),(0,i.eW)("(heatPassiveDecay):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"0.05",step:"0.001","onUpdate:modelValue":t[22]||(t[22]=e=>(0,s.R1)(b).heatPassiveDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).heatPassiveDecay,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",min:"0",max:"0.05",step:"0.001","onUpdate:modelValue":t[23]||(t[23]=e=>(0,s.R1)(b).heatPassiveDecay=e)},null,512),[[a.Jo,(0,s.R1)(b).heatPassiveDecay,void 0,{number:!0}]])]),(0,i.Lk)("div",Ge,[t[45]||(t[45]=(0,i.Lk)("label",null,[(0,i.eW)("アンチミル係数"),(0,i.Lk)("br"),(0,i.eW)("(antiMillGain):")],-1)),(0,i.bo)((0,i.Lk)("input",{type:"range",min:"0",max:"0.6",step:"0.01","onUpdate:modelValue":t[24]||(t[24]=e=>(0,s.R1)(b).antiMillGain=e)},null,512),[[a.Jo,(0,s.R1)(b).antiMillGain,void 0,{number:!0}]]),(0,i.bo)((0,i.Lk)("input",{class:"value-input",type:"number",step:"0.01","onUpdate:modelValue":t[25]||(t[25]=e=>(0,s.R1)(b).antiMillGain=e)},null,512),[[a.Jo,(0,s.R1)(b).antiMillGain,void 0,{number:!0}]])])])])]),t[57]||(t[57]=(0,i.Lk)("br",null,null,-1)),(0,i.Lk)("div",_e,[(0,i.Lk)("details",qe,[t[54]||(t[54]=(0,i.Lk)("summary",{class:"species-header"},[(0,i.Lk)("span",{class:"species-title"},"Debug")],-1)),(0,i.Lk)("div",ze,[(0,i.Lk)("label",Oe,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[26]||(t[26]=e=>mt.enableFogPipeline=e)},null,512),[[a.lH,mt.enableFogPipeline]]),t[47]||(t[47]=(0,i.eW)(" フォグ/SSAO/ブルームを有効化 "))]),(0,i.Lk)("label",Ke,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[27]||(t[27]=e=>mt.enableShadows=e)},null,512),[[a.lH,mt.enableShadows]]),t[48]||(t[48]=(0,i.eW)(" 影描画を有効化 "))]),(0,i.Lk)("label",Je,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[28]||(t[28]=e=>mt.enableTailAnimation=e)},null,512),[[a.lH,mt.enableTailAnimation]]),t[49]||(t[49]=(0,i.eW)(" 尾びれアニメーションを有効化 "))]),(0,i.Lk)("label",Ne,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[29]||(t[29]=e=>se.value=e)},null,512),[[a.lH,se.value]]),t[50]||(t[50]=(0,i.eW)(" 種族エンベロープ表示 "))]),(0,i.Lk)("label",Qe,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[30]||(t[30]=e=>oe.value=e)},null,512),[[a.lH,oe.value]]),t[51]||(t[51]=(0,i.eW)(" Heatセル表示 "))]),(0,i.Lk)("label",je,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[31]||(t[31]=e=>re.value=e)},null,512),[[a.lH,re.value]]),t[52]||(t[52]=(0,i.eW)(" クラスター表示 "))]),(0,i.Lk)("label",Xe,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[32]||(t[32]=e=>le.value=e)},null,512),[[a.lH,le.value]]),t[53]||(t[53]=(0,i.eW)(" 大クラスター表示 "))])])])])]),(0,i.Lk)("div",Ye,[(0,i.Lk)("p",null,"Boids Count: "+(0,o.v_)((0,s.R1)(S)),1)])])]),(0,i.Lk)("div",{ref_key:"threeContainer",ref:z,class:"three-container"},null,512),(0,i.Lk)("audio",{ref_key:"backgroundAudio",ref:O,src:"/UnderWater.mp3",loop:"",style:{display:"none"}},null,512)]))}},it=at,st=it,ot="/wasm-boids/".replace(/\/*$/,"/"),rt=`${ot}static/js`,lt=`${rt}/wasm_boids.js`,ut=`${rt}/wasm_boids.wasm`;async function ct(){try{const e=await import(lt);if(!e?.default)throw new Error(`WASM module loader not found at: ${lt}`);const t=await e.default({locateFile:e=>e.endsWith(".wasm")?ut:e});"undefined"!==typeof window&&(window.wasmModule=t),console.log("Wasm module initialized:",t);const n=(0,a.Ef)(st);n.provide("wasmModule",t),n.mount("#app")}catch(e){console.error("Failed to initialise WASM module:",e)}}ct()}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}n.m=e,(()=>{var e=[];n.O=(t,a,i,s)=>{if(!a){var o=1/0;for(c=0;c<e.length;c++){for(var[a,i,s]=e[c],r=!0,l=0;l<a.length;l++)(!1&s||o>=s)&&Object.keys(n.O).every((e=>n.O[e](a[l])))?a.splice(l--,1):(r=!1,s<o&&(o=s));if(r){e.splice(c--,1);var u=i();void 0!==u&&(t=u)}}return t}s=s||0;for(var c=e.length;c>0&&e[c-1][2]>s;c--)e[c]=e[c-1];e[c]=[a,i,s]}})(),(()=>{n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}})(),(()=>{n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e={57:0};n.O.j=t=>0===e[t];var t=(t,a)=>{var i,s,[o,r,l]=a,u=0;if(o.some((t=>0!==e[t]))){for(i in r)n.o(r,i)&&(n.m[i]=r[i]);if(l)var c=l(n)}for(t&&t(a);u<o.length;u++)s=o[u],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(c)},a=self["webpackChunkwasm_boids"]=self["webpackChunkwasm_boids"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})();var a=n.O(void 0,[504],(()=>n(544)));a=n.O(a)})();
//# sourceMappingURL=index.f1c339ff.js.map