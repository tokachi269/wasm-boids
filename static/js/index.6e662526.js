(()=>{var e={365:(e,t,n)=>{var i=n(751),a=n(641),s=n(953),o=n(33),r=n(922),l=n(437),u=n(24);const c={class:"settings"},h={class:"species-section",open:!1},d={class:"species-header"},p={class:"species-title"},f={class:"species-content"},m={class:"setting-row"},g=["title"],v=["title"],b={class:"setting-row"},S=["title"],y=["title"],w=["title"],x=["title"],M={class:"setting-row"},P=["title"],C=["title"],L=["title"],k=["title"],T={class:"setting-row"},R=["title"],F=["title"],E=["title"],A=["title"],B={class:"setting-row"},U=["title"],I=["title"],D=["title"],V=["title"],H={class:"setting-row"},W=["title"],N=["title"],_=["title"],q=["title"],O={class:"setting-row"},z=["title"],K=["title"],j=["title"],X=["title"],G={class:"setting-row"},J=["title"],Y=["title"],Q=["title"],$=["title"],Z={class:"setting-row"},ee=["title"],te=["title"],ne=["title"],ie=["title"],ae={class:"setting-row"},se=["title"],oe=["title"],re=["title"],le=["title"],ue={class:"setting-row"},ce=["title"],he=["title"],de=["title"],pe=["title"],fe={class:"setting-row"},me=["title"],ge=["title"],ve=["title"],be=["title"],Se={class:"setting-row"},ye=["title"],we=["title"],xe=["title"],Me=["title"],Pe={class:"setting-row"},Ce=["title"],Le=["title"],ke=["title"],Te=["title"],Re={class:"setting-row"},Fe=["title"],Ee=["title"],Ae=["title"],Be=["title"],Ue={class:"setting-row"},Ie=["title"],De=["title"],Ve=["title"],He=["title"],We={class:"setting-row"},Ne=["title"],_e=["title"],qe=["title"],Oe=["title"],ze={class:"setting-row"},Ke=["title"],je=["title"],Xe=["title"],Ge={__name:"Settings",props:{settings:{type:Object,required:!0},canRemove:{type:Boolean,default:!0}},emits:["remove"],setup(e,{emit:t}){const n=e,r=t;function l(){r("remove")}const u={species:"この種族の表示名。",count:"この種族の個体数。増やすほど重くなる。反映にはリセットが必要（要更新）。",cohesion:"仲間の中心へ寄る強さ。大きいほど群れが固まりやすい。",cohesionRange:"凝集を効かせる距離。遠くの仲間まで意識すると大きくまとまりやすい。",separation:"近づきすぎたときに離れる強さ。大きいほど衝突しにくく、散りやすい。",separationRange:"分離を始める距離。大きいほど早めに距離を取る。",alignment:"進行方向を揃える強さ。大きいほど同じ向きに泳ぐ。",alignmentRange:"整列を効かせる距離。近い仲間だけを見るか、少し遠くまで見るかが変わる。",predatorAlertRadius:"捕食者に反応し始める距離。大きいほど早めに逃げる。",densityReturnStrength:"群れの密度が崩れたときに、元の密度へ戻ろうとする強さ。",maxSpeed:"移動速度の上限。",maxTurnAngle:"移動距離あたりの曲がりやすさの上限。大きいほど小回りが利く（速度を変えても曲がり方が崩れにくい）。",maxNeighbors:"近傍として見る最大数。小さいと局所的、大きいと全体的な動きになる。",horizontalTorque:"上下方向の傾きを水平へ戻す強さ。",torqueStrength:"回転の反応の強さ。",lambda:"動きの減衰（抵抗）。大きいほど勢いが落ちやすい。",tau:"過去の状態をどれくらい残すか（記憶時間）。大きいほど反応が遅れて滑らかになる。",isPredator:"この種族を捕食者として扱う（他の種族が避ける対象になる）。"},Ge=(0,s.KR)(n.settings.count),Je=(0,s.KR)(!1),Ye=(0,s.KR)(null);function Qe(){Je.value=!0,Ge.value=n.settings.count,(0,a.dY)((()=>{Ye.value?.focus?.()}))}function $e(){n.settings.count=Ge.value}function Ze(){n.settings.count=Ge.value,Je.value=!1}function et(){Je.value=!1,Ge.value=n.settings.count}function tt(e,t){e.value=!0,(0,a.dY)((()=>{t.value?.focus?.()}))}function nt(e){e.value=!1}(0,a.wB)((()=>n.settings.count),(e=>{Je.value||(Ge.value=e)}));const it=(0,s.KR)(!1),at=(0,s.KR)(null);function st(){tt(it,at)}function ot(){nt(it)}const rt=(0,s.KR)(!1),lt=(0,s.KR)(null);function ut(){tt(rt,lt)}function ct(){nt(rt)}const ht=(0,s.KR)(!1),dt=(0,s.KR)(null);function pt(){tt(ht,dt)}function ft(){nt(ht)}const mt=(0,s.KR)(!1),gt=(0,s.KR)(null);function vt(){tt(mt,gt)}function bt(){nt(mt)}const St=(0,s.KR)(!1),yt=(0,s.KR)(null);function wt(){tt(St,yt)}function xt(){nt(St)}const Mt=(0,s.KR)(!1),Pt=(0,s.KR)(null);function Ct(){tt(Mt,Pt)}function Lt(){nt(Mt)}const kt=(0,s.KR)(!1),Tt=(0,s.KR)(null);function Rt(){tt(kt,Tt)}function Ft(){nt(kt)}const Et=(0,s.KR)(!1),At=(0,s.KR)(null);function Bt(){tt(Et,At)}function Ut(){nt(Et)}const It=(0,s.KR)(!1),Dt=(0,s.KR)(null);function Vt(){tt(It,Dt)}function Ht(){nt(It)}const Wt=(0,s.KR)(!1),Nt=(0,s.KR)(null);function _t(){tt(Wt,Nt)}function qt(){nt(Wt)}const Ot=(0,s.KR)(!1),zt=(0,s.KR)(null);function Kt(){tt(Ot,zt)}function jt(){nt(Ot)}const Xt=(0,s.KR)(!1),Gt=(0,s.KR)(null);function Jt(){tt(Xt,Gt)}function Yt(){nt(Xt)}const Qt=(0,s.KR)(!1),$t=(0,s.KR)(null);function Zt(){tt(Qt,$t)}function en(){nt(Qt)}const tn=(0,s.KR)(!1),nn=(0,s.KR)(null);function an(){tt(tn,nn)}function sn(){nt(tn)}const on=(0,s.KR)(!1),rn=(0,s.KR)(null);function ln(){tt(on,rn)}function un(){nt(on)}return(t,n)=>((0,a.uX)(),(0,a.CE)("div",c,[(0,a.Lk)("details",h,[(0,a.Lk)("summary",d,[(0,a.Lk)("span",p,(0,o.v_)(e.settings.species)+" ("+(0,o.v_)(e.settings.count)+"匹)",1),e.canRemove?((0,a.uX)(),(0,a.CE)("button",{key:0,class:"species-remove",type:"button",onClick:(0,i.D$)(l,["stop"])},"削除")):(0,a.Q3)("",!0)]),(0,a.Lk)("div",f,[(0,a.Lk)("div",m,[(0,a.Lk)("label",{title:u.species},n[33]||(n[33]=[(0,a.eW)("種族名"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Species):")]),8,g),(0,a.Lk)("span",{title:u.species},(0,o.v_)(e.settings.species),9,v)]),(0,a.Lk)("div",b,[(0,a.Lk)("label",{title:u.count},n[34]||(n[34]=[(0,a.eW)("群れの数(要更新)"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Count):")]),8,S),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[0]||(n[0]=e=>Ge.value=e),min:"0",max:"50000",step:"1",onChange:$e,title:u.count},null,40,y),[[i.Jo,Ge.value,void 0,{number:!0}]]),Je.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"countInput",ref:Ye,class:"value-input",type:"number","onUpdate:modelValue":n[1]||(n[1]=e=>Ge.value=e),min:"0",max:"20000",step:"1",onBlur:et,onKeyup:(0,i.jR)(Ze,["enter"]),title:u.count},null,40,x)),[[i.Jo,Ge.value,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Qe,title:u.count+"（クリックして編集）"},(0,o.v_)(e.settings.count),9,w))]),(0,a.Lk)("div",M,[(0,a.Lk)("label",{title:u.cohesion},n[35]||(n[35]=[(0,a.eW)("凝集"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Cohesion):")]),8,P),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[2]||(n[2]=t=>e.settings.cohesion=t),min:"0",max:"40",step:"0.01",title:u.cohesion},null,8,C),[[i.Jo,e.settings.cohesion,void 0,{number:!0}]]),it.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"cohesionInput",ref:at,class:"value-input",type:"number","onUpdate:modelValue":n[3]||(n[3]=t=>e.settings.cohesion=t),min:"0",max:"40",step:"0.01",onBlur:ot,onKeyup:(0,i.jR)(ot,["enter"]),title:u.cohesion},null,40,k)),[[i.Jo,e.settings.cohesion,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:st,title:u.cohesion+"（クリックして編集）"},(0,o.v_)(e.settings.cohesion),9,L))]),(0,a.Lk)("div",T,[(0,a.Lk)("label",{title:u.cohesionRange},n[36]||(n[36]=[(0,a.eW)("凝集範囲"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Cohesion Range):")]),8,R),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[4]||(n[4]=t=>e.settings.cohesionRange=t),min:"1",max:"300",step:"1",title:u.cohesionRange},null,8,F),[[i.Jo,e.settings.cohesionRange,void 0,{number:!0}]]),rt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"cohesionRangeInput",ref:lt,class:"value-input",type:"number","onUpdate:modelValue":n[5]||(n[5]=t=>e.settings.cohesionRange=t),min:"1",max:"300",step:"1",onBlur:ct,onKeyup:(0,i.jR)(ct,["enter"]),title:u.cohesionRange},null,40,A)),[[i.Jo,e.settings.cohesionRange,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:ut,title:u.cohesionRange+"（クリックして編集）"},(0,o.v_)(e.settings.cohesionRange),9,E))]),(0,a.Lk)("div",B,[(0,a.Lk)("label",{title:u.separation},n[37]||(n[37]=[(0,a.eW)("分離"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Separation):")]),8,U),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[6]||(n[6]=t=>e.settings.separation=t),min:"0",max:"10",step:"0.01",title:u.separation},null,8,I),[[i.Jo,e.settings.separation,void 0,{number:!0}]]),ht.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"separationInput",ref:dt,class:"value-input",type:"number","onUpdate:modelValue":n[7]||(n[7]=t=>e.settings.separation=t),min:"0",max:"10",step:"0.01",onBlur:ft,onKeyup:(0,i.jR)(ft,["enter"]),title:u.separation},null,40,V)),[[i.Jo,e.settings.separation,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:pt,title:u.separation+"（クリックして編集）"},(0,o.v_)(e.settings.separation),9,D))]),(0,a.Lk)("div",H,[(0,a.Lk)("label",{title:u.separationRange},n[38]||(n[38]=[(0,a.eW)("分離範囲"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Separation Range):")]),8,W),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[8]||(n[8]=t=>e.settings.separationRange=t),min:"0.1",max:"10",step:"0.1",title:u.separationRange},null,8,N),[[i.Jo,e.settings.separationRange,void 0,{number:!0}]]),mt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"separationRangeInput",ref:gt,class:"value-input",type:"number","onUpdate:modelValue":n[9]||(n[9]=t=>e.settings.separationRange=t),min:"0.1",max:"10",step:"0.1",onBlur:bt,onKeyup:(0,i.jR)(bt,["enter"]),title:u.separationRange},null,40,q)),[[i.Jo,e.settings.separationRange,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:vt,title:u.separationRange+"（クリックして編集）"},(0,o.v_)(e.settings.separationRange),9,_))]),(0,a.Lk)("div",O,[(0,a.Lk)("label",{title:u.alignment},n[39]||(n[39]=[(0,a.eW)("整列"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Alignment):")]),8,z),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[10]||(n[10]=t=>e.settings.alignment=t),min:"0",max:"20",step:"0.01",title:u.alignment},null,8,K),[[i.Jo,e.settings.alignment,void 0,{number:!0}]]),St.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"alignmentInput",ref:yt,class:"value-input",type:"number","onUpdate:modelValue":n[11]||(n[11]=t=>e.settings.alignment=t),min:"0",max:"20",step:"0.01",onBlur:xt,onKeyup:(0,i.jR)(xt,["enter"]),title:u.alignment},null,40,X)),[[i.Jo,e.settings.alignment,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:wt,title:u.alignment+"（クリックして編集）"},(0,o.v_)(e.settings.alignment),9,j))]),(0,a.Lk)("div",G,[(0,a.Lk)("label",{title:u.alignmentRange},n[40]||(n[40]=[(0,a.eW)("整列範囲"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Alignment Range):")]),8,J),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[12]||(n[12]=t=>e.settings.alignmentRange=t),min:"1",max:"100",step:"1",title:u.alignmentRange},null,8,Y),[[i.Jo,e.settings.alignmentRange,void 0,{number:!0}]]),Mt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"alignmentRangeInput",ref:Pt,class:"value-input",type:"number","onUpdate:modelValue":n[13]||(n[13]=t=>e.settings.alignmentRange=t),min:"1",max:"100",step:"1",onBlur:Lt,onKeyup:(0,i.jR)(Lt,["enter"]),title:u.alignmentRange},null,40,$)),[[i.Jo,e.settings.alignmentRange,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Ct,title:u.alignmentRange+"（クリックして編集）"},(0,o.v_)(e.settings.alignmentRange),9,Q))]),(0,a.Lk)("div",Z,[(0,a.Lk)("label",{title:u.predatorAlertRadius},n[41]||(n[41]=[(0,a.eW)("逃避開始距離"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Predator Alert):")]),8,ee),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[14]||(n[14]=t=>e.settings.predatorAlertRadius=t),min:"0",max:"10",step:"0.05",title:u.predatorAlertRadius},null,8,te),[[i.Jo,e.settings.predatorAlertRadius,void 0,{number:!0}]]),kt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"predatorAlertRadiusInput",ref:Tt,class:"value-input",type:"number","onUpdate:modelValue":n[15]||(n[15]=t=>e.settings.predatorAlertRadius=t),min:"0",max:"20",step:"0.05",onBlur:Ft,onKeyup:(0,i.jR)(Ft,["enter"]),title:u.predatorAlertRadius},null,40,ie)),[[i.Jo,e.settings.predatorAlertRadius,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Rt,title:u.predatorAlertRadius+"（クリックして編集）"},(0,o.v_)(e.settings.predatorAlertRadius),9,ne))]),(0,a.Lk)("div",ae,[(0,a.Lk)("label",{title:u.densityReturnStrength},n[42]||(n[42]=[(0,a.eW)("密度復帰強度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Density Return):")]),8,se),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[16]||(n[16]=t=>e.settings.densityReturnStrength=t),min:"0",max:"80",step:"0.5",title:u.densityReturnStrength},null,8,oe),[[i.Jo,e.settings.densityReturnStrength,void 0,{number:!0}]]),Et.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"densityReturnStrengthInput",ref:At,class:"value-input",type:"number","onUpdate:modelValue":n[17]||(n[17]=t=>e.settings.densityReturnStrength=t),min:"0",max:"120",step:"0.5",onBlur:Ut,onKeyup:(0,i.jR)(Ut,["enter"]),title:u.densityReturnStrength},null,40,le)),[[i.Jo,e.settings.densityReturnStrength,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Bt,title:u.densityReturnStrength+"（クリックして編集）"},(0,o.v_)(e.settings.densityReturnStrength),9,re))]),(0,a.Lk)("div",ue,[(0,a.Lk)("label",{title:u.maxSpeed},n[43]||(n[43]=[(0,a.eW)("最大速度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Max Speed):")]),8,ce),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[18]||(n[18]=t=>e.settings.maxSpeed=t),min:"0.1",max:"2",step:"0.01",title:u.maxSpeed},null,8,he),[[i.Jo,e.settings.maxSpeed,void 0,{number:!0}]]),It.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"maxSpeedInput",ref:Dt,class:"value-input",type:"number","onUpdate:modelValue":n[19]||(n[19]=t=>e.settings.maxSpeed=t),min:"0.1",max:"2",step:"0.01",onBlur:Ht,onKeyup:(0,i.jR)(Ht,["enter"]),title:u.maxSpeed},null,40,pe)),[[i.Jo,e.settings.maxSpeed,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Vt,title:u.maxSpeed+"（クリックして編集）"},(0,o.v_)(e.settings.maxSpeed),9,de))]),(0,a.Lk)("div",fe,[(0,a.Lk)("label",{title:u.maxTurnAngle},n[44]||(n[44]=[(0,a.eW)("最大曲がり"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Max Curvature):")]),8,me),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[20]||(n[20]=t=>e.settings.maxTurnAngle=t),min:"0",max:"30",step:"0.1",title:u.maxTurnAngle},null,8,ge),[[i.Jo,e.settings.maxTurnAngle,void 0,{number:!0}]]),Wt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"maxTurnAngleInput",ref:Nt,class:"value-input",type:"number","onUpdate:modelValue":n[21]||(n[21]=t=>e.settings.maxTurnAngle=t),min:"0",max:"60",step:"0.1",onBlur:qt,onKeyup:(0,i.jR)(qt,["enter"]),title:u.maxTurnAngle},null,40,be)),[[i.Jo,e.settings.maxTurnAngle,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:_t,title:u.maxTurnAngle+"（クリックして編集）"},(0,o.v_)(e.settings.maxTurnAngle),9,ve))]),(0,a.Lk)("div",Se,[(0,a.Lk)("label",{title:u.maxNeighbors},n[45]||(n[45]=[(0,a.eW)("最大近傍数"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Max Neighbors):")]),8,ye),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[22]||(n[22]=t=>e.settings.maxNeighbors=t),min:"0",max:"32",step:"1",title:u.maxNeighbors},null,8,we),[[i.Jo,e.settings.maxNeighbors,void 0,{number:!0}]]),Ot.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"maxNeighborsInput",ref:zt,class:"value-input",type:"number","onUpdate:modelValue":n[23]||(n[23]=t=>e.settings.maxNeighbors=t),min:"0",max:"32",step:"1",onBlur:jt,onKeyup:(0,i.jR)(jt,["enter"]),title:u.maxNeighbors},null,40,Me)),[[i.Jo,e.settings.maxNeighbors,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Kt,title:u.maxNeighbors+"（クリックして編集）"},(0,o.v_)(e.settings.maxNeighbors),9,xe))]),(0,a.Lk)("div",Pe,[(0,a.Lk)("label",{title:u.horizontalTorque},n[46]||(n[46]=[(0,a.eW)("水平化トルク"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Horizontal Torque):")]),8,Ce),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[24]||(n[24]=t=>e.settings.horizontalTorque=t),min:"0.0",max:"0.2",step:"0.001",title:u.horizontalTorque},null,8,Le),[[i.Jo,e.settings.horizontalTorque,void 0,{number:!0}]]),Xt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"horizontalTorqueInput",ref:Gt,class:"value-input",type:"number","onUpdate:modelValue":n[25]||(n[25]=t=>e.settings.horizontalTorque=t),min:"0.0",max:"0.2",step:"0.001",onBlur:Yt,onKeyup:(0,i.jR)(Yt,["enter"]),title:u.horizontalTorque},null,40,Te)),[[i.Jo,e.settings.horizontalTorque,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Jt,title:u.horizontalTorque+"（クリックして編集）"},(0,o.v_)(e.settings.horizontalTorque),9,ke))]),(0,a.Lk)("div",Re,[(0,a.Lk)("label",{title:u.torqueStrength},n[47]||(n[47]=[(0,a.eW)("回転トルク強度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Torque Strength):")]),8,Fe),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[26]||(n[26]=t=>e.settings.torqueStrength=t),min:"0.0",max:"20",step:"0.001",title:u.torqueStrength},null,8,Ee),[[i.Jo,e.settings.torqueStrength,void 0,{number:!0}]]),Qt.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"torqueStrengthInput",ref:$t,class:"value-input",type:"number","onUpdate:modelValue":n[27]||(n[27]=t=>e.settings.torqueStrength=t),min:"0.0",max:"5",step:"0.001",onBlur:en,onKeyup:(0,i.jR)(en,["enter"]),title:u.torqueStrength},null,40,Be)),[[i.Jo,e.settings.torqueStrength,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:Zt,title:u.torqueStrength+"（クリックして編集）"},(0,o.v_)(e.settings.torqueStrength),9,Ae))]),(0,a.Lk)("div",Ue,[(0,a.Lk)("label",{title:u.lambda},n[48]||(n[48]=[(0,a.eW)("減衰係数"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Damping Coefficient):")]),8,Ie),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[28]||(n[28]=t=>e.settings.lambda=t),min:"0",max:"1",step:"0.001",title:u.lambda},null,8,De),[[i.Jo,e.settings.lambda,void 0,{number:!0}]]),tn.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"lambdaInput",ref:nn,class:"value-input",type:"number","onUpdate:modelValue":n[29]||(n[29]=t=>e.settings.lambda=t),min:"0",max:"1",step:"0.001",onBlur:sn,onKeyup:(0,i.jR)(sn,["enter"]),title:u.lambda},null,40,He)),[[i.Jo,e.settings.lambda,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:an,title:u.lambda+"（クリックして編集）"},(0,o.v_)(e.settings.lambda),9,Ve))]),(0,a.Lk)("div",We,[(0,a.Lk)("label",{title:u.tau},n[49]||(n[49]=[(0,a.eW)("記憶時間"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Memory Time):")]),8,Ne),(0,a.bo)((0,a.Lk)("input",{type:"range","onUpdate:modelValue":n[30]||(n[30]=t=>e.settings.tau=t),min:"0",max:"5",step:"0.01",title:u.tau},null,8,_e),[[i.Jo,e.settings.tau,void 0,{number:!0}]]),on.value?(0,a.bo)(((0,a.uX)(),(0,a.CE)("input",{key:1,ref_key:"tauInput",ref:rn,class:"value-input",type:"number","onUpdate:modelValue":n[31]||(n[31]=t=>e.settings.tau=t),min:"0",max:"5",step:"0.01",onBlur:un,onKeyup:(0,i.jR)(un,["enter"]),title:u.tau},null,40,Oe)),[[i.Jo,e.settings.tau,void 0,{number:!0}]]):((0,a.uX)(),(0,a.CE)("span",{key:0,class:"editable-value",onClick:ln,title:u.tau+"（クリックして編集）"},(0,o.v_)(e.settings.tau),9,qe))]),(0,a.Lk)("div",ze,[(0,a.Lk)("label",{title:u.isPredator},n[50]||(n[50]=[(0,a.eW)("捕食者フラグ"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(Is Predator):")]),8,Ke),(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[32]||(n[32]=t=>e.settings.isPredator=t),title:u.isPredator},null,8,je),[[i.lH,e.settings.isPredator]]),(0,a.Lk)("span",{title:u.isPredator},(0,o.v_)(e.settings.isPredator),9,Xe)])])])]))}};var Je=n(262);const Ye=(0,Je.A)(Ge,[["__scopeId","data-v-27c2e252"]]),Qe=Ye;var $e=n(800),Ze=n(763);class et{constructor({tailAnimation:e,tripleBufferSize:t=3,hiddenPosition:n=1e6,identityQuaternion:i=[0,0,0,1],lodNearDistanceSq:a=4,lodMidDistanceSq:s=25}={}){this.tailAnimation=e,this.tripleBufferSize=t,this.hiddenPosition=n,this.identityQuaternion=i,this.lodNearDistanceSq=a,this.lodMidDistanceSq=s,this.streamUsage=r.Ktl??r.Vnu,this.scene=null,this.count=0,this.instancedMeshHigh=null,this.instancedMeshLow=null,this.instancingMaterials=new Set,this.bufferSetHigh=null,this.bufferSetLow=null,this.tailPhaseSeeds=null,this.bufferCursor=0,this.previousVelocities=null,this.previousLodFlags=null,this.predatorModel=null,this.predatorMeshes=[],this.predatorMeshCountCache=-1,this.positionQuantization={extent:64,originSnap:1},this.positionQuantUniforms={uInstanceOrigin:{value:new r.Pq0},uInstanceExtent:{value:this.positionQuantization.extent}}}init(e,{count:t,boidModel:n,boidModelLod:i,highMaterial:a,lowMaterial:s,predatorModel:o=null}){if(!e||!n||!i||!a||!s)return console.error("BoidInstancing.init: missing required arguments."),!1;if(!n.children?.length||!n.children[0].geometry)return console.error("BoidInstancing.init: invalid high model."),!1;if(!i.children?.length||!i.children[0].geometry)return console.error("BoidInstancing.init: invalid LOD model."),!1;this.dispose(e),this.scene=e,this.count=t,o&&(this.predatorModel=o);const l=a.clone(),u=s.clone();this.patchMaterial(l),this.patchMaterial(u);const c=n.children[0].geometry.clone(),h=i.children[0].geometry.clone();return this.ensureBodyCoordAttribute(c),this.ensureBodyCoordAttribute(h),this.instancedMeshHigh=new r.ZLX(c,l,t),this.configureInstancedMesh(this.instancedMeshHigh,l),this.instancedMeshLow=new r.ZLX(h,u,t),this.configureInstancedMesh(this.instancedMeshLow,u),e.add(this.instancedMeshHigh),e.add(this.instancedMeshLow),this.bufferSetHigh=this.createBufferSet(t),this.bufferSetLow=this.createBufferSet(t),this.resetBufferSetToHidden(this.bufferSetHigh),this.resetBufferSetToHidden(this.bufferSetLow),this.tailPhaseSeeds=this.createTailPhaseArray(t),this.applyTailPhaseSeeds(this.bufferSetHigh,this.tailPhaseSeeds),this.applyTailPhaseSeeds(this.bufferSetLow,this.tailPhaseSeeds),this.bufferCursor=0,this.applyBufferSet(this.instancedMeshHigh,this.bufferSetHigh,this.bufferCursor),this.applyBufferSet(this.instancedMeshLow,this.bufferSetLow,this.bufferCursor),this.instancedMeshHigh.instanceMatrix.setUsage(r.agE),this.instancedMeshLow.instanceMatrix.setUsage(r.agE),this.instancedMeshHigh.count=0,this.instancedMeshLow.count=0,this.previousVelocities=null,this.previousLodFlags=null,this.scene&&this.predatorModel&&this.ensurePredatorMeshes(0),!0}update({count:e,positions:t,orientations:n,velocities:i,cameraPosition:a,predatorCount:s=0,posRange:o,originPosition:r}){if(!this.instancedMeshHigh||!this.instancedMeshLow||!this.bufferSetHigh||!this.bufferSetLow)return{visibleCount:0,lodFlags:null};if(!t||!n)return{visibleCount:0,lodFlags:null};const l=this.bufferCursor,u=(l+1)%this.tripleBufferSize;this.ensureTailRuntimeBuffers(e),this.ensureTailSeedCapacity(e);const c=this.ensureLodFlagBuffer(e),h=this.bufferSetHigh.pos[l],d=this.bufferSetHigh.quat[l],p=this.bufferSetHigh.tailParams[l],f=this.bufferSetHigh.tailPhase[l],m=this.bufferSetLow.pos[l],g=this.bufferSetLow.quat[l],v=this.bufferSetLow.tailParams[l],b=this.bufferSetLow.tailPhase[l],S=h.array,y=d.array,w=p.array,x=f.array,M=m.array,P=g.array,C=v.array,L=b.array;let k=!1,T=!1,R=!1,F=!1,E=!1,A=!1;const B=a?.x??0,U=a?.y??0,I=a?.z??0,D=r?.x??B,V=r?.y??U,H=r?.z??I,W=Number.isFinite(o)&&o>0?16*o:0,N=Math.max(this.positionQuantization.extent,W),_=this.positionQuantization.originSnap,q=_>0?Math.floor(D/_)*_:D,O=_>0?Math.floor(V/_)*_:V,z=_>0?Math.floor(H/_)*_:H;this.positionQuantUniforms.uInstanceOrigin.value.set(q,O,z),this.positionQuantUniforms.uInstanceExtent.value=N;const K=N>0?1/N:0,j=s>0?Math.max(0,e-s):e;if(this.scene&&this.predatorModel){this.ensurePredatorMeshes(s)&&(this.predatorMeshCountCache=s);for(const e of this.predatorMeshes)e.visible=!1}const X=this.previousVelocities,G=this.tailPhaseSeeds;let J=0,Y=0;(!this.highInstanceToBoid||this.highInstanceToBoid.length<e)&&(this.highInstanceToBoid=new Uint32Array(e),this.lowInstanceToBoid=new Uint32Array(e));for(let $=0;$<e;$++){const e=3*$,a=4*$,s=t[e],o=t[e+1],r=t[e+2],l=n[a],u=n[a+1],h=n[a+2],d=n[a+3];if($>=j){if(this.scene&&this.predatorModel){const e=$-j,t=this.predatorMeshes[e];t&&(t.visible=!0,t.position.set(s,o,r),t.quaternion.set(l,u,h,d))}c&&(c[$]=0);continue}const p=s-B,f=o-U,m=r-I,g=p*p+f*f+m*m,v=g<this.lodNearDistanceSq,b=!v&&g<this.lodMidDistanceSq,D=v||b,V=i?i[e]:0,H=i?i[e+1]:0,W=i?i[e+2]:0,_=Math.hypot(V,H,W),Q=X?X[e]:0,Z=X?X[e+1]:0,ee=X?X[e+2]:0,te=Math.hypot(Q,Z,ee);let ne=0;if(te>1e-5&&_>1e-5){const e=ee*V-Q*W,t=Q*V+Z*H+ee*W;ne=Math.atan2(e,t)}const ie=D?_:0,ae=D?ne:0,se=D?1:0;if(v){const e=J,t=3*e,n=4*e,i=3*e;{const e=Math.max(-N,Math.min(N,s-q)),n=Math.max(-N,Math.min(N,o-O)),i=Math.max(-N,Math.min(N,r-z)),a=Math.max(0,Math.min(1,.5*e*K+.5)),l=Math.max(0,Math.min(1,.5*n*K+.5)),u=Math.max(0,Math.min(1,.5*i*K+.5));S[t]=65535*a+.5|0,S[t+1]=65535*l+.5|0,S[t+2]=65535*u+.5|0}y[n]=l,y[n+1]=u,y[n+2]=h,y[n+3]=d,w[i]=ie,w[i+1]=ae,w[i+2]=se;const a=G&&$<G.length?G[$]:0;x[e]=a,this.highInstanceToBoid[e]=$,J++,k=!0,R=!0,E=!0}else{const e=Y,t=3*e,n=4*e,i=3*e;{const e=Math.max(-N,Math.min(N,s-q)),n=Math.max(-N,Math.min(N,o-O)),i=Math.max(-N,Math.min(N,r-z)),a=Math.max(0,Math.min(1,.5*e*K+.5)),l=Math.max(0,Math.min(1,.5*n*K+.5)),u=Math.max(0,Math.min(1,.5*i*K+.5));M[t]=65535*a+.5|0,M[t+1]=65535*l+.5|0,M[t+2]=65535*u+.5|0}P[n]=l,P[n+1]=u,P[n+2]=h,P[n+3]=d,C[i]=ie,C[i+1]=ae,C[i+2]=se;const a=G&&$<G.length?G[$]:0;L[e]=a,this.lowInstanceToBoid[e]=$,Y++,T=!0,F=!0,A=!0}c&&(c[$]=v?1:2),X&&(X[e]=V,X[e+1]=H,X[e+2]=W)}const Q=s>0?Math.max(0,e-s):e;return this.instancedMeshHigh.count=J,this.instancedMeshLow.count=Y,this.applyBufferSet(this.instancedMeshHigh,this.bufferSetHigh,l),this.applyBufferSet(this.instancedMeshLow,this.bufferSetLow,l),h.needsUpdate=k,d.needsUpdate=k,m.needsUpdate=T,g.needsUpdate=T,p.needsUpdate=R,v.needsUpdate=F,f.needsUpdate=E,b.needsUpdate=A,this.bufferCursor=u,{visibleCount:Q,lodFlags:c,highCount:J,lowCount:Y,highInstanceToBoid:this.highInstanceToBoid,lowInstanceToBoid:this.lowInstanceToBoid}}forEachInstancingMaterial(e){for(const t of this.instancingMaterials)e(t)}getMeshes(){return{high:this.instancedMeshHigh,low:this.instancedMeshLow}}getPredatorMeshes(){return this.predatorMeshes}setTailUniformTime(e){this.tailAnimation?.uniforms&&this.tailAnimation.uniforms.uTailTime&&(this.tailAnimation.uniforms.uTailTime.value=e)}patchMaterial(e){if(!e||e.userData?.instancingPatched)return;const t=this.tailAnimation?.uniforms;t||console.warn("BoidInstancing.patchMaterial: tailAnimation.uniforms が未設定です"),e.onBeforeCompile=n=>{t&&Object.entries(t).forEach((([e,t])=>{n.uniforms[e]=t})),n.uniforms.uInstanceOrigin=this.positionQuantUniforms.uInstanceOrigin,n.uniforms.uInstanceExtent=this.positionQuantUniforms.uInstanceExtent,n.vertexShader=n.vertexShader.replace("#include <common>","#include <common>\nattribute vec3 instancePos;\nattribute vec4 instanceQuat;\nattribute float aBodyCoord;\nattribute float instanceTailPhase;\nattribute vec3 instanceTailParams;\nuniform vec3 uInstanceOrigin;\nuniform float uInstanceExtent;\nuniform float uTailTime;\nuniform float uTailAmplitude;\nuniform float uTailFrequency;\nuniform float uTailPhaseStride;\nuniform float uTailTurnStrength;\nuniform float uTailSpeedScale;\nuniform vec3 uTailRight;\nuniform vec3 uTailForward;\nuniform vec3 uTailUp;\nuniform float uTailEnable;\nuniform sampler2D uSinLut;\nuniform float uLutSize;\nvec3 quatTransform(vec3 v, vec4 q) {\n  vec3 t = 2.0 * cross(q.xyz, v);\n  return v + q.w * t + cross(q.xyz, t);\n}\nvec3 decodeInstancePos(vec3 packed01) {\n  // Uint16 normalized (0..1) を [-extent, extent] のローカル座標へ復号\n  vec3 local = (packed01 * 2.0 - 1.0) * uInstanceExtent;\n  return uInstanceOrigin + local;\n}\nvec2 sampleSinCos(float angle) {\n  float u = fract(angle * 0.15915494309189535);\n  u = u * (uLutSize - 1.0) + 0.5;\n  vec4 lutSample = texture(uSinLut, vec2(u / uLutSize, 0.5));\n  return lutSample.rg * 2.0 - 1.0;\n}").replace("#include <instancing_vertex>","#ifdef USE_INSTANCING\n#endif\n#ifdef USE_INSTANCING_COLOR\n  vColor.xyz *= instanceColor.xyz;\n#endif").replace("#include <begin_vertex>","#include <begin_vertex>\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 originalPos = transformed;\n    vec3 right = normalize(uTailRight);\n    vec3 forward = normalize(uTailForward);\n    vec3 up = normalize(uTailUp);\n\n    float localX = dot(originalPos, right);\n    float localY = dot(originalPos, forward);\n    float localZ = dot(originalPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    transformed = rotated;\n  }\n}\ntransformed = quatTransform(transformed, instanceQuat) + decodeInstancePos(instancePos);").replace("#include <beginnormal_vertex>","#include <beginnormal_vertex>\nobjectNormal = quatTransform(objectNormal, instanceQuat);").replace("#include <project_vertex>","#include <project_vertex>\n#ifdef DEPTH_PACKING\nvec3 tailParams = instanceTailParams;\nif (uTailEnable > 0.5) {\n  float driveRaw = tailParams.z;\n  if (driveRaw > 0.01) {\n    float drive = clamp(driveRaw, 0.0, 1.0);\n    vec3 viewPos = mvPosition.xyz;\n    mat3 normalMatrix3 = mat3(normalMatrix);\n    vec3 right = normalize(normalMatrix3 * uTailRight);\n    vec3 forward = normalize(normalMatrix3 * uTailForward);\n    vec3 up = normalize(normalMatrix3 * uTailUp);\n\n    float localX = dot(viewPos, right);\n    float localY = dot(viewPos, forward);\n    float localZ = dot(viewPos, up);\n\n    float bodyCoord = clamp(aBodyCoord, 0.0, 1.0);\n    float tailWeight = smoothstep(0.0, 0.35, bodyCoord);\n    float speedFactor = clamp(tailParams.x * uTailSpeedScale, 0.0, 2.0);\n\n    float phase = instanceTailPhase + uTailTime * uTailFrequency;\n    float wavePhase = phase + bodyCoord * uTailPhaseStride;\n    vec2 waveSC = sampleSinCos(wavePhase);\n    float wag = waveSC.x * uTailAmplitude * drive;\n    float turnOffset = tailParams.y * uTailTurnStrength * drive;\n    float motion = wag * (0.4 + 0.6 * speedFactor) + turnOffset;\n\n    float tipDamping = 1.0 - smoothstep(0.7, 1.0, bodyCoord) * 0.3;\n    float bendStrength = mix(0.02, 1.0, tailWeight) * tipDamping;\n\n    float bendAngle = motion * bendStrength;\n    vec2 bendSC = sampleSinCos(bendAngle);\n    float s = bendSC.x;\n    float c = bendSC.y;\n    float rotX = localX * c - localY * s;\n    float rotY = localX * s + localY * c;\n\n    float sway = motion * 0.4 * tipDamping;\n    rotX += sway * (0.05 + 0.95 * bodyCoord);\n\n    vec3 rotated = right * rotX + forward * rotY + up * localZ;\n    mvPosition.xyz = rotated;\n    gl_Position = projectionMatrix * mvPosition;\n  }\n}\n#endif"),e.userData={...e.userData||{},instancingPatched:!0}},e.needsUpdate=!0,this.instancingMaterials.add(e)}createDepthMaterial(e){const t=new r.CSG({depthPacking:r.N5j,alphaTest:e.alphaTest??0});return t.map=e.map??null,t.alphaMap=e.alphaMap??null,t.transparent=e.transparent??!1,this.patchMaterial(t),t}createDistanceMaterial(e){const t=new r.aVO({alphaTest:e.alphaTest??0});return t.map=e.map??null,t.alphaMap=e.alphaMap??null,t.transparent=e.transparent??!1,this.patchMaterial(t),t}configureInstancedMesh(e,t){e.castShadow=!0,e.receiveShadow=!0,e.frustumCulled=!1,e.customDepthMaterial=this.createDepthMaterial(t),e.customDistanceMaterial=this.createDistanceMaterial(t);const n=new r.Q1f(1,1,1);for(let i=0;i<e.count;i++)e.setColorAt(i,n);e.instanceColor&&(e.instanceColor.needsUpdate=!0)}createAttributeSet(e,t,n=Float32Array){const i=e*t,a=[];for(let s=0;s<this.tripleBufferSize;s++){const e=new r.uWO(new n(i),t);e.setUsage(this.streamUsage),a.push(e)}return a}createNormalizedAttributeSet(e,t,n){const i=e*t,a=[];for(let s=0;s<this.tripleBufferSize;s++){const e=new r.uWO(new n(i),t,!0);e.setUsage(this.streamUsage),a.push(e)}return a}createBufferSet(e){return{pos:this.createNormalizedAttributeSet(e,3,Uint16Array),quat:this.createAttributeSet(e,4),tailPhase:this.createAttributeSet(e,1),tailParams:this.createAttributeSet(e,3)}}resetBufferSetToHidden(e){for(const t of e.pos){const e=t.array;e.fill(0)}for(const t of e.quat){const e=t.array;for(let t=0;t<e.length;t+=4)e[t]=this.identityQuaternion[0],e[t+1]=this.identityQuaternion[1],e[t+2]=this.identityQuaternion[2],e[t+3]=this.identityQuaternion[3]}for(const t of e.tailPhase)t.array.fill(0);for(const t of e.tailParams)t.array.fill(0)}applyBufferSet(e,t,n){e.geometry.setAttribute("instancePos",t.pos[n]),e.geometry.setAttribute("instanceQuat",t.quat[n]),e.geometry.setAttribute("instanceTailPhase",t.tailPhase[n]),e.geometry.setAttribute("instanceTailParams",t.tailParams[n])}createTailPhaseArray(e){const t=new Float32Array(e);for(let n=0;n<e;n++)t[n]=Math.random()*Math.PI*2;return t}applyTailPhaseSeeds(e,t){if(e?.tailPhase)for(const n of e.tailPhase)n.array.set(t),n.needsUpdate=!0}ensureTailRuntimeBuffers(e){const t=3*e;this.previousVelocities&&this.previousVelocities.length===t||(this.previousVelocities=new Float32Array(t))}ensureLodFlagBuffer(e){return e<=0?(this.previousLodFlags=null,null):(this.previousLodFlags&&this.previousLodFlags.length===e||(this.previousLodFlags=new Uint8Array(e)),this.previousLodFlags)}ensureTailSeedCapacity(e){if(e<=0)return;const t=this.tailPhaseSeeds?this.tailPhaseSeeds.length:0;if(!this.tailPhaseSeeds||t<e){const n=new Float32Array(e);this.tailPhaseSeeds&&t>0&&n.set(this.tailPhaseSeeds.subarray(0,t));for(let i=t;i<e;i++)n[i]=Math.random()*Math.PI*2;this.tailPhaseSeeds=n}}ensureBodyCoordAttribute(e){if(e.getAttribute("aBodyCoord"))return;const t=e.getAttribute("position");if(!t)return;const n=t.count,i=t.array;let a=1/0,s=1/0,o=1/0,l=-1/0,u=-1/0,c=-1/0;for(let r=0;r<n;r++){const e=3*r,t=i[e],n=i[e+1],h=i[e+2];t<a&&(a=t),t>l&&(l=t),n<s&&(s=n),n>u&&(u=n),h<o&&(o=h),h>c&&(c=h)}const h=l-a,d=u-s,p=c-o;let f="z",m=o,g=p;h>d&&h>p?(f="x",m=a,g=h):d>p&&(f="y",m=s,g=d);const v=new Float32Array(n),b=g>0?g:1;for(let r=0;r<n;r++){const e=3*r,t="x"===f?i[e]:"y"===f?i[e+1]:i[e+2];v[r]=(t-m)/b}e.setAttribute("aBodyCoord",new r.THS(v,1))}ensurePredatorMeshes(e){if(!this.scene||!this.predatorModel)return!1;const t=Math.max(0,e);while(this.predatorMeshes.length>t){const e=this.predatorMeshes.pop();e&&this.scene.remove(e)}while(this.predatorMeshes.length<t){const e=this.predatorModel.clone(!0);e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),e.visible=!1,this.scene.add(e),this.predatorMeshes.push(e)}return this.predatorMeshes.length===t}dispose(e=this.scene){if(this.instancedMeshHigh&&(e?.remove(this.instancedMeshHigh),this.instancedMeshHigh.geometry?.dispose?.(),this.instancedMeshHigh.material?.dispose?.(),this.instancedMeshHigh=null),this.instancedMeshLow&&(e?.remove(this.instancedMeshLow),this.instancedMeshLow.geometry?.dispose?.(),this.instancedMeshLow.material?.dispose?.(),this.instancedMeshLow=null),e)for(const t of this.predatorMeshes)e.remove(t);this.instancingMaterials.clear(),this.bufferSetHigh=null,this.bufferSetLow=null,this.tailPhaseSeeds=null,this.bufferCursor=0,this.previousVelocities=null,this.previousLodFlags=null,this.predatorMeshes=[],this.predatorMeshCountCache=-1,this.scene=e??null,this.count=0}}var tt=n(794),nt=n(804),it=n(741),at=n(579),st=n(185);class ot{constructor(e){this.config=e,this.composer=null,this.heightFogPass=null,this.heightFogRenderTarget=null,this.renderer=null,this.scene=null,this.camera=null,this.internalScale=.75}get heightFog(){return this.heightFogPass}init(e,t,n,i,a){if(!e||!t||!n)return void console.warn("FogPipeline.init: renderer / scene / camera が未設定です");this.dispose(),this.renderer=e,this.scene=t,this.camera=n;const s=Math.max(.25,Math.min(Number(this.internalScale)||1,1)),o=Math.max(1,Math.floor(i*s)),l=Math.max(1,Math.floor(a*s)),u={depthBuffer:!0,stencilBuffer:!1};this.heightFogRenderTarget=new r.nWS(o,l,u),this.heightFogRenderTarget.depthTexture=new r.VCu(o,l,r.bkx),this.heightFogRenderTarget.depthTexture.format=r.zdS,this.heightFogRenderTarget.depthTexture.type=r.bkx,this.heightFogRenderTarget.depthTexture.needsUpdate=!0,this.composer=new tt.s(e,this.heightFogRenderTarget);const c=new nt.A(t,n);this.composer.addPass(c);const h=new it.C(t,n,o,l);h.kernelRadius=5,h.minDistance=.01,h.maxDistance=.3,this.composer.addPass(h);const d=4.5,p=.1,f=.83,m=new at.C(new r.I9Y(o,l),d,p,f);this.composer.addPass(m);const g=rt(this.config);this.heightFogPass=new st.p(g);const v=this.heightFogPass.render.bind(this.heightFogPass);this.heightFogPass.render=(e,t,n,i,a)=>{if(this.heightFogPass.uniforms.tDepth){const e=n?.depthTexture??this.heightFogRenderTarget?.depthTexture??null;e&&(this.heightFogPass.uniforms.tDepth.value=e)}v(e,t,n,i,a)},this.heightFogPass.needsSwap=!1,this.heightFogPass.uniforms.tDepth.value=this.heightFogRenderTarget.depthTexture,ht(this.heightFogPass.uniforms,this.config);const b=this.heightFogPass.material;b&&(b.depthTest=!1,b.depthWrite=!1,b.transparent=!1,b.blending=r.XIg,b.toneMapped=!1,b.needsUpdate=!0),this.heightFogPass.renderToScreen=!0,this.composer.addPass(this.heightFogPass)}resize(e,t){if(!this.composer)return;const n=Math.max(.25,Math.min(Number(this.internalScale)||1,1)),i=Math.max(1,Math.floor(e*n)),a=Math.max(1,Math.floor(t*n));this.composer.setSize(i,a),this.heightFogRenderTarget?.setSize(i,a)}render(e){this.composer&&this.composer.render(e)}isReady(){return!!this.composer}updateCameraUniforms(e){const t=this.heightFogPass,n=e||this.camera;if(!t||!n)return;const{uniforms:i}=t;if(i.uExposure){const e=Number(this.renderer?.toneMappingExposure);i.uExposure.value=Number.isFinite(e)?e:1}i.cameraNear&&(i.cameraNear.value=n.near),i.cameraFar&&(i.cameraFar.value=n.far),i.projectionMatrixInverse?.value&&i.projectionMatrixInverse.value.copy(n.projectionMatrixInverse),i.cameraMatrixWorld?.value&&i.cameraMatrixWorld.value.copy(n.matrixWorld)}updateConfig(e={}){this.config={...this.config,...e},this.heightFogPass&&ht(this.heightFogPass.uniforms,this.config)}dispose(){const e=this.heightFogPass?.uniforms?.tDistanceCurveLut?.value??null;e&&"function"===typeof e.dispose&&e.dispose(),this.heightFogPass=null,this.composer?.dispose?.(),this.composer=null,this.heightFogRenderTarget?.dispose?.(),this.heightFogRenderTarget=null,this.renderer=null,this.scene=null,this.camera=null}}function rt(e={}){const t=lt(),n={...t,...e},i=dt(null,ct(n.distanceControlPoint1),ct(n.distanceControlPoint2));return{uniforms:{tDiffuse:{value:null},tDepth:{value:null},tDistanceCurveLut:{value:i},uExposure:{value:1},cameraNear:{value:.1},cameraFar:{value:1e3},projectionMatrixInverse:{value:new r.kn4},cameraMatrixWorld:{value:new r.kn4},fogColor:{value:ut(n.color)},distanceStart:{value:n.distanceStart},distanceEnd:{value:n.distanceEnd},distanceExponent:{value:n.distanceExponent},surfaceLevel:{value:n.surfaceLevel},heightFalloff:{value:n.heightFalloff},heightExponent:{value:n.heightExponent},maxOpacity:{value:n.maxOpacity}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n      vUv = uv;\n      gl_Position = vec4(position.xy, 0.0, 1.0);\n    }\n  ",fragmentShader:"\n    precision highp float;\n    varying vec2 vUv;\n\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tDepth;\n    uniform sampler2D tDistanceCurveLut;\n    uniform float uExposure;\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform vec3 fogColor;\n    uniform float distanceStart;\n    uniform float distanceEnd;\n    uniform float distanceExponent;\n    uniform float surfaceLevel;\n    uniform float heightFalloff;\n    uniform float heightExponent;\n    uniform float maxOpacity;\n    uniform mat4 projectionMatrixInverse;\n    uniform mat4 cameraMatrixWorld;\n\n    float sampleDistanceCurve(float x) {\n      // 256x1 LUT。LinearFilterで補間されるためバンディングを抑えられる。\n      float u = clamp(x, 0.0, 1.0);\n      return texture2D(tDistanceCurveLut, vec2(u, 0.5)).r;\n    }\n\n\n    void main() {\n      vec4 baseColor = texture2D(tDiffuse, vUv);\n      float depth = texture2D(tDepth, vUv).x;\n\n      if (depth >= 1.0) {\n        gl_FragColor = baseColor;\n        return;\n      }\n\n      vec2 ndc = vUv * 2.0 - 1.0;\n      float ndcZ = depth * 2.0 - 1.0;\n      vec4 clipPos = vec4(ndc, ndcZ, 1.0);\n      vec4 viewPos = projectionMatrixInverse * clipPos;\n      viewPos /= max(viewPos.w, 1e-5);\n      // height fog は world-space の Y（=水面からの深さ）だけ使うため、\n      // vec4 全体の変換は避け、Y 成分だけを計算して ALU を減らす。\n      float worldY =\n        cameraMatrixWorld[0][1] * viewPos.x +\n        cameraMatrixWorld[1][1] * viewPos.y +\n        cameraMatrixWorld[2][1] * viewPos.z +\n        cameraMatrixWorld[3][1] * viewPos.w;\n\n      // Fog の距離は厳密なユークリッド距離でなくても見た目が崩れにくい。\n      // sqrt(length) はフラグメントコストになりやすいので、視線方向距離で近似する。\n      float viewDistance = abs(viewPos.z);\n\n      // distanceStart 内は必ずフォグ無しにする。\n      // NOTE: 深度復元の誤差やシーンスケール次第で、ごく薄いフォグが混入して\n      // 「距離startの内側でも色が違う」ように見えるのを防ぐ。\n      if (viewDistance <= distanceStart) {\n        gl_FragColor = baseColor;\n        #include <colorspace_fragment>\n        return;\n      }\n\n      float distanceFogNorm = clamp(\n        (viewDistance - distanceStart) / max(distanceEnd - distanceStart, 1e-5),\n        0.0,\n        1.0\n      );\n      float distanceFog = sampleDistanceCurve(distanceFogNorm);\n      distanceFog = pow(distanceFog, distanceExponent);\n\n      float depthBelowSurface = max(surfaceLevel - worldY, 0.0);\n      float heightFactor = 1.0 - exp(-depthBelowSurface * heightFalloff);\n      heightFactor = clamp(pow(heightFactor, heightExponent), 0.0, 1.0);\n\n      // 深度(高さ)による濃さは、水中らしさに効く一方で近距離の被写体まで暗く見せやすい。\n      // 近距離では距離フォグのみを優先し、深度成分は少し先から効かせる。\n      float heightDistanceFade = smoothstep(distanceStart, distanceStart + 10.0, viewDistance);\n      heightFactor *= heightDistanceFade;\n\n      float fogFactor = clamp(distanceFog * heightFactor, 0.0, 1.0);\n      fogFactor = mix(0.0, maxOpacity, fogFactor);\n\n      // 強いハイライト（反射/ブルーム源）をフォグで潰し過ぎないための補正。\n      // 物理的に厳密ではないが、水中の「キラキラ」が消える違和感を抑える目的。\n      float luma = dot(baseColor.rgb, vec3(0.2126, 0.7152, 0.0722));\n      float highlightMask = smoothstep(0.6, 1.2, luma);\n      fogFactor *= mix(1.0, 0.35, highlightMask);\n\n      // 露出はシーン側（RenderPass）には自動で効くが、フォグ色は固定だと追従しない。\n      // fogColor 側にも同じ露出を掛けて、明るさ調整時の一体感を保つ。\n      vec3 fogTarget = fogColor * uExposure;\n      vec3 fogged = mix(baseColor.rgb, fogTarget, fogFactor);\n      gl_FragColor = vec4(fogged, baseColor.a);\n      #include <colorspace_fragment>\n    }\n  "}}rt();function lt(){return{color:new r.Q1f("#153a6c"),distanceStart:2,distanceEnd:5,distanceExponent:.4,distanceControlPoint1:new r.I9Y(.4,.75),distanceControlPoint2:new r.I9Y(.75,.95),surfaceLevel:100,heightFalloff:.01,heightExponent:1,maxOpacity:1}}function ut(e){return e instanceof r.Q1f?e.clone():"string"===typeof e||"number"===typeof e?new r.Q1f(e):new r.Q1f("#000000")}function ct(e){return e instanceof r.I9Y?e.clone():e&&"number"===typeof e.x&&"number"===typeof e.y?new r.I9Y(e.x,e.y):new r.I9Y}function ht(e,t={}){const n=lt(),i={...n,...t};e.fogColor?.value&&e.fogColor.value.copy(ut(i.color)),e.distanceStart&&(e.distanceStart.value=i.distanceStart),e.distanceEnd&&(e.distanceEnd.value=i.distanceEnd),e.distanceExponent&&(e.distanceExponent.value=i.distanceExponent),e.tDistanceCurveLut&&(e.tDistanceCurveLut.value=dt(e.tDistanceCurveLut.value,ct(i.distanceControlPoint1),ct(i.distanceControlPoint2))),e.surfaceLevel&&(e.surfaceLevel.value=i.surfaceLevel),e.heightFalloff&&(e.heightFalloff.value=i.heightFalloff),e.heightExponent&&(e.heightExponent.value=i.heightExponent),e.maxOpacity&&(e.maxOpacity.value=i.maxOpacity)}function dt(e,t,n){const i=256,a=!e||!(e instanceof r.GYF)||e.image?.width!==i||1!==e.image?.height,s=t instanceof r.I9Y?t:new r.I9Y,o=n instanceof r.I9Y?n:new r.I9Y,l=e?.userData?.distanceCurveLut??null,u=l&&l.c1x===s.x&&l.c1y===s.y&&l.c2x===o.x&&l.c2y===o.y;if(!a&&u)return e;const c=a?new Uint8Array(4*i):e.image.data,h=(e,t,n,i,a)=>{const s=1-e,o=s*s,r=e*e;return s*o*t+3*o*e*n+3*s*r*i+r*e*a},d=(e,t,n,i,a)=>{const s=1-e;return 3*s*s*(n-t)+6*s*e*(i-n)+3*e*e*(a-i)};for(let r=0;r<i;r+=1){const e=r/(i-1);let t=e;for(let i=0;i<5;i+=1){const n=h(t,0,s.x,o.x,1)-e,i=d(t,0,s.x,o.x,1);if(Math.abs(i)<1e-5)break;t=Math.min(1,Math.max(0,t-n/i))}const n=h(t,0,s.y,o.y,1),a=Math.min(255,Math.max(0,Math.round(255*n))),l=4*r;c[l+0]=a,c[l+1]=a,c[l+2]=a,c[l+3]=255}const p=a?new r.GYF(c,i,1,r.GWd,r.OUM):e;return p.wrapS=r.ghU,p.wrapT=r.ghU,p.minFilter=r.k6q,p.magFilter=r.k6q,p.generateMipmaps=!1,p.needsUpdate=!0,p.userData.distanceCurveLut={c1x:s.x,c1y:s.y,c2x:o.x,c2y:o.y},p}class pt{constructor(e={}){this.options={color:e.color??new r.Q1f("#4fbaff"),intensity:Number.isFinite(e.intensity)?e.intensity:.14,rayDensity:Number.isFinite(e.rayDensity)?e.rayDensity:7,raySoftness:Number.isFinite(e.raySoftness)?e.raySoftness:.3,speed:Number.isFinite(e.speed)?e.speed:.07,planeCount:Number.isFinite(e.planeCount)?Math.floor(e.planeCount):7,planeWidth:Number.isFinite(e.planeWidth)?e.planeWidth:120,planeHeight:Number.isFinite(e.planeHeight)?e.planeHeight:220,placementRadius:Number.isFinite(e.placementRadius)?e.placementRadius:90,topOffsetY:Number.isFinite(e.topOffsetY)?e.topOffsetY:70},this.scene=null,this.material=null,this.meshes=[],this.anchor=new r.Pq0(0,0,0),this.anchorSmoothed=new r.Pq0(0,0,0),this.tmp=new r.Pq0,this.timeSeconds=0}init(){this.dispose(),this.scene=new r.Z58;const e=Math.max(1,Math.min(this.options.planeCount,16)),t=new r.bdM(this.options.planeWidth,this.options.planeHeight,1,1);this.material=new r.BKk({uniforms:{uTime:{value:0},uIntensity:{value:this.options.intensity},uColor:{value:this.options.color.clone()},uRayDensity:{value:this.options.rayDensity},uRaySoftness:{value:this.options.raySoftness},uSeed:{value:0}},vertexShader:"\n        varying vec2 vUv;\n        varying float vSeed;\n        uniform float uSeed;\n        void main() {\n          vUv = uv;\n          vSeed = uSeed;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        precision highp float;\n        varying vec2 vUv;\n        varying float vSeed;\n\n        uniform float uTime;\n        uniform float uIntensity;\n        uniform vec3 uColor;\n        uniform float uRayDensity;\n        uniform float uRaySoftness;\n\n        float hash12(vec2 p) {\n          // 軽量ノイズ（テクスチャ無し）\n          vec3 p3 = fract(vec3(p.xyx) * 0.1031);\n          p3 += dot(p3, p3.yzx + 33.33);\n          return fract((p3.x + p3.y) * p3.z);\n        }\n\n        void main() {\n          // 板の上側ほど強く、下へ行くほど弱い（海中の減衰っぽい）。\n          float fromTop = clamp((vUv.y - 0.05) / 0.95, 0.0, 1.0);\n          float verticalFade = pow(fromTop, 2.2);\n\n          // ビームの筋（x方向）\n          float x = vUv.x;\n          float t = uTime;\n\n          // 低周波ゆらぎ（筋の揺れ）\n          float n = hash12(vec2(floor(x * uRayDensity + vSeed * 17.0), floor(t * 2.5 + vSeed * 11.0)));\n          float phase = (x * uRayDensity + (n - 0.5) * 2.0 + vSeed * 3.0) + t * 0.55;\n\n          // 筋の中心からの距離を作り、softness で幅を制御\n          float stripe = abs(fract(phase) - 0.5);\n          float ray = 1.0 - smoothstep(uRaySoftness, 0.5, stripe);\n\n          // 下に行くほど弱く（海中の減衰っぽく）\n          ray *= verticalFade;\n\n          // 端はフェードして「板感」を減らす\n          float edge = smoothstep(0.0, 0.12, vUv.x) * smoothstep(0.0, 0.12, 1.0 - vUv.x);\n          ray *= edge;\n\n          float a = clamp(ray * uIntensity, 0.0, 1.0);\n          vec3 outColor = uColor * a;\n\n          // 加算合成で重ねる（背景を暗くしない）\n          gl_FragColor = vec4(outColor, a);\n          #include <colorspace_fragment>\n        }\n      ",transparent:!0,depthTest:!1,depthWrite:!1,blending:r.EZo}),this.material.toneMapped=!1,this.meshes=[],this.meshes.length=0;for(let n=0;n<e;n+=1){const e=this.material.clone();e.uniforms=r.LlO.clone(this.material.uniforms),e.uniforms.uSeed.value=n+.37,e.toneMapped=!1;const i=new r.eaF(t,e);i.frustumCulled=!1,i.matrixAutoUpdate=!0,this.scene.add(i),this.meshes.push(i)}}update(e,t,n){const i=Number(e);Number.isFinite(i)&&i>0&&(this.timeSeconds+=i),t&&"number"===typeof t.x&&this.anchor.copy(t);const a=1-Math.exp(2.5*-i);this.anchorSmoothed.lerp(this.anchor,Number.isFinite(a)?a:0);const s=this.timeSeconds*this.options.speed,o=this.meshes,r=o.length;if(!r)return;const l=!!n;for(let u=0;u<r;u+=1){const e=o[u],t=e.material;t?.uniforms?.uTime&&(t.uniforms.uTime.value=s);const i=u/r*Math.PI*2+.2*s,a=this.options.placementRadius,c=Math.cos(i)*a,h=Math.sin(i)*a;e.position.set(this.anchorSmoothed.x+c,this.anchorSmoothed.y+this.options.topOffsetY,this.anchorSmoothed.z+h);const d=.85+.3*Math.sin(1.3*i+1.7);e.scale.setScalar(d),l&&e.lookAt(n.position)}}render(e,t){if(!e||!this.scene||!t)return;const n=e.autoClear;e.autoClear=!1;try{e.render(this.scene,t)}finally{e.autoClear=n}}dispose(){if(this.meshes&&this.meshes.length)for(const e of this.meshes)e&&(this.scene?.remove?.(e),e.geometry?.dispose?.(),e.material?.dispose?.());this.meshes=[],this.material=null,this.scene=null,this.timeSeconds=0}}const ft=new r.Pq0(24,12,26),mt=new r.Pq0(16,9,18),gt=1.2*ft.z,vt=1.2*mt.z,bt=30,St=new r.Pq0(Math.cos(r.cj9.degToRad(bt)),-Math.sin(r.cj9.degToRad(bt)),0),yt=new r.Pq0(0,0,1),wt=new r.Pq0(0,1,0),xt=new r.Pq0,Mt=new r.Pq0,Pt=new r.Pq0,Ct=new r.Pq0;class Lt{constructor(e){this.isMobileDevice=Boolean(e),this.scene=null,this.renderer=null,this.camera=null,this.controls=null,this.particlePoints=null,this.particleMaterial=null,this.elapsedTime=0,this.worldOrigin=new r.Pq0(0,0,0)}init(e,t,n,i){if(!e||!t?.capabilities?.isWebGL2)return console.warn("Skipping particle system: WebGL2 required."),!1;this.dispose(e),this.scene=e,this.renderer=t,this.camera=n,this.controls=i,this.elapsedTime=0;const a=this.isMobileDevice?800:2e3,s=new r.LoY;s.setAttribute("position",new r.THS(new Float32Array(3*a),3)),s.setDrawRange(0,a);const o=(this.isMobileDevice?mt:ft).clone(),l=this.isMobileDevice?vt:gt,u=new r.BKk({glslVersion:r.Wdf,transparent:!0,depthWrite:!1,depthTest:!0,blending:r.EZo,uniforms:{uTime:{value:0},uOrigin:{value:new r.Pq0},uFlowDir:{value:St.clone()},uLat1:{value:yt.clone()},uLat2:{value:wt.clone()},uSpread:{value:o.clone()},uMaxDistance:{value:l},uBaseSpeed:{value:.6},uJitterAmp:{value:.22},uSizePx:{value:this.isMobileDevice?5:12},uFadeNear:{value:1.5},uFadeFar:{value:14},uColorNear:{value:new r.Q1f(7512516)},uColorFar:{value:new r.Q1f(676464)}},vertexShader:kt,fragmentShader:Tt}),c=i?n.position.distanceTo(i.target):n.position.length();return u.userData={baseSpread:o.clone(),baseMaxDistance:l,baseTargetDistance:Math.max(c,.1)},this.particlePoints=new r.ONl(s,u),this.particlePoints.frustumCulled=!1,this.particlePoints.renderOrder=2,e.add(this.particlePoints),this.particleMaterial=u,this.setWorldBasis(u.uniforms.uFlowDir.value),u.uniforms.uOrigin.value.copy(this.worldOrigin),this.update(n,i),!0}setTime(e){this.elapsedTime=e??this.elapsedTime,this.particleMaterial?.uniforms?.uTime&&(this.particleMaterial.uniforms.uTime.value=this.elapsedTime)}advanceTime(e){Number.isFinite(e)&&0!==e&&(this.elapsedTime+=e,this.particleMaterial?.uniforms?.uTime&&(this.particleMaterial.uniforms.uTime.value=this.elapsedTime))}setWorldBasis(e){if(!this.particleMaterial||!e)return;const t=xt.copy(e).normalize(),n=Math.abs(t.y)<.99?Mt.set(0,1,0):Mt.set(1,0,0),i=Pt.copy(t).cross(n);i.lengthSq()<1e-6&&(i.set(0,0,1),i.cross(t)),i.normalize();const a=Ct.copy(t).cross(i).normalize(),s=this.particleMaterial.uniforms;s.uFlowDir.value.copy(t),s.uLat1.value.copy(i),s.uLat2.value.copy(a)}update(e,t){const n=e||this.camera;if(!this.particleMaterial||!n)return;const i=this.particleMaterial.uniforms,{baseSpread:a,baseMaxDistance:s,baseTargetDistance:o}=this.particleMaterial.userData||{};a&&s&&(i.uSpread.value.copy(a),i.uMaxDistance.value=s)}dispose(e){const t=e||this.scene;this.particlePoints&&t&&t.remove(this.particlePoints),this.particlePoints?.geometry?.dispose(),this.particlePoints?.material?.dispose(),this.particlePoints=null,this.particleMaterial=null,this.scene=null,this.renderer=null,this.camera=null,this.controls=null}getMaterial(){return this.particleMaterial}}const kt="\nprecision highp float;\nprecision highp int;\n\nuniform float uTime;\nuniform vec3 uOrigin;\nuniform vec3 uFlowDir;\nuniform vec3 uLat1;\nuniform vec3 uLat2;\nuniform vec3 uSpread;\nuniform float uMaxDistance;\nuniform float uBaseSpeed;\nuniform float uJitterAmp;\nuniform float uSizePx;\nuniform float uFadeNear;\nuniform float uFadeFar;\n\nout float vFade;\nout float vColorMix;\n\nuint hashUint(uint n) {\n  n ^= (n << 13);\n  n ^= (n >> 17);\n  n ^= (n << 5);\n  return n * 0x27d4eb2du;\n}\n\nfloat hashFloat(uint n) {\n  return float(hashUint(n)) / 4294967296.0;\n}\n\nvec3 hashVec3(uint n) {\n  return vec3(\n    hashFloat(n),\n    hashFloat(n * 1664525u + 1013904223u),\n    hashFloat(n * 22695477u + 1u)\n  );\n}\n\nvoid main() {\n  uint id = uint(gl_VertexID);\n  vec3 randSeed = hashVec3(id) - 0.5;\n\n  vec3 flowDir = normalize(uFlowDir);\n  vec3 lateral = uLat1 * (randSeed.x * uSpread.x)\n    + uLat2 * (randSeed.y * uSpread.y);\n\n  float speedSeed = hashFloat(id * 747796405u);\n  float speed = uBaseSpeed * (0.7 + 0.6 * speedSeed);\n  float flowCycle = max(uSpread.z, 1e-3);\n  float flowParam = randSeed.z + (uTime * speed) / flowCycle;\n  float wrappedZ = fract(flowParam) - 0.5;\n  vec3 pos = uOrigin + lateral + flowDir * (wrappedZ * flowCycle);\n\n  float phase = hashFloat(id * 1664525u) * 6.28318530718;\n  float driftSeed = hashFloat(id * 22695477u);\n  float triangle = 1.0 - abs(fract((phase + uTime * (0.8 + 0.4 * driftSeed)) / 3.14159265) * 2.0 - 1.0);\n\n  vec3 jitter1 = normalize(uLat1);\n  vec3 jitter2 = normalize(uLat2);\n  pos += jitter1 * ((triangle - 0.5) * uJitterAmp);\n  pos += jitter2 * ((hashFloat(id * 1103515245u) - 0.5) * uJitterAmp * 0.6);\n\n  vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n  float dist = -mvPosition.z;\n  float forwardMask = step(0.0, dist);\n\n  vec4 clipPosition = projectionMatrix * mvPosition;\n  float invW = 1.0 / max(abs(clipPosition.w), 1e-3);\n  vec2 ndc = clipPosition.xy * invW;\n\n  float screenMask = 1.0 - smoothstep(0.96, 1.16, max(abs(ndc.x), abs(ndc.y)));\n  float rangeMask = 1.0 - smoothstep(uMaxDistance * 0.7, uMaxDistance, dist);\n\n  float fadeT = clamp((dist - uFadeNear) / max(uFadeFar - uFadeNear, 1e-3), 0.0, 1.0);\n  float fade = (1.0 - fadeT) * screenMask * rangeMask * forwardMask;\n  vFade = fade;\n  vColorMix = fade;\n\n  float sizeBase = uSizePx * projectionMatrix[1][1] / max(dist, 1e-3);\n  float attenuatedSize = sizeBase * fade;\n  gl_PointSize = max(attenuatedSize, 0.75) * step(0.001, fade);\n  gl_Position = clipPosition;\n}\n",Tt="\nprecision highp float;\n\nin float vFade;\nin float vColorMix;\n\nuniform vec3 uColorNear;\nuniform vec3 uColorFar;\n\nout vec4 fragColor;\n\nvoid main() {\n  vec2 coord = gl_PointCoord - vec2(0.5);\n  float falloff = exp(-8.0 * dot(coord, coord));\n  float alpha = vFade * falloff * 0.6;\n  if (alpha < 0.004) {\n    discard;\n  }\n  vec3 color = mix(uColorFar, uColorNear, vColorMix);\n  fragColor = vec4(color, alpha);\n}\n";class Rt{constructor(e){if(!e)throw new Error("WasmtimeBridge: wasmModule が未定義です");this.wasm=e,this.latestStatePtr=0,this.latestStateHeaderPtr=0,this.latestStateHeaderView=null,this.latestPositionsPtr=0,this.latestVelocitiesPtr=0,this.latestOrientationsPtr=0,this.latestBoidCount=0,this.cachedHeapBuffer=null,this.cachedPositionsPtr=0,this.cachedOrientationsPtr=0,this.cachedVelocitiesPtr=0,this.cachedSpeciesIdsPtr=0,this.cachedPositionsView=null,this.cachedOrientationsView=null,this.cachedVelocitiesView=null,this.cachedSpeciesIdsView=null,this.cachedPositionsCount=0,this.cachedOrientationsCount=0,this.cachedVelocitiesCount=0,this.cachedSpeciesIdsCount=0,this.cachedSpeciesIdsBuffer=null,this.cachedUnitDensityPtr=0,this.cachedUnitDensityCount=0,this.cachedUnitDensityView=null,this.cachedSpeciesEnvelopePtr=0,this.cachedSpeciesEnvelopeCount=0,this.cachedSpeciesEnvelopeView=null,this.cachedSpeciesClusterPtr=0,this.cachedSpeciesClusterCount=0,this.cachedSpeciesClusterView=null,this.cachedSpeciesSchoolClusterPtr=0,this.cachedSpeciesSchoolClusterCount=0,this.cachedSpeciesSchoolClusterView=null,this.stepSimulationHandle=Et(this.wasm,"stepSimulation","number",["number"]),this.buildHandle=Et(this.wasm,"build","void",[]),this.exportTreeStructureHandle=Et(this.wasm,"exportTreeStructure","object",[]),this.boidUnitMappingPtrHandle=Et(this.wasm,"boidUnitMappingPtr","number",[]),this.currentFirstBoidXHandle=Et(this.wasm,"currentFirstBoidX","number",[]),this.speciesIdsPtrHandle=Et(this.wasm,"speciesIdsPtr","number",[]),this.syncReadToWriteBuffersHandle=Et(this.wasm,"syncReadToWriteBuffers","void",[]),this.setSimulationTuningParamsHandle=Et(this.wasm,"setSimulationTuningParams","void",["object"]),this.unitSimpleDensityPtrHandle=Et(this.wasm,"unitSimpleDensityPtr","number",[]),this.unitSimpleDensityCountHandle=Et(this.wasm,"unitSimpleDensityCount","number",[]),this.speciesEnvelopesPtrHandle=Et(this.wasm,"speciesEnvelopesPtr","number",[]),this.speciesEnvelopesCountHandle=Et(this.wasm,"speciesEnvelopesCount","number",[]),this.speciesClustersPtrHandle=Et(this.wasm,"speciesClustersPtr","number",[]),this.speciesClustersCountHandle=Et(this.wasm,"speciesClustersCount","number",[]),this.speciesSchoolClustersPtrHandle=Et(this.wasm,"speciesSchoolClustersPtr","number",[]),this.speciesSchoolClustersCountHandle=Et(this.wasm,"speciesSchoolClustersCount","number",[]),this.configureGroundPlaneHandle=Et(this.wasm,"configureGroundPlane","void",["boolean","number","number","number","number"]),this.cachedUnitMappingsPtr=0,this.cachedUnitMappingsCount=0,this.cachedUnitMappingsView=null,this.cachedUnitMappingsBuffer=null,this.cachedDiagnostics={treeStructure:null,firstBoidX:0,unitMappings:null,unitDensities:null,speciesEnvelopes:null,speciesClusters:null,speciesSchoolClusters:null}}initializeFlock(e,t={}){if(!this.wasm)return 0;const n=Number.isFinite(t.spatialScale)?Number(t.spatialScale):1,i=Number.isFinite(t.posRange)?Number(t.posRange):4,a=Number.isFinite(t.velRange)?Number(t.velRange):.25,s=Array.isArray(e)?e:Array.from(e??[]),o=Ut(this.wasm,s);if(!o)return 0;try{if("function"!==typeof this.wasm.callInitBoids)throw new Error("WasmtimeBridge: callInitBoids が見つかりません");this.wasm.callInitBoids(o,n,i,a)}finally{"function"===typeof o.delete&&o.delete()}return t.groundPlane&&Bt(this.configureGroundPlaneHandle,t.groundPlane),At(this.buildHandle,"build")(),this.stepSimulation(0)}applySpeciesParams(e,t={}){if(!this.wasm||"function"!==typeof this.wasm.setGlobalSpeciesParamsFromJS)return!1;const n=Number.isFinite(t.spatialScale)?Number(t.spatialScale):1,i=Array.isArray(e)?e:Array.from(e??[]),a=Ut(this.wasm,i);if(!a)return!1;try{this.wasm.setGlobalSpeciesParamsFromJS(a,n)}finally{"function"===typeof a.delete&&a.delete()}return!0}applyTuningParams(e){if(!this.wasm)return;if(!e)return;const t=At(this.setSimulationTuningParamsHandle,"setSimulationTuningParams"),n=(e,t)=>{const n=Number(e);return Number.isFinite(n)?n:t};t({threatDecay:n(e.threatDecay,.5),maxEscapeWeight:n(e.maxEscapeWeight,1),baseEscapeStrength:n(e.baseEscapeStrength,3),fastAttractStrength:n(e.fastAttractStrength,1),schoolPullCoefficient:Math.max(0,n(e.schoolPullCoefficient,8e-4)),softBoundaryRadius:Math.max(0,n(e.softBoundaryRadius,200)),softBoundaryStart:Math.max(0,n(e.softBoundaryStart,120)),softBoundarySteer:Math.max(0,n(e.softBoundarySteer,.25))})}getDiagnostics(e={}){if(!this.wasm)return null;const t=e&&"object"===typeof e?e:{},n=Number.isFinite(t.boidCount)?Math.max(0,Math.floor(t.boidCount)):0,i=Boolean(t.treeStructure),a=Boolean(t.firstBoidX),s=Boolean(t.unitMappings),o=Boolean(t.unitDensities),r=Boolean(t.speciesEnvelopes),l=Boolean(t.speciesClusters),u=Boolean(t.speciesSchoolClusters),c=this.cachedDiagnostics;if(c.treeStructure=i&&"function"===typeof this.exportTreeStructureHandle?this.exportTreeStructureHandle():null,c.firstBoidX=a&&"function"===typeof this.currentFirstBoidXHandle?this.currentFirstBoidXHandle():0,s&&n>0&&"function"===typeof this.boidUnitMappingPtrHandle){const e=this.boidUnitMappingPtrHandle(),t=this.wasm.HEAP32.buffer;!e||null!==this.cachedUnitMappingsView&&this.cachedUnitMappingsPtr===e&&this.cachedUnitMappingsCount===n&&this.cachedUnitMappingsBuffer===t||(this.cachedUnitMappingsPtr=e,this.cachedUnitMappingsCount=n,this.cachedUnitMappingsBuffer=t,this.cachedUnitMappingsView=new Int32Array(t,e,2*n)),c.unitMappings=this.cachedUnitMappingsView}else c.unitMappings=null;return c.unitDensities=o?It(this):null,c.speciesEnvelopes=r?Dt(this):null,c.speciesClusters=l?Vt(this):null,c.speciesSchoolClusters=u?Ht(this):null,c}stepSimulation(e){const t=At(this.stepSimulationHandle,"stepSimulation"),{wasm:n}=this,i=Number.isFinite(e)?e:0,a=t(i);if(!a)return this.latestStatePtr=0,this.latestStateHeaderPtr=0,this.latestPositionsPtr=0,this.latestVelocitiesPtr=0,this.latestOrientationsPtr=0,this.latestStateHeaderView=null,this.latestBoidCount=0,0;const s=n.HEAPU8.buffer;return this.latestStateHeaderView&&this.latestStateHeaderPtr===a&&this.latestStateHeaderView.buffer===s||(this.latestStateHeaderView=new DataView(s,a,16),this.latestStateHeaderPtr=a),this.latestStatePtr=a,this.latestPositionsPtr=this.latestStateHeaderView.getUint32(0,!0),this.latestVelocitiesPtr=this.latestStateHeaderView.getUint32(4,!0),this.latestOrientationsPtr=this.latestStateHeaderView.getUint32(8,!0),this.latestBoidCount=this.latestStateHeaderView.getInt32(12,!0),this.latestBoidCount}getBuffers(e){if(!this.wasm)return{positions:new Float32Array(0),orientations:new Float32Array(0),velocities:new Float32Array(0),speciesIds:new Int32Array(0)};const t=this.wasm.HEAPF32.buffer,n=this.wasm.HEAP32.buffer;if(this.cachedHeapBuffer===t&&this.cachedSpeciesIdsBuffer===n||(this.cachedHeapBuffer=t,this.cachedSpeciesIdsBuffer=n,this.cachedPositionsPtr=0,this.cachedOrientationsPtr=0,this.cachedVelocitiesPtr=0,this.cachedSpeciesIdsPtr=0,this.cachedPositionsView=null,this.cachedOrientationsView=null,this.cachedVelocitiesView=null,this.cachedSpeciesIdsView=null,this.cachedPositionsCount=0,this.cachedOrientationsCount=0,this.cachedVelocitiesCount=0,this.cachedSpeciesIdsCount=0,this.cachedUnitDensityPtr=0,this.cachedUnitDensityCount=0,this.cachedUnitDensityView=null,this.cachedSpeciesEnvelopePtr=0,this.cachedSpeciesEnvelopeCount=0,this.cachedSpeciesEnvelopeView=null,this.cachedSpeciesClusterPtr=0,this.cachedSpeciesClusterCount=0,this.cachedSpeciesClusterView=null,this.cachedSpeciesSchoolClusterPtr=0,this.cachedSpeciesSchoolClusterCount=0,this.cachedSpeciesSchoolClusterView=null),!this.latestPositionsPtr||!this.latestOrientationsPtr||!this.latestVelocitiesPtr||e<=0)return{positions:this.cachedPositionsView??new Float32Array(0),orientations:this.cachedOrientationsView??new Float32Array(0),velocities:this.cachedVelocitiesView??new Float32Array(0),speciesIds:this.cachedSpeciesIdsView??new Int32Array(0)};null!==this.cachedPositionsView&&this.cachedPositionsCount===e&&this.cachedPositionsPtr===this.latestPositionsPtr||(this.cachedPositionsPtr=this.latestPositionsPtr,this.cachedPositionsView=new Float32Array(t,this.cachedPositionsPtr,3*e),this.cachedPositionsCount=e),null!==this.cachedOrientationsView&&this.cachedOrientationsCount===e&&this.cachedOrientationsPtr===this.latestOrientationsPtr||(this.cachedOrientationsPtr=this.latestOrientationsPtr,this.cachedOrientationsView=new Float32Array(t,this.cachedOrientationsPtr,4*e),this.cachedOrientationsCount=e),null!==this.cachedVelocitiesView&&this.cachedVelocitiesCount===e&&this.cachedVelocitiesPtr===this.latestVelocitiesPtr||(this.cachedVelocitiesPtr=this.latestVelocitiesPtr,this.cachedVelocitiesView=new Float32Array(t,this.cachedVelocitiesPtr,3*e),this.cachedVelocitiesCount=e);const i="function"===typeof this.speciesIdsPtrHandle?this.speciesIdsPtrHandle():0;return!i||null!==this.cachedSpeciesIdsView&&this.cachedSpeciesIdsPtr===i&&this.cachedSpeciesIdsCount===e&&this.cachedSpeciesIdsBuffer===n||(this.cachedSpeciesIdsPtr=i,this.cachedSpeciesIdsCount=e,this.cachedSpeciesIdsBuffer=n,this.cachedSpeciesIdsView=new Int32Array(n,i,e)),{positions:this.cachedPositionsView,orientations:this.cachedOrientationsView,velocities:this.cachedVelocitiesView,speciesIds:this.cachedSpeciesIdsView}}captureState(){if(!this.wasm)return null;const e=this.stepSimulation(0);if(!e||e<=0)return{count:0};const{positions:t,velocities:n,orientations:i,speciesIds:a}=this.getBuffers(e);return{count:e,positions:t?new Float32Array(t):null,velocities:n?new Float32Array(n):null,orientations:i?new Float32Array(i):null,speciesIds:a?new Int32Array(a):null}}restoreState(e,t,n){if(!e||e.count<=0)return;const i=this.stepSimulation(0);if(!i||i<=0)return;const{positions:a,velocities:s,orientations:o}=this.getBuffers(i);if(!a||!s||!o)return;const r=e.positions,l=e.velocities,u=e.orientations,c=Ft(t),h=Ft(n),d=new Map(c.map((e=>[e.name,e])));let p=0;for(const f of h){if(!f.count)continue;const t=d.get(f.name);if(!t||!t.count)continue;const n=Math.min(t.count,f.count);for(let c=0;c<n;c+=1){const n=t.start+c,h=f.start+c;if(n>=e.count||h>=i)break;if(r){const e=3*n,t=3*h;a[t]=r[e],a[t+1]=r[e+1],a[t+2]=r[e+2]}if(l){const e=3*n,t=3*h;s[t]=l[e],s[t+1]=l[e+1],s[t+2]=l[e+2]}if(u){const e=4*n,t=4*h;o[t]=u[e],o[t+1]=u[e+1],o[t+2]=u[e+2],o[t+3]=u[e+3]}p+=1}}p>0&&"function"===typeof this.syncReadToWriteBuffersHandle&&this.syncReadToWriteBuffersHandle()}}function Ft(e=[]){const t=[];let n=0;for(const i of e){if(!i)continue;const e=Math.max(0,Number(i.count)||0);t.push({name:i.species||"",start:n,count:e}),n+=e}return t}function Et(e,t,n,i){if(!e)return null;if("function"===typeof e[t])return e[t].bind(e);if("function"===typeof e.cwrap)try{return e.cwrap(t,n,i)}catch(a){console.warn(`WasmtimeBridge: ${t} のラップに失敗`,a)}return null}function At(e,t){if("function"!==typeof e)throw new Error(`WasmtimeBridge: ${t} ハンドルが初期化されていません`);return e}function Bt(e,t){if(!t)return;const n=At(e,"configureGroundPlane"),i=(e,t)=>{const n=Number(e);return Number.isFinite(n)?n:t},a=!1!==t.enabled,s=i(t.height,0),o=Math.max(0,i(t.blendDistance,2)),r=Math.max(0,i(t.stiffness,18)),l=Math.max(0,i(t.damping,8));n(a,s,o,r,l)}function Ut(e,t){if(!e||!Array.isArray(t))return null;const n=new e.VectorSpeciesParams;return t.forEach(((e,t)=>{if(!e)return;const i=(e,t=0)=>{const n=Number(e);return Number.isFinite(n)?n:t};n.push_back({species:"string"===typeof e.species?e.species:`Species ${t+1}`,count:Math.max(0,Math.floor(i(e.count,0))),speciesId:Math.max(0,Math.floor(i(e.speciesId,t))),cohesion:i(e.cohesion,0),separation:i(e.separation,0),alignment:i(e.alignment,0),maxSpeed:i(e.maxSpeed,1),minSpeed:i(e.minSpeed,0),maxTurnAngle:i(e.maxTurnAngle,0),separationRange:i(e.separationRange,0),alignmentRange:i(e.alignmentRange,0),cohesionRange:i(e.cohesionRange,0),maxNeighbors:Math.max(0,Math.floor(i(e.maxNeighbors,0))),lambda:i(e.lambda,0),tau:i(e.tau,0),horizontalTorque:i(e.horizontalTorque,0),velocityEpsilon:i(e.velocityEpsilon,1e-4),torqueStrength:i(e.torqueStrength,0),bodyHeadLength:i(e.bodyHeadLength,-.15),bodyTailLength:i(e.bodyTailLength,.33),bodyRadius:i(e.bodyRadius,.035),predatorAlertRadius:i(e.predatorAlertRadius,1),isPredator:Boolean(e.isPredator),densityReturnStrength:i(e.densityReturnStrength??e.centerAttractStrength,0)})})),n}function It(e){if(!e?.wasm)return null;if("function"!==typeof e.unitSimpleDensityPtrHandle||"function"!==typeof e.unitSimpleDensityCountHandle)return null;const t=e.unitSimpleDensityCountHandle(),n=e.unitSimpleDensityPtrHandle();if(!n||!t||t<=0)return e.cachedUnitDensityPtr=0,e.cachedUnitDensityCount=0,e.cachedUnitDensityView=null,null;const i=e.wasm.HEAPF32.buffer;return null!==e.cachedUnitDensityView&&e.cachedUnitDensityPtr===n&&e.cachedUnitDensityCount===t&&e.cachedHeapBuffer===i||(e.cachedUnitDensityPtr=n,e.cachedUnitDensityCount=t,e.cachedUnitDensityView=new Float32Array(i,n,t)),e.cachedUnitDensityView}function Dt(e){if(!e?.wasm)return null;if("function"!==typeof e.speciesEnvelopesPtrHandle||"function"!==typeof e.speciesEnvelopesCountHandle)return null;const t=e.speciesEnvelopesCountHandle(),n=e.speciesEnvelopesPtrHandle();if(!n||!t||t<=0)return e.cachedSpeciesEnvelopePtr=0,e.cachedSpeciesEnvelopeCount=0,e.cachedSpeciesEnvelopeView=null,null;const i=e.wasm.HEAPF32.buffer;return null!==e.cachedSpeciesEnvelopeView&&e.cachedSpeciesEnvelopePtr===n&&e.cachedSpeciesEnvelopeCount===t&&e.cachedHeapBuffer===i||(e.cachedSpeciesEnvelopePtr=n,e.cachedSpeciesEnvelopeCount=t,e.cachedSpeciesEnvelopeView=new Float32Array(i,n,t),e.cachedHeapBuffer=i),{buffer:e.cachedSpeciesEnvelopeView,count:Math.floor(t/5)}}function Vt(e){if(!e?.wasm)return null;if("function"!==typeof e.speciesClustersPtrHandle||"function"!==typeof e.speciesClustersCountHandle)return null;const t=e.speciesClustersCountHandle(),n=e.speciesClustersPtrHandle();if(!n||!t||t<=0)return e.cachedSpeciesClusterPtr=0,e.cachedSpeciesClusterCount=0,e.cachedSpeciesClusterView=null,null;const i=e.wasm.HEAPF32.buffer;return null!==e.cachedSpeciesClusterView&&e.cachedSpeciesClusterPtr===n&&e.cachedSpeciesClusterCount===t&&e.cachedHeapBuffer===i||(e.cachedSpeciesClusterPtr=n,e.cachedSpeciesClusterCount=t,e.cachedSpeciesClusterView=new Float32Array(i,n,t),e.cachedHeapBuffer=i),{buffer:e.cachedSpeciesClusterView,count:Math.floor(t/6)}}function Ht(e){if(!e?.wasm)return null;if("function"!==typeof e.speciesSchoolClustersPtrHandle||"function"!==typeof e.speciesSchoolClustersCountHandle)return null;const t=e.speciesSchoolClustersCountHandle(),n=e.speciesSchoolClustersPtrHandle();if(!n||!t||t<=0)return e.cachedSpeciesSchoolClusterPtr=0,e.cachedSpeciesSchoolClusterCount=0,e.cachedSpeciesSchoolClusterView=null,null;const i=e.wasm.HEAPF32.buffer;return null!==e.cachedSpeciesSchoolClusterView&&e.cachedSpeciesSchoolClusterPtr===n&&e.cachedSpeciesSchoolClusterCount===t&&e.cachedHeapBuffer===i||(e.cachedSpeciesSchoolClusterPtr=n,e.cachedSpeciesSchoolClusterCount=t,e.cachedSpeciesSchoolClusterView=new Float32Array(i,n,t),e.cachedHeapBuffer=i),{buffer:e.cachedSpeciesSchoolClusterView,count:Math.floor(t/6)}}const Wt="boids_settings",Nt=2,_t="boids_settings_schema_major",qt={species:"Species",count:1e4,cohesion:12.5,cohesionRange:5,separation:2.15,separationRange:.4,alignment:8,alignmentRange:1,maxSpeed:.35,minSpeed:0,maxTurnAngle:.75,maxNeighbors:4,horizontalTorque:.03,torqueStrength:1,lambda:.8,tau:.8,velocityEpsilon:1e-4,predatorAlertRadius:1,isPredator:!1,speciesId:0,densityReturnStrength:10};function Ot(e=[],t={}){const n=Kt(e,e),i={...t},o=(0,s.Kh)([]),r=(0,s.Kh)({});if(g(n),v(i),f()){const e=h();p(),g(n),v(i),d(o,e),m()}else u()||(g(n),v(i));const l=(0,a.EW)((()=>zt(o)));function u(){if("undefined"===typeof localStorage)return!1;try{const e=localStorage.getItem(Wt);if(!e)return!1;const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0)return g(t),!0;if(t&&"object"===typeof t)return Array.isArray(t.species)&&t.species.length>0&&g(t.species),t.system&&"object"===typeof t.system&&v(t.system),!0}catch(e){console.warn("Failed to load settings from localStorage:",e)}return!1}function c(){if("undefined"===typeof localStorage)return null;try{const e=localStorage.getItem(Wt);if(!e)return null;const t=JSON.parse(e);if(Array.isArray(t))return{species:t,system:null};if(t&&"object"===typeof t)return{species:Array.isArray(t.species)?t.species:null,system:t.system&&"object"===typeof t.system?t.system:null}}catch(e){console.warn("Failed to parse settings snapshot from localStorage:",e)}return null}function h(){const e=c(),t=e?.species;if(!Array.isArray(t))return new Map;const n=new Map;return t.forEach((e=>{if(!e||"object"!==typeof e)return;const t=Number(e.count);if(!Number.isFinite(t))return;const i=Math.max(0,Math.floor(t)),a=Boolean(e.isPredator),s="string"===typeof e.species?e.species:"",o=Number(e.speciesId);Number.isFinite(o)&&n.set(`id:${o}|pred:${a}`,i),s&&n.set(`name:${s}|pred:${a}`,i)})),n}function d(e,t){Array.isArray(e)&&t instanceof Map&&e.forEach((e=>{if(!e||"object"!==typeof e)return;const n=Boolean(e.isPredator),i=Number(e.speciesId),a="string"===typeof e.species?e.species:"";let s;Number.isFinite(i)&&(s=t.get(`id:${i}|pred:${n}`)),!Number.isFinite(s)&&a&&(s=t.get(`name:${a}|pred:${n}`)),Number.isFinite(s)&&(e.count=Math.max(0,Math.floor(s)))}))}function p(){if("undefined"===typeof localStorage)return!1;try{return localStorage.removeItem(Wt),!0}catch(e){return console.warn("Failed to clear settings in localStorage:",e),!1}}function f(){if("undefined"===typeof localStorage)return!1;try{const e=localStorage.getItem(_t);if(!e)return!0;const t=Number(e);return!Number.isFinite(t)||t!==Nt}catch(e){return console.warn("Failed to read settings schema version from localStorage:",e),!0}}function m(){if("undefined"===typeof localStorage)return!1;try{const e={species:o.map((e=>({...(0,s.ux)(e)}))),system:{...(0,s.ux)(r)}};return localStorage.setItem(Wt,JSON.stringify(e)),localStorage.setItem(_t,String(Nt)),!0}catch(e){return console.warn("Failed to save settings to localStorage:",e),!1}}function g(e){const t=Kt(e,n);return o.splice(0,o.length,...t),t}function v(e={}){const t={...i,...e||{}};return Object.keys(r).forEach((e=>{e in t||delete r[e]})),Object.entries(t).forEach((([e,t])=>{r[e]=t})),r}function b(){g(n),v(i),m()}function S(e){const t=o.length>0?o:n,i=t.find((e=>e&&!e.isPredator))||n.find((e=>e&&!e.isPredator))||qt,a=e?jt(e,i):Gt(i);return a.isPredator=!1,a.count=0,a.species=Xt(a.species,new Set(o.map((e=>e.species)))),o.push(a),a}function y(e){if(e<0||e>=o.length)return null;const t=o.splice(e,1);return t.length?t[0]:null}return{settings:o,systemSettings:r,totalBoids:l,loadFromStorage:u,saveToStorage:m,replaceSettings:g,assignSystemSettings:v,resetToDefaults:b,addSpecies:S,removeSpecies:y}}function zt(e){return e.reduce(((e,t)=>e+Math.max(0,Number(t?.count)||0)),0)}function Kt(e=[],t=[]){if(!Array.isArray(e))return[];const n=[],i=new Set;return e.forEach(((e,a)=>{const s=t[a]||t[0]||qt,o=jt(e,s);o.species=Xt(o.species,i),n.push(o)})),n}function jt(e={},t=qt){const n={...qt,...t},i={...n,...e},a=(e,t=0)=>{const n=Number(e);return Number.isFinite(n)?n:t},s={...i};s.count=Math.max(0,Math.floor(a(i.count,n.count??0))),s.maxNeighbors=Math.max(0,Math.floor(a(i.maxNeighbors,n.maxNeighbors??0))),s.speciesId=Math.max(0,Math.floor(a(i.speciesId,n.speciesId??0))),s.cohesion=a(i.cohesion,n.cohesion??0),s.cohesionRange=Math.max(0,a(i.cohesionRange,n.cohesionRange??0)),s.separation=a(i.separation,n.separation??0),s.separationRange=Math.max(0,a(i.separationRange,n.separationRange??0)),s.alignment=a(i.alignment,n.alignment??0),s.alignmentRange=Math.max(0,a(i.alignmentRange,n.alignmentRange??0)),s.maxSpeed=Math.max(0,a(i.maxSpeed,n.maxSpeed??0)),s.minSpeed=Math.max(0,a(i.minSpeed,n.minSpeed??0)),s.maxTurnAngle=Math.max(0,a(i.maxTurnAngle,n.maxTurnAngle??0)),s.horizontalTorque=a(i.horizontalTorque,n.horizontalTorque??0),s.torqueStrength=a(i.torqueStrength,n.torqueStrength??0),s.lambda=a(i.lambda,n.lambda??0),s.tau=a(i.tau,n.tau??0),s.velocityEpsilon=Math.max(0,a(i.velocityEpsilon,n.velocityEpsilon??1e-4)),s.predatorAlertRadius=Math.max(0,a(i.predatorAlertRadius,n.predatorAlertRadius??1));const o=n.densityReturnStrength??n.centerAttractStrength??0,r=i.densityReturnStrength??i.centerAttractStrength??o;s.densityReturnStrength=Math.max(0,a(r,o));const l="string"===typeof i.species?i.species.trim():"";return s.species=l||n.species||qt.species,s.isPredator=Boolean(i.isPredator),s}function Xt(e,t,n="Species"){const i="string"===typeof e&&e.trim()?e.trim():n;let a=i,s=2;while(t.has(a))a=`${i} ${s}`,s+=1;return t.add(a),a}function Gt(e){return JSON.parse(JSON.stringify(e))}const Jt={id:"app"},Yt={class:"ui-overlay"},Qt={class:"ui-panel"},$t={class:"settings tuning-settings"},Zt={class:"species-section",open:!1},en={class:"species-content"},tn={class:"setting-row"},nn=["title"],an=["title"],sn=["title"],on={class:"setting-row"},rn=["title"],ln=["title"],un=["title"],cn={class:"setting-row"},hn=["title"],dn=["title"],pn=["title"],fn={class:"setting-row"},mn=["title"],gn=["title"],vn=["title"],bn={class:"setting-row"},Sn=["title"],yn=["title"],wn=["title"],xn={class:"settings tuning-settings debug-settings"},Mn={class:"species-section",open:!1},Pn={class:"species-content debug-content"},Cn=["title"],Ln=["title"],kn=["title"],Tn=["title"],Rn=["title"],Fn=["title"],En=["title"],An=["title"],Bn=["title"],Un=["title"],In=["title"],Dn=["title"],Vn=["title"],Hn=["title"],Wn={class:"info"},Nn={key:0,class:"debug-hud"},_n=4,qn=400,On=3,zn=1e6,Kn=256,jn={__name:"App",setup(e){const t=(0,a.WQ)("wasmModule");t||console.error("wasmModule not provided");const n=t?new Rt(t):null;function c(){const e={isMobile:!1,hasIntegratedGpu:!1};if("undefined"===typeof navigator)return e;if(e.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e.isMobile)return e;try{const t=document.createElement("canvas"),n=t.getContext("webgl2")||t.getContext("webgl");if(n){const t=n.getExtension("WEBGL_debug_renderer_info");if(t){const i=n.getParameter(t.UNMASKED_RENDERER_WEBGL);i&&/intel/i.test(i)&&(console.log("Detected Intel integrated GPU:",i),e.hasIntegratedGpu=!0)}}}catch(t){console.warn("Failed to inspect GPU characteristics:",t)}return e}const h=c(),d=h.isMobile||h.hasIntegratedGpu,p=d?1:1.5,f=d?5e3:1e4,m=[{species:"Boids",count:f,cohesion:3.66,cohesionRange:5,separation:2.15,separationRange:.4,alignment:8,alignmentRange:1,maxSpeed:.35,maxTurnAngle:.75,maxNeighbors:4,horizontalTorque:.03,torqueStrength:1,lambda:.102,tau:.5,predatorAlertRadius:1,densityReturnStrength:0,isPredator:!1},{species:"Predator",count:3,cohesion:0,cohesionRange:5,separation:0,separationRange:.1,alignment:0,alignmentRange:1,predatorAlertRadius:0,densityReturnStrength:0,maxSpeed:2,minSpeed:1.5,maxTurnAngle:.4,maxNeighbors:0,lambda:.05,tau:1,horizontalTorque:.01,torqueStrength:2.5,isPredator:!0}],g={threatDecay:1,maxEscapeWeight:3.5,baseEscapeStrength:5,fastAttractStrength:2,schoolPullCoefficient:3e-5},v={threatDecay:"脅威（捕食者などの危険度）が時間でどれだけ早く消えるか。大きいほど早く落ち着きます。",maxEscapeWeight:"逃避行動をどれだけ優先するか（0〜1）。1 に近いほど、危険時はほぼ逃げが優先されます。",baseEscapeStrength:"逃避の舵取り強度（目標速度へ寄せる強さ）。大きいほど素早く逃げ方向へ乗ります。",fastAttractStrength:"近くの仲間が少ないときに、群れへ戻す補助の凝集強度（0で無効）。",schoolPullCoefficient:"大きな群れ（大クラスタ）へ引き寄せる強さ。大きいほど大群にまとまりやすいです。"},b={enableFogPipeline:"見た目（フォグ/SSAO/ブルーム）を有効にします。重い場合は OFF。",enableShadows:"影描画を有効にします。見た目は良くなりますが負荷が上がりやすいです。",enableTailAnimation:"尾びれのアニメーションを有効にします。負荷が気になるなら OFF。",showSpeciesEnvelopes:"各種族の分布（中心/半径）を可視化します。",showSpeciesClusters:"クラスタ検出結果を可視化します。",showSpeciesSchoolClusters:"大クラスタ（大きな群れ）の結果を可視化します。",showWorldAxisGrid:"ワールド座標のグリッド/軸（目盛り）を表示します。空間スケール確認用。"},S=Ot(m,g),{settings:y,systemSettings:w,assignSystemSettings:x,totalBoids:M,replaceSettings:P,resetToDefaults:C,addSpecies:L,removeSpecies:k,saveToStorage:T}=S,R=(0,s.KR)(!1);function F(e={}){const t={};for(const[n,i]of Object.entries(g)){const a=Number(e[n]);t[n]=Number.isFinite(a)?a:i}return t}function E(e){const t=F(e);return x(t),t}function A(){n&&n.applyTuningParams(F(w))}function B(e){return e.map((e=>JSON.parse(JSON.stringify((0,s.ux)(e)))))}let U=M.value,I=Qn(y),D=B(y),V=null,H=null;function W(e){if(!Array.isArray(e)||0===e.length)return null;const t=P(e);return T(),D=B(y),t}function N(e){const t=L(e);return T(),t}function _(e){if(y.length<=1)return null;const t=k(e);return t&&T(),t}const q=(0,s.KR)(null),O=(0,s.KR)(null);let z,K,j,X,G=null,J=null,Y=null,Q=null,$=null;const Z={active:!0,userInteracted:!1,controlsHooked:!1,startedAtMs:0,maxDurationMs:6e3,smoothingSpeed:4},ee=new r.Pq0(0,0,0),te=new r.Pq0(0,0,0),ne=(0,s.KR)(!1),ie={active:!1,previousMuted:!1,previousVolume:.1};function ae(){if("undefined"===typeof document)return!1;const e=Boolean(document.hidden),t="function"===typeof document.hasFocus&&!document.hasFocus();return e||t}function se(){const e=O.value;if(!e)return;const t=ae();if(t){if(e.muted||!(e.volume>0))return;return ie.active||(ie.previousMuted=e.muted,ie.previousVolume=e.volume,ie.active=!0),void(e.muted=!0)}ie.active&&(e.muted=ie.previousMuted,e.volume=ie.previousVolume,ie.active=!1)}const oe=(0,s.KR)(""),re=(0,s.KR)(!0),le=(0,s.KR)(!1),ue=(0,s.KR)(!1),ce=(0,s.KR)(!1),he=(0,s.KR)(!1),de=(0,s.KR)(!1),pe=(0,s.KR)(!1),fe=(0,s.KR)(!1);(0,s.KR)(1);let me=[],ge=[],ve=[],be=null,Se=null,ye=null,we=null,xe=null,Me=null,Pe=0,Ce=null,Le=null,ke=null,Te=0;const Re=new r.B69,Fe=new r.Q1f,Ee=new r.B69,Ae=new r.Q1f,Be=(0,s.Kh)({enableFogPipeline:!h.isMobile,enableShadows:!0,enableTailAnimation:!0});function Ue(){if(!z)return;const e=fe.value;e?(Se||(Se=new r.fTw(200,200,Et(Ft.AMBIENT_LIGHT),Et(Ft.BOTTOM_LIGHT))),ye||(ye=new r.IzY(12)),Se.parent||z.add(Se),ye.parent||z.add(ye)):(Se?.parent&&z.remove(Se),ye?.parent&&z.remove(ye))}let Ie=null,De=null,Ve=0,He=null,We=null,Ne=!1,_e=null,qe=0,Oe=!1,ze=!1,Ke=!1,je=null;function Xe(){if(!j||"undefined"===typeof window)return;const e=window.devicePixelRatio||1;j.setPixelRatio(Math.min(e,p))}function Ge(e){e&&(e.style.position="fixed",e.style.top="0px",e.style.right="0px",e.style.left="auto",e.style.bottom="auto",e.style.zIndex="9999",e.style.width="270px",e.style.height="48px",e.style.pointerEvents="auto",e.style.transform="none")}function Je(e){const t=e?.buffer,n=t?.length??0,i=Math.floor(n/5);if(!t||i<=0)return void(oe.value="");const a=[];for(let s=0;s<i;s+=1){const e=5*s,n=t[e],i=t[e+1],o=t[e+2],r=t[e+3],l=t[e+4];r>1e-4&&l>0&&a.push(`env[${s}] center=(${n.toFixed(2)}, ${i.toFixed(2)}, ${o.toFixed(2)}) radius=${r.toFixed(2)} count=${Math.floor(l)}`)}oe.value=a.join("\n")}function Ye(e){"Space"===e.code&&(ne.value=!ne.value)}function tt(){const e=Be.enableTailAnimation?1:0;Pt?.uniforms?.uTailEnable&&(Pt.uniforms.uTailEnable.value=e)}function nt(){const e=Be.enableShadows;j&&(j.shadowMap.enabled=e),Q&&(Q.castShadow=e,Q.shadow&&(Q.shadow.autoUpdate=e,Q.shadow.needsUpdate=!0)),$&&($.receiveShadow=e),kt&&(kt.castShadow=e,kt.receiveShadow=e),Tt&&(Tt.castShadow=e,Tt.receiveShadow=e);const t="function"===typeof Ct.getPredatorMeshes?Ct.getPredatorMeshes():[];for(const n of t)n&&n.traverse?.((t=>{t.isMesh&&(t.castShadow=e,t.receiveShadow=e)}))}function it(){if(!j||!z||!K)return void(!Be.enableFogPipeline&&G&&(G.dispose(),G=null));const e=j.capabilities?.isWebGL2,t=Boolean(Be.enableFogPipeline&&e);if(t){G||(G=new ot(At));const e=new r.I9Y;j.getSize(e),G.init(j,z,K,e.x,e.y)}else G&&(G.dispose(),G=null)}function at(){_e&&(clearTimeout(_e),_e=null)}function st(){const e=j?.domElement??We;e&&e.parentElement&&e.parentElement.removeChild(e)}function rt(){G&&(G.dispose(),G=null),Y&&(Y.dispose(),Y=null),j&&(We=j.domElement,j.dispose?.()),j=null,De=null}function lt(e,t){const n={alpha:!1,antialias:!0,depth:!0,stencil:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1};if(t){const t=e.getContext("webgl2",n);if(t)return t}return e.getContext("webgl",n)||e.getContext("experimental-webgl",n)}function ut(e){e?.preventDefault?.(),Ne=!0,console.warn("WebGL context lost. Scheduling recovery..."),je&&"function"===typeof cancelAnimationFrame&&(cancelAnimationFrame(je),je=null),j?.capabilities?.isWebGL2&&(Ke=!0,We=null),rt(),ht("contextlost")}function ct(){Ne=!1,console.warn("WebGL context restored. Reinitializing renderer..."),ht("contextrestored")}function ht(e){if(_e)return;const t=Math.min(8e3,500*Math.pow(2,qe));qe=Math.min(qe+1,6),_e=setTimeout((()=>{_e=null;try{const t=dt();if(!t)return void ht("retry:"+e);Ie&&"function"===typeof Ie.patchThreeRenderer&&Ie.patchThreeRenderer(j),Oe&&ei(U||M.value||0),je||pi(),qe=0,at()}catch(t){console.warn("WebGL recovery failed:",t),ht("error:"+e)}}),t)}function dt(){const e=window.innerWidth,t=window.innerHeight;st(),rt(),z=null,K=null,X=null,z=new r.Z58,z.background=new r.Q1f(Ft.DEEP_BLUE),Bt(),K=new r.ubm(75,e/t,.1,1e3),K.position.set(3,-5,3),K.lookAt(0,0,0);const n=We||document.createElement("canvas"),i=!Ke,a=lt(n,i);if(!a)return console.warn("Failed to create WebGL context (webgl2/webgl)."),We=n,ht("init"),!1;const s="undefined"!==typeof WebGL2RenderingContext&&a instanceof WebGL2RenderingContext;i&&!s&&(Ke=!0),j=new l.JeP({canvas:n,context:a,antialias:!0,depth:!0}),j.outputColorSpace=r.er$,j.toneMapping=r.nNL,j.toneMappingExposure=1.5,Xe(),j.setSize(e,t),j.shadowMap.enabled=Be.enableShadows,j.shadowMap.type=r.QP0,De=j.getContext(),We=j.domElement,We.addEventListener("webglcontextlost",ut,!1),We.addEventListener("webglcontextrestored",ct,!1),q.value.appendChild(j.domElement),K.aspect=e/t,K.updateProjectionMatrix(),X=new u.N(K,j.domElement),X.enableDamping=!0,X.dampingFactor=.1,Z.active=!0,Z.userInteracted=!1,Z.startedAtMs=performance.now(),Z.controlsHooked||(Z.controlsHooked=!0,X.addEventListener("start",(()=>{Z.userInteracted=!0})));const o=new r.bdM(300,300),c=Ut();c.depthTest=!0,$=new r.eaF(o,c),$.rotation.x=-Math.PI/2,$.position.y=-10,$.receiveShadow=!0,z.add($);const h=new r.$p8(Et(Ft.AMBIENT_LIGHT),.8);return z.add(h),Q=new r.ZyN(Et(Ft.SUN_LIGHT),12),Q.position.set(300,500,200),Q.castShadow=!0,Q.shadow.camera.left=-100,Q.shadow.camera.right=100,Q.shadow.camera.top=100,Q.shadow.camera.bottom=-100,Q.shadow.camera.near=1,Q.shadow.camera.far=1200,Q.shadow.camera.updateProjectionMatrix(),Q.shadow.mapSize.width=768,Q.shadow.mapSize.height=768,Q.shadow.bias=-.01,Q.shadow.normalBias=.01,z.add(Q),Y=new pt({color:new r.Q1f(Ft.SKY_HIGHLIGHT)}),Y.init(),Vt(),it(),nt(),tt(),Ue(),ze||(ze=!0,window.addEventListener("resize",vt)),Ne=!1,!0}function ft(e,t){const n=e?.buffer,i=n?.length??0,a=Math.floor(i/6);if(!n||a<=0)return!1;let s=0,o=0,r=0,l=0;for(let u=0;u<a;u+=1){const e=6*u,t=n[e+1],i=n[e+2],a=n[e+3],c=Math.max(0,n[e+5]||0);if(!(c>0))continue;const h=Math.min(c,5e4);s+=t*h,o+=i*h,r+=a*h,l+=h}return l>0&&(t.set(s/l,o/l,r/l),!0)}function mt(){if(!Z.active||Z.userInteracted)return!1;if(!K||!X)return!1;const e=performance.now()-Z.startedAtMs;return e>=0&&e<=Z.maxDurationMs}function gt(e,t){if(!mt())return;const n=Math.min(Math.max(t,0),.1),i=1-Math.exp(-Z.smoothingSpeed*n),a=ft(e,te);a&&ee.copy(te),X.target.lerp(ee,i)}function vt(){const e=window.innerWidth,t=window.innerHeight;K.aspect=e/t,K.updateProjectionMatrix(),Xe(),j.setSize(e,t),G?.resize(e,t)}function bt(e){const t=new Uint8Array(4*e);for(let i=0;i<e;i++){const n=i/e*Math.PI*2,a=Math.sin(n),s=Math.cos(n);t[4*i]=Math.round(255*(.5*a+.5)),t[4*i+1]=Math.round(255*(.5*s+.5)),t[4*i+2]=0,t[4*i+3]=255}const n=new r.GYF(t,e,1,r.GWd);return n.needsUpdate=!0,n.wrapS=r.GJx,n.wrapT=r.ghU,n.magFilter=r.k6q,n.minFilter=r.k6q,n.generateMipmaps=!1,n.flipY=!1,n}const St=[0,0,0,1],yt=bt(Kn),wt=h.isMobile?{nearSq:1.5,midSq:9}:{nearSq:4,midSq:25},xt=wt.nearSq,Mt=wt.midSq,Pt={uniforms:{uTailTime:{value:0},uTailAmplitude:{value:.14},uTailFrequency:{value:10},uTailPhaseStride:{value:5},uTailTurnStrength:{value:.1},uTailSpeedScale:{value:1},uTailRight:{value:new r.Pq0(1,0,0)},uTailForward:{value:new r.Pq0(0,0,1)},uTailUp:{value:new r.Pq0(0,1,0)},uTailEnable:{value:1},uSinLut:{value:yt},uLutSize:{value:Kn}}},Ct=new et({tailAnimation:Pt,tripleBufferSize:On,hiddenPosition:zn,identityQuaternion:St,lodNearDistanceSq:xt,lodMidDistanceSq:Mt});let kt=null,Tt=null;const Ft={SKY_HIGHLIGHT:"#4fbaff",SKY_BLUE:"#15a1ff",DEEP_BLUE:"#05337a",SEAFLOOR:"#777465",AMBIENT_LIGHT:"#59a5eb",SUN_LIGHT:"#5389b7",SIDE_LIGHT1:"#6ba3d0",SIDE_LIGHT2:"#2d5f7a",BOTTOM_LIGHT:"#0f2635"},Et=e=>parseInt(e.replace("#","0x"),16),At={color:new r.Q1f(Ft.DEEP_BLUE),distanceStart:2,distanceEnd:20,distanceExponent:.4,distanceControlPoint1:new r.I9Y(.15,.2),distanceControlPoint2:new r.I9Y(.88,.9),surfaceLevel:100,heightFalloff:.015,heightExponent:1,maxOpacity:.4};function Bt(){if(!z)return null;const e=document.createElement("canvas"),t=e.getContext("2d");e.width=512,e.height=512;const n=t.createLinearGradient(0,0,0,e.height);n.addColorStop(0,Ft.SKY_HIGHLIGHT),n.addColorStop(.2,Ft.SKY_BLUE),n.addColorStop(.6,Ft.DEEP_BLUE),n.addColorStop(1,Ft.DEEP_BLUE),t.fillStyle=n,t.fillRect(0,0,e.width,e.height);const i=new r.GOR(e);i.colorSpace=r.er$,i.generateMipmaps=!1,i.minFilter=r.k6q,i.magFilter=r.k6q;const a=new r.Gu$(300,32,32),s=new r.V9B({map:i,side:r.hsX,fog:!1}),o=new r.eaF(a,s);return z.add(o),o}function Ut(){const e=new r.Tap,t=e.load("./models/groundAlfa.png");t.minFilter=r.k6q,t.magFilter=r.k6q,t.wrapS=r.ghU,t.wrapT=r.ghU;const n=new r._4j({color:Et(Ft.SEAFLOOR),transparent:!0,alphaMap:t,depthWrite:!0});return n.roughness=.85,n.metalness=0,n}function It(e){Ct.setTailUniformTime(e),J?.setTime(e)}let Dt=0;function Vt(){z&&j&&(J||(J=new Lt(d)),J.init(z,j,K,X))}function Ht(){J?.update(K,X)}function Wt(){const e=O.value;if(!e)return;e.volume=.1,e.loop=!0;const t=()=>{const t=e.play();t&&"function"===typeof t.then&&t.catch((()=>{const t=()=>{document.removeEventListener("pointerdown",t),document.removeEventListener("keydown",t),e.play().catch((()=>{}))};document.addEventListener("pointerdown",t,{once:!0}),document.addEventListener("keydown",t,{once:!0})}))};t(),se()}function Nt(e){return n?n.stepSimulation(e):0}function _t(e){return n?n.getBuffers(e):{positions:new Float32Array(0),orientations:new Float32Array(0),velocities:new Float32Array(0),speciesIds:new Int32Array(0)}}function qt(){return n?.captureState()??null}function zt(e,t,i){n?.restoreState(e,t,i)}let Kt=null,jt=null,Xt=null,Gt=null,jn=null,Xn=null,Gn=!1;function Jn(){return y.reduce(((e,t)=>e+(t.isPredator&&t.count?t.count:0)),0)}function Yn(){return M.value}function Qn(e=y){return Array.isArray(e)?e.map(((e,t)=>`${t}:${e&&e.count||0}:${e&&e.isPredator?1:0}`)).join("|"):""}function $n(){if(!t||!n)return;const e=V?.state||null,i=V?.oldSettings||D,a=H||B(y),s=Qn(a);try{n.initializeFlock(a,{spatialScale:1,posRange:_n,velRange:.25,groundPlane:{enabled:!0,height:$?.position?.y??-10,blendDistance:1,stiffness:22,damping:10}})}catch(r){return console.error("群れの再初期化に失敗しました",r),W(D),V=null,void(H=null)}const o=Yn();U=o,ei(o),e?.count>0&&zt(e,i,a),I=s,D=a,V=null,H=null}function Zn(){He&&clearTimeout(He),V||(V={state:qt(),oldSettings:D}),H=B(y),He=setTimeout((()=>{He=null,$n()}),qn)}function ei(e){if(!z||!Kt||!jt||!Xt||!Gt)return void console.warn("initInstancedBoids: required assets are not ready");const t=Ct.init(z,{count:e,boidModel:Kt,boidModelLod:jt,highMaterial:Xt,lowMaterial:Gt,predatorModel:jn});if(!t)return void console.error("Failed to initialize boid instancing");const n=Ct.getMeshes();kt=n.high,Tt=n.low;const i=Jn();"function"===typeof Ct.ensurePredatorMeshes&&Ct.ensurePredatorMeshes(i),nt(),kt?.instanceColor&&(kt.instanceColor.needsUpdate=!0),Tt?.instanceColor&&(Tt.instanceColor.needsUpdate=!0)}function ti(e){const t=new Ze.B,n=new r.Tap;let i=3;const a=()=>{i=Math.max(0,i-1),0===i&&e()},s=n.load("./models/fish.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)})),o=n.load("./models/fish_lod.png",(()=>{console.log("Texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the texture:",e)}));s.flipY=!1,s.colorSpace=r.er$,o.flipY=!1,o.colorSpace=r.er$;const l=n.load("./models/fishPredetor.png",(()=>{console.log("Predator texture loaded successfully.")}),void 0,(e=>{console.error("An error occurred while loading the predator texture:",e)}));l.flipY=!1,l.colorSpace=r.er$;let u=new r._4j({color:16777215,roughness:.3,metalness:.3,transparent:!1,alphaTest:.5,map:s,vertexColors:!1,vertexColor:16777215}),c=new r._4j({color:16777215,roughness:.5,metalness:.2,transparent:!1,alphaTest:.5,map:o,vertexColors:!1,vertexColor:16777215});Xt=u,Gt=c,Xn=new r._4j({color:16777215,roughness:.5,metalness:0,transparent:!1,alphaTest:.5,map:l,vertexColors:!1,vertexColor:16777215}),t.load("./models/boidModel.glb",(e=>{Kt=e.scene,Kt.traverse((e=>{e.isMesh&&(e.material=u)})),a()}),void 0,(e=>{console.error("An error occurred while loading the model:",e),a()})),t.load("./models/boidModel_lod.glb",(e=>{jt=e.scene,jt.traverse((e=>{e.isMesh&&(e.material=c)})),a()}),void 0,(e=>{console.error("An error occurred while loading the LOD model:",e),a()})),t.load("./models/boidPredetorModel.glb",(e=>{jn=e.scene,jn.traverse((e=>{e.isMesh&&(e.material=Xn,e.castShadow=!0,e.receiveShadow=!0)})),a()}),void 0,(e=>{console.error("An error occurred while loading the predator model:",e),a()}))}function ni(){for(const e of me)z.remove(e);for(const e of ge)z.remove(e);me=[],ge=[]}function ii(){for(const e of ve)z.remove(e);ve=[]}function ai(e=!0){we&&(z.remove(we),we=null,Pe=0),e&&(xe?.dispose?.(),Me?.dispose?.(),xe=null,Me=null)}function si(e=!0){Ce&&(z.remove(Ce),Ce=null,Te=0),e&&(Le?.dispose?.(),ke?.dispose?.(),Le=null,ke=null)}function oi(e){if(!he.value)return void ii();const t=e?.buffer,n=t?.length??0,i=Math.floor(n/5);if(!t||i<=0)return void ii();be||(be=new r.Gu$(1,24,18));const a=.65;for(let s=0;s<i;s+=1){const e=5*s,n=t[e+3],i=t[e+4];if(n<=1e-4||i<=0){ve[s]&&(ve[s].visible=!1);continue}let o=ve[s];if(!o){const e=new r.V9B({color:(new r.Q1f).setHSL(.6,.8,.45),wireframe:!0,transparent:!0,opacity:.3,depthWrite:!1});o=new r.eaF(be,e),z.add(o),ve[s]=o}o.visible=!0,o.position.set(t[e],t[e+1],t[e+2]),o.scale.set(n,n,n),o.material.color.setHSL(s%7/7*a,.85,.5),o.material.opacity=.22+.25*Math.min(i/1e3,1)}for(let s=i;s<ve.length;s+=1)ve[s]&&(ve[s].visible=!1)}function ri(e){if(!de.value)return void ai();const t=e?.buffer,n=t?.length??0,i=Math.floor(n/6);if(!t||i<=0)return void ai();xe||(xe=new r.Gu$(1,24,18)),Me||(Me=new r.V9B({transparent:!0,opacity:.3,depthWrite:!1,vertexColors:!0,wireframe:!0})),(!we||Pe<i)&&(ai(!1),we=new r.ZLX(xe,Me,i),we.frustumCulled=!1,we.instanceMatrix.setUsage(r.Vnu),z.add(we),Pe=i),we.count=i;const a=.65,s=.5,o=.25;for(let r=0;r<i;r+=1){const e=6*r,n=Math.max(0,Math.floor(t[e]||0)),i=t[e+1],l=t[e+2],u=t[e+3],c=Math.max(o,(t[e+4]||0)*s),h=Math.max(0,t[e+5]||0);Re.position.set(i,l+.02,u),Re.scale.setScalar(c),Re.updateMatrix(),we.setMatrixAt(r,Re.matrix);const d=Math.min(h/5e3,1),p=n%7/7*a;Fe.setHSL(p,.9,.18+.62*d),we.setColorAt(r,Fe)}we.instanceMatrix.needsUpdate=!0,we.instanceColor&&(we.instanceColor.needsUpdate=!0)}function li(e){if(!pe.value)return void si();const t=e?.buffer,n=t?.length??0,i=Math.floor(n/6);if(!t||i<=0)return void si();Le||(Le=new r.Gu$(1,24,18)),ke||(ke=new r.V9B({transparent:!0,opacity:.3,depthWrite:!1,vertexColors:!0,wireframe:!0})),(!Ce||Te<i)&&(si(!1),Ce=new r.ZLX(Le,ke,i),Ce.frustumCulled=!1,Ce.instanceMatrix.setUsage(r.Vnu),z.add(Ce),Te=i),Ce.count=i;const a=.65,s=.6,o=.6;for(let r=0;r<i;r+=1){const e=6*r,n=Math.max(0,Math.floor(t[e]||0)),i=t[e+1],l=t[e+2],u=t[e+3],c=Math.max(o,(t[e+4]||0)*s),h=Math.max(0,t[e+5]||0);Ee.position.set(i,l+.03,u),Ee.scale.setScalar(c),Ee.updateMatrix(),Ce.setMatrixAt(r,Ee.matrix);const d=Math.min(h/12e3,1),p=n%7/7*a;Ae.setHSL(p,.85,.12+.75*d),Ce.setColorAt(r,Ae)}Ce.instanceMatrix.needsUpdate=!0,Ce.instanceColor&&(Ce.instanceColor.needsUpdate=!0)}let ui=performance.now(),ci=null,hi=0;const di=new r.Q1f;function pi(){!Ne&&j&&z&&K?"function"===typeof requestAnimationFrame&&(je=requestAnimationFrame(fi)):j||ht("raf")}function fi(e){if(Ne||!j||!z||!K)return void ht("animate");Ie?.begin();const t="number"===typeof e?e:performance.now(),i=(t-ui)/1e3;ui=t,ne.value||(Dt+=i),It(Dt);const a=Nt(ne.value?0:i),s=Ct.getMeshes();kt=s.high,Tt=s.low;const o=G?.isReady?.()??!1;if(!kt||!Tt)return X.update(),Ht(),o?(G.updateCameraUniforms(K),G.render(i)):j.render(z,K),Y?.update(i,X?.target,K),Y?.render(j,K),Ie?.end(),0===(1&Ve)&&Ie?.update(),void pi();const{positions:l,orientations:u,velocities:c}=_t(a);0===(63&Ve++)&&n?.getDiagnostics?.({firstBoidX:!0});const h=Jn(),d=Ct.update({count:a,positions:l,orientations:u,velocities:c,cameraPosition:K.position,originPosition:X?.target,predatorCount:h,posRange:_n}),p=d.visibleCount??Math.max(0,a-h);if(ce.value&&kt.instanceColor&&Tt.instanceColor){const e=n?.getDiagnostics?.({boidCount:a,unitMappings:!0,unitDensities:!0})??null,t=e?.unitMappings??null,i=d?.highCount??p,s=d?.lowCount??p,o=d?.highInstanceToBoid??null,r=d?.lowInstanceToBoid??null;if(t){hi!==a&&(ci=new Int32Array(a),hi=a),ci.fill(-1);for(let e=0;e<t.length;e+=2){const n=t[e];n>=0&&n<hi&&(ci[n]=t[e+1])}const n=e?.unitDensities??null,l=n?.length??0,u=.18,c=.45,h=.58,d=Boolean(n&&l>0);for(let e=0;e<i;e++){const t=o?o[e]:e,i=t>=0&&t<hi?ci[t]:-1;if(d&&i>=0&&i<l){const e=n[i],t=Math.min(Math.max(e*u,0),1),a=h-t*c;di.setHSL(a,.85,.55)}else i>=0?di.setHSL(i%100/100,.8,.6):di.setRGB(1,0,0);kt.setColorAt(e,di)}for(let e=0;e<s;e++){const t=r?r[e]:e,i=t>=0&&t<hi?ci[t]:-1;if(d&&i>=0&&i<l){const e=n[i],t=Math.min(Math.max(e*u,0),1),a=h-t*c;di.setHSL(a,.85,.55)}else i>=0?di.setHSL(i%100/100,.8,.6):di.setRGB(1,0,0);Tt.setColorAt(e,di)}kt.instanceColor.needsUpdate=!0,Tt.instanceColor.needsUpdate=!0}}else if(Gn&&kt.instanceColor&&Tt.instanceColor){const e=new r.Q1f(1,1,1),t=d?.highCount??p,n=d?.lowCount??p;for(let i=0;i<t;i++)kt.setColorAt(i,e);for(let i=0;i<n;i++)Tt.setColorAt(i,e);kt.instanceColor.needsUpdate=!0,Tt.instanceColor.needsUpdate=!0,console.log("✓ Reset vertex colors to white (OFF mode)")}Gn=ce.value;let f=null;n&&he.value&&(f=n.getDiagnostics?.({speciesEnvelopes:!0})?.speciesEnvelopes??null),he.value?(oi(f),0===(3&Ve)&&Je(f)):ve.length>0&&(ii(),oe.value="");let m=null;if(n&&mt()&&(m=n.getDiagnostics?.({speciesClusters:!0})?.speciesClusters??null),gt(m,i),de.value&&n){if(0===(3&Ve)){const e=n.getDiagnostics?.({speciesClusters:!0})?.speciesClusters??null;ri(e)}}else we&&ai();if(pe.value&&n){if(0===(3&Ve)){const e=n.getDiagnostics?.({speciesSchoolClusters:!0})?.speciesSchoolClusters??null;li(e)}}else Ce&&si();X.update(),Ht(),o?(G.updateCameraUniforms(K),G.render(i)):j.render(z,K),Y?.update(i,X?.target,K),Y?.render(j,K),Ie?.end(),Ie?.update(),pi()}function mi(){$n(),pi()}function gi(e){Array.isArray(e)&&e.length>0?W(e):C(),E(g),T(),R.value&&A()}return(0,a.sV)((()=>{R.value||(E((0,s.ux)(w)),R.value=!0,A(),T()),dt(),ti((()=>{console.log("Boid model loaded successfully."),Oe=!0,Ie=new $e.A({trackGPU:!0,trackHz:!0,trackCPT:!0,logsPerSecond:4,graphsPerSecond:30,samplesLog:40,samplesGraph:10,precision:2,horizontal:!0,minimal:!1,mode:0});const e=j?.domElement??document.body,t=()=>{const e=("undefined"!==typeof Ie?.domElement?Ie.domElement:null)||("function"===typeof Ie?.getDom?Ie.getDom():null)||Ie?.dom||Ie?.container||Ie?.wrapper||null;e&&(e.parentElement||document.body.appendChild(e),Ge(e))},n=Ie&&"function"===typeof Ie.init?Promise.resolve(Ie.init(e)):Promise.resolve();n.then((()=>{j&&"function"===typeof Ie?.patchThreeRenderer&&Ie.patchThreeRenderer(j),t()})).catch((e=>{console.error("Failed to initialize stats-gl:",e),t()})),mi(),Wt()})),window.addEventListener("keydown",Ye),document.addEventListener("visibilitychange",se),window.addEventListener("blur",se),window.addEventListener("focus",se),document.addEventListener("visibilitychange",(()=>{document.hidden||ht("visibility")})),window.addEventListener("focus",(()=>{ht("focus")}))})),(0,a.hi)((()=>{window.removeEventListener("keydown",Ye),document.removeEventListener("visibilitychange",se),window.removeEventListener("blur",se),window.removeEventListener("focus",se),je&&"function"===typeof cancelAnimationFrame&&(cancelAnimationFrame(je),je=null),at(),rt()})),(0,a.wB)((()=>Be.enableFogPipeline),(()=>{it()})),(0,a.wB)((()=>Be.enableShadows),(()=>{nt()})),(0,a.wB)((()=>Be.enableTailAnimation),(()=>{tt()})),(0,a.wB)(fe,(()=>{Ue()})),(0,a.wB)(w,(()=>{R.value&&(A(),T())}),{deep:!0}),(0,a.wB)(y,(()=>{n?.applySpeciesParams((0,s.ux)(y),{spatialScale:1}),T();const e=Qn(y);e!==I?Zn():(He&&(clearTimeout(He),He=null),V=null,H=null,D=B(y));const t=Jn();"function"===typeof Ct.ensurePredatorMeshes&&Ct.ensurePredatorMeshes(t);const i="function"===typeof Ct.getPredatorMeshes?Ct.getPredatorMeshes():[];for(const n of i)n.visible=!1}),{deep:!0}),(0,a.wB)(re,(e=>{console.log("showUnits changed to:",e),e||ni()})),(0,a.wB)(he,(e=>{e||ii()})),(0,a.wB)([le,ue],(([e,t])=>{console.log("Unit display mode changed - Spheres:",e,"Lines:",t),re.value&&ni()})),(e,t)=>((0,a.uX)(),(0,a.CE)("div",Jt,[(0,a.Lk)("div",Yt,[(0,a.Lk)("div",Qt,[t[34]||(t[34]=(0,a.Lk)("h1",null,"Boids Simulation",-1)),(0,a.Lk)("details",null,[t[31]||(t[31]=(0,a.Lk)("summary",null,"Settings",-1)),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)((0,s.R1)(y),((e,t)=>((0,a.uX)(),(0,a.CE)("div",{key:t},[(0,a.bF)(Qe,{settings:e,"can-remove":(0,s.R1)(y).length>1,onRemove:e=>_(t)},null,8,["settings","can-remove","onRemove"])])))),128)),(0,a.Lk)("button",{class:"add-species-button",onClick:N}," 種族を追加 "),(0,a.Lk)("button",{onClick:gi,style:{"margin-bottom":"1em"}}," リセット "),t[32]||(t[32]=(0,a.Lk)("br",null,null,-1)),(0,a.Lk)("div",$t,[(0,a.Lk)("details",Zt,[t[22]||(t[22]=(0,a.Lk)("summary",{class:"species-header"},[(0,a.Lk)("span",{class:"species-title"},"Adjustment")],-1)),(0,a.Lk)("div",en,[(0,a.Lk)("div",tn,[(0,a.Lk)("label",{title:v.threatDecay},t[17]||(t[17]=[(0,a.eW)("脅威減衰"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(threatDecay):")]),8,nn),(0,a.bo)((0,a.Lk)("input",{type:"range",min:"0",max:"5",step:"0.05","onUpdate:modelValue":t[0]||(t[0]=e=>(0,s.R1)(w).threatDecay=e),title:v.threatDecay},null,8,an),[[i.Jo,(0,s.R1)(w).threatDecay,void 0,{number:!0}]]),(0,a.bo)((0,a.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[1]||(t[1]=e=>(0,s.R1)(w).threatDecay=e),title:v.threatDecay},null,8,sn),[[i.Jo,(0,s.R1)(w).threatDecay,void 0,{number:!0}]])]),(0,a.Lk)("div",on,[(0,a.Lk)("label",{title:v.maxEscapeWeight},t[18]||(t[18]=[(0,a.eW)("逃避優先度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(maxEscapeWeight):")]),8,rn),(0,a.bo)((0,a.Lk)("input",{type:"range",min:"0",max:"1",step:"0.01","onUpdate:modelValue":t[2]||(t[2]=e=>(0,s.R1)(w).maxEscapeWeight=e),title:v.maxEscapeWeight},null,8,ln),[[i.Jo,(0,s.R1)(w).maxEscapeWeight,void 0,{number:!0}]]),(0,a.bo)((0,a.Lk)("input",{class:"value-input",type:"number",step:"0.01","onUpdate:modelValue":t[3]||(t[3]=e=>(0,s.R1)(w).maxEscapeWeight=e),title:v.maxEscapeWeight},null,8,un),[[i.Jo,(0,s.R1)(w).maxEscapeWeight,void 0,{number:!0}]])]),(0,a.Lk)("div",cn,[(0,a.Lk)("label",{title:v.baseEscapeStrength},t[19]||(t[19]=[(0,a.eW)("逃避舵取り強度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(baseEscapeStrength):")]),8,hn),(0,a.bo)((0,a.Lk)("input",{type:"range",min:"0",max:"15",step:"0.1","onUpdate:modelValue":t[4]||(t[4]=e=>(0,s.R1)(w).baseEscapeStrength=e),title:v.baseEscapeStrength},null,8,dn),[[i.Jo,(0,s.R1)(w).baseEscapeStrength,void 0,{number:!0}]]),(0,a.bo)((0,a.Lk)("input",{class:"value-input",type:"number",step:"0.1","onUpdate:modelValue":t[5]||(t[5]=e=>(0,s.R1)(w).baseEscapeStrength=e),title:v.baseEscapeStrength},null,8,pn),[[i.Jo,(0,s.R1)(w).baseEscapeStrength,void 0,{number:!0}]])]),(0,a.Lk)("div",fn,[(0,a.Lk)("label",{title:v.fastAttractStrength},t[20]||(t[20]=[(0,a.eW)("補助凝集強度"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(fastAttractStrength):")]),8,mn),(0,a.bo)((0,a.Lk)("input",{type:"range",min:"0",max:"3",step:"0.05","onUpdate:modelValue":t[6]||(t[6]=e=>(0,s.R1)(w).fastAttractStrength=e),title:v.fastAttractStrength},null,8,gn),[[i.Jo,(0,s.R1)(w).fastAttractStrength,void 0,{number:!0}]]),(0,a.bo)((0,a.Lk)("input",{class:"value-input",type:"number",step:"0.05","onUpdate:modelValue":t[7]||(t[7]=e=>(0,s.R1)(w).fastAttractStrength=e),title:v.fastAttractStrength},null,8,vn),[[i.Jo,(0,s.R1)(w).fastAttractStrength,void 0,{number:!0}]])]),(0,a.Lk)("div",bn,[(0,a.Lk)("label",{title:v.schoolPullCoefficient},t[21]||(t[21]=[(0,a.eW)("大クラスタ引力係数"),(0,a.Lk)("br",null,null,-1),(0,a.eW)("(schoolPullCoefficient):")]),8,Sn),(0,a.bo)((0,a.Lk)("input",{type:"range",min:"0",max:"0.005",step:"0.00001","onUpdate:modelValue":t[8]||(t[8]=e=>(0,s.R1)(w).schoolPullCoefficient=e),title:v.schoolPullCoefficient},null,8,yn),[[i.Jo,(0,s.R1)(w).schoolPullCoefficient,void 0,{number:!0}]]),(0,a.bo)((0,a.Lk)("input",{class:"value-input",type:"number",min:"0",step:"0.00001","onUpdate:modelValue":t[9]||(t[9]=e=>(0,s.R1)(w).schoolPullCoefficient=e),title:v.schoolPullCoefficient},null,8,wn),[[i.Jo,(0,s.R1)(w).schoolPullCoefficient,void 0,{number:!0}]])])])])]),t[33]||(t[33]=(0,a.Lk)("br",null,null,-1)),(0,a.Lk)("div",xn,[(0,a.Lk)("details",Mn,[t[30]||(t[30]=(0,a.Lk)("summary",{class:"species-header"},[(0,a.Lk)("span",{class:"species-title"},"Debug")],-1)),(0,a.Lk)("div",Pn,[(0,a.Lk)("label",{class:"debug-checkbox",title:b.enableFogPipeline},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[10]||(t[10]=e=>Be.enableFogPipeline=e),title:b.enableFogPipeline},null,8,Ln),[[i.lH,Be.enableFogPipeline]]),t[23]||(t[23]=(0,a.eW)(" フォグ/SSAO/ブルームを有効化 "))],8,Cn),(0,a.Lk)("label",{class:"debug-checkbox",title:b.enableShadows},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[11]||(t[11]=e=>Be.enableShadows=e),title:b.enableShadows},null,8,Tn),[[i.lH,Be.enableShadows]]),t[24]||(t[24]=(0,a.eW)(" 影描画を有効化 "))],8,kn),(0,a.Lk)("label",{class:"debug-checkbox",title:b.enableTailAnimation},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[12]||(t[12]=e=>Be.enableTailAnimation=e),title:b.enableTailAnimation},null,8,Fn),[[i.lH,Be.enableTailAnimation]]),t[25]||(t[25]=(0,a.eW)(" 尾びれアニメーションを有効化 "))],8,Rn),(0,a.Lk)("label",{class:"debug-checkbox",title:b.showSpeciesEnvelopes},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[13]||(t[13]=e=>he.value=e),title:b.showSpeciesEnvelopes},null,8,An),[[i.lH,he.value]]),t[26]||(t[26]=(0,a.eW)(" 種族エンベロープ表示 "))],8,En),(0,a.Lk)("label",{class:"debug-checkbox",title:b.showSpeciesClusters},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[14]||(t[14]=e=>de.value=e),title:b.showSpeciesClusters},null,8,Un),[[i.lH,de.value]]),t[27]||(t[27]=(0,a.eW)(" クラスター表示 "))],8,Bn),(0,a.Lk)("label",{class:"debug-checkbox",title:b.showSpeciesSchoolClusters},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[15]||(t[15]=e=>pe.value=e),title:b.showSpeciesSchoolClusters},null,8,Dn),[[i.lH,pe.value]]),t[28]||(t[28]=(0,a.eW)(" 大クラスター表示 "))],8,In),(0,a.Lk)("label",{class:"debug-checkbox",title:b.showWorldAxisGrid},[(0,a.bo)((0,a.Lk)("input",{type:"checkbox","onUpdate:modelValue":t[16]||(t[16]=e=>fe.value=e),title:b.showWorldAxisGrid},null,8,Hn),[[i.lH,fe.value]]),t[29]||(t[29]=(0,a.eW)(" ワールド座標グリッド/軸（目盛り）表示 "))],8,Vn)])])])]),(0,a.Lk)("div",Wn,[(0,a.Lk)("p",null,"Boids Count: "+(0,o.v_)((0,s.R1)(M)),1)])])]),he.value&&oe.value?((0,a.uX)(),(0,a.CE)("pre",Nn,(0,o.v_)(oe.value)+"\n    ",1)):(0,a.Q3)("",!0),(0,a.Lk)("div",{ref_key:"threeContainer",ref:q,class:"three-container"},null,512),(0,a.Lk)("audio",{ref_key:"backgroundAudio",ref:O,src:"/UnderWater.mp3",loop:"",style:{display:"none"}},null,512)]))}},Xn=jn,Gn=Xn,Jn="/wasm-boids/".replace(/\/*$/,"/"),Yn=`${Jn}static/js`,Qn=`${Yn}/wasm_boids.js`,$n=`${Yn}/wasm_boids.wasm`;async function Zn(){try{const e=await import(Qn);if(!e?.default)throw new Error(`WASM module loader not found at: ${Qn}`);const t=await e.default({locateFile:e=>e.endsWith(".wasm")?$n:e});"undefined"!==typeof window&&(window.wasmModule=t),console.log("Wasm module initialized:",t);const n=(0,i.Ef)(Gn);n.provide("wasmModule",t),n.mount("#app")}catch(e){console.error("Failed to initialise WASM module:",e)}}Zn()}},t={};function n(i){var a=t[i];if(void 0!==a)return a.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,n),s.exports}n.m=e,(()=>{var e=[];n.O=(t,i,a,s)=>{if(!i){var o=1/0;for(c=0;c<e.length;c++){for(var[i,a,s]=e[c],r=!0,l=0;l<i.length;l++)(!1&s||o>=s)&&Object.keys(n.O).every((e=>n.O[e](i[l])))?i.splice(l--,1):(r=!1,s<o&&(o=s));if(r){e.splice(c--,1);var u=a();void 0!==u&&(t=u)}}return t}s=s||0;for(var c=e.length;c>0&&e[c-1][2]>s;c--)e[c]=e[c-1];e[c]=[i,a,s]}})(),(()=>{n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}})(),(()=>{n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e={57:0};n.O.j=t=>0===e[t];var t=(t,i)=>{var a,s,[o,r,l]=i,u=0;if(o.some((t=>0!==e[t]))){for(a in r)n.o(r,a)&&(n.m[a]=r[a]);if(l)var c=l(n)}for(t&&t(i);u<o.length;u++)s=o[u],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(c)},i=self["webpackChunkwasm_boids"]=self["webpackChunkwasm_boids"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var i=n.O(void 0,[504],(()=>n(365)));i=n.O(i)})();
//# sourceMappingURL=index.6e662526.js.map